/**
 * Calculator Manager - Registry and management for medical calculators
 */

import { eventBus } from './EventBus.js';
import { storage } from './StorageManager.js';
import { analytics } from './AnalyticsManager.js';
import { EVENTS, STORAGE_KEYS, CALCULATOR_TYPES, TOOL_CATEGORIES } from './Constants.js';
import { calculatorRegistry } from './Calculators.js';
import calculatorBridge from './CalculatorBridge.js';

export class CalculatorManager {
    constructor() {
        this.calculators = new Map();
        this.currentCalculator = null;
        this.recentTools = [];
        this.toolNotes = {};
        this.bridge = calculatorBridge;
    }

    /**
     * Initialize calculator manager and auto-register all calculators
     */
    initialize() {
        // Initialize the bridge with dependencies
        this.bridge.initialize(eventBus, storage, analytics);
        
        // Load saved data
        this.recentTools = storage.getItem(STORAGE_KEYS.RECENT_TOOLS, []);
        this.toolNotes = storage.getItem(STORAGE_KEYS.TOOL_NOTES, {});
        
        // Auto-register all calculators from registry
        this.registerAllCalculators();
        
        // Register bridge calculators
        this.registerBridgeCalculators();
        
        console.log(`ðŸ§® Calculator Manager initialized with ${this.calculators.size} calculators`);
    }
    
    /**
     * Auto-register all calculators from the registry
     */
    registerAllCalculators() {
        Object.entries(calculatorRegistry).forEach(([id, config]) => {
            this.registerCalculator(id, config);
        });
    }

    /**
     * Register calculators from the V1 bridge
     * 
     * Connects to ExtractedCalculators which contains all 61 calculator implementations from V1.
     * V2 native implementations (Calculators.js) provides only 6 calculators.
     * The bridge provides the remaining 55+ calculators until full V2 migration is complete.
     */
    registerBridgeCalculators() {
        // Check if ExtractedCalculators is available
        const EC = window.ExtractedCalculators;
        if (!EC) {
            console.warn('âš ï¸ ExtractedCalculators not loaded - many calculators unavailable');
            console.info('â„¹ï¸  Only 6 native V2 calculators available without bridge');
            return; // Exit early if bridge not available
        }
        
        console.log('âœ… ExtractedCalculators bridge loaded - registering 55+ calculators...');
        
        // Note: For now, the bridge provides most calculator functionality
        // V2 native implementations in Calculators.js only cover 6 calculators
        // TODO: Migrate remaining calculators to native V2 implementations

        // === CARDIOVASCULAR CALCULATORS ===
        
        // GRACE Score
        if (EC.getGRACECalculator) {
            this.registerCalculator('grace', {
                name: 'GRACE Score',
                category: TOOL_CATEGORIES.CARDIOLOGY,
                description: 'Risk stratification for ACS',
                keywords: ['grace', 'acs', 'risk', 'cardiac', 'heart'],
                getTemplate: () => EC.getGRACECalculator(),
                calculate: () => EC.calculateGRACE(),
                bindEvents: () => {}
            });
        }

        // QRISK3
        if (EC.getQRISK3Calculator) {
            this.registerCalculator('qrisk3', {
                name: 'QRISK3',
                category: TOOL_CATEGORIES.RISK,
                description: 'CV risk assessment',
                keywords: ['qrisk', 'cardiovascular', 'risk', 'prevention'],
                getTemplate: () => EC.getQRISK3Calculator(),
                calculate: () => EC.calculateQRISK3(),
                bindEvents: () => {}
            });
        }
        
        // === RESPIRATORY CALCULATORS ===
        
        // CURB-65
        if (EC.getCURB65Calculator) {
            this.registerCalculator('curb65', {
                name: 'CURB-65',
                category: TOOL_CATEGORIES.RESPIRATORY,
                description: 'Pneumonia severity assessment',
                keywords: ['curb', 'pneumonia', 'severity', 'respiratory'],
                getTemplate: () => EC.getCURB65Calculator(),
                calculate: () => EC.calculateCURB65(),
                bindEvents: () => {}
            });
        }

        // Peak Flow (PEFR)
        if (EC.getPEFRCalculator) {
            this.registerCalculator('pefr', {
                name: 'Peak Flow Calculator',
                category: TOOL_CATEGORIES.RESPIRATORY,
                description: 'Expected peak expiratory flow rate',
                keywords: ['pefr', 'peak', 'flow', 'respiratory', 'asthma'],
                getTemplate: () => EC.getPEFRCalculator(),
                calculate: () => EC.calculatePEFR(),
                bindEvents: () => {}
            });
        }
        
        // === NEUROLOGICAL CALCULATORS ===
        
        // NIHSS
        if (EC.getNIHSSCalculator) {
            this.registerCalculator('nihss', {
                name: 'NIHSS',
                category: TOOL_CATEGORIES.NEUROLOGY,
                description: 'Stroke severity assessment',
                keywords: ['nihss', 'stroke', 'neurology', 'severity'],
                getTemplate: () => EC.getNIHSSCalculator(),
                calculate: () => EC.calculateNIHSS(),
                bindEvents: () => {}
            });
        }

        // ABCD2 Score
        if (EC.getABCD2Calculator) {
            this.registerCalculator('abcd2', {
                name: 'ABCD2 Score',
                category: TOOL_CATEGORIES.NEUROLOGY,
                description: 'TIA stroke risk stratification',
                keywords: ['abcd2', 'tia', 'stroke', 'risk'],
                getTemplate: () => EC.getABCD2Calculator(),
                calculate: () => EC.calculateABCD2(),
                bindEvents: () => {}
            });
        }
        
        // === CRITICAL CARE CALCULATORS ===
        
        // APACHE II
        if (EC.getAPACHECalculator) {
            this.registerCalculator('apache', {
                name: 'APACHE II',
                category: TOOL_CATEGORIES.CRITICAL_CARE,
                description: 'ICU mortality prediction',
                keywords: ['apache', 'icu', 'mortality', 'critical'],
                getTemplate: () => EC.getAPACHECalculator(),
                calculate: () => EC.calculateAPACHE(),
                bindEvents: () => {}
            });
        }

        // SOFA Score
        if (EC.getSOFACalculator) {
            this.registerCalculator('sofa', {
                name: 'SOFA Score',
                category: TOOL_CATEGORIES.CRITICAL_CARE,
                description: 'Sequential organ failure assessment',
                keywords: ['sofa', 'organ', 'failure', 'critical', 'sepsis'],
                getTemplate: () => EC.getSOFACalculator(),
                calculate: () => EC.calculateSOFA(),
                bindEvents: () => {}
            });
        }

        // MEWS (Modified Early Warning Score)
        if (EC.getMEWSCalculator) {
            this.registerCalculator('mews', {
                name: 'MEWS',
                category: TOOL_CATEGORIES.CRITICAL_CARE,
                description: 'Modified Early Warning Score',
                keywords: ['mews', 'warning', 'deterioration', 'vital'],
                getTemplate: () => EC.getMEWSCalculator(),
                calculate: () => EC.calculateMEWS(),
                bindEvents: () => {}
            });
        }

        // NEWS2
        if (EC.getNEWS2Calculator) {
            this.registerCalculator('news2', {
                name: 'NEWS2',
                category: TOOL_CATEGORIES.CRITICAL_CARE,
                description: 'National Early Warning Score 2',
                keywords: ['news', 'warning', 'deterioration', 'rcp'],
                getTemplate: () => EC.getNEWS2Calculator(),
                calculate: () => EC.calculateNEWS2(),
                bindEvents: () => {}
            });
        }
        
        // === RENAL CALCULATORS ===
        
        // eGFR
        if (EC.getEGFRCalculator) {
            this.registerCalculator('egfr', {
                name: 'eGFR Calculator',
                category: TOOL_CATEGORIES.NEPHROLOGY,
                description: 'Estimated glomerular filtration rate',
                keywords: ['egfr', 'kidney', 'renal', 'creatinine'],
                getTemplate: () => EC.getEGFRCalculator(),
                calculate: () => EC.calculateEGFR(),
                bindEvents: () => {}
            });
        }
        
        // === HEPATOLOGY CALCULATORS ===
        
        // MELD Score
        if (EC.getMELDCalculator) {
            this.registerCalculator('meld', {
                name: 'MELD Score',
                category: TOOL_CATEGORIES.HEPATOLOGY,
                description: 'Model for End-stage Liver Disease',
                keywords: ['meld', 'liver', 'hepatology', 'cirrhosis'],
                getTemplate: () => EC.getMELDCalculator(),
                calculate: () => EC.calculateMELD(),
                bindEvents: () => {}
            });
        }

        // Child-Pugh
        if (EC.getChildPughCalculator) {
            this.registerCalculator('child-pugh', {
                name: 'Child-Pugh Score',
                category: TOOL_CATEGORIES.HEPATOLOGY,
                description: 'Chronic liver disease severity',
                keywords: ['child', 'pugh', 'liver', 'cirrhosis'],
                getTemplate: () => EC.getChildPughCalculator(),
                calculate: () => EC.calculateChildPugh(),
                bindEvents: () => {}
            });
        }
        
        // === LABORATORY CALCULATORS ===
        
        // Anion Gap
        if (EC.getAnionGapCalculator) {
            this.registerCalculator('anion-gap', {
                name: 'Anion Gap',
                category: TOOL_CATEGORIES.LABORATORY,
                description: 'Serum anion gap calculation',
                keywords: ['anion', 'gap', 'electrolytes', 'acidosis'],
                getTemplate: () => EC.getAnionGapCalculator(),
                calculate: () => EC.calculateAnionGap(),
                bindEvents: () => {}
            });
        }

        // Corrected Calcium
        if (EC.getCorrectedCalciumCalculator) {
            this.registerCalculator('corrected-calcium', {
                name: 'Corrected Calcium',
                category: TOOL_CATEGORIES.LABORATORY,
                description: 'Albumin-corrected calcium',
                keywords: ['calcium', 'albumin', 'corrected', 'biochemistry'],
                getTemplate: () => EC.getCorrectedCalciumCalculator(),
                calculate: () => EC.calculateCorrectedCalcium(),
                bindEvents: () => {}
            });
        }

        // Corrected Sodium
        if (EC.getCorrectedSodiumCalculator) {
            this.registerCalculator('corrected-sodium', {
                name: 'Corrected Sodium',
                category: TOOL_CATEGORIES.LABORATORY,
                description: 'Glucose-corrected sodium',
                keywords: ['sodium', 'glucose', 'corrected', 'hyperglycemia'],
                getTemplate: () => EC.getCorrectedSodiumCalculator(),
                calculate: () => EC.calculateCorrectedSodium(),
                bindEvents: () => {}
            });
        }

        // Osmolal Gap
        if (EC.getOsmolalGapCalculator) {
            this.registerCalculator('osmolal-gap', {
                name: 'Osmolal Gap',
                category: TOOL_CATEGORIES.LABORATORY,
                description: 'Serum osmolal gap calculation',
                keywords: ['osmolal', 'gap', 'toxicology', 'alcohol'],
                getTemplate: () => EC.getOsmolalGapCalculator(),
                calculate: () => EC.calculateOsmolalGap(),
                bindEvents: () => {}
            });
        }
        
        // === GASTROENTEROLOGY CALCULATORS ===
        
        // Ranson Score
        if (EC.getRansonCalculator) {
            this.registerCalculator('ranson', {
                name: 'Ranson Score',
                category: TOOL_CATEGORIES.GASTROENTEROLOGY,
                description: 'Acute pancreatitis severity',
                keywords: ['ranson', 'pancreatitis', 'severity', 'gastro'],
                getTemplate: () => EC.getRansonCalculator(),
                calculate: () => EC.calculateRanson(),
                bindEvents: () => {}
            });
        }

        // Centor Score
        if (EC.getCentorCalculator) {
            this.registerCalculator('centor', {
                name: 'Centor Score',
                category: TOOL_CATEGORIES.INFECTIOUS_DISEASE,
                description: 'Strep throat probability',
                keywords: ['centor', 'strep', 'throat', 'pharyngitis'],
                getTemplate: () => EC.getCentorCalculator(),
                calculate: () => EC.calculateCentor(),
                bindEvents: () => {}
            });
        }

        // Alvarado Score
        if (EC.getAlvaradoCalculator) {
            this.registerCalculator('alvarado', {
                name: 'Alvarado Score',
                category: TOOL_CATEGORIES.SURGERY,
                description: 'Acute appendicitis diagnosis',
                keywords: ['alvarado', 'appendicitis', 'surgery', 'diagnosis'],
                getTemplate: () => EC.getAlvaradoCalculator(),
                calculate: () => EC.calculateAlvarado(),
                bindEvents: () => {}
            });
        }
        
        // === PSYCHIATRY CALCULATORS ===
        
        // PHQ-9
        if (EC.getPHQ9Calculator) {
            this.registerCalculator('phq9', {
                name: 'PHQ-9',
                category: TOOL_CATEGORIES.PSYCHIATRY,
                description: 'Depression severity questionnaire',
                keywords: ['phq', 'depression', 'psychiatry', 'mental'],
                getTemplate: () => EC.getPHQ9Calculator(),
                calculate: () => EC.calculatePHQ9(),
                bindEvents: () => {}
            });
        }

        // GAD-7
        if (EC.getGAD7Calculator) {
            this.registerCalculator('gad7', {
                name: 'GAD-7',
                category: TOOL_CATEGORIES.PSYCHIATRY,
                description: 'Generalized anxiety disorder assessment',
                keywords: ['gad', 'anxiety', 'psychiatry', 'mental'],
                getTemplate: () => EC.getGAD7Calculator(),
                calculate: () => EC.calculateGAD7(),
                bindEvents: () => {}
            });
        }

        // Mental State Examination
        if (EC.getMSECalculator) {
            this.registerCalculator('mse', {
                name: 'Mental State Exam',
                category: TOOL_CATEGORIES.PSYCHIATRY,
                description: 'Structured MSE assessment',
                keywords: ['mse', 'mental', 'state', 'psychiatry'],
                getTemplate: () => EC.getMSECalculator(),
                calculate: () => EC.calculateMSE(),
                bindEvents: () => {}
            });
        }

        // MMSE
        if (EC.getMMSECalculator) {
            this.registerCalculator('mmse', {
                name: 'Mini-Mental State Exam',
                category: TOOL_CATEGORIES.NEUROLOGY,
                description: 'Cognitive impairment screening',
                keywords: ['mmse', 'cognitive', 'dementia', 'mental'],
                getTemplate: () => EC.getMMSECalculator(),
                calculate: () => EC.calculateMMSE(),
                bindEvents: () => {}
            });
        }
        
        // === PHARMACOLOGY CALCULATORS ===
        
        // Insulin Sliding Scale
        if (EC.getInsulinSlidingCalculator) {
            this.registerCalculator('insulin-sliding', {
                name: 'Insulin Sliding Scale',
                category: TOOL_CATEGORIES.ENDOCRINOLOGY,
                description: 'Variable rate insulin infusion',
                keywords: ['insulin', 'sliding', 'diabetes', 'glucose'],
                getTemplate: () => EC.getInsulinSlidingCalculator(),
                calculate: () => EC.calculateInsulinSliding(),
                bindEvents: () => {}
            });
        }

        // Vasopressor Calculator
        if (EC.getVasopressorCalculator) {
            this.registerCalculator('vasopressor', {
                name: 'Vasopressor Calculator',
                category: TOOL_CATEGORIES.CRITICAL_CARE,
                description: 'Inotrope/vasopressor dosing',
                keywords: ['vasopressor', 'inotrope', 'noradrenaline', 'adrenaline'],
                getTemplate: () => EC.getVasopressorCalculator(),
                calculate: () => EC.calculateVasopressor(),
                bindEvents: () => {}
            });
        }

        // Paediatric Dosing
        if (EC.getPaediatricDosingCalculator) {
            this.registerCalculator('paediatric-dosing', {
                name: 'Paediatric Dosing',
                category: TOOL_CATEGORIES.PAEDIATRICS,
                description: 'Weight-based drug dosing',
                keywords: ['paediatric', 'dosing', 'weight', 'children'],
                getTemplate: () => EC.getPaediatricDosingCalculator(),
                calculate: () => EC.calculatePaediatricDosing(),
                bindEvents: () => {}
            });
        }

        // Infusion Rate Calculator
        if (EC.getInfusionRateCalculator) {
            this.registerCalculator('infusion-rate', {
                name: 'Infusion Rate Calculator',
                category: TOOL_CATEGORIES.PHARMACOLOGY,
                description: 'IV infusion rate calculations',
                keywords: ['infusion', 'rate', 'iv', 'drip'],
                getTemplate: () => EC.getInfusionRateCalculator(),
                calculate: () => EC.calculateInfusionRate(),
                bindEvents: () => {}
            });
        }

        // Drug Volume Calculator
        if (EC.getDrugVolumeCalculator) {
            this.registerCalculator('drug-volume', {
                name: 'Drug Volume Calculator',
                category: TOOL_CATEGORIES.PHARMACOLOGY,
                description: 'Drug volume and dilution calculations',
                keywords: ['drug', 'volume', 'dilution', 'concentration'],
                getTemplate: () => EC.getDrugVolumeCalculator(),
                calculate: () => EC.calculateDrugVolume(),
                bindEvents: () => {}
            });
        }
        
        // === NUTRITION & GERIATRICS ===
        
        // MUST Score
        if (EC.getMUSTCalculator) {
            this.registerCalculator('must', {
                name: 'MUST Score',
                category: TOOL_CATEGORIES.NUTRITION,
                description: 'Malnutrition Universal Screening Tool',
                keywords: ['must', 'malnutrition', 'nutrition', 'screening'],
                getTemplate: () => EC.getMUSTCalculator(),
                calculate: () => EC.calculateMUST(),
                bindEvents: () => {}
            });
        }

        // Waterlow Score
        if (EC.getWaterlowCalculator) {
            this.registerCalculator('waterlow', {
                name: 'Waterlow Score',
                category: TOOL_CATEGORIES.SURGERY,
                description: 'Pressure ulcer risk assessment',
                keywords: ['waterlow', 'pressure', 'ulcer', 'risk'],
                getTemplate: () => EC.getWaterlowCalculator(),
                calculate: () => EC.calculateWaterlow(),
                bindEvents: () => {}
            });
        }

        // Frailty Index
        if (EC.getFrailtyCalculator) {
            this.registerCalculator('frailty', {
                name: 'Frailty Index',
                category: TOOL_CATEGORIES.GERIATRICS,
                description: 'Clinical frailty assessment',
                keywords: ['frailty', 'geriatrics', 'elderly', 'assessment'],
                getTemplate: () => EC.getFrailtyCalculator(),
                calculate: () => EC.calculateFrailty(),
                bindEvents: () => {}
            });
        }

        // Barthel Index
        if (EC.getBarthelCalculator) {
            this.registerCalculator('barthel', {
                name: 'Barthel Index',
                category: TOOL_CATEGORIES.GERIATRICS,
                description: 'Activities of daily living assessment',
                keywords: ['barthel', 'adl', 'independence', 'function'],
                getTemplate: () => EC.getBarthelCalculator(),
                calculate: () => EC.calculateBarthel(),
                bindEvents: () => {}
            });
        }

        // Modified Rankin Scale
        if (EC.getModifiedRankinCalculator) {
            this.registerCalculator('modified-rankin', {
                name: 'Modified Rankin Scale',
                category: TOOL_CATEGORIES.NEUROLOGY,
                description: 'Degree of disability after stroke',
                keywords: ['rankin', 'stroke', 'disability', 'outcome'],
                getTemplate: () => EC.getModifiedRankinCalculator(),
                calculate: () => EC.calculateModifiedRankin(),
                bindEvents: () => {}
            });
        }
        
        // === ADDITIONAL CARDIOLOGY ===
        
        // TIMI Risk Score
        if (EC.getTIMICalculator) {
            this.registerCalculator('timi', {
                name: 'TIMI Risk Score',
                category: TOOL_CATEGORIES.CARDIOLOGY,
                description: 'Cardiac risk stratification',
                keywords: ['timi', 'cardiac', 'risk', 'acs'],
                getTemplate: () => EC.getTIMICalculator(),
                calculate: () => EC.calculateTIMI(),
                bindEvents: () => {}
            });
        }

        // RCRI (Revised Cardiac Risk Index)
        if (EC.getRCRICalculator) {
            this.registerCalculator('rcri', {
                name: 'Revised Cardiac Risk Index',
                category: TOOL_CATEGORIES.CARDIOLOGY,
                description: 'Perioperative cardiac risk',
                keywords: ['rcri', 'cardiac', 'perioperative', 'surgery'],
                getTemplate: () => EC.getRCRICalculator(),
                calculate: () => EC.calculateRCRI(),
                bindEvents: () => {}
            });
        }

        // QTc Calculator
        if (EC.getQTcCalculator) {
            this.registerCalculator('qtc', {
                name: 'QTc Calculator',
                category: TOOL_CATEGORIES.CARDIOLOGY,
                description: 'Corrected QT interval',
                keywords: ['qtc', 'qt', 'interval', 'ecg', 'arrhythmia'],
                getTemplate: () => EC.getQTcCalculator(),
                calculate: () => EC.calculateQTc(),
                bindEvents: () => {}
            });
        }

        // Wells DVT Score
        if (EC.getWellsDVTCalculator) {
            this.registerCalculator('wells-dvt', {
                name: 'Wells DVT Score',
                category: TOOL_CATEGORIES.VASCULAR,
                description: 'Deep vein thrombosis probability',
                keywords: ['wells', 'dvt', 'thrombosis', 'vascular'],
                getTemplate: () => EC.getWellsDVTCalculator(),
                calculate: () => EC.calculateWellsDVT(),
                bindEvents: () => {}
            });
        }
        
        // === GASTROENTEROLOGY ADDITIONAL ===
        
        // Rockall Score
        if (EC.getRockallCalculator) {
            this.registerCalculator('rockall', {
                name: 'Rockall Score',
                category: TOOL_CATEGORIES.GASTROENTEROLOGY,
                description: 'Upper GI bleeding risk assessment',
                keywords: ['rockall', 'gi', 'bleeding', 'upper'],
                getTemplate: () => EC.getRockallCalculator(),
                calculate: () => EC.calculateRockall(),
                bindEvents: () => {}
            });
        }

        // Glasgow-Blatchford Score
        if (EC.getGlasgowBlatchfordCalculator) {
            this.registerCalculator('glasgow-blatchford', {
                name: 'Glasgow-Blatchford Score',
                category: TOOL_CATEGORIES.GASTROENTEROLOGY,
                description: 'GI bleeding severity assessment',
                keywords: ['glasgow', 'blatchford', 'gi', 'bleeding'],
                getTemplate: () => EC.getGlasgowBlatchfordCalculator(),
                calculate: () => EC.calculateGlasgowBlatchford(),
                bindEvents: () => {}
            });
        }
        
        // === ORTHOPAEDIC CALCULATORS ===
        
        // Ottawa Ankle Rules
        if (EC.getOttawaAnkleCalculator) {
            this.registerCalculator('ottawa-ankle', {
                name: 'Ottawa Ankle Rules',
                category: TOOL_CATEGORIES.ORTHOPAEDICS,
                description: 'Ankle fracture decision rule',
                keywords: ['ottawa', 'ankle', 'fracture', 'xray'],
                getTemplate: () => EC.getOttawaAnkleCalculator(),
                calculate: () => EC.calculateOttawaAnkle(),
                bindEvents: () => {}
            });
        }

        // Ottawa Knee Rules
        if (EC.getOttawaKneeCalculator) {
            this.registerCalculator('ottawa-knee', {
                name: 'Ottawa Knee Rules',
                category: TOOL_CATEGORIES.ORTHOPAEDICS,
                description: 'Knee fracture decision rule',
                keywords: ['ottawa', 'knee', 'fracture', 'xray'],
                getTemplate: () => EC.getOttawaKneeCalculator(),
                calculate: () => EC.calculateOttawaKnee(),
                bindEvents: () => {}
            });
        }

        // Canadian C-Spine Rules
        if (EC.getCSpineCalculator) {
            this.registerCalculator('c-spine', {
                name: 'Canadian C-Spine Rules',
                category: TOOL_CATEGORIES.ORTHOPAEDICS,
                description: 'Cervical spine imaging decision rule',
                keywords: ['c-spine', 'cervical', 'spine', 'canadian'],
                getTemplate: () => EC.getCSpineCalculator(),
                calculate: () => EC.calculateCSpine(),
                bindEvents: () => {}
            });
        }
        
        // === OBSTETRICS & GYNAECOLOGY ===
        
        // Bishop Score
        if (EC.getBishopCalculator) {
            this.registerCalculator('bishop', {
                name: 'Bishop Score',
                category: TOOL_CATEGORIES.OBSTETRICS,
                description: 'Cervical readiness for induction',
                keywords: ['bishop', 'cervical', 'induction', 'labour'],
                getTemplate: () => EC.getBishopCalculator(),
                calculate: () => EC.calculateBishop(),
                bindEvents: () => {}
            });
        }
        
        // === UTILITY CALCULATORS ===
        
        // Unit Converter
        if (EC.getUnitConverterCalculator) {
            this.registerCalculator('unit-converter', {
                name: 'Clinical Unit Converter',
                category: TOOL_CATEGORIES.UTILITIES,
                description: 'Convert between clinical units',
                keywords: ['unit', 'converter', 'conversion', 'mmol', 'mg'],
                getTemplate: () => EC.getUnitConverterCalculator(),
                calculate: () => EC.calculateUnitConverter(),
                bindEvents: () => {}
            });
        }
        
        // Mean Arterial Pressure
        if (EC.getMAPCalculator) {
            this.registerCalculator('map', {
                name: 'Mean Arterial Pressure',
                category: TOOL_CATEGORIES.CARDIOLOGY,
                description: 'Calculate MAP from BP',
                keywords: ['map', 'mean', 'arterial', 'pressure', 'bp'],
                getTemplate: () => EC.getMAPCalculator(),
                calculate: () => EC.calculateMAP(),
                bindEvents: () => {}
            });
        }
        
        // A-a Gradient
        if (EC.getAAGradientCalculator) {
            this.registerCalculator('aa-gradient', {
                name: 'A-a Gradient',
                category: TOOL_CATEGORIES.RESPIRATORY,
                description: 'Alveolar-arterial oxygen gradient',
                keywords: ['aa', 'gradient', 'oxygen', 'respiratory', 'abg'],
                getTemplate: () => EC.getAAGradientCalculator(),
                calculate: () => EC.calculateAAGradient(),
                bindEvents: () => {}
            });
        }
        
        // PERC Rule
        if (EC.getPERCCalculator) {
            this.registerCalculator('perc', {
                name: 'PERC Rule',
                category: TOOL_CATEGORIES.RESPIRATORY,
                description: 'Pulmonary embolism rule-out criteria',
                keywords: ['perc', 'pe', 'pulmonary', 'embolism'],
                getTemplate: () => EC.getPERCCalculator(),
                calculate: () => EC.calculatePERC(),
                bindEvents: () => {}
            });
        }

        console.log(`âœ… Bridge calculators registered: ${this.calculators.size - 6} from ExtractedCalculators`);
    }

    /**
     * Register a calculator
     */
    registerCalculator(id, config) {
        const calculator = {
            id,
            name: config.name,
            category: config.category || TOOL_CATEGORIES.OTHER,
            description: config.description || '',
            keywords: config.keywords || [],
            getTemplate: config.getTemplate,
            calculate: config.calculate,
            bindEvents: config.bindEvents,
            metadata: config.metadata || {}
        };

        this.calculators.set(id, calculator);
        
        return calculator;
    }
    
    /**
     * Load calculator into detail view
     */
    loadCalculator(calculatorId) {
        const calculator = this.getCalculator(calculatorId);
        if (!calculator) {
            console.error(`Calculator not found: ${calculatorId}`);
            return false;
        }

        try {
            // Switch to calculator detail panel first
            eventBus.emit(EVENTS.UI_SWITCH_TOOL, { tool: 'calculator-detail' });
            
            // Set current calculator
            this.currentCalculator = calculator;
            
            // Add to recent tools
            this.addToRecentTools(calculatorId);
            
            // Get container element
            const container = document.getElementById('calculator-content');
            if (!container) {
                console.error('Calculator container not found');
                return false;
            }
            
            // Clear existing content
            container.innerHTML = '';
            
            // Render calculator
            const success = this.renderCalculator(calculator, container);
            if (success) {
                // Emit event
                eventBus.emit(EVENTS.CALCULATOR_LOADED, {
                    id: calculator.id,
                    name: calculator.name,
                    category: calculator.category
                });
                
                // Analytics
                analytics.trackCalculatorUsage(calculator.id);
                
                console.log(`âœ… Calculator loaded: ${calculator.name}`);
            }
            
            return success;
        } catch (error) {
            console.error('Error loading calculator:', error);
            return false;
        }
    }

    /**
     * Render calculator HTML and bind events
     */
    renderCalculator(calculator, container) {
        try {
            // Render HTML using getTemplate
            const html = calculator.getTemplate();
            container.innerHTML = html;
            
            // Bind calculator events - pass the container
            if (calculator.bindEvents) {
                calculator.bindEvents(container);
            }
            
            return true;
        } catch (error) {
            console.error('Error rendering calculator:', error);
            return false;
        }
    }
    
    /**
     * Execute calculation for a calculator
     */
    executeCalculation(calculatorId) {
        const calculator = this.getCalculator(calculatorId);
        if (!calculator) {
            console.error(`Calculator not found: ${calculatorId}`);
            return null;
        }
        
        try {
            const result = calculator.calculate();
            
            // Emit event
            eventBus.emit(EVENTS.CALCULATOR_CALCULATED, {
                id: calculator.id,
                name: calculator.name,
                result
            });
            
            // Vibration feedback
            if (result && !result.error) {
                analytics.vibrateSuccess();
            } else if (result && result.error) {
                analytics.vibrateError();
            }
            
            return result;
        } catch (error) {
            console.error('Calculation error:', error);
            eventBus.emit(EVENTS.ERROR_OCCURRED, { 
                type: 'calculator', 
                calculator: calculatorId,
                error 
            });
            return { error: error.message };
        }
    }

    /**
     * Get calculator by ID
     */
    getCalculator(id) {
        return this.calculators.get(id);
    }

    /**
     * Get all calculators
     */
    getAllCalculators() {
        return Array.from(this.calculators.values());
    }

    /**
     * Get calculators by category
     */
    getCalculatorsByCategory(category) {
        return this.getAllCalculators().filter(calc => calc.category === category);
    }

    /**
     * Get calculator count
     */
    getCalculatorCount() {
        return this.calculators.size;
    }

    /**
     * Search calculators by keyword
     */
    searchCalculators(query) {
        const searchTerm = query.toLowerCase();
        return this.getAllCalculators().filter(calc => {
                name: 'QRISK3',
                category: TOOL_CATEGORIES.CARDIOLOGY,
                description: '10-year cardiovascular disease risk',
                keywords: ['qrisk', 'cvd', 'cardiac', 'risk', 'cardiovascular'],
                getTemplate: () => EC.getQRISK3Calculator(),
                calculate: () => EC.calculateQRISK3(),
                bindEvents: () => {}
            };
            this.registerCalculator('qrisk3', qriskConfig);
            this.registerCalculator('qrisk', qriskConfig); // Alias for HTML compatibility
        }
        
        // === RESPIRATORY CALCULATORS ===
        
        // CURB-65
        if (EC.getCURB65Calculator) {
            this.registerCalculator('curb65', {
                name: 'CURB-65',
                category: TOOL_CATEGORIES.RESPIRATORY,
                description: 'Pneumonia severity assessment',
                keywords: ['curb', 'pneumonia', 'respiratory', 'infection'],
                getTemplate: () => EC.getCURB65Calculator(),
                calculate: () => EC.calculateCURB65(),
                bindEvents: () => {}
            });
        }
        
        // PEFR
        if (EC.getPEFRCalculator) {
            this.registerCalculator('pefr', {
                name: 'Peak Flow (PEFR)',
                category: TOOL_CATEGORIES.RESPIRATORY,
                description: 'Peak expiratory flow rate calculator',
                keywords: ['pefr', 'peak', 'flow', 'asthma', 'respiratory'],
                getTemplate: () => EC.getPEFRCalculator(),
                calculate: () => EC.calculatePEFR(),
                bindEvents: () => {}
            });
        }
        
        // === NEUROLOGY CALCULATORS ===
        
        // NIHSS
        if (EC.getNIHSSCalculator) {
            this.registerCalculator('nihss', {
                name: 'NIH Stroke Scale',
                category: TOOL_CATEGORIES.NEUROLOGY,
                description: 'Stroke severity assessment',
                keywords: ['nihss', 'stroke', 'neurology', 'cva'],
                getTemplate: () => EC.getNIHSSCalculator(),
                calculate: () => EC.calculateNIHSS(),
                bindEvents: () => {}
            });
        }
        
        // ABCD2 Score
        if (EC.getABCD2Calculator) {
            this.registerCalculator('abcd2', {
                name: 'ABCDÂ² Score',
                category: TOOL_CATEGORIES.NEUROLOGY,
                description: 'TIA stroke risk stratification',
                keywords: ['abcd2', 'tia', 'stroke', 'neurology'],
                getTemplate: () => EC.getABCD2Calculator(),
                calculate: () => EC.calculateABCD2(),
                bindEvents: () => {}
            });
        }
        
        // === CRITICAL CARE CALCULATORS ===
        
        // APACHE II
        if (EC.getAPACHECalculator) {
            this.registerCalculator('apache', {
                name: 'APACHE II',
                category: TOOL_CATEGORIES.CRITICAL_CARE,
                description: 'ICU mortality prediction',
                keywords: ['apache', 'icu', 'critical', 'mortality'],
                getTemplate: () => EC.getAPACHECalculator(),
                calculate: () => EC.calculateAPACHE(),
                bindEvents: () => {}
            });
        }
        
        // SOFA Score
        if (EC.getSOFACalculator) {
            this.registerCalculator('sofa', {
                name: 'SOFA Score',
                category: TOOL_CATEGORIES.CRITICAL_CARE,
                description: 'Sequential organ failure assessment',
                keywords: ['sofa', 'sepsis', 'organ', 'failure', 'icu'],
                getTemplate: () => EC.getSOFACalculator(),
                calculate: () => EC.calculateSOFA(),
                bindEvents: () => {}
            });
        }
        
        // MEWS
        if (EC.getMEWSCalculator) {
            this.registerCalculator('mews', {
                name: 'MEWS',
                category: TOOL_CATEGORIES.CRITICAL_CARE,
                description: 'Modified Early Warning Score',
                keywords: ['mews', 'warning', 'deterioration', 'ews'],
                getTemplate: () => EC.getMEWSCalculator(),
                calculate: () => EC.calculateMEWS(),
                bindEvents: () => {}
            });
        }
        
        // NEWS Score
        if (EC.getNEWS2Calculator) {
            this.registerCalculator('news', {
                name: 'NEWS2',
                category: TOOL_CATEGORIES.CRITICAL_CARE,
                description: 'National Early Warning Score 2',
                keywords: ['news', 'warning', 'deterioration', 'ews'],
                getTemplate: () => EC.getNEWS2Calculator(),
                calculate: () => EC.calculateNEWS2(),
                bindEvents: () => {}
            });
        }
        
        // === RENAL CALCULATORS ===
        
        // eGFR
        if (EC.getEGFRCalculator) {
            this.registerCalculator('egfr', {
                name: 'eGFR Calculator',
                category: TOOL_CATEGORIES.RENAL,
                description: 'Estimated glomerular filtration rate',
                keywords: ['egfr', 'kidney', 'renal', 'creatinine', 'gfr'],
                getTemplate: () => EC.getEGFRCalculator(),
                calculate: () => EC.calculateEGFR(),
                bindEvents: () => {}
            });
        }
        
        // === HEPATIC CALCULATORS ===
        
        // MELD Score
        if (EC.getMELDCalculator) {
            this.registerCalculator('meld', {
                name: 'MELD Score',
                category: TOOL_CATEGORIES.HEPATOLOGY,
                description: 'Liver disease severity',
                keywords: ['meld', 'liver', 'cirrhosis', 'hepatic'],
                getTemplate: () => EC.getMELDCalculator(),
                calculate: () => EC.calculateMELD(),
                bindEvents: () => {}
            });
        }
        
        // Child-Pugh Score
        if (EC.getChildPughCalculator) {
            this.registerCalculator('child-pugh', {
                name: 'Child-Pugh Score',
                category: TOOL_CATEGORIES.HEPATOLOGY,
                description: 'Cirrhosis classification',
                keywords: ['child', 'pugh', 'liver', 'cirrhosis', 'hepatic'],
                getTemplate: () => EC.getChildPughCalculator(),
                calculate: () => EC.calculateChildPugh(),
                bindEvents: () => {}
            });
        }
        
        // === METABOLIC/CHEMISTRY CALCULATORS ===
        
        // Anion Gap
        if (EC.getAnionGapCalculator) {
            this.registerCalculator('anion-gap', {
                name: 'Anion Gap',
                category: TOOL_CATEGORIES.CHEMISTRY,
                description: 'Acid-base disorder assessment',
                keywords: ['anion', 'gap', 'metabolic', 'acidosis', 'chemistry'],
                getTemplate: () => EC.getAnionGapCalculator(),
                calculate: () => EC.calculateAnionGap(),
                bindEvents: () => {}
            });
        }
        
        // Corrected Calcium
        if (EC.getCorrectedCalciumCalculator) {
            this.registerCalculator('corrected-calcium', {
                name: 'Corrected Calcium',
                category: TOOL_CATEGORIES.CHEMISTRY,
                description: 'Albumin-corrected calcium',
                keywords: ['calcium', 'albumin', 'corrected', 'chemistry'],
                getTemplate: () => EC.getCorrectedCalciumCalculator(),
                calculate: () => EC.calculateCorrectedCalcium(),
                bindEvents: () => {}
            });
        }
        
        // Corrected Sodium
        if (EC.getCorrectedSodiumCalculator) {
            this.registerCalculator('corrected-sodium', {
                name: 'Corrected Sodium',
                category: TOOL_CATEGORIES.CHEMISTRY,
                description: 'Glucose-corrected sodium',
                keywords: ['sodium', 'glucose', 'corrected', 'hyponatremia', 'chemistry'],
                getTemplate: () => EC.getCorrectedSodiumCalculator(),
                calculate: () => EC.calculateCorrectedSodium(),
                bindEvents: () => {}
            });
        }
        
        // Osmolality
        if (EC.getOsmolalGapCalculator) {
            this.registerCalculator('osmolality', {
                name: 'Serum Osmolality',
                category: TOOL_CATEGORIES.CHEMISTRY,
                description: 'Serum osmolality and osmolal gap',
                keywords: ['osmolality', 'osmolal', 'gap', 'chemistry'],
                getTemplate: () => EC.getOsmolalGapCalculator(),
                calculate: () => EC.calculateOsmolalGap(),
                bindEvents: () => {}
            });
        }
        
        // === EMERGENCY MEDICINE CALCULATORS ===
        
        // Ranson Criteria
        if (EC.getRansonCalculator) {
            this.registerCalculator('ranson', {
                name: 'Ranson Criteria',
                category: TOOL_CATEGORIES.EMERGENCY,
                description: 'Acute pancreatitis severity',
                keywords: ['ranson', 'pancreatitis', 'pancreas', 'emergency'],
                getTemplate: () => EC.getRansonCalculator(),
                calculate: () => EC.calculateRanson(),
                bindEvents: () => {}
            });
        }
        
        // Centor Score
        if (EC.getCentorCalculator) {
            this.registerCalculator('centor', {
                name: 'Centor Score',
                category: TOOL_CATEGORIES.EMERGENCY,
                description: 'Strep throat probability',
                keywords: ['centor', 'strep', 'throat', 'pharyngitis', 'tonsillitis'],
                getTemplate: () => EC.getCentorCalculator(),
                calculate: () => EC.calculateCentor(),
                bindEvents: () => {}
            });
        }
        
        // Alvarado Score
        if (EC.getAlvaradoCalculator) {
            this.registerCalculator('alvarado', {
                name: 'Alvarado Score',
                category: TOOL_CATEGORIES.EMERGENCY,
                description: 'Appendicitis probability',
                keywords: ['alvarado', 'appendicitis', 'appendix', 'emergency'],
                getTemplate: () => EC.getAlvaradoCalculator(),
                calculate: () => EC.calculateAlvarado(),
                bindEvents: () => {}
            });
        }
        
        // === PSYCHIATRY CALCULATORS ===
        
        // PHQ-9
        if (EC.getPHQ9Calculator) {
            this.registerCalculator('phq9', {
                name: 'PHQ-9',
                category: TOOL_CATEGORIES.PSYCHIATRY,
                description: 'Depression severity assessment',
                keywords: ['phq', 'depression', 'mental', 'health', 'psychiatry'],
                getTemplate: () => EC.getPHQ9Calculator(),
                calculate: () => EC.calculatePHQ9(),
                bindEvents: () => {}
            });
        }
        
        // GAD-7
        if (EC.getGAD7Calculator) {
            this.registerCalculator('gad7', {
                name: 'GAD-7',
                category: TOOL_CATEGORIES.PSYCHIATRY,
                description: 'Generalized anxiety disorder assessment',
                keywords: ['gad', 'anxiety', 'mental', 'health', 'psychiatry'],
                getTemplate: () => EC.getGAD7Calculator(),
                calculate: () => EC.calculateGAD7(),
                bindEvents: () => {}
            });
        }
        
        // MSE
        if (EC.getMSECalculator) {
            this.registerCalculator('mse', {
                name: 'Mental State Examination',
                category: TOOL_CATEGORIES.PSYCHIATRY,
                description: 'Structured mental state assessment',
                keywords: ['mse', 'mental', 'state', 'psychiatry', 'cognitive'],
                getTemplate: () => EC.getMSECalculator(),
                calculate: () => EC.calculateMSE(),
                bindEvents: () => {}
            });
        }
        
        // MMSE
        if (EC.getMMSECalculator) {
            this.registerCalculator('mmse', {
                name: 'Mini-Mental State Examination',
                category: TOOL_CATEGORIES.PSYCHIATRY,
                description: 'Cognitive impairment screening',
                keywords: ['mmse', 'cognitive', 'dementia', 'mental', 'folstein'],
                getTemplate: () => EC.getMMSECalculator(),
                calculate: () => EC.calculateMMSE(),
                bindEvents: () => {}
            });
        }
        
        // === DOSING/INFUSION CALCULATORS ===
        
        // Insulin Sliding Scale
        if (EC.getInsulinSlidingCalculator) {
            this.registerCalculator('insulin-sliding', {
                name: 'Insulin Sliding Scale',
                category: TOOL_CATEGORIES.ENDOCRINE,
                description: 'Variable insulin dosing guide',
                keywords: ['insulin', 'diabetes', 'glucose', 'sliding', 'scale'],
                getTemplate: () => EC.getInsulinSlidingCalculator(),
                calculate: () => EC.calculateInsulinSliding(),
                bindEvents: () => {}
            });
        }
        
        // Vasopressor Dosing
        if (EC.getVasopressorCalculator) {
            this.registerCalculator('vasopressor', {
                name: 'Vasopressor Dosing',
                category: TOOL_CATEGORIES.CRITICAL_CARE,
                description: 'Vasopressor and inotrope dosing calculator',
                keywords: ['vasopressor', 'noradrenaline', 'adrenaline', 'dopamine', 'icu'],
                getTemplate: () => EC.getVasopressorCalculator(),
                calculate: () => EC.calculateVasopressor(),
                bindEvents: () => {}
            });
        }
        
        // Paediatric Dosing
        if (EC.getPaediatricDosingCalculator) {
            this.registerCalculator('paediatric-dosing', {
                name: 'Paediatric Drug Dosing',
                category: TOOL_CATEGORIES.PAEDIATRICS,
                description: 'Weight-based paediatric medication dosing',
                keywords: ['paediatric', 'pediatric', 'child', 'dosing', 'weight'],
                getTemplate: () => EC.getPaediatricDosingCalculator(),
                calculate: () => EC.calculatePaediatricDosing(),
                bindEvents: () => {}
            });
        }
        
        // Infusion Rate
        if (EC.getInfusionRateCalculator) {
            this.registerCalculator('infusion-rate', {
                name: 'Infusion Rate Calculator',
                category: TOOL_CATEGORIES.CRITICAL_CARE,
                description: 'IV infusion rate and drip rate calculator',
                keywords: ['infusion', 'rate', 'drip', 'iv', 'pump'],
                getTemplate: () => EC.getInfusionRateCalculator(),
                calculate: () => EC.calculateInfusionRate(),
                bindEvents: () => {}
            });
        }
        
        // Drug Volume
        if (EC.getDrugVolumeCalculator) {
            this.registerCalculator('drug-volume', {
                name: 'Drug Volume Calculator',
                category: TOOL_CATEGORIES.PHARMACY,
                description: 'Calculate volume of drug to administer',
                keywords: ['drug', 'volume', 'dose', 'concentration', 'pharmacy'],
                getTemplate: () => EC.getDrugVolumeCalculator(),
                calculate: () => EC.calculateDrugVolume(),
                bindEvents: () => {}
            });
        }
        
        // === FUNCTIONAL ASSESSMENT CALCULATORS ===
        
        // MUST Score
        if (EC.getMUSTCalculator) {
            this.registerCalculator('must', {
                name: 'MUST Score',
                category: TOOL_CATEGORIES.NUTRITION,
                description: 'Malnutrition Universal Screening Tool',
                keywords: ['must', 'malnutrition', 'nutrition', 'screening'],
                getTemplate: () => EC.getMUSTCalculator(),
                calculate: () => EC.calculateMUST(),
                bindEvents: () => {}
            });
        }
        
        // Waterlow Score
        if (EC.getWaterlowCalculator) {
            this.registerCalculator('waterlow', {
                name: 'Waterlow Score',
                category: TOOL_CATEGORIES.NURSING,
                description: 'Pressure ulcer risk assessment',
                keywords: ['waterlow', 'pressure', 'ulcer', 'sore', 'risk'],
                getTemplate: () => EC.getWaterlowCalculator(),
                calculate: () => EC.calculateWaterlow(),
                bindEvents: () => {}
            });
        }
        
        // Clinical Frailty Scale
        if (EC.getFrailtyCalculator) {
            this.registerCalculator('frailty', {
                name: 'Clinical Frailty Scale',
                category: TOOL_CATEGORIES.GERIATRICS,
                description: 'Rockwood Clinical Frailty Scale',
                keywords: ['frailty', 'rockwood', 'geriatric', 'elderly', 'functional'],
                getTemplate: () => EC.getFrailtyCalculator(),
                calculate: () => EC.calculateFrailty(),
                bindEvents: () => {}
            });
        }
        
        // Barthel Index
        if (EC.getBarthelCalculator) {
            this.registerCalculator('barthel', {
                name: 'Barthel Index',
                category: TOOL_CATEGORIES.GERIATRICS,
                description: 'Activities of daily living assessment',
                keywords: ['barthel', 'adl', 'activities', 'daily', 'living', 'functional'],
                getTemplate: () => EC.getBarthelCalculator(),
                calculate: () => EC.calculateBarthel(),
                bindEvents: () => {}
            });
        }
        
        // Modified Rankin Scale
        if (EC.getModifiedRankinCalculator) {
            this.registerCalculator('rankin', {
                name: 'Modified Rankin Scale',
                category: TOOL_CATEGORIES.NEUROLOGY,
                description: 'Degree of disability after stroke',
                keywords: ['rankin', 'stroke', 'disability', 'functional', 'outcome'],
                getTemplate: () => EC.getModifiedRankinCalculator(),
                calculate: () => EC.calculateModifiedRankin(),
                bindEvents: () => {}
            });
        }
        
        // === ADDITIONAL CARDIOVASCULAR CALCULATORS ===
        
        // TIMI Score
        if (EC.getTIMICalculator) {
            this.registerCalculator('timi', {
                name: 'TIMI Risk Score',
                category: TOOL_CATEGORIES.CARDIOLOGY,
                description: 'STEMI/NSTEMI risk stratification',
                keywords: ['timi', 'mi', 'stemi', 'nstemi', 'cardiac'],
                getTemplate: () => EC.getTIMICalculator(),
                calculate: () => EC.calculateTIMI(),
                bindEvents: () => {}
            });
        }
        
        // RCRI
        if (EC.getRCRICalculator) {
            this.registerCalculator('rcri', {
                name: 'Revised Cardiac Risk Index',
                category: TOOL_CATEGORIES.CARDIOLOGY,
                description: 'Perioperative cardiac risk',
                keywords: ['rcri', 'cardiac', 'risk', 'surgery', 'perioperative'],
                getTemplate: () => EC.getRCRICalculator(),
                calculate: () => EC.calculateRCRI(),
                bindEvents: () => {}
            });
        }
        
        // QTc Calculator
        if (EC.getQTcCalculator) {
            this.registerCalculator('qtc', {
                name: 'QTc Calculator',
                category: TOOL_CATEGORIES.CARDIOLOGY,
                description: 'Corrected QT interval calculation',
                keywords: ['qtc', 'qt', 'interval', 'ecg', 'cardiac', 'bazett'],
                getTemplate: () => EC.getQTcCalculator(),
                calculate: () => EC.calculateQTc(),
                bindEvents: () => {}
            });
        }
        
        // Wells DVT Score
        if (EC.getWellsDVTCalculator) {
            this.registerCalculator('wells-dvt', {
                name: 'Wells DVT Score',
                category: TOOL_CATEGORIES.VASCULAR,
                description: 'Deep vein thrombosis probability',
                keywords: ['wells', 'dvt', 'thrombosis', 'clot', 'vascular'],
                getTemplate: () => EC.getWellsDVTCalculator(),
                calculate: () => EC.calculateWellsDVT(),
                bindEvents: () => {}
            });
        }
        
        // === GI CALCULATORS ===
        
        // Rockall Score
        if (EC.getRockallCalculator) {
            this.registerCalculator('rockall', {
                name: 'Rockall Score',
                category: TOOL_CATEGORIES.GASTROENTEROLOGY,
                description: 'Upper GI bleeding risk assessment',
                keywords: ['rockall', 'gi', 'bleed', 'gastro', 'haematemesis'],
                getTemplate: () => EC.getRockallCalculator(),
                calculate: () => EC.calculateRockall(),
                bindEvents: () => {}
            });
        }
        
        // Glasgow-Blatchford Score
        if (EC.getGlasgowBlatchfordCalculator) {
            this.registerCalculator('glasgow-blatchford', {
                name: 'Glasgow-Blatchford Score',
                category: TOOL_CATEGORIES.GASTROENTEROLOGY,
                description: 'Upper GI bleeding need for intervention',
                keywords: ['glasgow', 'blatchford', 'gi', 'bleed', 'gastro'],
                getTemplate: () => EC.getGlasgowBlatchfordCalculator(),
                calculate: () => EC.calculateGlasgowBlatchford(),
                bindEvents: () => {}
            });
        }
        
        // === ORTHOPEDIC CALCULATORS ===
        
        // Ottawa Ankle Rules
        if (EC.getOttawaAnkleCalculator) {
            this.registerCalculator('ottawa-ankle', {
                name: 'Ottawa Ankle Rules',
                category: TOOL_CATEGORIES.ORTHOPEDICS,
                description: 'Ankle/foot injury X-ray decision rule',
                keywords: ['ottawa', 'ankle', 'foot', 'fracture', 'xray'],
                getTemplate: () => EC.getOttawaAnkleCalculator(),
                calculate: () => EC.calculateOttawaAnkle(),
                bindEvents: () => {}
            });
        }
        
        // FRAX Fracture Risk
        if (EC.getFractureRiskCalculator) {
            this.registerCalculator('frax-fracture', {
                name: 'FRAX Fracture Risk',
                category: TOOL_CATEGORIES.ORTHOPEDICS,
                description: 'Osteoporotic fracture risk assessment',
                keywords: ['frax', 'fracture', 'osteoporosis', 'bone', 'risk'],
                getTemplate: () => EC.getFractureRiskCalculator(),
                calculate: () => EC.calculateFractureRisk(),
                bindEvents: () => {}
            });
        }
        
        // === ADDITIONAL RENAL CALCULATORS ===
        
        // Cockcroft-Gault
        if (EC.getCockcroftGaultCalculator) {
            this.registerCalculator('cockcroft-gault', {
                name: 'Cockcroft-Gault',
                category: TOOL_CATEGORIES.RENAL,
                description: 'Creatinine clearance estimation',
                keywords: ['cockcroft', 'gault', 'creatinine', 'clearance', 'renal'],
                getTemplate: () => EC.getCockcroftGaultCalculator(),
                calculate: () => EC.calculateCockcroftGault(),
                bindEvents: () => {}
            });
        }
        
        // Urea:Creatinine Ratio
        if (EC.getUreaCreatinineCalculator) {
            this.registerCalculator('urea-creatinine', {
                name: 'Urea:Creatinine Ratio',
                category: TOOL_CATEGORIES.RENAL,
                description: 'BUN:Creatinine ratio for AKI classification',
                keywords: ['urea', 'creatinine', 'ratio', 'aki', 'renal'],
                getTemplate: () => EC.getUreaCreatinineCalculator(),
                calculate: () => EC.calculateUreaCreatinine(),
                bindEvents: () => {}
            });
        }
        
        // === SEDATION & PALLIATIVE CALCULATORS ===
        
        // RASS Scale
        if (EC.getRASSCalculator) {
            this.registerCalculator('rass', {
                name: 'RASS Scale',
                category: TOOL_CATEGORIES.CRITICAL_CARE,
                description: 'Richmond Agitation-Sedation Scale',
                keywords: ['rass', 'sedation', 'agitation', 'icu', 'conscious'],
                getTemplate: () => EC.getRASSCalculator(),
                calculate: () => EC.calculateRASS(),
                bindEvents: () => {}
            });
        }
        
        // Palliative Care Calculator
        if (EC.getPalliativeCalculator) {
            this.registerCalculator('palliative', {
                name: 'Palliative Care Calculator',
                category: TOOL_CATEGORIES.PALLIATIVE,
                description: 'Opioid conversion and symptom management',
                keywords: ['palliative', 'opioid', 'conversion', 'morphine', 'pain'],
                getTemplate: () => EC.getPalliativeCalculator(),
                calculate: () => EC.calculatePalliative(),
                bindEvents: () => {}
            });
        }
        
        // MADDERS Score
        if (EC.getMADDERSCalculator) {
            this.registerCalculator('madders', {
                name: 'MADDERS Score',
                category: TOOL_CATEGORIES.EMERGENCY,
                description: 'Medical assessment decision support',
                keywords: ['madders', 'assessment', 'decision', 'emergency'],
                getTemplate: () => EC.getMADDERSCalculator(),
                calculate: () => EC.calculateMADDERS(),
                bindEvents: () => {}
            });
        }
        
        // === RESPIRATORY (ADDITIONAL) ===
        
        // CRB-65
        if (EC.getCRB65Calculator) {
            this.registerCalculator('crb65', {
                name: 'CRB-65',
                category: TOOL_CATEGORIES.RESPIRATORY,
                description: 'Simplified pneumonia severity (community)',
                keywords: ['crb', 'crb65', 'pneumonia', 'respiratory'],
                getTemplate: () => EC.getCRB65Calculator(),
                calculate: () => EC.calculateCRB65(),
                bindEvents: () => {}
            });
        }
        
        // === OBSTETRICS CALCULATORS ===
        
        // APGAR Score
        if (EC.getAPGARCalculator) {
            this.registerCalculator('apgar', {
                name: 'APGAR Score',
                category: TOOL_CATEGORIES.OBSTETRICS,
                description: 'Newborn health assessment',
                keywords: ['apgar', 'newborn', 'baby', 'obstetrics', 'neonate'],
                getTemplate: () => EC.getAPGARCalculator(),
                calculate: () => EC.calculateAPGAR(),
                bindEvents: () => {}
            });
        }
        
        // Bishop Score
        if (EC.getBishopCalculator) {
            this.registerCalculator('bishop', {
                name: 'Bishop Score',
                category: TOOL_CATEGORIES.OBSTETRICS,
                description: 'Cervical readiness for induction',
                keywords: ['bishop', 'cervix', 'induction', 'labour', 'obstetrics'],
                getTemplate: () => EC.getBishopCalculator(),
                calculate: () => EC.calculateBishop(),
                bindEvents: () => {}
            });
        }
        
        // === UTILITY CALCULATORS ===
        
        // Unit Converter
        if (EC.getUnitConverterCalculator) {
            this.registerCalculator('unit-converter', {
                name: 'Clinical Unit Converter',
                category: TOOL_CATEGORIES.UTILITIES,
                description: 'Convert between clinical units',
                keywords: ['unit', 'converter', 'conversion', 'mmol', 'mg'],
                getTemplate: () => EC.getUnitConverterCalculator(),
                calculate: () => EC.calculateUnitConverter(),
                bindEvents: () => {}
            });
        }
        
        // Mean Arterial Pressure
        if (EC.getMAPCalculator) {
            this.registerCalculator('map', {
                name: 'Mean Arterial Pressure',
                category: TOOL_CATEGORIES.CARDIOLOGY,
                description: 'Calculate MAP from BP',
                keywords: ['map', 'mean', 'arterial', 'pressure', 'bp'],
                getTemplate: () => EC.getMAPCalculator(),
                calculate: () => EC.calculateMAP(),
                bindEvents: () => {}
            });
        }
        
        // A-a Gradient
        if (EC.getAAGradientCalculator) {
            this.registerCalculator('aa-gradient', {
                name: 'A-a Gradient',
                category: TOOL_CATEGORIES.RESPIRATORY,
                description: 'Alveolar-arterial oxygen gradient',
                keywords: ['aa', 'gradient', 'oxygen', 'respiratory', 'abg'],
                getTemplate: () => EC.getAAGradientCalculator(),
                calculate: () => EC.calculateAAGradient(),
                bindEvents: () => {}
            });
        }
        
        // PERC Rule
        if (EC.getPERCCalculator) {
            this.registerCalculator('perc', {
                name: 'PERC Rule',
                category: TOOL_CATEGORIES.EMERGENCY,
                description: 'Pulmonary Embolism Rule-out Criteria',
                keywords: ['perc', 'pe', 'pulmonary', 'embolism', 'rule'],
                getTemplate: () => EC.getPERCCalculator(),
                calculate: () => EC.calculatePERC(),
                bindEvents: () => {}
            });
        }
        
        // LDL Calculator
        if (EC.getLDLCalculator) {
            this.registerCalculator('ldl-calc', {
                name: 'LDL Calculator',
                category: TOOL_CATEGORIES.CARDIOLOGY,
                description: 'Friedewald LDL calculation',
                keywords: ['ldl', 'cholesterol', 'lipid', 'friedewald'],
                getTemplate: () => EC.getLDLCalculator(),
                calculate: () => EC.calculateLDL(),
                bindEvents: () => {}
            });
        }
        
        // Winters Formula
        if (EC.getWintersCalculator) {
            this.registerCalculator('winters', {
                name: 'Winters Formula',
                category: TOOL_CATEGORIES.CHEMISTRY,
                description: 'Expected PaCO2 in metabolic acidosis',
                keywords: ['winters', 'pco2', 'acidosis', 'metabolic', 'compensation'],
                getTemplate: () => EC.getWintersCalculator(),
                calculate: () => EC.calculateWinters(),
                bindEvents: () => {}
            });
        }
        
        console.log(`âœ… Bridge calculators registered: ${EC ? 'with ExtractedCalculators' : 'native only'}`);
    }

    /**
     * Register a calculator
     */
    registerCalculator(id, config) {
        const calculator = {
            id,
            name: config.name,
            category: config.category || TOOL_CATEGORIES.OTHER,
            description: config.description || '',
            keywords: config.keywords || [],
            getTemplate: config.getTemplate,
            calculate: config.calculate,
            bindEvents: config.bindEvents,
            metadata: config.metadata || {}
        };

        this.calculators.set(id, calculator);
        
        return calculator;
    }
    
    /**
     * Load calculator into detail view
     */
    loadCalculator(calculatorId) {
        const calculator = this.getCalculator(calculatorId);
        if (!calculator) {
            console.error(`Calculator not found: ${calculatorId}`);
            return false;
        }

        try {
            // Switch to calculator detail panel first
            eventBus.emit(EVENTS.UI_SWITCH_TOOL, { tool: 'calculator-detail' });
            
            // Get container
            const container = document.getElementById('calculator-detail-container');
            if (!container) {
                console.error('Calculator detail container not found');
                return false;
            }

            // Build header with back button
            const headerHtml = `
                <div class="calculator-header">
                    <button class="back-btn" id="calc-back-btn">â† Back to Calculators</button>
                    <h3>${calculator.name}</h3>
                </div>
                <div class="calculator-content">
                    ${calculator.getTemplate()}
                </div>
            `;

            container.innerHTML = headerHtml;

            // Bind back button
            const backBtn = document.getElementById('calc-back-btn');
            if (backBtn) {
                backBtn.addEventListener('click', () => {
                    eventBus.emit(EVENTS.UI_SWITCH_TOOL, { tool: 'calculators' });
                });
            }

            // Bind calculator events - pass the content container
            if (calculator.bindEvents) {
                const contentContainer = container.querySelector('.calculator-content');
                calculator.bindEvents(contentContainer || container);
            }

            // Set as current calculator
            this.currentCalculator = calculator;

            // Add to recent
            this.addToRecent(calculatorId);

            // Track usage
            analytics.trackCalculatorUse(calculator.name);

            // Emit event
            eventBus.emit(EVENTS.CALCULATOR_OPENED, { 
                id: calculatorId, 
                name: calculator.name 
            });

            // Switch to detail view
            eventBus.emit(EVENTS.UI_SWITCH_TOOL, { tool: 'calculator-detail' });

            console.log(`ðŸ§® Loaded calculator: ${calculator.name}`);
            return true;

        } catch (error) {
            console.error('Error loading calculator:', error);
            return false;
        }
    }

    /**
     * Render calculator HTML into a container
     */
    renderCalculator(calculatorId, containerId) {
        const calculator = this.getCalculator(calculatorId);
        const container = typeof containerId === 'string' 
            ? document.getElementById(containerId) 
            : containerId;
            
        if (!calculator || !container) {
            console.error('Calculator or container not found');
            return false;
        }
        
        try {
            // Render HTML using getTemplate
            const html = calculator.getTemplate();
            container.innerHTML = html;
            
            // Bind calculator events - pass the container
            if (calculator.bindEvents) {
                calculator.bindEvents(container);
            }
            
            return true;
        } catch (error) {
            console.error('Error rendering calculator:', error);
            return false;
        }
    }
    
    /**
     * Execute calculation for a calculator
     */
    executeCalculation(calculatorId) {
        const calculator = this.getCalculator(calculatorId);
        if (!calculator) {
            console.error(`Calculator not found: ${calculatorId}`);
            return null;
        }
        
        try {
            const result = calculator.calculate();
            
            // Emit event
            eventBus.emit(EVENTS.CALCULATOR_CALCULATED, {
                id: calculator.id,
                name: calculator.name,
                result
            });
            
            // Vibration feedback
            if (result && !result.error) {
                analytics.vibrateSuccess();
            } else if (result && result.error) {
                analytics.vibrateError();
            }
            
            return result;
        } catch (error) {
            console.error('Calculation error:', error);
            eventBus.emit(EVENTS.ERROR_OCCURRED, { 
                type: 'calculator', 
                calculator: calculatorId,
                error 
            });
            analytics.vibrateError();
            return null;
        }
    }

    /**
     * Unregister a calculator
     */
    unregisterCalculator(id) {
        const deleted = this.calculators.delete(id);
        if (deleted) {
            console.log(`ðŸ—‘ï¸ Unregistered calculator: ${id}`);
        }
        return deleted;
    }

    /**
     * Get calculator by ID
     */
    getCalculator(id) {
        return this.calculators.get(id);
    }

    /**
     * Get all calculators
     */
    getAllCalculators() {
        return Array.from(this.calculators.values());
    }

    /**
     * Get calculators by category
     */
    getCalculatorsByCategory(category) {
        return this.getAllCalculators().filter(calc => calc.category === category);
    }

    /**
     * Open calculator
     */
    openCalculator(id) {
        const calculator = this.getCalculator(id);
        if (!calculator) {
            console.error(`Calculator not found: ${id}`);
            return null;
        }

        this.currentCalculator = calculator;
        
        // Add to recent tools (max 10)
        this.addToRecent(id);
        
        // Track usage
        analytics.trackCalculatorUse(calculator.name);
        
        // Emit event
        eventBus.emit(EVENTS.CALCULATOR_OPENED, { id, name: calculator.name });
        
        console.log(`ðŸ“Š Opened calculator: ${calculator.name}`);
        
        return calculator;
    }

    /**
     * Calculate using current calculator
     */
    calculate(inputs) {
        if (!this.currentCalculator) {
            console.error('No calculator is currently open');
            return null;
        }

        const calculator = this.currentCalculator;
        
        try {
            // New calculators don't take inputs, they read from DOM
            const result = calculator.calculate();
            
            // Emit event
            eventBus.emit(EVENTS.CALCULATOR_CALCULATED, {
                id: calculator.id,
                name: calculator.name,
                result
            });
            
            return result;
        } catch (error) {
            console.error('Calculation error:', error);
            eventBus.emit(EVENTS.ERROR_OCCURRED, { 
                type: 'calculator', 
                calculator: calculator.id,
                error 
            });
            return null;
        }
    }

    /**
     * Add calculator to recent list
     */
    addToRecent(id) {
        // Remove if already in list
        const index = this.recentTools.indexOf(id);
        if (index > -1) {
            this.recentTools.splice(index, 1);
        }

        // Add to beginning
        this.recentTools.unshift(id);

        // Keep max 10 recent
        if (this.recentTools.length > 10) {
            this.recentTools = this.recentTools.slice(0, 10);
        }

        // Save to storage
        storage.setItem(STORAGE_KEYS.RECENT_TOOLS, this.recentTools);
    }

    /**
     * Get recent calculators
     */
    getRecentCalculators() {
        return this.recentTools
            .map(id => this.getCalculator(id))
            .filter(calc => calc !== undefined);
    }

    /**
     * Clear recent calculators
     */
    clearRecent() {
        this.recentTools = [];
        storage.removeItem(STORAGE_KEYS.RECENT_TOOLS);
        console.log('ðŸ—‘ï¸ Recent calculators cleared');
    }

    /**
     * Add note to calculator
     */
    addNote(calculatorId, note) {
        if (!this.toolNotes[calculatorId]) {
            this.toolNotes[calculatorId] = [];
        }

        this.toolNotes[calculatorId].push({
            text: note,
            timestamp: Date.now()
        });

        storage.setItem(STORAGE_KEYS.TOOL_NOTES, this.toolNotes);
        console.log(`ðŸ“ Note added to calculator: ${calculatorId}`);
    }

    /**
     * Get notes for calculator
     */
    getNotes(calculatorId) {
        return this.toolNotes[calculatorId] || [];
    }

    /**
     * Delete note
     */
    deleteNote(calculatorId, index) {
        if (this.toolNotes[calculatorId] && this.toolNotes[calculatorId][index]) {
            this.toolNotes[calculatorId].splice(index, 1);
            storage.setItem(STORAGE_KEYS.TOOL_NOTES, this.toolNotes);
            console.log(`ðŸ—‘ï¸ Note deleted from calculator: ${calculatorId}`);
            return true;
        }
        return false;
    }

    /**
     * Clear all notes for a calculator
     */
    clearNotes(calculatorId) {
        if (this.toolNotes[calculatorId]) {
            delete this.toolNotes[calculatorId];
            storage.setItem(STORAGE_KEYS.TOOL_NOTES, this.toolNotes);
            console.log(`ðŸ—‘ï¸ All notes cleared for calculator: ${calculatorId}`);
            return true;
        }
        return false;
    }

    /**
     * Search calculators
     */
    searchCalculators(query) {
        const q = query.toLowerCase();
        return this.getAllCalculators().filter(calc => {
            return calc.name.toLowerCase().includes(q) ||
                   calc.description.toLowerCase().includes(q) ||
                   calc.category.toLowerCase().includes(q);
        });
    }

    /**
     * Get calculator categories
     */
    getCategories() {
        const categories = new Set();
        this.getAllCalculators().forEach(calc => {
            categories.add(calc.category);
        });
        return Array.from(categories).sort();
    }

    /**
     * Get calculator count
     */
    getCalculatorCount() {
        return this.calculators.size;
    }

    /**
     * Get calculator count by category
     */
    getCategoryCount(category) {
        return this.getCalculatorsByCategory(category).length;
    }

    /**
     * Check if calculator exists
     */
    hasCalculator(id) {
        return this.calculators.has(id);
    }

    /**
     * Get current calculator
     */
    getCurrentCalculator() {
        return this.currentCalculator;
    }

    /**
     * Close current calculator
     */
    closeCalculator() {
        const previousCalculator = this.currentCalculator;
        this.currentCalculator = null;
        
        if (previousCalculator) {
            console.log(`ðŸ“Š Closed calculator: ${previousCalculator.name}`);
        }
        
        return previousCalculator;
    }

    /**
     * Export calculator history (for analysis)
     */
    exportHistory() {
        return {
            recent: this.recentTools,
            notes: this.toolNotes,
            exportedAt: new Date().toISOString()
        };
    }

    /**
     * Import calculator history
     */
    importHistory(data) {
        if (data.recent) {
            this.recentTools = data.recent;
            storage.setItem(STORAGE_KEYS.RECENT_TOOLS, this.recentTools);
        }
        
        if (data.notes) {
            this.toolNotes = data.notes;
            storage.setItem(STORAGE_KEYS.TOOL_NOTES, this.toolNotes);
        }
        
        console.log('ðŸ“¥ Calculator history imported');
    }

    /**
     * Get calculator statistics
     */
    getStatistics() {
        return {
            totalCalculators: this.getCalculatorCount(),
            categories: this.getCategories().length,
            recentCount: this.recentTools.length,
            notesCount: Object.keys(this.toolNotes).length,
            totalNotes: Object.values(this.toolNotes).reduce((sum, notes) => sum + notes.length, 0)
        };
    }

    /**
     * Validate inputs for calculator
     */
    validateInputs(calculatorId, inputs) {
        const calculator = this.getCalculator(calculatorId);
        if (!calculator) {
            return { valid: false, error: 'Calculator not found' };
        }

        // If calculator has custom validation
        if (calculator.metadata.validate) {
            return calculator.metadata.validate(inputs);
        }

        // Basic validation - check all required inputs exist
        if (calculator.metadata.requiredInputs) {
            for (const input of calculator.metadata.requiredInputs) {
                if (inputs[input] === undefined || inputs[input] === null || inputs[input] === '') {
                    return { valid: false, error: `Missing required input: ${input}` };
                }
            }
        }

        return { valid: true };
    }
}

// Export singleton instance
export const calculatorManager = new CalculatorManager();
