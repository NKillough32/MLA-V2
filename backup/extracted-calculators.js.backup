/**
 * Extracted Calculators from app.js
 * Generated: 2025-11-05 (Fixed)
 * Total calculators: 61
 */

const ExtractedCalculators = {

    getBMICalculator() {
        return `
            <div class="calculator-form">
                <h4>BMI & Waist Circumference Calculator</h4>
                <div class="calc-input-group">
                    <label>Weight (kg):</label>
                    <input type="number" id="bmi-weight" placeholder="70" step="0.1">
                </div>
                <div class="calc-input-group">
                    <label>Height (cm):</label>
                    <input type="number" id="bmi-height" placeholder="175" step="0.1">
                </div>
                <div class="calc-input-group">
                    <label>Waist Circumference (cm) - Optional:</label>
                    <input type="number" id="bmi-waist" placeholder="85" step="0.1">
                </div>
                <div class="calc-input-group">
                    <label>Ethnicity:</label>
                    <select id="bmi-ethnicity">
                        <option value="european">European/Caucasian</option>
                        <option value="asian">Asian (Chinese, Japanese, South Asian)</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="calc-checkbox-group">
                    <label><input type="radio" name="bmi-sex" value="male"> Male</label>
                    <label><input type="radio" name="bmi-sex" value="female"> Female</label>
                </div>
                <button onclick="window.quizApp.calculateBMI()">Calculate</button>
                <div id="bmi-result" class="calc-result"></div>
                <div class="calc-reference">
                    <small>
                        <strong>BMI Categories (WHO):</strong><br>
                        Underweight: &lt;18.5 | Normal: 18.5-24.9<br>
                        Overweight: 25-29.9 | Obese: ‚â•30<br>
                        <strong>Asian populations:</strong> Overweight ‚â•23, Obese ‚â•27.5
                    </small>
                </div>
            </div>
        `;
    }

    getFrailtyCalculator() {
        return `
            <div class="calculator-form">
                <h4>Clinical Frailty Scale (Rockwood)</h4>
                <p><small>Select the category that best matches the patient</small></p>
                <div class="calc-input-group" id="frailty-options-detail">
                    <select id="frailty-select">
                        <option value="">-- Select frailty score --</option>
                        <option value="1">1 ‚Äî Very fit</option>
                        <option value="2">2 ‚Äî Well</option>
                        <option value="3">3 ‚Äî Managing well</option>
                        <option value="4">4 ‚Äî Vulnerable</option>
                        <option value="5">5 ‚Äî Mildly frail</option>
                        <option value="6">6 ‚Äî Moderately frail</option>
                        <option value="7">7 ‚Äî Severely frail</option>
                        <option value="8">8 ‚Äî Very severely frail</option>
                        <option value="9">9 ‚Äî Terminally ill</option>
                    </select>
                </div>
                <button onclick="window.quizApp.calculateFrailty()">Calculate</button>
                <div id="frailty-detail-result" class="calc-result"></div>
                <div class="calc-reference"><small>Rockwood Clinical Frailty Scale (1‚Äì9): use as an aid to clinical judgement.</small></div>
            </div>
        `;
    }

    calculateFrailty() {
        const sel = document.getElementById('frailty-select');
        const out = document.getElementById('frailty-detail-result');
        if (!sel || !out) return;
        const val = sel.value;
        if (!val) {
            out.innerHTML = '<p class="error">Please select a frailty score</p>';
            return;
        }
        const descriptions = {
            1: 'Very fit ‚Äî robust, active, energetic and motivated. Typically exercises regularly.',
            2: 'Well ‚Äî no active disease symptoms but less fit than category 1.',
            3: 'Managing well ‚Äî medical problems are well controlled, not regularly active beyond routine activities.',
            4: 'Vulnerable ‚Äî not dependent on others for daily help, but symptoms limit activities.',
            5: 'Mildly frail ‚Äî evident slowing and need help in high order instrumental activities of daily living.',
            6: 'Moderately frail ‚Äî need help with all outside activities and with keeping house.',
            7: 'Severely frail ‚Äî completely dependent for personal care, but stable and not at high risk of dying within 6 months.',
            8: 'Very severely frail ‚Äî completely dependent, approaching the end of life. Typically approaching high risk of dying.',
            9: 'Terminally ill ‚Äî life expectancy <6 months, not otherwise evidently frail.'
        };
        const guidance = (n) => {
            const num = parseInt(n, 10);
            if (num <= 3) return 'Not frail ‚Äî encourage activity and prevention.';
            if (num === 4) return 'Pre-frail/vulnerable ‚Äî consider targeted interventions (exercise, medication review).';
            if (num >=5 && num <=6) return 'Frailty present ‚Äî consider CGA, falls review and medication optimisation.';
            return 'High dependency ‚Äî prioritise care needs, consider palliative needs assessment where appropriate.';
        };

        out.innerHTML = `
            <div>
                <strong>Score: ${val}</strong>
                <div style="margin-top:8px">${descriptions[val]}</div>
                <div style="margin-top:8px;color:#374151;font-weight:600">${guidance(val)}</div>
            </div>
        `;
    }

    getBarthelCalculator() {
        return `
            <div class="calculator-form">
                <h4>Barthel Index (ADL)</h4>
                <p><small>Complete the items and press Calculate</small></p>
                <div class="calc-input-group" id="barthel-detail-items">
                    <!-- Simplified form: items named to match common Barthel scoring -->
                    <label>Feeding: <select id="b-feeding"><option value="0">Dependent (0)</option><option value="5">Needs assistance (5)</option><option value="10">Independent (10)</option></select></label>
                    <label>Bathing: <select id="b-bathing"><option value="0">Dependent (0)</option><option value="5">Independent (5)</option></select></label>
                    <label>Grooming: <select id="b-grooming"><option value="0">Needs help (0)</option><option value="5">Independent (5)</option></select></label>
                    <label>Dressing: <select id="b-dressing"><option value="0">Dependent (0)</option><option value="5">Needs help (5)</option><option value="10">Independent (10)</option></select></label>
                    <label>Bowels: <select id="b-bowels"><option value="0">Incontinent (0)</option><option value="5">Occasional accident (5)</option><option value="10">Continent (10)</option></select></label>
                    <label>Bladder: <select id="b-bladder"><option value="0">Incontinent (0)</option><option value="5">Occasional accident (5)</option><option value="10">Continent (10)</option></select></label>
                    <label>Toilet use: <select id="b-toilet"><option value="0">Dependent (0)</option><option value="5">Needs some help (5)</option><option value="10">Independent (10)</option></select></label>
                    <label>Transfers (bed-chair): <select id="b-transfers"><option value="0">Dependent (0)</option><option value="5">Major help (5)</option><option value="10">Minor help (10)</option><option value="15">Independent (15)</option></select></label>
                    <label>Mobility (level): <select id="b-mobility"><option value="0">Dependent (0)</option><option value="5">Immobile (5)</option><option value="10">Walks with help (10)</option><option value="15">Independent (15)</option></select></label>
                    <label>Stairs: <select id="b-stairs"><option value="0">Unable (0)</option><option value="5">Needs help (5)</option><option value="10">Independent (10)</option></select></label>
                </div>
                <button onclick="window.quizApp.calculateBarthel()">Calculate</button>
                <div id="barthel-detail-result" class="calc-result"></div>
                <div class="calc-reference"><small>Score 0-100. Higher scores indicate greater independence.</small></div>
            </div>
        `;
    }

    calculateBarthel() {
        const ids = ['b-feeding','b-bathing','b-grooming','b-dressing','b-bowels','b-bladder','b-toilet','b-transfers','b-mobility','b-stairs'];
        let total = 0;
        ids.forEach(id => {
            const el = document.getElementById(id);
            if (el) total += parseInt(el.value, 10) || 0;
        });
        let interpretation = 'Total dependency';
        if (total === 100) interpretation = 'Independent';
        else if (total >= 91) interpretation = 'Slight dependency';
        else if (total >= 61) interpretation = 'Moderate dependency';
        else if (total >= 21) interpretation = 'Severe dependency';
        document.getElementById('barthel-detail-result').innerHTML = `
            <div>
                <strong>Barthel Total: ${total} / 100</strong>
                <div style="margin-top:8px">Interpretation: ${interpretation}</div>
            </div>
        `;
    }

    calculateBMI() {
        const weight = parseFloat(document.getElementById('bmi-weight').value);
        const height = parseFloat(document.getElementById('bmi-height').value) / 100; // Convert cm to m
        const waist = parseFloat(document.getElementById('bmi-waist').value);
        const ethnicity = document.getElementById('bmi-ethnicity').value;
        const sex = document.querySelector('input[name="bmi-sex"]:checked')?.value;
        
        if (!weight || !height) {
            document.getElementById('bmi-result').innerHTML = '<p class="error">Please enter valid weight and height</p>';
            return;
        }
        
        const bmi = weight / (height * height);
        let category = '';
        let color = '';
        let healthRisk = '';
        
        // Ethnic-specific BMI thresholds
        let overweightThreshold = 25;
        let obeseThreshold = 30;
        
        if (ethnicity === 'asian') {
            overweightThreshold = 23;


// ========================================
// Alvarado (lines 5127-5527)
// ========================================
                calculatorContent += this.getRCRICalculator();
                break;
        }
        calculatorContent = calculatorContent.replace('<h3 id="calculator-title"></h3>', `<h3 id="calculator-title">${calculatorTitle}</h3>`);
        container.innerHTML = calculatorContent;
        // Attach export buttons to results and per-calculator notes area
        try {
            // Ensure export features are available across calc-result blocks
            if (typeof this.setupExportFeatures === 'function') {
                this.setupExportFeatures();
            }
            // Add notes area for this calculator (persisted via localStorage)
            if (typeof this.setupCalculatorNotes === 'function') {
                this.setupCalculatorNotes(calcType);
            }
        } catch (err) {
            console.warn('‚ö†Ô∏è Failed to setup export/features or notes for calculator:', err);
        }
        console.log('üßÆ Loaded calculator:', calcType);
    }
    getBMICalculator() {
        return `
            <div class="calculator-form">
                <h4>BMI & Waist Circumference Calculator</h4>
                <div class="calc-input-group">
                    <label>Weight (kg):</label>
                    <input type="number" id="bmi-weight" placeholder="70" step="0.1">
                </div>
                <div class="calc-input-group">
                    <label>Height (cm):</label>
                    <input type="number" id="bmi-height" placeholder="175" step="0.1">
                </div>
                <div class="calc-input-group">
                    <label>Waist Circumference (cm) - Optional:</label>
                    <input type="number" id="bmi-waist" placeholder="85" step="0.1">
                </div>
                <div class="calc-input-group">
                    <label>Ethnicity:</label>
                    <select id="bmi-ethnicity">
                        <option value="european">European/Caucasian</option>
                        <option value="asian">Asian (Chinese, Japanese, South Asian)</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="calc-checkbox-group">
                    <label><input type="radio" name="bmi-sex" value="male"> Male</label>
                    <label><input type="radio" name="bmi-sex" value="female"> Female</label>
                </div>
                <button onclick="window.quizApp.calculateBMI()">Calculate</button>
                <div id="bmi-result" class="calc-result"></div>
                <div class="calc-reference">
                    <small>
                        <strong>BMI Categories (WHO):</strong><br>
                        Underweight: &lt;18.5 | Normal: 18.5-24.9<br>
                        Overweight: 25-29.9 | Obese: ‚â•30<br>
                        <strong>Asian populations:</strong> Overweight ‚â•23, Obese ‚â•27.5
                    </small>
                </div>
            </div>
        `;
    }

    getFrailtyCalculator() {
        return `
            <div class="calculator-form">
                <h4>Clinical Frailty Scale (Rockwood)</h4>
                <p><small>Select the category that best matches the patient</small></p>
                <div class="calc-input-group" id="frailty-options-detail">
                    <select id="frailty-select">
                        <option value="">-- Select frailty score --</option>
                        <option value="1">1 ‚Äî Very fit</option>
                        <option value="2">2 ‚Äî Well</option>
                        <option value="3">3 ‚Äî Managing well</option>
                        <option value="4">4 ‚Äî Vulnerable</option>
                        <option value="5">5 ‚Äî Mildly frail</option>
                        <option value="6">6 ‚Äî Moderately frail</option>
                        <option value="7">7 ‚Äî Severely frail</option>
                        <option value="8">8 ‚Äî Very severely frail</option>
                        <option value="9">9 ‚Äî Terminally ill</option>
                    </select>
                </div>
                <button onclick="window.quizApp.calculateFrailty()">Calculate</button>
                <div id="frailty-detail-result" class="calc-result"></div>
                <div class="calc-reference"><small>Rockwood Clinical Frailty Scale (1‚Äì9): use as an aid to clinical judgement.</small></div>
            </div>
        `;
    }

    calculateFrailty() {
        const sel = document.getElementById('frailty-select');
        const out = document.getElementById('frailty-detail-result');
        if (!sel || !out) return;
        const val = sel.value;
        if (!val) {
            out.innerHTML = '<p class="error">Please select a frailty score</p>';
            return;
        }
        const descriptions = {
            1: 'Very fit ‚Äî robust, active, energetic and motivated. Typically exercises regularly.',
            2: 'Well ‚Äî no active disease symptoms but less fit than category 1.',
            3: 'Managing well ‚Äî medical problems are well controlled, not regularly active beyond routine activities.',
            4: 'Vulnerable ‚Äî not dependent on others for daily help, but symptoms limit activities.',
            5: 'Mildly frail ‚Äî evident slowing and need help in high order instrumental activities of daily living.',
            6: 'Moderately frail ‚Äî need help with all outside activities and with keeping house.',
            7: 'Severely frail ‚Äî completely dependent for personal care, but stable and not at high risk of dying within 6 months.',
            8: 'Very severely frail ‚Äî completely dependent, approaching the end of life. Typically approaching high risk of dying.',
            9: 'Terminally ill ‚Äî life expectancy <6 months, not otherwise evidently frail.'
        };
        const guidance = (n) => {
            const num = parseInt(n, 10);
            if (num <= 3) return 'Not frail ‚Äî encourage activity and prevention.';
            if (num === 4) return 'Pre-frail/vulnerable ‚Äî consider targeted interventions (exercise, medication review).';
            if (num >=5 && num <=6) return 'Frailty present ‚Äî consider CGA, falls review and medication optimisation.';
            return 'High dependency ‚Äî prioritise care needs, consider palliative needs assessment where appropriate.';
        };

        out.innerHTML = `
            <div>
                <strong>Score: ${val}</strong>
                <div style="margin-top:8px">${descriptions[val]}</div>
                <div style="margin-top:8px;color:#374151;font-weight:600">${guidance(val)}</div>
            </div>
        `;
    }

    getBarthelCalculator() {
        return `
            <div class="calculator-form">
                <h4>Barthel Index (ADL)</h4>
                <p><small>Complete the items and press Calculate</small></p>
                <div class="calc-input-group" id="barthel-detail-items">
                    <!-- Simplified form: items named to match common Barthel scoring -->
                    <label>Feeding: <select id="b-feeding"><option value="0">Dependent (0)</option><option value="5">Needs assistance (5)</option><option value="10">Independent (10)</option></select></label>
                    <label>Bathing: <select id="b-bathing"><option value="0">Dependent (0)</option><option value="5">Independent (5)</option></select></label>
                    <label>Grooming: <select id="b-grooming"><option value="0">Needs help (0)</option><option value="5">Independent (5)</option></select></label>
                    <label>Dressing: <select id="b-dressing"><option value="0">Dependent (0)</option><option value="5">Needs help (5)</option><option value="10">Independent (10)</option></select></label>
                    <label>Bowels: <select id="b-bowels"><option value="0">Incontinent (0)</option><option value="5">Occasional accident (5)</option><option value="10">Continent (10)</option></select></label>
                    <label>Bladder: <select id="b-bladder"><option value="0">Incontinent (0)</option><option value="5">Occasional accident (5)</option><option value="10">Continent (10)</option></select></label>
                    <label>Toilet use: <select id="b-toilet"><option value="0">Dependent (0)</option><option value="5">Needs some help (5)</option><option value="10">Independent (10)</option></select></label>
                    <label>Transfers (bed-chair): <select id="b-transfers"><option value="0">Dependent (0)</option><option value="5">Major help (5)</option><option value="10">Minor help (10)</option><option value="15">Independent (15)</option></select></label>
                    <label>Mobility (level): <select id="b-mobility"><option value="0">Dependent (0)</option><option value="5">Immobile (5)</option><option value="10">Walks with help (10)</option><option value="15">Independent (15)</option></select></label>
                    <label>Stairs: <select id="b-stairs"><option value="0">Unable (0)</option><option value="5">Needs help (5)</option><option value="10">Independent (10)</option></select></label>
                </div>
                <button onclick="window.quizApp.calculateBarthel()">Calculate</button>
                <div id="barthel-detail-result" class="calc-result"></div>
                <div class="calc-reference"><small>Score 0-100. Higher scores indicate greater independence.</small></div>
            </div>
        `;
    }

    calculateBarthel() {
        const ids = ['b-feeding','b-bathing','b-grooming','b-dressing','b-bowels','b-bladder','b-toilet','b-transfers','b-mobility','b-stairs'];
        let total = 0;
        ids.forEach(id => {
            const el = document.getElementById(id);
            if (el) total += parseInt(el.value, 10) || 0;
        });
        let interpretation = 'Total dependency';
        if (total === 100) interpretation = 'Independent';
        else if (total >= 91) interpretation = 'Slight dependency';
        else if (total >= 61) interpretation = 'Moderate dependency';
        else if (total >= 21) interpretation = 'Severe dependency';
        document.getElementById('barthel-detail-result').innerHTML = `
            <div>
                <strong>Barthel Total: ${total} / 100</strong>
                <div style="margin-top:8px">Interpretation: ${interpretation}</div>
            </div>
        `;
    }

    calculateBMI() {
        const weight = parseFloat(document.getElementById('bmi-weight').value);
        const height = parseFloat(document.getElementById('bmi-height').value) / 100; // Convert cm to m
        const waist = parseFloat(document.getElementById('bmi-waist').value);
        const ethnicity = document.getElementById('bmi-ethnicity').value;
        const sex = document.querySelector('input[name="bmi-sex"]:checked')?.value;
        
        if (!weight || !height) {
            document.getElementById('bmi-result').innerHTML = '<p class="error">Please enter valid weight and height</p>';
            return;
        }
        
        const bmi = weight / (height * height);
        let category = '';
        let color = '';
        let healthRisk = '';
        
        // Ethnic-specific BMI thresholds
        let overweightThreshold = 25;
        let obeseThreshold = 30;
        
        if (ethnicity === 'asian') {
            overweightThreshold = 23;
            obeseThreshold = 27.5;
        }
        
        if (bmi < 18.5) {
            category = 'Underweight';
            color = '#2196F3';
            healthRisk = 'Increased risk: nutritional deficiency, osteoporosis, immune dysfunction';
        } else if (bmi < overweightThreshold) {
            category = 'Normal weight';
            color = '#4CAF50';
            healthRisk = 'Optimal health risk profile';
        } else if (bmi < obeseThreshold) {
            category = 'Overweight';
            color = '#FF9800';
            healthRisk = 'Increased risk: diabetes, cardiovascular disease, sleep apnoea';
        } else if (bmi < 35) {
            category = 'Obese Class I';
            color = '#F44336';
            healthRisk = 'High risk: diabetes, CVD, stroke, certain cancers';
        } else if (bmi < 40) {
            category = 'Obese Class II';
            color = '#D32F2F';
            healthRisk = 'Very high risk: consider bariatric surgery consultation';
        } else {
            category = 'Obese Class III';
            color = '#B71C1C';
            healthRisk = 'Extremely high risk: urgent weight management, consider bariatric surgery';
        }
        
        // Waist circumference assessment
        let waistAssessment = '';
        if (waist && sex) {
            let waistRisk = '';
            let waistColor = '#4CAF50';
            
            if (sex === 'male') {
                if (waist >= 102) {
                    waistRisk = 'Very high risk';
                    waistColor = '#F44336';
                } else if (waist >= 94) {
                    waistRisk = 'Increased risk';
                    waistColor = '#FF9800';
                } else {
                    waistRisk = 'Low risk';
                }
            } else {
                if (waist >= 88) {
                    waistRisk = 'Very high risk';
                    waistColor = '#F44336';
                } else if (waist >= 80) {
                    waistRisk = 'Increased risk';
                    waistColor = '#FF9800';
                } else {
                    waistRisk = 'Low risk';
                }
            }
            
            waistAssessment = `
                <div style="margin-top: 8px; padding: 6px; background: #f5f5f5; border-radius: 4px;">
                    <strong>Waist Circumference:</strong> ${waist} cm<br>
                    <span style="color: ${waistColor}; font-weight: bold;">${waistRisk}</span> for metabolic complications
                </div>
            `;
        }
        
        document.getElementById('bmi-result').innerHTML = `
            <div class="bmi-result-display">
                <div class="bmi-value" style="color: ${color}; font-size: 1.2em;">
                    <strong>BMI: ${bmi.toFixed(1)} kg/m¬≤</strong>
                </div>
                <div class="bmi-category" style="color: ${color}; font-weight: bold; margin: 4px 0;">
                    ${category}
                </div>
                <div style="margin-top: 8px; font-size: 0.9em; color: #666;">
                    ${healthRisk}
                </div>
                ${waistAssessment}
                <div style="margin-top: 8px; font-size: 0.8em; color: #666;">
                    ${ethnicity === 'asian' ? 'Using Asian-specific BMI thresholds' : 'Using WHO BMI thresholds'}
                </div>
            </div>
        `;
    }

    getCHADS2VAScCalculator() {
        return `
            <div class="calculator-form">
                <h4>CHA‚ÇÇDS‚ÇÇ-VASc Score</h4>
                <p><small>Stroke risk assessment in atrial fibrillation</small></p>
                
                <div class="calc-checkbox-group">
                    <label><input type="checkbox" id="chads-chf"> Congestive heart failure (+1)</label>
                    <label><input type="checkbox" id="chads-htn"> Hypertension (+1)</label>
                    <label><input type="checkbox" id="chads-age75"> Age ‚â•75 years (+2)</label>
                    <label><input type="checkbox" id="chads-diabetes"> Diabetes mellitus (+1)</label>
                    <label><input type="checkbox" id="chads-stroke"> Stroke/TIA/thromboembolism (+2)</label>
                    <label><input type="checkbox" id="chads-vascular"> Vascular disease (+1)</label>
                    <label><input type="checkbox" id="chads-age65"> Age 65-74 years (+1)</label>
                    <label><input type="checkbox" id="chads-female"> Female sex (+1)</label>
                </div>
                
                <button onclick="window.quizApp.calculateCHADS2VASc()">Calculate Score</button>
                <div id="chads-result" class="calc-result"></div>
            </div>
        `;
    }

    calculateCHADS2VASc() {
        let score = 0;
        
        if (document.getElementById('chads-chf').checked) score += 1;
        if (document.getElementById('chads-htn').checked) score += 1;
        if (document.getElementById('chads-age75').checked) score += 2;
        if (document.getElementById('chads-diabetes').checked) score += 1;
        if (document.getElementById('chads-stroke').checked) score += 2;
        if (document.getElementById('chads-vascular').checked) score += 1;
        if (document.getElementById('chads-age65').checked) score += 1;
        
        const isFemale = document.getElementById('chads-female').checked;
        if (isFemale) score += 1;
        
        let risk = '';
        let recommendation = '';
        let color = '';
        
        // Updated UK guidelines: sex-specific treatment recommendations
        if (score === 0) {
            risk = 'Low risk (0.2%/year)';
            recommendation = 'No anticoagulation recommended';
            color = '#4CAF50';
        } else if (score === 1) {
            if (isFemale && score === 1) {
                // Female with score 1 (sex alone) - special case
                risk = 'Low-moderate risk (0.6%/year)';
                recommendation = 'Female sex alone: generally no anticoagulation. Consider other risk factors';
                color = '#FF9800';
            } else {
                // Male with score 1 or female with other risk factors
                risk = 'Low-moderate risk (0.6%/year)';
                recommendation = 'Consider anticoagulation (men ‚â•1 or women ‚â•2 with non-sex risk factors)';
                color = '#FF9800';
            }
        } else {


// ========================================
// AnionGap (lines 5095-5495)
// ========================================
                calculatorContent += this.getTIMICalculator();
                break;
        }
        calculatorContent = calculatorContent.replace('<h3 id="calculator-title"></h3>', `<h3 id="calculator-title">${calculatorTitle}</h3>`);
        container.innerHTML = calculatorContent;
        // Attach export buttons to results and per-calculator notes area
        try {
            // Ensure export features are available across calc-result blocks
            if (typeof this.setupExportFeatures === 'function') {
                this.setupExportFeatures();
            }
            // Add notes area for this calculator (persisted via localStorage)
            if (typeof this.setupCalculatorNotes === 'function') {
                this.setupCalculatorNotes(calcType);
            }
        } catch (err) {
            console.warn('‚ö†Ô∏è Failed to setup export/features or notes for calculator:', err);
        }
        console.log('üßÆ Loaded calculator:', calcType);
    }
    getBMICalculator() {
        return `
            <div class="calculator-form">
                <h4>BMI & Waist Circumference Calculator</h4>
                <div class="calc-input-group">
                    <label>Weight (kg):</label>
                    <input type="number" id="bmi-weight" placeholder="70" step="0.1">
                </div>
                <div class="calc-input-group">
                    <label>Height (cm):</label>
                    <input type="number" id="bmi-height" placeholder="175" step="0.1">
                </div>
                <div class="calc-input-group">
                    <label>Waist Circumference (cm) - Optional:</label>
                    <input type="number" id="bmi-waist" placeholder="85" step="0.1">
                </div>
                <div class="calc-input-group">
                    <label>Ethnicity:</label>
                    <select id="bmi-ethnicity">
                        <option value="european">European/Caucasian</option>
                        <option value="asian">Asian (Chinese, Japanese, South Asian)</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="calc-checkbox-group">
                    <label><input type="radio" name="bmi-sex" value="male"> Male</label>
                    <label><input type="radio" name="bmi-sex" value="female"> Female</label>
                </div>
                <button onclick="window.quizApp.calculateBMI()">Calculate</button>
                <div id="bmi-result" class="calc-result"></div>
                <div class="calc-reference">
                    <small>
                        <strong>BMI Categories (WHO):</strong><br>
                        Underweight: &lt;18.5 | Normal: 18.5-24.9<br>
                        Overweight: 25-29.9 | Obese: ‚â•30<br>
                        <strong>Asian populations:</strong> Overweight ‚â•23, Obese ‚â•27.5
                    </small>
                </div>
            </div>
        `;
    }

    getFrailtyCalculator() {
        return `
            <div class="calculator-form">
                <h4>Clinical Frailty Scale (Rockwood)</h4>
                <p><small>Select the category that best matches the patient</small></p>
                <div class="calc-input-group" id="frailty-options-detail">
                    <select id="frailty-select">
                        <option value="">-- Select frailty score --</option>
                        <option value="1">1 ‚Äî Very fit</option>
                        <option value="2">2 ‚Äî Well</option>
                        <option value="3">3 ‚Äî Managing well</option>
                        <option value="4">4 ‚Äî Vulnerable</option>
                        <option value="5">5 ‚Äî Mildly frail</option>
                        <option value="6">6 ‚Äî Moderately frail</option>
                        <option value="7">7 ‚Äî Severely frail</option>
                        <option value="8">8 ‚Äî Very severely frail</option>
                        <option value="9">9 ‚Äî Terminally ill</option>
                    </select>
                </div>
                <button onclick="window.quizApp.calculateFrailty()">Calculate</button>
                <div id="frailty-detail-result" class="calc-result"></div>
                <div class="calc-reference"><small>Rockwood Clinical Frailty Scale (1‚Äì9): use as an aid to clinical judgement.</small></div>
            </div>
        `;
    }

    calculateFrailty() {
        const sel = document.getElementById('frailty-select');
        const out = document.getElementById('frailty-detail-result');
        if (!sel || !out) return;
        const val = sel.value;
        if (!val) {
            out.innerHTML = '<p class="error">Please select a frailty score</p>';
            return;
        }
        const descriptions = {
            1: 'Very fit ‚Äî robust, active, energetic and motivated. Typically exercises regularly.',
            2: 'Well ‚Äî no active disease symptoms but less fit than category 1.',
            3: 'Managing well ‚Äî medical problems are well controlled, not regularly active beyond routine activities.',
            4: 'Vulnerable ‚Äî not dependent on others for daily help, but symptoms limit activities.',
            5: 'Mildly frail ‚Äî evident slowing and need help in high order instrumental activities of daily living.',
            6: 'Moderately frail ‚Äî need help with all outside activities and with keeping house.',
            7: 'Severely frail ‚Äî completely dependent for personal care, but stable and not at high risk of dying within 6 months.',
            8: 'Very severely frail ‚Äî completely dependent, approaching the end of life. Typically approaching high risk of dying.',
            9: 'Terminally ill ‚Äî life expectancy <6 months, not otherwise evidently frail.'
        };
        const guidance = (n) => {
            const num = parseInt(n, 10);
            if (num <= 3) return 'Not frail ‚Äî encourage activity and prevention.';
            if (num === 4) return 'Pre-frail/vulnerable ‚Äî consider targeted interventions (exercise, medication review).';
            if (num >=5 && num <=6) return 'Frailty present ‚Äî consider CGA, falls review and medication optimisation.';
            return 'High dependency ‚Äî prioritise care needs, consider palliative needs assessment where appropriate.';
        };

        out.innerHTML = `
            <div>
                <strong>Score: ${val}</strong>
                <div style="margin-top:8px">${descriptions[val]}</div>
                <div style="margin-top:8px;color:#374151;font-weight:600">${guidance(val)}</div>
            </div>
        `;
    }

    getBarthelCalculator() {
        return `
            <div class="calculator-form">
                <h4>Barthel Index (ADL)</h4>
                <p><small>Complete the items and press Calculate</small></p>
                <div class="calc-input-group" id="barthel-detail-items">
                    <!-- Simplified form: items named to match common Barthel scoring -->
                    <label>Feeding: <select id="b-feeding"><option value="0">Dependent (0)</option><option value="5">Needs assistance (5)</option><option value="10">Independent (10)</option></select></label>
                    <label>Bathing: <select id="b-bathing"><option value="0">Dependent (0)</option><option value="5">Independent (5)</option></select></label>
                    <label>Grooming: <select id="b-grooming"><option value="0">Needs help (0)</option><option value="5">Independent (5)</option></select></label>
                    <label>Dressing: <select id="b-dressing"><option value="0">Dependent (0)</option><option value="5">Needs help (5)</option><option value="10">Independent (10)</option></select></label>
                    <label>Bowels: <select id="b-bowels"><option value="0">Incontinent (0)</option><option value="5">Occasional accident (5)</option><option value="10">Continent (10)</option></select></label>
                    <label>Bladder: <select id="b-bladder"><option value="0">Incontinent (0)</option><option value="5">Occasional accident (5)</option><option value="10">Continent (10)</option></select></label>
                    <label>Toilet use: <select id="b-toilet"><option value="0">Dependent (0)</option><option value="5">Needs some help (5)</option><option value="10">Independent (10)</option></select></label>
                    <label>Transfers (bed-chair): <select id="b-transfers"><option value="0">Dependent (0)</option><option value="5">Major help (5)</option><option value="10">Minor help (10)</option><option value="15">Independent (15)</option></select></label>
                    <label>Mobility (level): <select id="b-mobility"><option value="0">Dependent (0)</option><option value="5">Immobile (5)</option><option value="10">Walks with help (10)</option><option value="15">Independent (15)</option></select></label>
                    <label>Stairs: <select id="b-stairs"><option value="0">Unable (0)</option><option value="5">Needs help (5)</option><option value="10">Independent (10)</option></select></label>
                </div>
                <button onclick="window.quizApp.calculateBarthel()">Calculate</button>
                <div id="barthel-detail-result" class="calc-result"></div>
                <div class="calc-reference"><small>Score 0-100. Higher scores indicate greater independence.</small></div>
            </div>
        `;
    }

    calculateBarthel() {
        const ids = ['b-feeding','b-bathing','b-grooming','b-dressing','b-bowels','b-bladder','b-toilet','b-transfers','b-mobility','b-stairs'];
        let total = 0;
        ids.forEach(id => {
            const el = document.getElementById(id);
            if (el) total += parseInt(el.value, 10) || 0;
        });
        let interpretation = 'Total dependency';
        if (total === 100) interpretation = 'Independent';
        else if (total >= 91) interpretation = 'Slight dependency';
        else if (total >= 61) interpretation = 'Moderate dependency';
        else if (total >= 21) interpretation = 'Severe dependency';
        document.getElementById('barthel-detail-result').innerHTML = `
            <div>
                <strong>Barthel Total: ${total} / 100</strong>
                <div style="margin-top:8px">Interpretation: ${interpretation}</div>
            </div>
        `;
    }

    calculateBMI() {
        const weight = parseFloat(document.getElementById('bmi-weight').value);
        const height = parseFloat(document.getElementById('bmi-height').value) / 100; // Convert cm to m
        const waist = parseFloat(document.getElementById('bmi-waist').value);
        const ethnicity = document.getElementById('bmi-ethnicity').value;
        const sex = document.querySelector('input[name="bmi-sex"]:checked')?.value;
        
        if (!weight || !height) {
            document.getElementById('bmi-result').innerHTML = '<p class="error">Please enter valid weight and height</p>';
            return;
        }
        
        const bmi = weight / (height * height);
        let category = '';
        let color = '';
        let healthRisk = '';
        
        // Ethnic-specific BMI thresholds
        let overweightThreshold = 25;
        let obeseThreshold = 30;
        
        if (ethnicity === 'asian') {
            overweightThreshold = 23;
            obeseThreshold = 27.5;
        }
        
        if (bmi < 18.5) {
            category = 'Underweight';
            color = '#2196F3';
            healthRisk = 'Increased risk: nutritional deficiency, osteoporosis, immune dysfunction';
        } else if (bmi < overweightThreshold) {
            category = 'Normal weight';
            color = '#4CAF50';
            healthRisk = 'Optimal health risk profile';
        } else if (bmi < obeseThreshold) {
            category = 'Overweight';
            color = '#FF9800';
            healthRisk = 'Increased risk: diabetes, cardiovascular disease, sleep apnoea';
        } else if (bmi < 35) {
            category = 'Obese Class I';
            color = '#F44336';
            healthRisk = 'High risk: diabetes, CVD, stroke, certain cancers';
        } else if (bmi < 40) {
            category = 'Obese Class II';
            color = '#D32F2F';
            healthRisk = 'Very high risk: consider bariatric surgery consultation';
        } else {
            category = 'Obese Class III';
            color = '#B71C1C';
            healthRisk = 'Extremely high risk: urgent weight management, consider bariatric surgery';
        }
        
        // Waist circumference assessment
        let waistAssessment = '';
        if (waist && sex) {
            let waistRisk = '';
            let waistColor = '#4CAF50';
            
            if (sex === 'male') {
                if (waist >= 102) {
                    waistRisk = 'Very high risk';
                    waistColor = '#F44336';
                } else if (waist >= 94) {
                    waistRisk = 'Increased risk';
                    waistColor = '#FF9800';
                } else {
                    waistRisk = 'Low risk';
                }
            } else {
                if (waist >= 88) {
                    waistRisk = 'Very high risk';
                    waistColor = '#F44336';
                } else if (waist >= 80) {
                    waistRisk = 'Increased risk';
                    waistColor = '#FF9800';
                } else {
                    waistRisk = 'Low risk';
                }
            }
            
            waistAssessment = `
                <div style="margin-top: 8px; padding: 6px; background: #f5f5f5; border-radius: 4px;">
                    <strong>Waist Circumference:</strong> ${waist} cm<br>
                    <span style="color: ${waistColor}; font-weight: bold;">${waistRisk}</span> for metabolic complications
                </div>
            `;
        }
        
        document.getElementById('bmi-result').innerHTML = `
            <div class="bmi-result-display">
                <div class="bmi-value" style="color: ${color}; font-size: 1.2em;">
                    <strong>BMI: ${bmi.toFixed(1)} kg/m¬≤</strong>
                </div>
                <div class="bmi-category" style="color: ${color}; font-weight: bold; margin: 4px 0;">
                    ${category}
                </div>
                <div style="margin-top: 8px; font-size: 0.9em; color: #666;">
                    ${healthRisk}
                </div>
                ${waistAssessment}
                <div style="margin-top: 8px; font-size: 0.8em; color: #666;">
                    ${ethnicity === 'asian' ? 'Using Asian-specific BMI thresholds' : 'Using WHO BMI thresholds'}
                </div>
            </div>
        `;
    }

    getCHADS2VAScCalculator() {
        return `
            <div class="calculator-form">
                <h4>CHA‚ÇÇDS‚ÇÇ-VASc Score</h4>
                <p><small>Stroke risk assessment in atrial fibrillation</small></p>
                
                <div class="calc-checkbox-group">
                    <label><input type="checkbox" id="chads-chf"> Congestive heart failure (+1)</label>
                    <label><input type="checkbox" id="chads-htn"> Hypertension (+1)</label>
                    <label><input type="checkbox" id="chads-age75"> Age ‚â•75 years (+2)</label>
                    <label><input type="checkbox" id="chads-diabetes"> Diabetes mellitus (+1)</label>
                    <label><input type="checkbox" id="chads-stroke"> Stroke/TIA/thromboembolism (+2)</label>
                    <label><input type="checkbox" id="chads-vascular"> Vascular disease (+1)</label>
                    <label><input type="checkbox" id="chads-age65"> Age 65-74 years (+1)</label>
                    <label><input type="checkbox" id="chads-female"> Female sex (+1)</label>
                </div>
                
                <button onclick="window.quizApp.calculateCHADS2VASc()">Calculate Score</button>
                <div id="chads-result" class="calc-result"></div>
            </div>
        `;
    }

    calculateCHADS2VASc() {
        let score = 0;
        
        if (document.getElementById('chads-chf').checked) score += 1;


// ========================================
// APACHE (lines 4939-5339)
// ========================================
        
        switch (calcType) {
        }
        calculatorContent = calculatorContent.replace('<h3 id="calculator-title"></h3>', `<h3 id="calculator-title">${calculatorTitle}</h3>`);
        container.innerHTML = calculatorContent;
        // Attach export buttons to results and per-calculator notes area
        try {
            // Ensure export features are available across calc-result blocks
            if (typeof this.setupExportFeatures === 'function') {
                this.setupExportFeatures();
            }
            // Add notes area for this calculator (persisted via localStorage)
            if (typeof this.setupCalculatorNotes === 'function') {
                this.setupCalculatorNotes(calcType);
            }
        } catch (err) {
            console.warn('‚ö†Ô∏è Failed to setup export/features or notes for calculator:', err);
        }
        console.log('üßÆ Loaded calculator:', calcType);
    }
    getBMICalculator() {
        return `
            <div class="calculator-form">
                <h4>BMI & Waist Circumference Calculator</h4>
                <div class="calc-input-group">
                    <label>Weight (kg):</label>
                    <input type="number" id="bmi-weight" placeholder="70" step="0.1">
                </div>
                <div class="calc-input-group">
                    <label>Height (cm):</label>
                    <input type="number" id="bmi-height" placeholder="175" step="0.1">
                </div>
                <div class="calc-input-group">
                    <label>Waist Circumference (cm) - Optional:</label>
                    <input type="number" id="bmi-waist" placeholder="85" step="0.1">
                </div>
                <div class="calc-input-group">
                    <label>Ethnicity:</label>
                    <select id="bmi-ethnicity">
                        <option value="european">European/Caucasian</option>
                        <option value="asian">Asian (Chinese, Japanese, South Asian)</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="calc-checkbox-group">
                    <label><input type="radio" name="bmi-sex" value="male"> Male</label>
                    <label><input type="radio" name="bmi-sex" value="female"> Female</label>
                </div>
                <button onclick="window.quizApp.calculateBMI()">Calculate</button>
                <div id="bmi-result" class="calc-result"></div>
                <div class="calc-reference">
                    <small>
                        <strong>BMI Categories (WHO):</strong><br>
                        Underweight: &lt;18.5 | Normal: 18.5-24.9<br>
                        Overweight: 25-29.9 | Obese: ‚â•30<br>
                        <strong>Asian populations:</strong> Overweight ‚â•23, Obese ‚â•27.5
                    </small>
                </div>
            </div>
        `;
    }

    getFrailtyCalculator() {
        return `
            <div class="calculator-form">
                <h4>Clinical Frailty Scale (Rockwood)</h4>
                <p><small>Select the category that best matches the patient</small></p>
                <div class="calc-input-group" id="frailty-options-detail">
                    <select id="frailty-select">
                        <option value="">-- Select frailty score --</option>
                        <option value="1">1 ‚Äî Very fit</option>
                        <option value="2">2 ‚Äî Well</option>
                        <option value="3">3 ‚Äî Managing well</option>
                        <option value="4">4 ‚Äî Vulnerable</option>
                        <option value="5">5 ‚Äî Mildly frail</option>
                        <option value="6">6 ‚Äî Moderately frail</option>
                        <option value="7">7 ‚Äî Severely frail</option>
                        <option value="8">8 ‚Äî Very severely frail</option>
                        <option value="9">9 ‚Äî Terminally ill</option>
                    </select>
                </div>
                <button onclick="window.quizApp.calculateFrailty()">Calculate</button>
                <div id="frailty-detail-result" class="calc-result"></div>
                <div class="calc-reference"><small>Rockwood Clinical Frailty Scale (1‚Äì9): use as an aid to clinical judgement.</small></div>
            </div>
        `;
    }

    calculateFrailty() {
        const sel = document.getElementById('frailty-select');
        const out = document.getElementById('frailty-detail-result');
        if (!sel || !out) return;
        const val = sel.value;
        if (!val) {
            out.innerHTML = '<p class="error">Please select a frailty score</p>';
            return;
        }
        const descriptions = {
            1: 'Very fit ‚Äî robust, active, energetic and motivated. Typically exercises regularly.',
            2: 'Well ‚Äî no active disease symptoms but less fit than category 1.',
            3: 'Managing well ‚Äî medical problems are well controlled, not regularly active beyond routine activities.',
            4: 'Vulnerable ‚Äî not dependent on others for daily help, but symptoms limit activities.',
            5: 'Mildly frail ‚Äî evident slowing and need help in high order instrumental activities of daily living.',
            6: 'Moderately frail ‚Äî need help with all outside activities and with keeping house.',
            7: 'Severely frail ‚Äî completely dependent for personal care, but stable and not at high risk of dying within 6 months.',
            8: 'Very severely frail ‚Äî completely dependent, approaching the end of life. Typically approaching high risk of dying.',
            9: 'Terminally ill ‚Äî life expectancy <6 months, not otherwise evidently frail.'
        };
        const guidance = (n) => {
            const num = parseInt(n, 10);
            if (num <= 3) return 'Not frail ‚Äî encourage activity and prevention.';
            if (num === 4) return 'Pre-frail/vulnerable ‚Äî consider targeted interventions (exercise, medication review).';
            if (num >=5 && num <=6) return 'Frailty present ‚Äî consider CGA, falls review and medication optimisation.';
            return 'High dependency ‚Äî prioritise care needs, consider palliative needs assessment where appropriate.';
        };

        out.innerHTML = `
            <div>
                <strong>Score: ${val}</strong>
                <div style="margin-top:8px">${descriptions[val]}</div>
                <div style="margin-top:8px;color:#374151;font-weight:600">${guidance(val)}</div>
            </div>
        `;
    }

    getBarthelCalculator() {
        return `
            <div class="calculator-form">
                <h4>Barthel Index (ADL)</h4>
                <p><small>Complete the items and press Calculate</small></p>
                <div class="calc-input-group" id="barthel-detail-items">
                    <!-- Simplified form: items named to match common Barthel scoring -->
                    <label>Feeding: <select id="b-feeding"><option value="0">Dependent (0)</option><option value="5">Needs assistance (5)</option><option value="10">Independent (10)</option></select></label>
                    <label>Bathing: <select id="b-bathing"><option value="0">Dependent (0)</option><option value="5">Independent (5)</option></select></label>
                    <label>Grooming: <select id="b-grooming"><option value="0">Needs help (0)</option><option value="5">Independent (5)</option></select></label>
                    <label>Dressing: <select id="b-dressing"><option value="0">Dependent (0)</option><option value="5">Needs help (5)</option><option value="10">Independent (10)</option></select></label>
                    <label>Bowels: <select id="b-bowels"><option value="0">Incontinent (0)</option><option value="5">Occasional accident (5)</option><option value="10">Continent (10)</option></select></label>
                    <label>Bladder: <select id="b-bladder"><option value="0">Incontinent (0)</option><option value="5">Occasional accident (5)</option><option value="10">Continent (10)</option></select></label>
                    <label>Toilet use: <select id="b-toilet"><option value="0">Dependent (0)</option><option value="5">Needs some help (5)</option><option value="10">Independent (10)</option></select></label>
                    <label>Transfers (bed-chair): <select id="b-transfers"><option value="0">Dependent (0)</option><option value="5">Major help (5)</option><option value="10">Minor help (10)</option><option value="15">Independent (15)</option></select></label>
                    <label>Mobility (level): <select id="b-mobility"><option value="0">Dependent (0)</option><option value="5">Immobile (5)</option><option value="10">Walks with help (10)</option><option value="15">Independent (15)</option></select></label>
                    <label>Stairs: <select id="b-stairs"><option value="0">Unable (0)</option><option value="5">Needs help (5)</option><option value="10">Independent (10)</option></select></label>
                </div>
                <button onclick="window.quizApp.calculateBarthel()">Calculate</button>
                <div id="barthel-detail-result" class="calc-result"></div>
                <div class="calc-reference"><small>Score 0-100. Higher scores indicate greater independence.</small></div>
            </div>
        `;


// ========================================
// AsthmaCalculator (lines 5163-5563)
// ========================================
                calculatorContent += this.getMAPCalculator();
                break;
        }
        calculatorContent = calculatorContent.replace('<h3 id="calculator-title"></h3>', `<h3 id="calculator-title">${calculatorTitle}</h3>`);
        container.innerHTML = calculatorContent;
        // Attach export buttons to results and per-calculator notes area
        try {
            // Ensure export features are available across calc-result blocks
            if (typeof this.setupExportFeatures === 'function') {
                this.setupExportFeatures();
            }
            // Add notes area for this calculator (persisted via localStorage)
            if (typeof this.setupCalculatorNotes === 'function') {
                this.setupCalculatorNotes(calcType);
            }
        } catch (err) {
            console.warn('‚ö†Ô∏è Failed to setup export/features or notes for calculator:', err);
        }
        console.log('üßÆ Loaded calculator:', calcType);
    }
    getBMICalculator() {
        return `
            <div class="calculator-form">
                <h4>BMI & Waist Circumference Calculator</h4>
                <div class="calc-input-group">
                    <label>Weight (kg):</label>
                    <input type="number" id="bmi-weight" placeholder="70" step="0.1">
                </div>
                <div class="calc-input-group">
                    <label>Height (cm):</label>
                    <input type="number" id="bmi-height" placeholder="175" step="0.1">
                </div>
                <div class="calc-input-group">
                    <label>Waist Circumference (cm) - Optional:</label>
                    <input type="number" id="bmi-waist" placeholder="85" step="0.1">
                </div>
                <div class="calc-input-group">
                    <label>Ethnicity:</label>
                    <select id="bmi-ethnicity">
                        <option value="european">European/Caucasian</option>
                        <option value="asian">Asian (Chinese, Japanese, South Asian)</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="calc-checkbox-group">
                    <label><input type="radio" name="bmi-sex" value="male"> Male</label>
                    <label><input type="radio" name="bmi-sex" value="female"> Female</label>
                </div>
                <button onclick="window.quizApp.calculateBMI()">Calculate</button>
                <div id="bmi-result" class="calc-result"></div>
                <div class="calc-reference">
                    <small>
                        <strong>BMI Categories (WHO):</strong><br>
                        Underweight: &lt;18.5 | Normal: 18.5-24.9<br>
                        Overweight: 25-29.9 | Obese: ‚â•30<br>
                        <strong>Asian populations:</strong> Overweight ‚â•23, Obese ‚â•27.5
                    </small>
                </div>
            </div>
        `;
    }

    getFrailtyCalculator() {
        return `
            <div class="calculator-form">
                <h4>Clinical Frailty Scale (Rockwood)</h4>
                <p><small>Select the category that best matches the patient</small></p>
                <div class="calc-input-group" id="frailty-options-detail">
                    <select id="frailty-select">
                        <option value="">-- Select frailty score --</option>
                        <option value="1">1 ‚Äî Very fit</option>
                        <option value="2">2 ‚Äî Well</option>
                        <option value="3">3 ‚Äî Managing well</option>
                        <option value="4">4 ‚Äî Vulnerable</option>
                        <option value="5">5 ‚Äî Mildly frail</option>
                        <option value="6">6 ‚Äî Moderately frail</option>
                        <option value="7">7 ‚Äî Severely frail</option>
                        <option value="8">8 ‚Äî Very severely frail</option>
                        <option value="9">9 ‚Äî Terminally ill</option>
                    </select>
                </div>
                <button onclick="window.quizApp.calculateFrailty()">Calculate</button>
                <div id="frailty-detail-result" class="calc-result"></div>
                <div class="calc-reference"><small>Rockwood Clinical Frailty Scale (1‚Äì9): use as an aid to clinical judgement.</small></div>
            </div>
        `;
    }

    calculateFrailty() {
        const sel = document.getElementById('frailty-select');
        const out = document.getElementById('frailty-detail-result');
        if (!sel || !out) return;
        const val = sel.value;
        if (!val) {
            out.innerHTML = '<p class="error">Please select a frailty score</p>';
            return;
        }
        const descriptions = {
            1: 'Very fit ‚Äî robust, active, energetic and motivated. Typically exercises regularly.',
            2: 'Well ‚Äî no active disease symptoms but less fit than category 1.',
            3: 'Managing well ‚Äî medical problems are well controlled, not regularly active beyond routine activities.',
            4: 'Vulnerable ‚Äî not dependent on others for daily help, but symptoms limit activities.',
            5: 'Mildly frail ‚Äî evident slowing and need help in high order instrumental activities of daily living.',
            6: 'Moderately frail ‚Äî need help with all outside activities and with keeping house.',
            7: 'Severely frail ‚Äî completely dependent for personal care, but stable and not at high risk of dying within 6 months.',
            8: 'Very severely frail ‚Äî completely dependent, approaching the end of life. Typically approaching high risk of dying.',
            9: 'Terminally ill ‚Äî life expectancy <6 months, not otherwise evidently frail.'
        };
        const guidance = (n) => {
            const num = parseInt(n, 10);
            if (num <= 3) return 'Not frail ‚Äî encourage activity and prevention.';
            if (num === 4) return 'Pre-frail/vulnerable ‚Äî consider targeted interventions (exercise, medication review).';
            if (num >=5 && num <=6) return 'Frailty present ‚Äî consider CGA, falls review and medication optimisation.';
            return 'High dependency ‚Äî prioritise care needs, consider palliative needs assessment where appropriate.';
        };

        out.innerHTML = `
            <div>
                <strong>Score: ${val}</strong>
                <div style="margin-top:8px">${descriptions[val]}</div>
                <div style="margin-top:8px;color:#374151;font-weight:600">${guidance(val)}</div>
            </div>
        `;
    }

    getBarthelCalculator() {
        return `
            <div class="calculator-form">
                <h4>Barthel Index (ADL)</h4>
                <p><small>Complete the items and press Calculate</small></p>
                <div class="calc-input-group" id="barthel-detail-items">
                    <!-- Simplified form: items named to match common Barthel scoring -->
                    <label>Feeding: <select id="b-feeding"><option value="0">Dependent (0)</option><option value="5">Needs assistance (5)</option><option value="10">Independent (10)</option></select></label>
                    <label>Bathing: <select id="b-bathing"><option value="0">Dependent (0)</option><option value="5">Independent (5)</option></select></label>
                    <label>Grooming: <select id="b-grooming"><option value="0">Needs help (0)</option><option value="5">Independent (5)</option></select></label>
                    <label>Dressing: <select id="b-dressing"><option value="0">Dependent (0)</option><option value="5">Needs help (5)</option><option value="10">Independent (10)</option></select></label>
                    <label>Bowels: <select id="b-bowels"><option value="0">Incontinent (0)</option><option value="5">Occasional accident (5)</option><option value="10">Continent (10)</option></select></label>
                    <label>Bladder: <select id="b-bladder"><option value="0">Incontinent (0)</option><option value="5">Occasional accident (5)</option><option value="10">Continent (10)</option></select></label>
                    <label>Toilet use: <select id="b-toilet"><option value="0">Dependent (0)</option><option value="5">Needs some help (5)</option><option value="10">Independent (10)</option></select></label>
                    <label>Transfers (bed-chair): <select id="b-transfers"><option value="0">Dependent (0)</option><option value="5">Major help (5)</option><option value="10">Minor help (10)</option><option value="15">Independent (15)</option></select></label>
                    <label>Mobility (level): <select id="b-mobility"><option value="0">Dependent (0)</option><option value="5">Immobile (5)</option><option value="10">Walks with help (10)</option><option value="15">Independent (15)</option></select></label>
                    <label>Stairs: <select id="b-stairs"><option value="0">Unable (0)</option><option value="5">Needs help (5)</option><option value="10">Independent (10)</option></select></label>
                </div>
                <button onclick="window.quizApp.calculateBarthel()">Calculate</button>
                <div id="barthel-detail-result" class="calc-result"></div>
                <div class="calc-reference"><small>Score 0-100. Higher scores indicate greater independence.</small></div>
            </div>
        `;
    }

    calculateBarthel() {
        const ids = ['b-feeding','b-bathing','b-grooming','b-dressing','b-bowels','b-bladder','b-toilet','b-transfers','b-mobility','b-stairs'];
        let total = 0;
        ids.forEach(id => {
            const el = document.getElementById(id);
            if (el) total += parseInt(el.value, 10) || 0;
        });
        let interpretation = 'Total dependency';
        if (total === 100) interpretation = 'Independent';
        else if (total >= 91) interpretation = 'Slight dependency';
        else if (total >= 61) interpretation = 'Moderate dependency';
        else if (total >= 21) interpretation = 'Severe dependency';
        document.getElementById('barthel-detail-result').innerHTML = `
            <div>
                <strong>Barthel Total: ${total} / 100</strong>
                <div style="margin-top:8px">Interpretation: ${interpretation}</div>
            </div>
        `;
    }

    calculateBMI() {
        const weight = parseFloat(document.getElementById('bmi-weight').value);
        const height = parseFloat(document.getElementById('bmi-height').value) / 100; // Convert cm to m
        const waist = parseFloat(document.getElementById('bmi-waist').value);
        const ethnicity = document.getElementById('bmi-ethnicity').value;
        const sex = document.querySelector('input[name="bmi-sex"]:checked')?.value;
        
        if (!weight || !height) {
            document.getElementById('bmi-result').innerHTML = '<p class="error">Please enter valid weight and height</p>';
            return;
        }
        
        const bmi = weight / (height * height);
        let category = '';
        let color = '';
        let healthRisk = '';
        
        // Ethnic-specific BMI thresholds
        let overweightThreshold = 25;
        let obeseThreshold = 30;
        
        if (ethnicity === 'asian') {
            overweightThreshold = 23;
            obeseThreshold = 27.5;
        }
        
        if (bmi < 18.5) {
            category = 'Underweight';
            color = '#2196F3';
            healthRisk = 'Increased risk: nutritional deficiency, osteoporosis, immune dysfunction';
        } else if (bmi < overweightThreshold) {
            category = 'Normal weight';
            color = '#4CAF50';
            healthRisk = 'Optimal health risk profile';
        } else if (bmi < obeseThreshold) {
            category = 'Overweight';
            color = '#FF9800';
            healthRisk = 'Increased risk: diabetes, cardiovascular disease, sleep apnoea';
        } else if (bmi < 35) {
            category = 'Obese Class I';
            color = '#F44336';
            healthRisk = 'High risk: diabetes, CVD, stroke, certain cancers';
        } else if (bmi < 40) {
            category = 'Obese Class II';
            color = '#D32F2F';
            healthRisk = 'Very high risk: consider bariatric surgery consultation';
        } else {
            category = 'Obese Class III';
            color = '#B71C1C';
            healthRisk = 'Extremely high risk: urgent weight management, consider bariatric surgery';
        }
        
        // Waist circumference assessment
        let waistAssessment = '';
        if (waist && sex) {
            let waistRisk = '';
            let waistColor = '#4CAF50';
            
            if (sex === 'male') {
                if (waist >= 102) {
                    waistRisk = 'Very high risk';
                    waistColor = '#F44336';
                } else if (waist >= 94) {
                    waistRisk = 'Increased risk';
                    waistColor = '#FF9800';
                } else {
                    waistRisk = 'Low risk';
                }
            } else {
                if (waist >= 88) {
                    waistRisk = 'Very high risk';
                    waistColor = '#F44336';
                } else if (waist >= 80) {
                    waistRisk = 'Increased risk';
                    waistColor = '#FF9800';
                } else {
                    waistRisk = 'Low risk';
                }
            }
            
            waistAssessment = `
                <div style="margin-top: 8px; padding: 6px; background: #f5f5f5; border-radius: 4px;">
                    <strong>Waist Circumference:</strong> ${waist} cm<br>
                    <span style="color: ${waistColor}; font-weight: bold;">${waistRisk}</span> for metabolic complications
                </div>
            `;
        }
        
        document.getElementById('bmi-result').innerHTML = `
            <div class="bmi-result-display">
                <div class="bmi-value" style="color: ${color}; font-size: 1.2em;">
                    <strong>BMI: ${bmi.toFixed(1)} kg/m¬≤</strong>
                </div>
                <div class="bmi-category" style="color: ${color}; font-weight: bold; margin: 4px 0;">
                    ${category}
                </div>
                <div style="margin-top: 8px; font-size: 0.9em; color: #666;">
                    ${healthRisk}
                </div>
                ${waistAssessment}
                <div style="margin-top: 8px; font-size: 0.8em; color: #666;">
                    ${ethnicity === 'asian' ? 'Using Asian-specific BMI thresholds' : 'Using WHO BMI thresholds'}
                </div>
            </div>
        `;
    }

    getCHADS2VAScCalculator() {
        return `
            <div class="calculator-form">
                <h4>CHA‚ÇÇDS‚ÇÇ-VASc Score</h4>
                <p><small>Stroke risk assessment in atrial fibrillation</small></p>
                
                <div class="calc-checkbox-group">
                    <label><input type="checkbox" id="chads-chf"> Congestive heart failure (+1)</label>
                    <label><input type="checkbox" id="chads-htn"> Hypertension (+1)</label>
                    <label><input type="checkbox" id="chads-age75"> Age ‚â•75 years (+2)</label>
                    <label><input type="checkbox" id="chads-diabetes"> Diabetes mellitus (+1)</label>
                    <label><input type="checkbox" id="chads-stroke"> Stroke/TIA/thromboembolism (+2)</label>
                    <label><input type="checkbox" id="chads-vascular"> Vascular disease (+1)</label>
                    <label><input type="checkbox" id="chads-age65"> Age 65-74 years (+1)</label>
                    <label><input type="checkbox" id="chads-female"> Female sex (+1)</label>
                </div>
                
                <button onclick="window.quizApp.calculateCHADS2VASc()">Calculate Score</button>
                <div id="chads-result" class="calc-result"></div>
            </div>
        `;
    }

    calculateCHADS2VASc() {
        let score = 0;
        
        if (document.getElementById('chads-chf').checked) score += 1;
        if (document.getElementById('chads-htn').checked) score += 1;
        if (document.getElementById('chads-age75').checked) score += 2;
        if (document.getElementById('chads-diabetes').checked) score += 1;
        if (document.getElementById('chads-stroke').checked) score += 2;
        if (document.getElementById('chads-vascular').checked) score += 1;
        if (document.getElementById('chads-age65').checked) score += 1;
        
        const isFemale = document.getElementById('chads-female').checked;
        if (isFemale) score += 1;
        
        let risk = '';
        let recommendation = '';
        let color = '';
        
        // Updated UK guidelines: sex-specific treatment recommendations
        if (score === 0) {
            risk = 'Low risk (0.2%/year)';
            recommendation = 'No anticoagulation recommended';
            color = '#4CAF50';
        } else if (score === 1) {
            if (isFemale && score === 1) {
                // Female with score 1 (sex alone) - special case
                risk = 'Low-moderate risk (0.6%/year)';
                recommendation = 'Female sex alone: generally no anticoagulation. Consider other risk factors';
                color = '#FF9800';
            } else {
                // Male with score 1 or female with other risk factors
                risk = 'Low-moderate risk (0.6%/year)';
                recommendation = 'Consider anticoagulation (men ‚â•1 or women ‚â•2 with non-sex risk factors)';
                color = '#FF9800';
            }
        } else {
            // Score ‚â•2
            risk = 'High risk (‚â•2.2%/year)';
            recommendation = 'Anticoagulation recommended unless contraindicated';
            color = '#F44336';
        }
        
        document.getElementById('chads-result').innerHTML = `
            <div class="score-result">
                <div class="score-value" style="color: ${color}">
                    Score: <strong>${score}</strong>
                </div>
                <div class="score-risk">${risk}</div>
                <div class="score-recommendation" style="color: ${color}">
                    <strong>${recommendation}</strong>
                </div>
                <div style="margin-top: 8px; font-size: 0.8em; color: #666;">
                    Based on current UK guidelines. Consider individual bleeding risk (HAS-BLED).
                </div>
            </div>
        `;
    }

    getHASBLEDCalculator() {
        return `
            <div class="calculator-form">
                <h4>HAS-BLED Score</h4>
                <p><small>Bleeding risk assessment in atrial fibrillation</small></p>
                
                <div class="calc-checkbox-group">
                    <label><input type="checkbox" id="hasbled-htn"> Hypertension (+1)</label>
                    <label><input type="checkbox" id="hasbled-renal"> Abnormal renal function (+1)</label>
                    <label><input type="checkbox" id="hasbled-liver"> Abnormal liver function (+1)</label>
                    <label><input type="checkbox" id="hasbled-stroke"> Stroke history (+1)</label>
                    <label><input type="checkbox" id="hasbled-bleeding"> Prior bleeding/predisposition (+1)</label>
                    <label><input type="checkbox" id="hasbled-labile"> Labile INR (+1)</label>
                    <label><input type="checkbox" id="hasbled-elderly"> Elderly (>65 years) (+1)</label>


// ========================================
// BMI (lines 4923-5323)
// ========================================
        // Switch to dedicated calculator panel
        this.switchMedicalTool('calculator-detail');
        
        const container = document.getElementById('calculator-detail-container');
        if (!container) return;
        
        // Add back button and structured content
        let calculatorContent = `
            <div class="calculator-header">
                <button class="back-btn" onclick="window.quizApp.switchMedicalTool('calculators'); event.stopPropagation();">‚Üê Back to Calculators</button>
                <h3 id="calculator-title"></h3>
            </div>
            <div class="calculator-content">
        `;
        
        let calculatorTitle = '';
        
        switch (calcType) {
        }
        calculatorContent = calculatorContent.replace('<h3 id="calculator-title"></h3>', `<h3 id="calculator-title">${calculatorTitle}</h3>`);
        container.innerHTML = calculatorContent;
        // Attach export buttons to results and per-calculator notes area
        try {
            // Ensure export features are available across calc-result blocks
            if (typeof this.setupExportFeatures === 'function') {
                this.setupExportFeatures();
            }
            // Add notes area for this calculator (persisted via localStorage)
            if (typeof this.setupCalculatorNotes === 'function') {
                this.setupCalculatorNotes(calcType);
            }
        } catch (err) {
            console.warn('‚ö†Ô∏è Failed to setup export/features or notes for calculator:', err);
        }
        console.log('üßÆ Loaded calculator:', calcType);
    }
    getBMICalculator() {
        return `
            <div class="calculator-form">
                <h4>BMI & Waist Circumference Calculator</h4>
                <div class="calc-input-group">
                    <label>Weight (kg):</label>
                    <input type="number" id="bmi-weight" placeholder="70" step="0.1">
                </div>
                <div class="calc-input-group">
                    <label>Height (cm):</label>
                    <input type="number" id="bmi-height" placeholder="175" step="0.1">
                </div>
                <div class="calc-input-group">
                    <label>Waist Circumference (cm) - Optional:</label>
                    <input type="number" id="bmi-waist" placeholder="85" step="0.1">
                </div>
                <div class="calc-input-group">
                    <label>Ethnicity:</label>
                    <select id="bmi-ethnicity">
                        <option value="european">European/Caucasian</option>
                        <option value="asian">Asian (Chinese, Japanese, South Asian)</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="calc-checkbox-group">
                    <label><input type="radio" name="bmi-sex" value="male"> Male</label>
                    <label><input type="radio" name="bmi-sex" value="female"> Female</label>
                </div>
                <button onclick="window.quizApp.calculateBMI()">Calculate</button>
                <div id="bmi-result" class="calc-result"></div>
                <div class="calc-reference">
                    <small>
                        <strong>BMI Categories (WHO):</strong><br>
                        Underweight: &lt;18.5 | Normal: 18.5-24.9<br>
                        Overweight: 25-29.9 | Obese: ‚â•30<br>
                        <strong>Asian populations:</strong> Overweight ‚â•23, Obese ‚â•27.5
                    </small>
                </div>
            </div>
        `;
    }

    getFrailtyCalculator() {
        return `
            <div class="calculator-form">
                <h4>Clinical Frailty Scale (Rockwood)</h4>
                <p><small>Select the category that best matches the patient</small></p>
                <div class="calc-input-group" id="frailty-options-detail">
                    <select id="frailty-select">
                        <option value="">-- Select frailty score --</option>
                        <option value="1">1 ‚Äî Very fit</option>
                        <option value="2">2 ‚Äî Well</option>
                        <option value="3">3 ‚Äî Managing well</option>
                        <option value="4">4 ‚Äî Vulnerable</option>
                        <option value="5">5 ‚Äî Mildly frail</option>
                        <option value="6">6 ‚Äî Moderately frail</option>
                        <option value="7">7 ‚Äî Severely frail</option>
                        <option value="8">8 ‚Äî Very severely frail</option>
                        <option value="9">9 ‚Äî Terminally ill</option>
                    </select>
                </div>
                <button onclick="window.quizApp.calculateFrailty()">Calculate</button>
                <div id="frailty-detail-result" class="calc-result"></div>
                <div class="calc-reference"><small>Rockwood Clinical Frailty Scale (1‚Äì9): use as an aid to clinical judgement.</small></div>
            </div>
        `;
    }

    calculateFrailty() {
        const sel = document.getElementById('frailty-select');
        const out = document.getElementById('frailty-detail-result');
        if (!sel || !out) return;
        const val = sel.value;
        if (!val) {
            out.innerHTML = '<p class="error">Please select a frailty score</p>';
            return;
        }
        const descriptions = {
            1: 'Very fit ‚Äî robust, active, energetic and motivated. Typically exercises regularly.',
            2: 'Well ‚Äî no active disease symptoms but less fit than category 1.',
            3: 'Managing well ‚Äî medical problems are well controlled, not regularly active beyond routine activities.',
            4: 'Vulnerable ‚Äî not dependent on others for daily help, but symptoms limit activities.',
            5: 'Mildly frail ‚Äî evident slowing and need help in high order instrumental activities of daily living.',
            6: 'Moderately frail ‚Äî need help with all outside activities and with keeping house.',
            7: 'Severely frail ‚Äî completely dependent for personal care, but stable and not at high risk of dying within 6 months.',
            8: 'Very severely frail ‚Äî completely dependent, approaching the end of life. Typically approaching high risk of dying.',
            9: 'Terminally ill ‚Äî life expectancy <6 months, not otherwise evidently frail.'
        };
        const guidance = (n) => {
            const num = parseInt(n, 10);
            if (num <= 3) return 'Not frail ‚Äî encourage activity and prevention.';
            if (num === 4) return 'Pre-frail/vulnerable ‚Äî consider targeted interventions (exercise, medication review).';
            if (num >=5 && num <=6) return 'Frailty present ‚Äî consider CGA, falls review and medication optimisation.';
            return 'High dependency ‚Äî prioritise care needs, consider palliative needs assessment where appropriate.';
        };

        out.innerHTML = `
            <div>
                <strong>Score: ${val}</strong>
                <div style="margin-top:8px">${descriptions[val]}</div>
                <div style="margin-top:8px;color:#374151;font-weight:600">${guidance(val)}</div>
            </div>
        `;
    }

    getBarthelCalculator() {
        return `
            <div class="calculator-form">
                <h4>Barthel Index (ADL)</h4>
                <p><small>Complete the items and press Calculate</small></p>
                <div class="calc-input-group" id="barthel-detail-items">
                    <!-- Simplified form: items named to match common Barthel scoring -->


// ========================================
// BSA (lines 5067-5467)
// ========================================
                calculatorContent += this.getPaediatricDosingCalculator();
                break;
        }
        calculatorContent = calculatorContent.replace('<h3 id="calculator-title"></h3>', `<h3 id="calculator-title">${calculatorTitle}</h3>`);
        container.innerHTML = calculatorContent;
        // Attach export buttons to results and per-calculator notes area
        try {
            // Ensure export features are available across calc-result blocks
            if (typeof this.setupExportFeatures === 'function') {
                this.setupExportFeatures();
            }
            // Add notes area for this calculator (persisted via localStorage)
            if (typeof this.setupCalculatorNotes === 'function') {
                this.setupCalculatorNotes(calcType);
            }
        } catch (err) {
            console.warn('‚ö†Ô∏è Failed to setup export/features or notes for calculator:', err);
        }
        console.log('üßÆ Loaded calculator:', calcType);
    }
    getBMICalculator() {
        return `
            <div class="calculator-form">
                <h4>BMI & Waist Circumference Calculator</h4>
                <div class="calc-input-group">
                    <label>Weight (kg):</label>
                    <input type="number" id="bmi-weight" placeholder="70" step="0.1">
                </div>
                <div class="calc-input-group">
                    <label>Height (cm):</label>
                    <input type="number" id="bmi-height" placeholder="175" step="0.1">
                </div>
                <div class="calc-input-group">
                    <label>Waist Circumference (cm) - Optional:</label>
                    <input type="number" id="bmi-waist" placeholder="85" step="0.1">
                </div>
                <div class="calc-input-group">
                    <label>Ethnicity:</label>
                    <select id="bmi-ethnicity">
                        <option value="european">European/Caucasian</option>
                        <option value="asian">Asian (Chinese, Japanese, South Asian)</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="calc-checkbox-group">
                    <label><input type="radio" name="bmi-sex" value="male"> Male</label>
                    <label><input type="radio" name="bmi-sex" value="female"> Female</label>
                </div>
                <button onclick="window.quizApp.calculateBMI()">Calculate</button>
                <div id="bmi-result" class="calc-result"></div>
                <div class="calc-reference">
                    <small>
                        <strong>BMI Categories (WHO):</strong><br>
                        Underweight: &lt;18.5 | Normal: 18.5-24.9<br>
                        Overweight: 25-29.9 | Obese: ‚â•30<br>
                        <strong>Asian populations:</strong> Overweight ‚â•23, Obese ‚â•27.5
                    </small>
                </div>
            </div>
        `;
    }

    getFrailtyCalculator() {
        return `
            <div class="calculator-form">
                <h4>Clinical Frailty Scale (Rockwood)</h4>
                <p><small>Select the category that best matches the patient</small></p>
                <div class="calc-input-group" id="frailty-options-detail">
                    <select id="frailty-select">
                        <option value="">-- Select frailty score --</option>
                        <option value="1">1 ‚Äî Very fit</option>
                        <option value="2">2 ‚Äî Well</option>
                        <option value="3">3 ‚Äî Managing well</option>
                        <option value="4">4 ‚Äî Vulnerable</option>
                        <option value="5">5 ‚Äî Mildly frail</option>
                        <option value="6">6 ‚Äî Moderately frail</option>
                        <option value="7">7 ‚Äî Severely frail</option>
                        <option value="8">8 ‚Äî Very severely frail</option>
                        <option value="9">9 ‚Äî Terminally ill</option>
                    </select>
                </div>
                <button onclick="window.quizApp.calculateFrailty()">Calculate</button>
                <div id="frailty-detail-result" class="calc-result"></div>
                <div class="calc-reference"><small>Rockwood Clinical Frailty Scale (1‚Äì9): use as an aid to clinical judgement.</small></div>
            </div>
        `;
    }

    calculateFrailty() {
        const sel = document.getElementById('frailty-select');
        const out = document.getElementById('frailty-detail-result');
        if (!sel || !out) return;
        const val = sel.value;
        if (!val) {
            out.innerHTML = '<p class="error">Please select a frailty score</p>';
            return;
        }
        const descriptions = {
            1: 'Very fit ‚Äî robust, active, energetic and motivated. Typically exercises regularly.',
            2: 'Well ‚Äî no active disease symptoms but less fit than category 1.',
            3: 'Managing well ‚Äî medical problems are well controlled, not regularly active beyond routine activities.',
            4: 'Vulnerable ‚Äî not dependent on others for daily help, but symptoms limit activities.',
            5: 'Mildly frail ‚Äî evident slowing and need help in high order instrumental activities of daily living.',
            6: 'Moderately frail ‚Äî need help with all outside activities and with keeping house.',
            7: 'Severely frail ‚Äî completely dependent for personal care, but stable and not at high risk of dying within 6 months.',
            8: 'Very severely frail ‚Äî completely dependent, approaching the end of life. Typically approaching high risk of dying.',
            9: 'Terminally ill ‚Äî life expectancy <6 months, not otherwise evidently frail.'
        };
        const guidance = (n) => {
            const num = parseInt(n, 10);
            if (num <= 3) return 'Not frail ‚Äî encourage activity and prevention.';
            if (num === 4) return 'Pre-frail/vulnerable ‚Äî consider targeted interventions (exercise, medication review).';
            if (num >=5 && num <=6) return 'Frailty present ‚Äî consider CGA, falls review and medication optimisation.';
            return 'High dependency ‚Äî prioritise care needs, consider palliative needs assessment where appropriate.';
        };

        out.innerHTML = `
            <div>
                <strong>Score: ${val}</strong>
                <div style="margin-top:8px">${descriptions[val]}</div>
                <div style="margin-top:8px;color:#374151;font-weight:600">${guidance(val)}</div>
            </div>
        `;
    }

    getBarthelCalculator() {
        return `
            <div class="calculator-form">
                <h4>Barthel Index (ADL)</h4>
                <p><small>Complete the items and press Calculate</small></p>
                <div class="calc-input-group" id="barthel-detail-items">
                    <!-- Simplified form: items named to match common Barthel scoring -->
                    <label>Feeding: <select id="b-feeding"><option value="0">Dependent (0)</option><option value="5">Needs assistance (5)</option><option value="10">Independent (10)</option></select></label>
                    <label>Bathing: <select id="b-bathing"><option value="0">Dependent (0)</option><option value="5">Independent (5)</option></select></label>
                    <label>Grooming: <select id="b-grooming"><option value="0">Needs help (0)</option><option value="5">Independent (5)</option></select></label>
                    <label>Dressing: <select id="b-dressing"><option value="0">Dependent (0)</option><option value="5">Needs help (5)</option><option value="10">Independent (10)</option></select></label>
                    <label>Bowels: <select id="b-bowels"><option value="0">Incontinent (0)</option><option value="5">Occasional accident (5)</option><option value="10">Continent (10)</option></select></label>
                    <label>Bladder: <select id="b-bladder"><option value="0">Incontinent (0)</option><option value="5">Occasional accident (5)</option><option value="10">Continent (10)</option></select></label>
                    <label>Toilet use: <select id="b-toilet"><option value="0">Dependent (0)</option><option value="5">Needs some help (5)</option><option value="10">Independent (10)</option></select></label>
                    <label>Transfers (bed-chair): <select id="b-transfers"><option value="0">Dependent (0)</option><option value="5">Major help (5)</option><option value="10">Minor help (10)</option><option value="15">Independent (15)</option></select></label>
                    <label>Mobility (level): <select id="b-mobility"><option value="0">Dependent (0)</option><option value="5">Immobile (5)</option><option value="10">Walks with help (10)</option><option value="15">Independent (15)</option></select></label>
                    <label>Stairs: <select id="b-stairs"><option value="0">Unable (0)</option><option value="5">Needs help (5)</option><option value="10">Independent (10)</option></select></label>
                </div>
                <button onclick="window.quizApp.calculateBarthel()">Calculate</button>
                <div id="barthel-detail-result" class="calc-result"></div>
                <div class="calc-reference"><small>Score 0-100. Higher scores indicate greater independence.</small></div>
            </div>
        `;
    }

    calculateBarthel() {
        const ids = ['b-feeding','b-bathing','b-grooming','b-dressing','b-bowels','b-bladder','b-toilet','b-transfers','b-mobility','b-stairs'];
        let total = 0;
        ids.forEach(id => {
            const el = document.getElementById(id);
            if (el) total += parseInt(el.value, 10) || 0;
        });
        let interpretation = 'Total dependency';
        if (total === 100) interpretation = 'Independent';
        else if (total >= 91) interpretation = 'Slight dependency';
        else if (total >= 61) interpretation = 'Moderate dependency';
        else if (total >= 21) interpretation = 'Severe dependency';
        document.getElementById('barthel-detail-result').innerHTML = `
            <div>
                <strong>Barthel Total: ${total} / 100</strong>
                <div style="margin-top:8px">Interpretation: ${interpretation}</div>
            </div>
        `;
    }

    calculateBMI() {
        const weight = parseFloat(document.getElementById('bmi-weight').value);
        const height = parseFloat(document.getElementById('bmi-height').value) / 100; // Convert cm to m
        const waist = parseFloat(document.getElementById('bmi-waist').value);
        const ethnicity = document.getElementById('bmi-ethnicity').value;
        const sex = document.querySelector('input[name="bmi-sex"]:checked')?.value;
        
        if (!weight || !height) {
            document.getElementById('bmi-result').innerHTML = '<p class="error">Please enter valid weight and height</p>';
            return;
        }
        
        const bmi = weight / (height * height);
        let category = '';
        let color = '';
        let healthRisk = '';
        
        // Ethnic-specific BMI thresholds
        let overweightThreshold = 25;
        let obeseThreshold = 30;
        
        if (ethnicity === 'asian') {
            overweightThreshold = 23;
            obeseThreshold = 27.5;
        }
        
        if (bmi < 18.5) {
            category = 'Underweight';
            color = '#2196F3';
            healthRisk = 'Increased risk: nutritional deficiency, osteoporosis, immune dysfunction';
        } else if (bmi < overweightThreshold) {
            category = 'Normal weight';
            color = '#4CAF50';
            healthRisk = 'Optimal health risk profile';
        } else if (bmi < obeseThreshold) {
            category = 'Overweight';
            color = '#FF9800';
            healthRisk = 'Increased risk: diabetes, cardiovascular disease, sleep apnoea';
        } else if (bmi < 35) {
            category = 'Obese Class I';
            color = '#F44336';
            healthRisk = 'High risk: diabetes, CVD, stroke, certain cancers';
        } else if (bmi < 40) {
            category = 'Obese Class II';
            color = '#D32F2F';
            healthRisk = 'Very high risk: consider bariatric surgery consultation';
        } else {
            category = 'Obese Class III';
            color = '#B71C1C';
            healthRisk = 'Extremely high risk: urgent weight management, consider bariatric surgery';
        }
        
        // Waist circumference assessment
        let waistAssessment = '';
        if (waist && sex) {
            let waistRisk = '';
            let waistColor = '#4CAF50';
            
            if (sex === 'male') {
                if (waist >= 102) {
                    waistRisk = 'Very high risk';
                    waistColor = '#F44336';
                } else if (waist >= 94) {
                    waistRisk = 'Increased risk';
                    waistColor = '#FF9800';
                } else {
                    waistRisk = 'Low risk';
                }
            } else {
                if (waist >= 88) {
                    waistRisk = 'Very high risk';
                    waistColor = '#F44336';
                } else if (waist >= 80) {
                    waistRisk = 'Increased risk';
                    waistColor = '#FF9800';
                } else {
                    waistRisk = 'Low risk';
                }
            }
            
            waistAssessment = `
                <div style="margin-top: 8px; padding: 6px; background: #f5f5f5; border-radius: 4px;">
                    <strong>Waist Circumference:</strong> ${waist} cm<br>
                    <span style="color: ${waistColor}; font-weight: bold;">${waistRisk}</span> for metabolic complications
                </div>
            `;
        }
        
        document.getElementById('bmi-result').innerHTML = `
            <div class="bmi-result-display">
                <div class="bmi-value" style="color: ${color}; font-size: 1.2em;">
                    <strong>BMI: ${bmi.toFixed(1)} kg/m¬≤</strong>
                </div>
                <div class="bmi-category" style="color: ${color}; font-weight: bold; margin: 4px 0;">
                    ${category}
                </div>
                <div style="margin-top: 8px; font-size: 0.9em; color: #666;">
                    ${healthRisk}
                </div>
                ${waistAssessment}
                <div style="margin-top: 8px; font-size: 0.8em; color: #666;">
                    ${ethnicity === 'asian' ? 'Using Asian-specific BMI thresholds' : 'Using WHO BMI thresholds'}
                </div>
            </div>
        `;
    }


// ========================================
// Centor (lines 5123-5523)
// ========================================
                calculatorContent += this.getPERCCalculator();
                break;
        }
        calculatorContent = calculatorContent.replace('<h3 id="calculator-title"></h3>', `<h3 id="calculator-title">${calculatorTitle}</h3>`);
        container.innerHTML = calculatorContent;
        // Attach export buttons to results and per-calculator notes area
        try {
            // Ensure export features are available across calc-result blocks
            if (typeof this.setupExportFeatures === 'function') {
                this.setupExportFeatures();
            }
            // Add notes area for this calculator (persisted via localStorage)
            if (typeof this.setupCalculatorNotes === 'function') {
                this.setupCalculatorNotes(calcType);
            }
        } catch (err) {
            console.warn('‚ö†Ô∏è Failed to setup export/features or notes for calculator:', err);
        }
        console.log('üßÆ Loaded calculator:', calcType);
    }
    getBMICalculator() {
        return `
            <div class="calculator-form">
                <h4>BMI & Waist Circumference Calculator</h4>
                <div class="calc-input-group">
                    <label>Weight (kg):</label>
                    <input type="number" id="bmi-weight" placeholder="70" step="0.1">
                </div>
                <div class="calc-input-group">
                    <label>Height (cm):</label>
                    <input type="number" id="bmi-height" placeholder="175" step="0.1">
                </div>
                <div class="calc-input-group">
                    <label>Waist Circumference (cm) - Optional:</label>
                    <input type="number" id="bmi-waist" placeholder="85" step="0.1">
                </div>
                <div class="calc-input-group">
                    <label>Ethnicity:</label>
                    <select id="bmi-ethnicity">
                        <option value="european">European/Caucasian</option>
                        <option value="asian">Asian (Chinese, Japanese, South Asian)</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="calc-checkbox-group">
                    <label><input type="radio" name="bmi-sex" value="male"> Male</label>
                    <label><input type="radio" name="bmi-sex" value="female"> Female</label>
                </div>
                <button onclick="window.quizApp.calculateBMI()">Calculate</button>
                <div id="bmi-result" class="calc-result"></div>
                <div class="calc-reference">
                    <small>
                        <strong>BMI Categories (WHO):</strong><br>
                        Underweight: &lt;18.5 | Normal: 18.5-24.9<br>
                        Overweight: 25-29.9 | Obese: ‚â•30<br>
                        <strong>Asian populations:</strong> Overweight ‚â•23, Obese ‚â•27.5
                    </small>
                </div>
            </div>
        `;
    }

    getFrailtyCalculator() {
        return `
            <div class="calculator-form">
                <h4>Clinical Frailty Scale (Rockwood)</h4>
                <p><small>Select the category that best matches the patient</small></p>
                <div class="calc-input-group" id="frailty-options-detail">
                    <select id="frailty-select">
                        <option value="">-- Select frailty score --</option>
                        <option value="1">1 ‚Äî Very fit</option>
                        <option value="2">2 ‚Äî Well</option>
                        <option value="3">3 ‚Äî Managing well</option>
                        <option value="4">4 ‚Äî Vulnerable</option>
                        <option value="5">5 ‚Äî Mildly frail</option>
                        <option value="6">6 ‚Äî Moderately frail</option>
                        <option value="7">7 ‚Äî Severely frail</option>
                        <option value="8">8 ‚Äî Very severely frail</option>
                        <option value="9">9 ‚Äî Terminally ill</option>
                    </select>
                </div>
                <button onclick="window.quizApp.calculateFrailty()">Calculate</button>
                <div id="frailty-detail-result" class="calc-result"></div>
                <div class="calc-reference"><small>Rockwood Clinical Frailty Scale (1‚Äì9): use as an aid to clinical judgement.</small></div>
            </div>
        `;
    }

    calculateFrailty() {
        const sel = document.getElementById('frailty-select');
        const out = document.getElementById('frailty-detail-result');
        if (!sel || !out) return;
        const val = sel.value;
        if (!val) {
            out.innerHTML = '<p class="error">Please select a frailty score</p>';
            return;
        }
        const descriptions = {
            1: 'Very fit ‚Äî robust, active, energetic and motivated. Typically exercises regularly.',
            2: 'Well ‚Äî no active disease symptoms but less fit than category 1.',
            3: 'Managing well ‚Äî medical problems are well controlled, not regularly active beyond routine activities.',
            4: 'Vulnerable ‚Äî not dependent on others for daily help, but symptoms limit activities.',
            5: 'Mildly frail ‚Äî evident slowing and need help in high order instrumental activities of daily living.',
            6: 'Moderately frail ‚Äî need help with all outside activities and with keeping house.',
            7: 'Severely frail ‚Äî completely dependent for personal care, but stable and not at high risk of dying within 6 months.',
            8: 'Very severely frail ‚Äî completely dependent, approaching the end of life. Typically approaching high risk of dying.',
            9: 'Terminally ill ‚Äî life expectancy <6 months, not otherwise evidently frail.'
        };
        const guidance = (n) => {
            const num = parseInt(n, 10);
            if (num <= 3) return 'Not frail ‚Äî encourage activity and prevention.';
            if (num === 4) return 'Pre-frail/vulnerable ‚Äî consider targeted interventions (exercise, medication review).';
            if (num >=5 && num <=6) return 'Frailty present ‚Äî consider CGA, falls review and medication optimisation.';
            return 'High dependency ‚Äî prioritise care needs, consider palliative needs assessment where appropriate.';
        };

        out.innerHTML = `
            <div>
                <strong>Score: ${val}</strong>
                <div style="margin-top:8px">${descriptions[val]}</div>
                <div style="margin-top:8px;color:#374151;font-weight:600">${guidance(val)}</div>
            </div>
        `;
    }

    getBarthelCalculator() {
        return `
            <div class="calculator-form">
                <h4>Barthel Index (ADL)</h4>
                <p><small>Complete the items and press Calculate</small></p>
                <div class="calc-input-group" id="barthel-detail-items">
                    <!-- Simplified form: items named to match common Barthel scoring -->
                    <label>Feeding: <select id="b-feeding"><option value="0">Dependent (0)</option><option value="5">Needs assistance (5)</option><option value="10">Independent (10)</option></select></label>
                    <label>Bathing: <select id="b-bathing"><option value="0">Dependent (0)</option><option value="5">Independent (5)</option></select></label>
                    <label>Grooming: <select id="b-grooming"><option value="0">Needs help (0)</option><option value="5">Independent (5)</option></select></label>
                    <label>Dressing: <select id="b-dressing"><option value="0">Dependent (0)</option><option value="5">Needs help (5)</option><option value="10">Independent (10)</option></select></label>
                    <label>Bowels: <select id="b-bowels"><option value="0">Incontinent (0)</option><option value="5">Occasional accident (5)</option><option value="10">Continent (10)</option></select></label>
                    <label>Bladder: <select id="b-bladder"><option value="0">Incontinent (0)</option><option value="5">Occasional accident (5)</option><option value="10">Continent (10)</option></select></label>
                    <label>Toilet use: <select id="b-toilet"><option value="0">Dependent (0)</option><option value="5">Needs some help (5)</option><option value="10">Independent (10)</option></select></label>
                    <label>Transfers (bed-chair): <select id="b-transfers"><option value="0">Dependent (0)</option><option value="5">Major help (5)</option><option value="10">Minor help (10)</option><option value="15">Independent (15)</option></select></label>
                    <label>Mobility (level): <select id="b-mobility"><option value="0">Dependent (0)</option><option value="5">Immobile (5)</option><option value="10">Walks with help (10)</option><option value="15">Independent (15)</option></select></label>
                    <label>Stairs: <select id="b-stairs"><option value="0">Unable (0)</option><option value="5">Needs help (5)</option><option value="10">Independent (10)</option></select></label>
                </div>
                <button onclick="window.quizApp.calculateBarthel()">Calculate</button>
                <div id="barthel-detail-result" class="calc-result"></div>
                <div class="calc-reference"><small>Score 0-100. Higher scores indicate greater independence.</small></div>
            </div>
        `;
    }

    calculateBarthel() {
        const ids = ['b-feeding','b-bathing','b-grooming','b-dressing','b-bowels','b-bladder','b-toilet','b-transfers','b-mobility','b-stairs'];
        let total = 0;
        ids.forEach(id => {
            const el = document.getElementById(id);
            if (el) total += parseInt(el.value, 10) || 0;
        });
        let interpretation = 'Total dependency';
        if (total === 100) interpretation = 'Independent';
        else if (total >= 91) interpretation = 'Slight dependency';
        else if (total >= 61) interpretation = 'Moderate dependency';
        else if (total >= 21) interpretation = 'Severe dependency';
        document.getElementById('barthel-detail-result').innerHTML = `
            <div>
                <strong>Barthel Total: ${total} / 100</strong>
                <div style="margin-top:8px">Interpretation: ${interpretation}</div>
            </div>
        `;
    }

    calculateBMI() {
        const weight = parseFloat(document.getElementById('bmi-weight').value);
        const height = parseFloat(document.getElementById('bmi-height').value) / 100; // Convert cm to m
        const waist = parseFloat(document.getElementById('bmi-waist').value);
        const ethnicity = document.getElementById('bmi-ethnicity').value;
        const sex = document.querySelector('input[name="bmi-sex"]:checked')?.value;
        
        if (!weight || !height) {
            document.getElementById('bmi-result').innerHTML = '<p class="error">Please enter valid weight and height</p>';
            return;
        }
        
        const bmi = weight / (height * height);
        let category = '';
        let color = '';
        let healthRisk = '';
        
        // Ethnic-specific BMI thresholds
        let overweightThreshold = 25;
        let obeseThreshold = 30;
        
        if (ethnicity === 'asian') {
            overweightThreshold = 23;
            obeseThreshold = 27.5;
        }
        
        if (bmi < 18.5) {
            category = 'Underweight';
            color = '#2196F3';
            healthRisk = 'Increased risk: nutritional deficiency, osteoporosis, immune dysfunction';
        } else if (bmi < overweightThreshold) {
            category = 'Normal weight';
            color = '#4CAF50';
            healthRisk = 'Optimal health risk profile';
        } else if (bmi < obeseThreshold) {
            category = 'Overweight';
            color = '#FF9800';
            healthRisk = 'Increased risk: diabetes, cardiovascular disease, sleep apnoea';
        } else if (bmi < 35) {
            category = 'Obese Class I';
            color = '#F44336';
            healthRisk = 'High risk: diabetes, CVD, stroke, certain cancers';
        } else if (bmi < 40) {
            category = 'Obese Class II';
            color = '#D32F2F';
            healthRisk = 'Very high risk: consider bariatric surgery consultation';
        } else {
            category = 'Obese Class III';
            color = '#B71C1C';
            healthRisk = 'Extremely high risk: urgent weight management, consider bariatric surgery';
        }
        
        // Waist circumference assessment
        let waistAssessment = '';
        if (waist && sex) {
            let waistRisk = '';
            let waistColor = '#4CAF50';
            
            if (sex === 'male') {
                if (waist >= 102) {
                    waistRisk = 'Very high risk';
                    waistColor = '#F44336';
                } else if (waist >= 94) {
                    waistRisk = 'Increased risk';
                    waistColor = '#FF9800';
                } else {
                    waistRisk = 'Low risk';
                }
            } else {
                if (waist >= 88) {
                    waistRisk = 'Very high risk';
                    waistColor = '#F44336';
                } else if (waist >= 80) {
                    waistRisk = 'Increased risk';
                    waistColor = '#FF9800';
                } else {
                    waistRisk = 'Low risk';
                }
            }
            
            waistAssessment = `
                <div style="margin-top: 8px; padding: 6px; background: #f5f5f5; border-radius: 4px;">
                    <strong>Waist Circumference:</strong> ${waist} cm<br>
                    <span style="color: ${waistColor}; font-weight: bold;">${waistRisk}</span> for metabolic complications
                </div>
            `;
        }
        
        document.getElementById('bmi-result').innerHTML = `
            <div class="bmi-result-display">
                <div class="bmi-value" style="color: ${color}; font-size: 1.2em;">
                    <strong>BMI: ${bmi.toFixed(1)} kg/m¬≤</strong>
                </div>
                <div class="bmi-category" style="color: ${color}; font-weight: bold; margin: 4px 0;">
                    ${category}
                </div>
                <div style="margin-top: 8px; font-size: 0.9em; color: #666;">
                    ${healthRisk}
                </div>
                ${waistAssessment}
                <div style="margin-top: 8px; font-size: 0.8em; color: #666;">
                    ${ethnicity === 'asian' ? 'Using Asian-specific BMI thresholds' : 'Using WHO BMI thresholds'}
                </div>
            </div>
        `;
    }

    getCHADS2VAScCalculator() {
        return `
            <div class="calculator-form">
                <h4>CHA‚ÇÇDS‚ÇÇ-VASc Score</h4>
                <p><small>Stroke risk assessment in atrial fibrillation</small></p>
                
                <div class="calc-checkbox-group">
                    <label><input type="checkbox" id="chads-chf"> Congestive heart failure (+1)</label>
                    <label><input type="checkbox" id="chads-htn"> Hypertension (+1)</label>
                    <label><input type="checkbox" id="chads-age75"> Age ‚â•75 years (+2)</label>
                    <label><input type="checkbox" id="chads-diabetes"> Diabetes mellitus (+1)</label>
                    <label><input type="checkbox" id="chads-stroke"> Stroke/TIA/thromboembolism (+2)</label>
                    <label><input type="checkbox" id="chads-vascular"> Vascular disease (+1)</label>
                    <label><input type="checkbox" id="chads-age65"> Age 65-74 years (+1)</label>
                    <label><input type="checkbox" id="chads-female"> Female sex (+1)</label>
                </div>
                
                <button onclick="window.quizApp.calculateCHADS2VASc()">Calculate Score</button>
                <div id="chads-result" class="calc-result"></div>
            </div>
        `;
    }

    calculateCHADS2VASc() {
        let score = 0;
        
        if (document.getElementById('chads-chf').checked) score += 1;
        if (document.getElementById('chads-htn').checked) score += 1;
        if (document.getElementById('chads-age75').checked) score += 2;
        if (document.getElementById('chads-diabetes').checked) score += 1;
        if (document.getElementById('chads-stroke').checked) score += 2;
        if (document.getElementById('chads-vascular').checked) score += 1;
        if (document.getElementById('chads-age65').checked) score += 1;
        
        const isFemale = document.getElementById('chads-female').checked;
        if (isFemale) score += 1;
        
        let risk = '';
        let recommendation = '';
        let color = '';
        
        // Updated UK guidelines: sex-specific treatment recommendations
        if (score === 0) {
            risk = 'Low risk (0.2%/year)';
            recommendation = 'No anticoagulation recommended';
            color = '#4CAF50';
        } else if (score === 1) {
            if (isFemale && score === 1) {
                // Female with score 1 (sex alone) - special case
                risk = 'Low-moderate risk (0.6%/year)';
                recommendation = 'Female sex alone: generally no anticoagulation. Consider other risk factors';
                color = '#FF9800';
            } else {
                // Male with score 1 or female with other risk factors
                risk = 'Low-moderate risk (0.6%/year)';


// ========================================
// CHA2DS2VASc (lines 13097-13497)
// ========================================
                organisation: 'NICE',
                types: {
                    'Paroxysmal': 'Self-terminating within 7 days (usually <48 hours)',
                    'Persistent': 'Lasts >7 days or requires cardioversion',
                    'Long-standing persistent': '>12 months duration',
                    'Permanent': 'Accepted long-term AF, no attempt at rhythm control'
                },
                rateControl: {
                    'First-line': 'Beta-blocker or rate-limiting CCB (diltiazem, verapamil)',
                    'Alternative': 'Digoxin (if sedentary or heart failure)',
                    'Target': 'Resting heart rate <110 bpm (lenient control)',
                    'Strict control': '<80 bpm if symptoms persist'
                },
                rhythmControl: {
                    'Indications': 'Symptomatic AF despite rate control, younger patients, first presentation',
                    'Cardioversion': 'If AF <48 hours or anticoagulated for ‚â•3 weeks',
                    'Maintenance': 'Amiodarone, sotalol, flecainide (if no structural heart disease)'
                },
                anticoagulation: {
                    'CHA2DS2-VASc': 'Calculate stroke risk. Anticoagulate if score ‚â•2 (men) or ‚â•3 (women)',
                    'HAS-BLED': 'Assess bleeding risk but high score not contraindication',
                    'DOAC': 'First-line: apixaban, dabigatran, edoxaban, rivaroxaban',
                    'Warfarin': 'If DOAC contraindicated. Target INR 2.0-3.0'
                },
                monitoring: 'Annual review. Check for symptoms, pulse rate/rhythm, blood pressure, medication adherence'
            },
            'depression': {
                title: 'Depression Management (NICE NG222 2024)',
                category: 'mental-health',
                evidenceLevel: 'NICE Clinical Guideline',
                lastUpdated: '2024',
                organisation: 'NICE',
                assessment: {
                    'PHQ-9': 'Patient Health Questionnaire for severity assessment',
                    'Mild': 'PHQ-9 score 5-9. Watchful waiting, self-help, brief interventions',
                    'Moderate': 'PHQ-9 score 10-14. Psychological interventions or antidepressants',
                    'Severe': 'PHQ-9 score 15-19. Antidepressants + psychological interventions'
                },
                psychological: {
                    'First-line': 'CBT (individual or group), guided self-help, computerised CBT',
                    'Alternatives': 'IPT (interpersonal therapy), counselling, mindfulness-based cognitive therapy'
                },
                pharmacological: {
                    'First-line': 'SSRI (sertraline, citalopram, fluoxetine, paroxetine)',
                    'Second-line': 'Different SSRI, SNRI (venlafaxine), mirtazapine',
                    'Starting dose': 'Sertraline 50mg daily, citalopram 20mg daily'
                },
                monitoring: {
                    'Initial': 'Review within 2 weeks of starting antidepressant',
                    'Young people': 'Weekly for first month if <30 years old',
                    'Ongoing': 'Every 2-4 weeks for first 3 months, then less frequently'
                },
                duration: 'Continue antidepressant for ‚â•6 months after remission. Consider longer if recurrent episodes',
                riskFactors: 'Discontinuation symptoms, suicide risk (especially early treatment), drug interactions'
            },
            'obesity': {
                title: 'Obesity Management (NICE NG189 2024)',
                category: 'endocrine',
                evidenceLevel: 'NICE Clinical Guideline',
                lastUpdated: '2024',
                organisation: 'NICE',
                classification: {
                    'Overweight': 'BMI 25-29.9 kg/m¬≤',
                    'Obesity class I': 'BMI 30-34.9 kg/m¬≤',
                    'Obesity class II': 'BMI 35-39.9 kg/m¬≤',
                    'Obesity class III': 'BMI ‚â•40 kg/m¬≤'
                },
                assessment: 'BMI, waist circumference, comorbidities (T2DM, hypertension, sleep apnoea), cardiovascular risk',
                lifestyle: {
                    'Diet': 'Calorie deficit 600kcal/day. Mediterranean-style, low-calorie, low-fat diets',
                    'Exercise': 'Gradually increase to 150-300 minutes moderate intensity per week',
                    'Behaviour': 'Goal setting, self-monitoring, cognitive restructuring'
                },
                pharmacotherapy: {
                    'Orlistat': 'BMI ‚â•30 or ‚â•28 with comorbidities. 120mg three times daily with meals',
                    'GLP-1 agonists': 'Specialist initiation. Liraglutide if specific criteria met',
                    'Monitoring': 'Weight loss target ‚â•5% at 3 months, ‚â•10% at 6 months'
                },
                surgery: {
                    'Criteria': 'BMI ‚â•40 or ‚â•35 with comorbidities. Failed non-surgical methods',
                    'Options': 'Gastric bypass, sleeve gastrectomy, adjustable gastric band',
                    'Follow-up': 'Lifelong specialist monitoring, nutritional supplements'
                },
                comorbidities: 'Screen for T2DM, hypertension, dyslipidaemia, sleep apnoea, NAFLD, osteoarthritis'
            },
            'stroke': {
                title: 'Stroke Prevention & Management (NICE NG128 2024)',
                category: 'neurological',
                evidenceLevel: 'NICE Clinical Guideline',
                lastUpdated: '2024',
                organisation: 'NICE',
                prevention: {
                    'Antiplatelet': 'Aspirin 75mg + dipyridamole 200mg twice daily for secondary prevention',
                    'Anticoagulation': 'For AF: DOAC first-line (apixaban, rivaroxaban, dabigatran)',
                    'Statin': 'Atorvastatin 80mg daily for secondary prevention',
                    'Blood pressure': 'Target <130/80 mmHg. Start 2 weeks after acute stroke'
                },
                acute: {
                    'Recognition': 'FAST (Face, Arms, Speech, Time) assessment',
                    'Thrombolysis': 'Alteplase within 4.5 hours of symptom onset if eligible',
                    'Thrombectomy': 'Within 6 hours for proximal anterior circulation occlusion',
                    'Aspirin': '300mg daily for 2 weeks, then 75mg daily long-term'
                },
                rehabilitation: {
                    'Early': 'Mobilisation within 24 hours if medically stable',
                    'MDT': 'Physiotherapy, occupational therapy, speech therapy, dietician',
                    'Goals': 'Functional independence, swallowing assessment, mood screening'
                },
                riskFactors: 'Hypertension, AF, diabetes, smoking, hyperlipidaemia, carotid stenosis, previous TIA/stroke',
                monitoring: 'Annual review: BP, cholesterol, diabetes control, medication adherence, functional status'
            },
            'uti': {
                title: 'Urinary Tract Infections (NICE NG109 2024)',
                category: 'infectious-diseases',
                evidenceLevel: 'NICE Clinical Guideline',
                lastUpdated: '2024',
                organisation: 'NICE',
                diagnosis: {
                    'Uncomplicated UTI': 'Dysuria, frequency, urgency, suprapubic pain in healthy women',
                    'Complicated UTI': 'Men, pregnant women, children, catheterised patients, immunocompromised',
                    'Urine dipstick': 'Nitrites + leucocyte esterase positive. Blood may be present'
                },
                treatment: {
                    'Uncomplicated cystitis': 'Nitrofurantoin 100mg twice daily for 3 days OR trimethoprim 200mg twice daily for 3 days',
                    'Pyelonephritis': 'Ciprofloxacin 500mg twice daily for 7 days OR co-amoxiclav 500/125mg three times daily for 14 days',
                    'Men': 'Trimethoprim 200mg twice daily for 7 days OR nitrofurantoin 100mg twice daily for 7 days',
                    'Pregnancy': 'Nitrofurantoin 100mg twice daily for 7 days (avoid at term)'
                },
                recurrent: {
                    'Definition': '‚â•3 UTIs in 12 months or ‚â•2 in 6 months',
                    'Prevention': 'Post-coital prophylaxis, continuous prophylaxis, self-treatment',
                    'Prophylaxis': 'Trimethoprim 100mg at night OR nitrofurantoin 50mg at night'
                },
                catheter: {
                    'Symptomatic CAUTI': 'Treat with antibiotics based on local guidelines',
                    'Asymptomatic bacteriuria': 'Do not treat unless immunocompromised or before invasive procedures'
                },
                advice: 'Adequate fluid intake, complete antibiotic course, cranberry products may help prevent recurrence'
            },
            'diabetes': {
                title: 'Type 2 Diabetes Management (NICE NG28 2024)',
                category: 'endocrine',
                evidenceLevel: 'NICE Clinical Guideline',
                lastUpdated: '2024',
                organisation: 'NICE',
                diagnosis: {
                    'HbA1c': '‚â•48 mmol/mol (‚â•6.5%) on two occasions OR single value if symptomatic',
                    'Fasting glucose': '‚â•7.0 mmol/L (‚â•126 mg/dL)',
                    'Random glucose': '‚â•11.1 mmol/L (‚â•200 mg/dL) with symptoms',
                    'OGTT': '2-hour glucose ‚â•11.1 mmol/L (‚â•200 mg/dL)'
                },
                targets: {
                    'HbA1c': '<48 mmol/mol (<6.5%) for newly diagnosed, <53 mmol/mol (<7.0%) for most adults',
                    'Blood pressure': '<130/80 mmHg',
                    'Cholesterol': 'Non-HDL <2.5 mmol/L'
                },
                lifestyle: {
                    'Diet': 'Mediterranean-style, low glycaemic index, weight loss if BMI >25',
                    'Exercise': '150 minutes moderate intensity per week, resistance training',
                    'Weight': 'Target weight loss 5-10% if overweight'
                },
                medications: {
                    'First-line': 'Metformin 500mg twice daily, titrate to 1g twice daily',
                    'Second-line': 'SGLT2 inhibitor (if CVD/heart failure) OR DPP-4 inhibitor OR sulfonylurea',
                    'Third-line': 'Triple therapy or insulin',
                    'Insulin': 'Start with basal insulin (glargine, detemir) 10 units daily, titrate 2-4 units every 3-7 days'
                },
                monitoring: {
                    'HbA1c': 'Every 3-6 months until stable, then 6-monthly',
                    'Annual checks': 'Foot examination, eye screening, kidney function, lipids, blood pressure',
                    'Sick day rules': 'Continue insulin, increase monitoring, seek help if vomiting'
                },
                complications: 'Retinopathy, nephropathy, neuropathy, cardiovascular disease, diabetic foot'
            },
            'pneumonia': {
                title: 'Pneumonia Management (NICE NG138 2024)',
                category: 'pulmonary',
                evidenceLevel: 'NICE Clinical Guideline',
                lastUpdated: '2024',
                organisation: 'NICE',
                diagnosis: {
                    'Clinical': 'Cough, fever, dyspnea, pleuritic chest pain, crackles',
                    'CXR': 'New infiltrate (may be normal in early disease)',
                    'Blood tests': 'FBC, CRP, U&E, LFT. Consider pneumococcal/legionella antigens'
                },
                severity: {
                    'CURB-65': 'Confusion, Urea >7, RR ‚â•30, BP <90/60, age ‚â•65',
                    'Score 0-1': 'Low severity - consider home treatment',
                    'Score 2': 'Moderate severity - consider hospital admission',
                    'Score ‚â•3': 'High severity - urgent hospital admission'
                },
                treatment: {
                    'Mild CAP': 'Amoxicillin 500mg three times daily for 5 days',
                    'Moderate CAP': 'Amoxicillin 500mg three times daily + clarithromycin 500mg twice daily for 5 days',
                    'Severe CAP': 'Co-amoxiclav 1.2g three times daily IV + clarithromycin 500mg twice daily IV',
                    'Atypical': 'Clarithromycin 500mg twice daily OR doxycycline 200mg on day 1, then 100mg daily'
                },
                admission: {
                    'Criteria': 'CURB-65 ‚â•2, hypoxia <90%, inability to maintain oral intake, significant comorbidities',
                    'Monitoring': 'Oxygen saturation, fluid balance, response to treatment',
                    'Discharge': 'Clinically stable for 24 hours, able to maintain oral intake, oxygen saturation >90%'
                },
                prevention: 'Pneumococcal vaccination (‚â•65 years, immunocompromised), annual influenza vaccination'
            },
            'sepsis': {
                title: 'Sepsis Recognition & Management (NICE NG51 2024)',
                category: 'infectious-diseases',
                evidenceLevel: 'NICE Clinical Guideline',
                lastUpdated: '2024',
                organisation: 'NICE',
                recognition: {
                    'Red flags': 'Systolic BP <90, HR >130, RR ‚â•25, needs O2 to maintain sats ‚â•92%, non-blanching rash',
                    'Amber flags': 'Relatives concerned about mental state, acute change in mental state, HR 91-130, T <36¬∞C',
                    'High-risk groups': 'Age >75, immunocompromised, recent surgery/invasive procedure, indwelling devices'
                },
                definitions: {
                    'Sepsis': 'Life-threatening organ dysfunction due to dysregulated host response to infection',
                    'Septic shock': 'Sepsis with circulatory/cellular dysfunction (lactate >2, vasopressors needed)',
                    'qSOFA': 'Altered mental state, SBP ‚â§100, RR ‚â•22 (score ‚â•2 = high risk)'
                },
                management: {
                    'Sepsis Six': '1. Give oxygen, 2. Take blood cultures, 3. Give antibiotics, 4. Give fluids, 5. Measure lactate, 6. Measure urine output',
                    'Timeframe': 'Complete within 1 hour of recognition',
                    'Antibiotics': 'Broad-spectrum within 1 hour. Adjust based on cultures and local guidelines',
                    'Fluids': '500ml crystalloid bolus, reassess and repeat if needed'
                },
                antibiotics: {
                    'Community-acquired': 'Amoxicillin 1g IV three times daily + gentamicin',
                    'Hospital-acquired': 'Piperacillin-tazobactam 4.5g three times daily + gentamicin',
                    'Neutropenic': 'Piperacillin-tazobactam + gentamicin',
                    'Duration': 'Review daily, typically 5-7 days depending on source and response'
                },
                monitoring: 'Hourly observations, fluid balance, lactate, organ function, consider HDU/ICU if deteriorating'
            },
            'dvt-pe': {
                title: 'DVT & Pulmonary Embolism (NICE NG158 2024)',
                category: 'cardiovascular',
                evidenceLevel: 'NICE Clinical Guideline',
                lastUpdated: '2024',
                organisation: 'NICE',
                assessment: {
                    'Wells Score DVT': '<1 unlikely, ‚â•1 likely. Use 2-level score',
                    'Wells Score PE': '‚â§4 unlikely, >4 likely. Use 2-level score',
                    'D-dimer': 'If low probability. Negative D-dimer excludes VTE'
                },
                diagnosis: {
                    'DVT': 'Doppler ultrasound within 4 hours or interim DOAC + scan within 24 hours',
                    'PE': 'CTPA (CT pulmonary angiography) first-line imaging',
                    'V/Q scan': 'If CTPA contraindicated (pregnancy, contrast allergy, renal impairment)'
                },
                treatment: {
                    'Initial': 'DOAC (apixaban, rivaroxaban) first-line OR LMWH ‚Üí warfarin',
                    'Apixaban': '10mg twice daily for 7 days, then 5mg twice daily',
                    'Rivaroxaban': '15mg twice daily for 21 days, then 20mg daily',
                    'Warfarin': 'LMWH overlap until INR 2-3 for 2 consecutive days. Target INR 2.5',
                    'Duration': 'Provoked: 3 months. Unprovoked: 3-6 months, consider longer if recurrent'
                },
                'massive PE': {
                    'Definition': 'Hypotension, shock, cardiac arrest',
                    'Treatment': 'Thrombolysis (alteplase), consider embolectomy',
                    'HDU/ICU': 'Immediate admission, monitoring, vasopressor support'
                },
                thrombophilia: {
                    'Screen if': 'Age <50, unprovoked VTE, recurrent VTE, unusual site, family history',
                    'Tests': 'Protein C/S, antithrombin, factor V Leiden, prothrombin gene, antiphospholipid antibodies',
                    'Timing': 'At least 3 months after stopping anticoagulation'
                },
                prevention: 'Risk assess all hospital admissions. LMWH prophylaxis if indicated. TED stockings if immobile'
            },
            'acs': {
                title: 'Acute Coronary Syndrome (NICE NG185 2024)',
                category: 'cardiovascular',
                evidenceLevel: 'NICE Clinical Guideline',
                lastUpdated: '2024',
                organisation: 'NICE',
                recognition: {
                    'Chest pain': 'Central, crushing, radiating to jaw/arm, associated with sweating, nausea',
                    'Atypical': 'Epigastric pain, dyspnoea, syncope (especially elderly, diabetic, women)',
                    'ECG': 'ST elevation (STEMI), ST depression/T wave inversion (NSTEMI), normal (possible ACS)'
                },
                'stemi': {
                    'Diagnosis': 'ST elevation ‚â•1mm in ‚â•2 contiguous leads OR new LBBB',
                    'Immediate': 'Aspirin 300mg, P2Y12 inhibitor (ticagrelor 180mg), morphine, antiemetic, GTN',
                    'Reperfusion': 'Primary PCI <120 minutes OR thrombolysis if PCI not available <120 minutes',
                    'Thrombolysis': 'Alteplase or tenecteplase. Give if PCI not achievable within 120 minutes'
                },
                'nstemi': {
                    'Risk stratification': 'GRACE score determines management',
                    'High risk': 'Coronary angiography within 72 hours',
                    'Immediate': 'Aspirin 300mg, ticagrelor 180mg, fondaparinux 2.5mg SC daily',
                    'Anticoagulation': 'Fondaparinux preferred unless angiography planned within 24 hours'
                },
                'secondary prevention': {
                    'Antiplatelet': 'Aspirin 75mg + ticagrelor 90mg twice daily for 12 months, then aspirin alone',
                    'Statin': 'Atorvastatin 80mg daily',
                    'ACE inhibitor': 'Ramipril 1.25mg twice daily, titrate to 5mg twice daily',
                    'Beta-blocker': 'Bisoprolol 1.25mg daily, titrate to 10mg daily',
                    'Lifestyle': 'Cardiac rehabilitation, smoking cessation, BP <130/80, lipid target'
                },
                complications: 'Arrhythmias, heart failure, cardiogenic shock, mechanical complications (VSD, MR, rupture)',
                targets: 'Total cholesterol <4mmol/L, LDL <2mmol/L, non-HDL <2.5mmol/L'
            },
            'anaphylaxis': {
                title: 'Anaphylaxis Management (Resus Council UK 2024)',
                category: 'emergency',
                evidenceLevel: 'Emergency Guideline',
                lastUpdated: '2024',
                organisation: 'Resuscitation Council UK',
                recognition: {
                    'ABC problems': 'Airway, breathing, circulation compromise',
                    'Skin changes': 'Urticaria, angioedema, flushing (may be absent in 20%)',
                    'Sudden onset': 'Minutes after exposure to known allergen',
                    'Life-threatening': 'Airway/breathing/circulation problems'
                },
                treatment: {
                    'IM Adrenaline': '500 micrograms (0.5ml of 1:1000) into anterolateral thigh. Repeat after 5 minutes if no improvement',
                    'Position': 'Lie flat with legs raised (unless airway/breathing compromised)',
                    'High-flow oxygen': '15L via non-rebreathing mask',
                    'IV fluids': '500ml-1L crystalloid rapidly if signs of shock',
                    'Antihistamine': 'Chlorphenamine 10mg IV/IM (after adrenaline)',
                    'Steroid': 'Hydrocortisone 200mg IV/IM (after adrenaline)'
                },
                refractory: {
                    'IV adrenaline': 'If no response to IM doses. Titrate carefully, cardiac monitoring',
                    'Alternative': 'Glucagon 1-2mg IM if on beta-blockers'
                },
                observation: {
                    'Minimum': '6-8 hours observation after resolution',
                    'Biphasic reaction': 'Can occur up to 72 hours later (1-20% cases)',
                    'Discharge': 'Ensure 2 adrenaline auto-injectors prescribed, referral to allergy clinic'
                },
                autoInjector: {
                    'Indications': 'Previous anaphylaxis, high-risk foods (nuts, fish), venom allergy, idiopathic',
                    'Training': 'Demonstrate use, provide written plan, MedicAlert bracelet',
                    'Types': 'EpiPen, Jext, Emerade (150, 300, 500 microgram doses)'
                }
            },
            'osteoporosis': {
                title: 'Osteoporosis Prevention & Treatment (NICE NG239 2024)',
                category: 'endocrine',
                evidenceLevel: 'NICE Clinical Guideline',
                lastUpdated: '2024',
                organisation: 'NICE',
                assessment: {
                    'FRAX tool': 'Calculate 10-year fracture risk. Age, sex, BMI, risk factors',
                    'DEXA scan': 'T-score ‚â§-2.5 = osteoporosis. -1 to -2.5 = osteopenia',
                    'Indications for DEXA': 'Age >50 + fragility fracture, long-term steroids, FRAX intermediate/high risk'
                },
                riskFactors: {
                    'Major': 'Age >75, previous fragility fracture, glucocorticoids, family history hip fracture',
                    'Other': 'Low BMI <18.5, alcohol >14 units/week, smoking, rheumatoid arthritis, conditions causing secondary osteoporosis'
                },
                prevention: {
                    'Calcium': '700-1200mg daily (diet or supplements)',
                    'Vitamin D': '10-20 micrograms (400-800 IU) daily',
                    'Exercise': 'Weight-bearing, balance, resistance training',
                    'Lifestyle': 'Stop smoking, reduce alcohol, maintain healthy weight'
                },
                treatment: {
                    'First-line': 'Oral bisphosphonate (alendronate 70mg weekly OR risedronate 35mg weekly)',
                    'Administration': 'Take on empty stomach with full glass water, stay upright 30 minutes',
                    'Second-line': 'IV bisphosphonate (zoledronic acid 5mg annually) OR denosumab 60mg SC 6-monthly',
                    'Alternatives': 'Raloxifene (postmenopausal women), teriparatide (severe osteoporosis)',
                    'Duration': 'Review after 5 years bisphosphonate, consider drug holiday'
                },
                monitoring: {
                    'DEXA': 'Not routinely repeated if on treatment unless clinical indication',
                    'Falls risk': 'Assess and address falls risk factors',
                    'Fracture liaison': 'Post-fracture services for secondary prevention'
                },
                steroids: 'Consider bone protection if prednisolone ‚â•7.5mg daily for ‚â•3 months'
            },
            'gout': {
                title: 'Gout Management (BSR/BHPR Guidelines 2024)',
                category: 'rheumatologic',
                evidenceLevel: 'BSR Guideline',
                lastUpdated: '2024',
                organisation: 'British Society for Rheumatology',
                diagnosis: {
                    'Clinical': 'Acute monoarthritis (typically 1st MTP joint), rapid onset, severe pain, red, hot, swollen',
                    'Joint aspiration': 'Negatively birefringent needle-shaped crystals (monosodium urate)',
                    'Serum urate': 'May be normal during acute attack. Check 2-4 weeks after attack'
                },
                acute: {
                    'First-line': 'NSAID (naproxen 750mg stat, then 250mg three times daily) OR colchicine 500mcg 2-4 times daily',
                    'Alternatives': 'Colchicine (if NSAID contraindicated), oral/IM steroid (if both contraindicated)',
                    'Avoid': 'Do NOT start/stop allopurinol during acute attack',
                    'Duration': 'Continue until 1-2 days after symptoms resolve'
                },
                uratelowering: {
                    'Indications': '‚â•2 attacks/year, tophi, chronic gouty arthritis, urate stones, CKD stage ‚â•3',
                    'Target': 'Serum urate <300 micromol/L (<5mg/dL)',
                    'First-line': 'Allopurinol 100mg daily, increase by 100mg every 2-4 weeks to target (max 900mg)',
                    'Prophylaxis': 'Give colchicine 500mcg once/twice daily OR NSAID when starting allopurinol',
                    'Alternative': 'Febuxostat if allopurinol not tolerated'
                },
                lifestyle: {
                    'Diet': 'Reduce purine-rich foods (red meat, seafood, organ meats, yeast extracts)',
                    'Alcohol': 'Limit beer and spirits (wine less problematic)',
                    'Drinks': 'Avoid sugar-sweetened drinks, increase water intake',
                    'Weight': 'Gradual weight loss if overweight (rapid weight loss can trigger attacks)',


// ========================================
// ChildPugh (lines 4967-5367)
// ========================================
                calculatorContent += this.getQRISKCalculator();
                break;
        }
        calculatorContent = calculatorContent.replace('<h3 id="calculator-title"></h3>', `<h3 id="calculator-title">${calculatorTitle}</h3>`);
        container.innerHTML = calculatorContent;
        // Attach export buttons to results and per-calculator notes area
        try {
            // Ensure export features are available across calc-result blocks
            if (typeof this.setupExportFeatures === 'function') {
                this.setupExportFeatures();
            }
            // Add notes area for this calculator (persisted via localStorage)
            if (typeof this.setupCalculatorNotes === 'function') {
                this.setupCalculatorNotes(calcType);
            }
        } catch (err) {
            console.warn('‚ö†Ô∏è Failed to setup export/features or notes for calculator:', err);
        }
        console.log('üßÆ Loaded calculator:', calcType);
    }
    getBMICalculator() {
        return `
            <div class="calculator-form">
                <h4>BMI & Waist Circumference Calculator</h4>
                <div class="calc-input-group">
                    <label>Weight (kg):</label>
                    <input type="number" id="bmi-weight" placeholder="70" step="0.1">
                </div>
                <div class="calc-input-group">
                    <label>Height (cm):</label>
                    <input type="number" id="bmi-height" placeholder="175" step="0.1">
                </div>
                <div class="calc-input-group">
                    <label>Waist Circumference (cm) - Optional:</label>
                    <input type="number" id="bmi-waist" placeholder="85" step="0.1">
                </div>
                <div class="calc-input-group">
                    <label>Ethnicity:</label>
                    <select id="bmi-ethnicity">
                        <option value="european">European/Caucasian</option>
                        <option value="asian">Asian (Chinese, Japanese, South Asian)</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="calc-checkbox-group">
                    <label><input type="radio" name="bmi-sex" value="male"> Male</label>
                    <label><input type="radio" name="bmi-sex" value="female"> Female</label>
                </div>
                <button onclick="window.quizApp.calculateBMI()">Calculate</button>
                <div id="bmi-result" class="calc-result"></div>
                <div class="calc-reference">
                    <small>
                        <strong>BMI Categories (WHO):</strong><br>
                        Underweight: &lt;18.5 | Normal: 18.5-24.9<br>
                        Overweight: 25-29.9 | Obese: ‚â•30<br>
                        <strong>Asian populations:</strong> Overweight ‚â•23, Obese ‚â•27.5
                    </small>
                </div>
            </div>
        `;
    }

    getFrailtyCalculator() {
        return `
            <div class="calculator-form">
                <h4>Clinical Frailty Scale (Rockwood)</h4>
                <p><small>Select the category that best matches the patient</small></p>
                <div class="calc-input-group" id="frailty-options-detail">
                    <select id="frailty-select">
                        <option value="">-- Select frailty score --</option>
                        <option value="1">1 ‚Äî Very fit</option>
                        <option value="2">2 ‚Äî Well</option>
                        <option value="3">3 ‚Äî Managing well</option>
                        <option value="4">4 ‚Äî Vulnerable</option>
                        <option value="5">5 ‚Äî Mildly frail</option>
                        <option value="6">6 ‚Äî Moderately frail</option>
                        <option value="7">7 ‚Äî Severely frail</option>
                        <option value="8">8 ‚Äî Very severely frail</option>
                        <option value="9">9 ‚Äî Terminally ill</option>
                    </select>
                </div>
                <button onclick="window.quizApp.calculateFrailty()">Calculate</button>
                <div id="frailty-detail-result" class="calc-result"></div>
                <div class="calc-reference"><small>Rockwood Clinical Frailty Scale (1‚Äì9): use as an aid to clinical judgement.</small></div>
            </div>
        `;
    }

    calculateFrailty() {
        const sel = document.getElementById('frailty-select');
        const out = document.getElementById('frailty-detail-result');
        if (!sel || !out) return;
        const val = sel.value;
        if (!val) {
            out.innerHTML = '<p class="error">Please select a frailty score</p>';
            return;
        }
        const descriptions = {
            1: 'Very fit ‚Äî robust, active, energetic and motivated. Typically exercises regularly.',
            2: 'Well ‚Äî no active disease symptoms but less fit than category 1.',
            3: 'Managing well ‚Äî medical problems are well controlled, not regularly active beyond routine activities.',
            4: 'Vulnerable ‚Äî not dependent on others for daily help, but symptoms limit activities.',
            5: 'Mildly frail ‚Äî evident slowing and need help in high order instrumental activities of daily living.',
            6: 'Moderately frail ‚Äî need help with all outside activities and with keeping house.',
            7: 'Severely frail ‚Äî completely dependent for personal care, but stable and not at high risk of dying within 6 months.',
            8: 'Very severely frail ‚Äî completely dependent, approaching the end of life. Typically approaching high risk of dying.',
            9: 'Terminally ill ‚Äî life expectancy <6 months, not otherwise evidently frail.'
        };
        const guidance = (n) => {
            const num = parseInt(n, 10);
            if (num <= 3) return 'Not frail ‚Äî encourage activity and prevention.';
            if (num === 4) return 'Pre-frail/vulnerable ‚Äî consider targeted interventions (exercise, medication review).';
            if (num >=5 && num <=6) return 'Frailty present ‚Äî consider CGA, falls review and medication optimisation.';
            return 'High dependency ‚Äî prioritise care needs, consider palliative needs assessment where appropriate.';
        };

        out.innerHTML = `
            <div>
                <strong>Score: ${val}</strong>
                <div style="margin-top:8px">${descriptions[val]}</div>
                <div style="margin-top:8px;color:#374151;font-weight:600">${guidance(val)}</div>
            </div>
        `;
    }

    getBarthelCalculator() {
        return `
            <div class="calculator-form">
                <h4>Barthel Index (ADL)</h4>
                <p><small>Complete the items and press Calculate</small></p>
                <div class="calc-input-group" id="barthel-detail-items">
                    <!-- Simplified form: items named to match common Barthel scoring -->
                    <label>Feeding: <select id="b-feeding"><option value="0">Dependent (0)</option><option value="5">Needs assistance (5)</option><option value="10">Independent (10)</option></select></label>
                    <label>Bathing: <select id="b-bathing"><option value="0">Dependent (0)</option><option value="5">Independent (5)</option></select></label>
                    <label>Grooming: <select id="b-grooming"><option value="0">Needs help (0)</option><option value="5">Independent (5)</option></select></label>
                    <label>Dressing: <select id="b-dressing"><option value="0">Dependent (0)</option><option value="5">Needs help (5)</option><option value="10">Independent (10)</option></select></label>
                    <label>Bowels: <select id="b-bowels"><option value="0">Incontinent (0)</option><option value="5">Occasional accident (5)</option><option value="10">Continent (10)</option></select></label>
                    <label>Bladder: <select id="b-bladder"><option value="0">Incontinent (0)</option><option value="5">Occasional accident (5)</option><option value="10">Continent (10)</option></select></label>
                    <label>Toilet use: <select id="b-toilet"><option value="0">Dependent (0)</option><option value="5">Needs some help (5)</option><option value="10">Independent (10)</option></select></label>
                    <label>Transfers (bed-chair): <select id="b-transfers"><option value="0">Dependent (0)</option><option value="5">Major help (5)</option><option value="10">Minor help (10)</option><option value="15">Independent (15)</option></select></label>
                    <label>Mobility (level): <select id="b-mobility"><option value="0">Dependent (0)</option><option value="5">Immobile (5)</option><option value="10">Walks with help (10)</option><option value="15">Independent (15)</option></select></label>
                    <label>Stairs: <select id="b-stairs"><option value="0">Unable (0)</option><option value="5">Needs help (5)</option><option value="10">Independent (10)</option></select></label>
                </div>
                <button onclick="window.quizApp.calculateBarthel()">Calculate</button>
                <div id="barthel-detail-result" class="calc-result"></div>
                <div class="calc-reference"><small>Score 0-100. Higher scores indicate greater independence.</small></div>
            </div>
        `;
    }

    calculateBarthel() {
        const ids = ['b-feeding','b-bathing','b-grooming','b-dressing','b-bowels','b-bladder','b-toilet','b-transfers','b-mobility','b-stairs'];
        let total = 0;
        ids.forEach(id => {
            const el = document.getElementById(id);
            if (el) total += parseInt(el.value, 10) || 0;
        });
        let interpretation = 'Total dependency';
        if (total === 100) interpretation = 'Independent';
        else if (total >= 91) interpretation = 'Slight dependency';
        else if (total >= 61) interpretation = 'Moderate dependency';
        else if (total >= 21) interpretation = 'Severe dependency';
        document.getElementById('barthel-detail-result').innerHTML = `
            <div>
                <strong>Barthel Total: ${total} / 100</strong>
                <div style="margin-top:8px">Interpretation: ${interpretation}</div>
            </div>
        `;
    }

    calculateBMI() {
        const weight = parseFloat(document.getElementById('bmi-weight').value);
        const height = parseFloat(document.getElementById('bmi-height').value) / 100; // Convert cm to m
        const waist = parseFloat(document.getElementById('bmi-waist').value);
        const ethnicity = document.getElementById('bmi-ethnicity').value;
        const sex = document.querySelector('input[name="bmi-sex"]:checked')?.value;


// ========================================
// CorrectedCalcium (lines 5151-5551)
// ========================================
                calculatorContent += this.getGlasgowBlatchfordCalculator();
                break;
        }
        calculatorContent = calculatorContent.replace('<h3 id="calculator-title"></h3>', `<h3 id="calculator-title">${calculatorTitle}</h3>`);
        container.innerHTML = calculatorContent;
        // Attach export buttons to results and per-calculator notes area
        try {
            // Ensure export features are available across calc-result blocks
            if (typeof this.setupExportFeatures === 'function') {
                this.setupExportFeatures();
            }
            // Add notes area for this calculator (persisted via localStorage)
            if (typeof this.setupCalculatorNotes === 'function') {
                this.setupCalculatorNotes(calcType);
            }
        } catch (err) {
            console.warn('‚ö†Ô∏è Failed to setup export/features or notes for calculator:', err);
        }
        console.log('üßÆ Loaded calculator:', calcType);
    }
    getBMICalculator() {
        return `
            <div class="calculator-form">
                <h4>BMI & Waist Circumference Calculator</h4>
                <div class="calc-input-group">
                    <label>Weight (kg):</label>
                    <input type="number" id="bmi-weight" placeholder="70" step="0.1">
                </div>
                <div class="calc-input-group">
                    <label>Height (cm):</label>
                    <input type="number" id="bmi-height" placeholder="175" step="0.1">
                </div>
                <div class="calc-input-group">
                    <label>Waist Circumference (cm) - Optional:</label>
                    <input type="number" id="bmi-waist" placeholder="85" step="0.1">
                </div>
                <div class="calc-input-group">
                    <label>Ethnicity:</label>
                    <select id="bmi-ethnicity">
                        <option value="european">European/Caucasian</option>
                        <option value="asian">Asian (Chinese, Japanese, South Asian)</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="calc-checkbox-group">
                    <label><input type="radio" name="bmi-sex" value="male"> Male</label>
                    <label><input type="radio" name="bmi-sex" value="female"> Female</label>
                </div>
                <button onclick="window.quizApp.calculateBMI()">Calculate</button>
                <div id="bmi-result" class="calc-result"></div>
                <div class="calc-reference">
                    <small>
                        <strong>BMI Categories (WHO):</strong><br>
                        Underweight: &lt;18.5 | Normal: 18.5-24.9<br>
                        Overweight: 25-29.9 | Obese: ‚â•30<br>
                        <strong>Asian populations:</strong> Overweight ‚â•23, Obese ‚â•27.5
                    </small>
                </div>
            </div>
        `;
    }

    getFrailtyCalculator() {
        return `
            <div class="calculator-form">
                <h4>Clinical Frailty Scale (Rockwood)</h4>
                <p><small>Select the category that best matches the patient</small></p>
                <div class="calc-input-group" id="frailty-options-detail">
                    <select id="frailty-select">
                        <option value="">-- Select frailty score --</option>
                        <option value="1">1 ‚Äî Very fit</option>
                        <option value="2">2 ‚Äî Well</option>
                        <option value="3">3 ‚Äî Managing well</option>
                        <option value="4">4 ‚Äî Vulnerable</option>
                        <option value="5">5 ‚Äî Mildly frail</option>
                        <option value="6">6 ‚Äî Moderately frail</option>
                        <option value="7">7 ‚Äî Severely frail</option>
                        <option value="8">8 ‚Äî Very severely frail</option>
                        <option value="9">9 ‚Äî Terminally ill</option>
                    </select>
                </div>
                <button onclick="window.quizApp.calculateFrailty()">Calculate</button>
                <div id="frailty-detail-result" class="calc-result"></div>
                <div class="calc-reference"><small>Rockwood Clinical Frailty Scale (1‚Äì9): use as an aid to clinical judgement.</small></div>
            </div>
        `;
    }

    calculateFrailty() {
        const sel = document.getElementById('frailty-select');
        const out = document.getElementById('frailty-detail-result');
        if (!sel || !out) return;
        const val = sel.value;
        if (!val) {
            out.innerHTML = '<p class="error">Please select a frailty score</p>';
            return;
        }
        const descriptions = {
            1: 'Very fit ‚Äî robust, active, energetic and motivated. Typically exercises regularly.',
            2: 'Well ‚Äî no active disease symptoms but less fit than category 1.',
            3: 'Managing well ‚Äî medical problems are well controlled, not regularly active beyond routine activities.',
            4: 'Vulnerable ‚Äî not dependent on others for daily help, but symptoms limit activities.',
            5: 'Mildly frail ‚Äî evident slowing and need help in high order instrumental activities of daily living.',
            6: 'Moderately frail ‚Äî need help with all outside activities and with keeping house.',
            7: 'Severely frail ‚Äî completely dependent for personal care, but stable and not at high risk of dying within 6 months.',
            8: 'Very severely frail ‚Äî completely dependent, approaching the end of life. Typically approaching high risk of dying.',
            9: 'Terminally ill ‚Äî life expectancy <6 months, not otherwise evidently frail.'
        };
        const guidance = (n) => {
            const num = parseInt(n, 10);
            if (num <= 3) return 'Not frail ‚Äî encourage activity and prevention.';
            if (num === 4) return 'Pre-frail/vulnerable ‚Äî consider targeted interventions (exercise, medication review).';
            if (num >=5 && num <=6) return 'Frailty present ‚Äî consider CGA, falls review and medication optimisation.';
            return 'High dependency ‚Äî prioritise care needs, consider palliative needs assessment where appropriate.';
        };

        out.innerHTML = `
            <div>
                <strong>Score: ${val}</strong>
                <div style="margin-top:8px">${descriptions[val]}</div>
                <div style="margin-top:8px;color:#374151;font-weight:600">${guidance(val)}</div>
            </div>
        `;
    }

    getBarthelCalculator() {
        return `
            <div class="calculator-form">
                <h4>Barthel Index (ADL)</h4>
                <p><small>Complete the items and press Calculate</small></p>
                <div class="calc-input-group" id="barthel-detail-items">
                    <!-- Simplified form: items named to match common Barthel scoring -->
                    <label>Feeding: <select id="b-feeding"><option value="0">Dependent (0)</option><option value="5">Needs assistance (5)</option><option value="10">Independent (10)</option></select></label>
                    <label>Bathing: <select id="b-bathing"><option value="0">Dependent (0)</option><option value="5">Independent (5)</option></select></label>
                    <label>Grooming: <select id="b-grooming"><option value="0">Needs help (0)</option><option value="5">Independent (5)</option></select></label>
                    <label>Dressing: <select id="b-dressing"><option value="0">Dependent (0)</option><option value="5">Needs help (5)</option><option value="10">Independent (10)</option></select></label>
                    <label>Bowels: <select id="b-bowels"><option value="0">Incontinent (0)</option><option value="5">Occasional accident (5)</option><option value="10">Continent (10)</option></select></label>
                    <label>Bladder: <select id="b-bladder"><option value="0">Incontinent (0)</option><option value="5">Occasional accident (5)</option><option value="10">Continent (10)</option></select></label>
                    <label>Toilet use: <select id="b-toilet"><option value="0">Dependent (0)</option><option value="5">Needs some help (5)</option><option value="10">Independent (10)</option></select></label>
                    <label>Transfers (bed-chair): <select id="b-transfers"><option value="0">Dependent (0)</option><option value="5">Major help (5)</option><option value="10">Minor help (10)</option><option value="15">Independent (15)</option></select></label>
                    <label>Mobility (level): <select id="b-mobility"><option value="0">Dependent (0)</option><option value="5">Immobile (5)</option><option value="10">Walks with help (10)</option><option value="15">Independent (15)</option></select></label>
                    <label>Stairs: <select id="b-stairs"><option value="0">Unable (0)</option><option value="5">Needs help (5)</option><option value="10">Independent (10)</option></select></label>
                </div>
                <button onclick="window.quizApp.calculateBarthel()">Calculate</button>
                <div id="barthel-detail-result" class="calc-result"></div>
                <div class="calc-reference"><small>Score 0-100. Higher scores indicate greater independence.</small></div>
            </div>
        `;
    }

    calculateBarthel() {
        const ids = ['b-feeding','b-bathing','b-grooming','b-dressing','b-bowels','b-bladder','b-toilet','b-transfers','b-mobility','b-stairs'];
        let total = 0;
        ids.forEach(id => {
            const el = document.getElementById(id);
            if (el) total += parseInt(el.value, 10) || 0;
        });
        let interpretation = 'Total dependency';
        if (total === 100) interpretation = 'Independent';
        else if (total >= 91) interpretation = 'Slight dependency';
        else if (total >= 61) interpretation = 'Moderate dependency';
        else if (total >= 21) interpretation = 'Severe dependency';
        document.getElementById('barthel-detail-result').innerHTML = `
            <div>
                <strong>Barthel Total: ${total} / 100</strong>
                <div style="margin-top:8px">Interpretation: ${interpretation}</div>
            </div>
        `;
    }

    calculateBMI() {
        const weight = parseFloat(document.getElementById('bmi-weight').value);
        const height = parseFloat(document.getElementById('bmi-height').value) / 100; // Convert cm to m
        const waist = parseFloat(document.getElementById('bmi-waist').value);
        const ethnicity = document.getElementById('bmi-ethnicity').value;
        const sex = document.querySelector('input[name="bmi-sex"]:checked')?.value;
        
        if (!weight || !height) {
            document.getElementById('bmi-result').innerHTML = '<p class="error">Please enter valid weight and height</p>';
            return;
        }
        
        const bmi = weight / (height * height);
        let category = '';
        let color = '';
        let healthRisk = '';
        
        // Ethnic-specific BMI thresholds
        let overweightThreshold = 25;
        let obeseThreshold = 30;
        
        if (ethnicity === 'asian') {
            overweightThreshold = 23;
            obeseThreshold = 27.5;
        }
        
        if (bmi < 18.5) {
            category = 'Underweight';
            color = '#2196F3';
            healthRisk = 'Increased risk: nutritional deficiency, osteoporosis, immune dysfunction';
        } else if (bmi < overweightThreshold) {
            category = 'Normal weight';
            color = '#4CAF50';
            healthRisk = 'Optimal health risk profile';
        } else if (bmi < obeseThreshold) {
            category = 'Overweight';
            color = '#FF9800';
            healthRisk = 'Increased risk: diabetes, cardiovascular disease, sleep apnoea';
        } else if (bmi < 35) {
            category = 'Obese Class I';
            color = '#F44336';
            healthRisk = 'High risk: diabetes, CVD, stroke, certain cancers';
        } else if (bmi < 40) {
            category = 'Obese Class II';
            color = '#D32F2F';
            healthRisk = 'Very high risk: consider bariatric surgery consultation';
        } else {
            category = 'Obese Class III';
            color = '#B71C1C';
            healthRisk = 'Extremely high risk: urgent weight management, consider bariatric surgery';
        }
        
        // Waist circumference assessment
        let waistAssessment = '';
        if (waist && sex) {
            let waistRisk = '';
            let waistColor = '#4CAF50';
            
            if (sex === 'male') {
                if (waist >= 102) {
                    waistRisk = 'Very high risk';
                    waistColor = '#F44336';
                } else if (waist >= 94) {
                    waistRisk = 'Increased risk';
                    waistColor = '#FF9800';
                } else {
                    waistRisk = 'Low risk';
                }
            } else {
                if (waist >= 88) {
                    waistRisk = 'Very high risk';
                    waistColor = '#F44336';
                } else if (waist >= 80) {
                    waistRisk = 'Increased risk';
                    waistColor = '#FF9800';
                } else {
                    waistRisk = 'Low risk';
                }
            }
            
            waistAssessment = `
                <div style="margin-top: 8px; padding: 6px; background: #f5f5f5; border-radius: 4px;">
                    <strong>Waist Circumference:</strong> ${waist} cm<br>
                    <span style="color: ${waistColor}; font-weight: bold;">${waistRisk}</span> for metabolic complications
                </div>
            `;
        }
        
        document.getElementById('bmi-result').innerHTML = `
            <div class="bmi-result-display">
                <div class="bmi-value" style="color: ${color}; font-size: 1.2em;">
                    <strong>BMI: ${bmi.toFixed(1)} kg/m¬≤</strong>
                </div>
                <div class="bmi-category" style="color: ${color}; font-weight: bold; margin: 4px 0;">
                    ${category}
                </div>
                <div style="margin-top: 8px; font-size: 0.9em; color: #666;">
                    ${healthRisk}
                </div>
                ${waistAssessment}
                <div style="margin-top: 8px; font-size: 0.8em; color: #666;">
                    ${ethnicity === 'asian' ? 'Using Asian-specific BMI thresholds' : 'Using WHO BMI thresholds'}
                </div>
            </div>
        `;
    }

    getCHADS2VAScCalculator() {
        return `
            <div class="calculator-form">
                <h4>CHA‚ÇÇDS‚ÇÇ-VASc Score</h4>
                <p><small>Stroke risk assessment in atrial fibrillation</small></p>
                
                <div class="calc-checkbox-group">
                    <label><input type="checkbox" id="chads-chf"> Congestive heart failure (+1)</label>
                    <label><input type="checkbox" id="chads-htn"> Hypertension (+1)</label>
                    <label><input type="checkbox" id="chads-age75"> Age ‚â•75 years (+2)</label>
                    <label><input type="checkbox" id="chads-diabetes"> Diabetes mellitus (+1)</label>
                    <label><input type="checkbox" id="chads-stroke"> Stroke/TIA/thromboembolism (+2)</label>
                    <label><input type="checkbox" id="chads-vascular"> Vascular disease (+1)</label>
                    <label><input type="checkbox" id="chads-age65"> Age 65-74 years (+1)</label>
                    <label><input type="checkbox" id="chads-female"> Female sex (+1)</label>
                </div>
                
                <button onclick="window.quizApp.calculateCHADS2VASc()">Calculate Score</button>
                <div id="chads-result" class="calc-result"></div>
            </div>
        `;
    }

    calculateCHADS2VASc() {
        let score = 0;
        
        if (document.getElementById('chads-chf').checked) score += 1;
        if (document.getElementById('chads-htn').checked) score += 1;
        if (document.getElementById('chads-age75').checked) score += 2;
        if (document.getElementById('chads-diabetes').checked) score += 1;
        if (document.getElementById('chads-stroke').checked) score += 2;
        if (document.getElementById('chads-vascular').checked) score += 1;
        if (document.getElementById('chads-age65').checked) score += 1;
        
        const isFemale = document.getElementById('chads-female').checked;
        if (isFemale) score += 1;
        
        let risk = '';
        let recommendation = '';
        let color = '';
        
        // Updated UK guidelines: sex-specific treatment recommendations
        if (score === 0) {
            risk = 'Low risk (0.2%/year)';
            recommendation = 'No anticoagulation recommended';
            color = '#4CAF50';
        } else if (score === 1) {
            if (isFemale && score === 1) {
                // Female with score 1 (sex alone) - special case
                risk = 'Low-moderate risk (0.6%/year)';
                recommendation = 'Female sex alone: generally no anticoagulation. Consider other risk factors';
                color = '#FF9800';
            } else {
                // Male with score 1 or female with other risk factors
                risk = 'Low-moderate risk (0.6%/year)';
                recommendation = 'Consider anticoagulation (men ‚â•1 or women ‚â•2 with non-sex risk factors)';
                color = '#FF9800';
            }
        } else {
            // Score ‚â•2
            risk = 'High risk (‚â•2.2%/year)';
            recommendation = 'Anticoagulation recommended unless contraindicated';
            color = '#F44336';
        }
        
        document.getElementById('chads-result').innerHTML = `
            <div class="score-result">
                <div class="score-value" style="color: ${color}">
                    Score: <strong>${score}</strong>
                </div>
                <div class="score-risk">${risk}</div>
                <div class="score-recommendation" style="color: ${color}">
                    <strong>${recommendation}</strong>
                </div>
                <div style="margin-top: 8px; font-size: 0.8em; color: #666;">
                    Based on current UK guidelines. Consider individual bleeding risk (HAS-BLED).
                </div>
            </div>
        `;
    }

    getHASBLEDCalculator() {
        return `


// ========================================
// CorrectedSodium (lines 5115-5515)
// ========================================
                calculatorContent += this.getAnionGapCalculator();
                break;
        }
        calculatorContent = calculatorContent.replace('<h3 id="calculator-title"></h3>', `<h3 id="calculator-title">${calculatorTitle}</h3>`);
        container.innerHTML = calculatorContent;
        // Attach export buttons to results and per-calculator notes area
        try {
            // Ensure export features are available across calc-result blocks
            if (typeof this.setupExportFeatures === 'function') {
                this.setupExportFeatures();
            }
            // Add notes area for this calculator (persisted via localStorage)
            if (typeof this.setupCalculatorNotes === 'function') {
                this.setupCalculatorNotes(calcType);
            }
        } catch (err) {
            console.warn('‚ö†Ô∏è Failed to setup export/features or notes for calculator:', err);
        }
        console.log('üßÆ Loaded calculator:', calcType);
    }
    getBMICalculator() {
        return `
            <div class="calculator-form">
                <h4>BMI & Waist Circumference Calculator</h4>
                <div class="calc-input-group">
                    <label>Weight (kg):</label>
                    <input type="number" id="bmi-weight" placeholder="70" step="0.1">
                </div>
                <div class="calc-input-group">
                    <label>Height (cm):</label>
                    <input type="number" id="bmi-height" placeholder="175" step="0.1">
                </div>
                <div class="calc-input-group">
                    <label>Waist Circumference (cm) - Optional:</label>
                    <input type="number" id="bmi-waist" placeholder="85" step="0.1">
                </div>
                <div class="calc-input-group">
                    <label>Ethnicity:</label>
                    <select id="bmi-ethnicity">
                        <option value="european">European/Caucasian</option>
                        <option value="asian">Asian (Chinese, Japanese, South Asian)</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="calc-checkbox-group">
                    <label><input type="radio" name="bmi-sex" value="male"> Male</label>
                    <label><input type="radio" name="bmi-sex" value="female"> Female</label>
                </div>
                <button onclick="window.quizApp.calculateBMI()">Calculate</button>
                <div id="bmi-result" class="calc-result"></div>
                <div class="calc-reference">
                    <small>
                        <strong>BMI Categories (WHO):</strong><br>
                        Underweight: &lt;18.5 | Normal: 18.5-24.9<br>
                        Overweight: 25-29.9 | Obese: ‚â•30<br>
                        <strong>Asian populations:</strong> Overweight ‚â•23, Obese ‚â•27.5
                    </small>
                </div>
            </div>
        `;
    }

    getFrailtyCalculator() {
        return `
            <div class="calculator-form">
                <h4>Clinical Frailty Scale (Rockwood)</h4>
                <p><small>Select the category that best matches the patient</small></p>
                <div class="calc-input-group" id="frailty-options-detail">
                    <select id="frailty-select">
                        <option value="">-- Select frailty score --</option>
                        <option value="1">1 ‚Äî Very fit</option>
                        <option value="2">2 ‚Äî Well</option>
                        <option value="3">3 ‚Äî Managing well</option>
                        <option value="4">4 ‚Äî Vulnerable</option>
                        <option value="5">5 ‚Äî Mildly frail</option>
                        <option value="6">6 ‚Äî Moderately frail</option>
                        <option value="7">7 ‚Äî Severely frail</option>
                        <option value="8">8 ‚Äî Very severely frail</option>
                        <option value="9">9 ‚Äî Terminally ill</option>
                    </select>
                </div>
                <button onclick="window.quizApp.calculateFrailty()">Calculate</button>
                <div id="frailty-detail-result" class="calc-result"></div>
                <div class="calc-reference"><small>Rockwood Clinical Frailty Scale (1‚Äì9): use as an aid to clinical judgement.</small></div>
            </div>
        `;
    }

    calculateFrailty() {
        const sel = document.getElementById('frailty-select');
        const out = document.getElementById('frailty-detail-result');
        if (!sel || !out) return;
        const val = sel.value;
        if (!val) {
            out.innerHTML = '<p class="error">Please select a frailty score</p>';
            return;
        }
        const descriptions = {
            1: 'Very fit ‚Äî robust, active, energetic and motivated. Typically exercises regularly.',
            2: 'Well ‚Äî no active disease symptoms but less fit than category 1.',
            3: 'Managing well ‚Äî medical problems are well controlled, not regularly active beyond routine activities.',
            4: 'Vulnerable ‚Äî not dependent on others for daily help, but symptoms limit activities.',
            5: 'Mildly frail ‚Äî evident slowing and need help in high order instrumental activities of daily living.',
            6: 'Moderately frail ‚Äî need help with all outside activities and with keeping house.',
            7: 'Severely frail ‚Äî completely dependent for personal care, but stable and not at high risk of dying within 6 months.',
            8: 'Very severely frail ‚Äî completely dependent, approaching the end of life. Typically approaching high risk of dying.',
            9: 'Terminally ill ‚Äî life expectancy <6 months, not otherwise evidently frail.'
        };
        const guidance = (n) => {
            const num = parseInt(n, 10);
            if (num <= 3) return 'Not frail ‚Äî encourage activity and prevention.';
            if (num === 4) return 'Pre-frail/vulnerable ‚Äî consider targeted interventions (exercise, medication review).';
            if (num >=5 && num <=6) return 'Frailty present ‚Äî consider CGA, falls review and medication optimisation.';
            return 'High dependency ‚Äî prioritise care needs, consider palliative needs assessment where appropriate.';
        };

        out.innerHTML = `
            <div>
                <strong>Score: ${val}</strong>
                <div style="margin-top:8px">${descriptions[val]}</div>
                <div style="margin-top:8px;color:#374151;font-weight:600">${guidance(val)}</div>
            </div>
        `;
    }

    getBarthelCalculator() {
        return `
            <div class="calculator-form">
                <h4>Barthel Index (ADL)</h4>
                <p><small>Complete the items and press Calculate</small></p>
                <div class="calc-input-group" id="barthel-detail-items">
                    <!-- Simplified form: items named to match common Barthel scoring -->
                    <label>Feeding: <select id="b-feeding"><option value="0">Dependent (0)</option><option value="5">Needs assistance (5)</option><option value="10">Independent (10)</option></select></label>
                    <label>Bathing: <select id="b-bathing"><option value="0">Dependent (0)</option><option value="5">Independent (5)</option></select></label>
                    <label>Grooming: <select id="b-grooming"><option value="0">Needs help (0)</option><option value="5">Independent (5)</option></select></label>
                    <label>Dressing: <select id="b-dressing"><option value="0">Dependent (0)</option><option value="5">Needs help (5)</option><option value="10">Independent (10)</option></select></label>
                    <label>Bowels: <select id="b-bowels"><option value="0">Incontinent (0)</option><option value="5">Occasional accident (5)</option><option value="10">Continent (10)</option></select></label>
                    <label>Bladder: <select id="b-bladder"><option value="0">Incontinent (0)</option><option value="5">Occasional accident (5)</option><option value="10">Continent (10)</option></select></label>
                    <label>Toilet use: <select id="b-toilet"><option value="0">Dependent (0)</option><option value="5">Needs some help (5)</option><option value="10">Independent (10)</option></select></label>
                    <label>Transfers (bed-chair): <select id="b-transfers"><option value="0">Dependent (0)</option><option value="5">Major help (5)</option><option value="10">Minor help (10)</option><option value="15">Independent (15)</option></select></label>
                    <label>Mobility (level): <select id="b-mobility"><option value="0">Dependent (0)</option><option value="5">Immobile (5)</option><option value="10">Walks with help (10)</option><option value="15">Independent (15)</option></select></label>
                    <label>Stairs: <select id="b-stairs"><option value="0">Unable (0)</option><option value="5">Needs help (5)</option><option value="10">Independent (10)</option></select></label>
                </div>
                <button onclick="window.quizApp.calculateBarthel()">Calculate</button>
                <div id="barthel-detail-result" class="calc-result"></div>
                <div class="calc-reference"><small>Score 0-100. Higher scores indicate greater independence.</small></div>
            </div>
        `;
    }

    calculateBarthel() {
        const ids = ['b-feeding','b-bathing','b-grooming','b-dressing','b-bowels','b-bladder','b-toilet','b-transfers','b-mobility','b-stairs'];
        let total = 0;
        ids.forEach(id => {
            const el = document.getElementById(id);
            if (el) total += parseInt(el.value, 10) || 0;
        });
        let interpretation = 'Total dependency';
        if (total === 100) interpretation = 'Independent';
        else if (total >= 91) interpretation = 'Slight dependency';
        else if (total >= 61) interpretation = 'Moderate dependency';
        else if (total >= 21) interpretation = 'Severe dependency';
        document.getElementById('barthel-detail-result').innerHTML = `
            <div>
                <strong>Barthel Total: ${total} / 100</strong>
                <div style="margin-top:8px">Interpretation: ${interpretation}</div>
            </div>
        `;
    }

    calculateBMI() {
        const weight = parseFloat(document.getElementById('bmi-weight').value);
        const height = parseFloat(document.getElementById('bmi-height').value) / 100; // Convert cm to m
        const waist = parseFloat(document.getElementById('bmi-waist').value);
        const ethnicity = document.getElementById('bmi-ethnicity').value;
        const sex = document.querySelector('input[name="bmi-sex"]:checked')?.value;
        
        if (!weight || !height) {
            document.getElementById('bmi-result').innerHTML = '<p class="error">Please enter valid weight and height</p>';
            return;
        }
        
        const bmi = weight / (height * height);
        let category = '';
        let color = '';
        let healthRisk = '';
        
        // Ethnic-specific BMI thresholds
        let overweightThreshold = 25;
        let obeseThreshold = 30;
        
        if (ethnicity === 'asian') {
            overweightThreshold = 23;
            obeseThreshold = 27.5;
        }
        
        if (bmi < 18.5) {
            category = 'Underweight';
            color = '#2196F3';
            healthRisk = 'Increased risk: nutritional deficiency, osteoporosis, immune dysfunction';
        } else if (bmi < overweightThreshold) {
            category = 'Normal weight';
            color = '#4CAF50';
            healthRisk = 'Optimal health risk profile';
        } else if (bmi < obeseThreshold) {
            category = 'Overweight';
            color = '#FF9800';
            healthRisk = 'Increased risk: diabetes, cardiovascular disease, sleep apnoea';
        } else if (bmi < 35) {
            category = 'Obese Class I';
            color = '#F44336';
            healthRisk = 'High risk: diabetes, CVD, stroke, certain cancers';
        } else if (bmi < 40) {
            category = 'Obese Class II';
            color = '#D32F2F';
            healthRisk = 'Very high risk: consider bariatric surgery consultation';
        } else {
            category = 'Obese Class III';
            color = '#B71C1C';
            healthRisk = 'Extremely high risk: urgent weight management, consider bariatric surgery';
        }
        
        // Waist circumference assessment
        let waistAssessment = '';
        if (waist && sex) {
            let waistRisk = '';
            let waistColor = '#4CAF50';
            
            if (sex === 'male') {
                if (waist >= 102) {
                    waistRisk = 'Very high risk';
                    waistColor = '#F44336';
                } else if (waist >= 94) {
                    waistRisk = 'Increased risk';
                    waistColor = '#FF9800';
                } else {
                    waistRisk = 'Low risk';
                }
            } else {
                if (waist >= 88) {
                    waistRisk = 'Very high risk';
                    waistColor = '#F44336';
                } else if (waist >= 80) {
                    waistRisk = 'Increased risk';
                    waistColor = '#FF9800';
                } else {
                    waistRisk = 'Low risk';
                }
            }
            
            waistAssessment = `
                <div style="margin-top: 8px; padding: 6px; background: #f5f5f5; border-radius: 4px;">
                    <strong>Waist Circumference:</strong> ${waist} cm<br>
                    <span style="color: ${waistColor}; font-weight: bold;">${waistRisk}</span> for metabolic complications
                </div>
            `;
        }
        
        document.getElementById('bmi-result').innerHTML = `
            <div class="bmi-result-display">
                <div class="bmi-value" style="color: ${color}; font-size: 1.2em;">
                    <strong>BMI: ${bmi.toFixed(1)} kg/m¬≤</strong>
                </div>
                <div class="bmi-category" style="color: ${color}; font-weight: bold; margin: 4px 0;">
                    ${category}
                </div>
                <div style="margin-top: 8px; font-size: 0.9em; color: #666;">
                    ${healthRisk}
                </div>
                ${waistAssessment}
                <div style="margin-top: 8px; font-size: 0.8em; color: #666;">
                    ${ethnicity === 'asian' ? 'Using Asian-specific BMI thresholds' : 'Using WHO BMI thresholds'}
                </div>
            </div>
        `;
    }

    getCHADS2VAScCalculator() {
        return `
            <div class="calculator-form">
                <h4>CHA‚ÇÇDS‚ÇÇ-VASc Score</h4>
                <p><small>Stroke risk assessment in atrial fibrillation</small></p>
                
                <div class="calc-checkbox-group">
                    <label><input type="checkbox" id="chads-chf"> Congestive heart failure (+1)</label>
                    <label><input type="checkbox" id="chads-htn"> Hypertension (+1)</label>
                    <label><input type="checkbox" id="chads-age75"> Age ‚â•75 years (+2)</label>
                    <label><input type="checkbox" id="chads-diabetes"> Diabetes mellitus (+1)</label>
                    <label><input type="checkbox" id="chads-stroke"> Stroke/TIA/thromboembolism (+2)</label>
                    <label><input type="checkbox" id="chads-vascular"> Vascular disease (+1)</label>
                    <label><input type="checkbox" id="chads-age65"> Age 65-74 years (+1)</label>
                    <label><input type="checkbox" id="chads-female"> Female sex (+1)</label>
                </div>
                
                <button onclick="window.quizApp.calculateCHADS2VASc()">Calculate Score</button>
                <div id="chads-result" class="calc-result"></div>
            </div>
        `;
    }

    calculateCHADS2VASc() {
        let score = 0;
        
        if (document.getElementById('chads-chf').checked) score += 1;
        if (document.getElementById('chads-htn').checked) score += 1;
        if (document.getElementById('chads-age75').checked) score += 2;
        if (document.getElementById('chads-diabetes').checked) score += 1;
        if (document.getElementById('chads-stroke').checked) score += 2;
        if (document.getElementById('chads-vascular').checked) score += 1;
        if (document.getElementById('chads-age65').checked) score += 1;
        
        const isFemale = document.getElementById('chads-female').checked;
        if (isFemale) score += 1;
        
        let risk = '';
        let recommendation = '';
        let color = '';
        
        // Updated UK guidelines: sex-specific treatment recommendations
        if (score === 0) {
            risk = 'Low risk (0.2%/year)';
            recommendation = 'No anticoagulation recommended';
            color = '#4CAF50';
        } else if (score === 1) {


// ========================================
// CRUSADE (lines 4999-5399)
// ========================================
                calculatorContent += this.getUreaCreatinineCalculator();
                break;
        }
        calculatorContent = calculatorContent.replace('<h3 id="calculator-title"></h3>', `<h3 id="calculator-title">${calculatorTitle}</h3>`);
        container.innerHTML = calculatorContent;
        // Attach export buttons to results and per-calculator notes area
        try {
            // Ensure export features are available across calc-result blocks
            if (typeof this.setupExportFeatures === 'function') {
                this.setupExportFeatures();
            }
            // Add notes area for this calculator (persisted via localStorage)
            if (typeof this.setupCalculatorNotes === 'function') {
                this.setupCalculatorNotes(calcType);
            }
        } catch (err) {
            console.warn('‚ö†Ô∏è Failed to setup export/features or notes for calculator:', err);
        }
        console.log('üßÆ Loaded calculator:', calcType);
    }
    getBMICalculator() {
        return `
            <div class="calculator-form">
                <h4>BMI & Waist Circumference Calculator</h4>
                <div class="calc-input-group">
                    <label>Weight (kg):</label>
                    <input type="number" id="bmi-weight" placeholder="70" step="0.1">
                </div>
                <div class="calc-input-group">
                    <label>Height (cm):</label>
                    <input type="number" id="bmi-height" placeholder="175" step="0.1">
                </div>
                <div class="calc-input-group">
                    <label>Waist Circumference (cm) - Optional:</label>
                    <input type="number" id="bmi-waist" placeholder="85" step="0.1">
                </div>
                <div class="calc-input-group">
                    <label>Ethnicity:</label>
                    <select id="bmi-ethnicity">
                        <option value="european">European/Caucasian</option>
                        <option value="asian">Asian (Chinese, Japanese, South Asian)</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="calc-checkbox-group">
                    <label><input type="radio" name="bmi-sex" value="male"> Male</label>
                    <label><input type="radio" name="bmi-sex" value="female"> Female</label>
                </div>
                <button onclick="window.quizApp.calculateBMI()">Calculate</button>
                <div id="bmi-result" class="calc-result"></div>
                <div class="calc-reference">
                    <small>
                        <strong>BMI Categories (WHO):</strong><br>
                        Underweight: &lt;18.5 | Normal: 18.5-24.9<br>
                        Overweight: 25-29.9 | Obese: ‚â•30<br>
                        <strong>Asian populations:</strong> Overweight ‚â•23, Obese ‚â•27.5
                    </small>
                </div>
            </div>
        `;
    }

    getFrailtyCalculator() {
        return `
            <div class="calculator-form">
                <h4>Clinical Frailty Scale (Rockwood)</h4>
                <p><small>Select the category that best matches the patient</small></p>
                <div class="calc-input-group" id="frailty-options-detail">
                    <select id="frailty-select">
                        <option value="">-- Select frailty score --</option>
                        <option value="1">1 ‚Äî Very fit</option>
                        <option value="2">2 ‚Äî Well</option>
                        <option value="3">3 ‚Äî Managing well</option>
                        <option value="4">4 ‚Äî Vulnerable</option>
                        <option value="5">5 ‚Äî Mildly frail</option>
                        <option value="6">6 ‚Äî Moderately frail</option>
                        <option value="7">7 ‚Äî Severely frail</option>
                        <option value="8">8 ‚Äî Very severely frail</option>
                        <option value="9">9 ‚Äî Terminally ill</option>
                    </select>
                </div>
                <button onclick="window.quizApp.calculateFrailty()">Calculate</button>
                <div id="frailty-detail-result" class="calc-result"></div>
                <div class="calc-reference"><small>Rockwood Clinical Frailty Scale (1‚Äì9): use as an aid to clinical judgement.</small></div>
            </div>
        `;
    }

    calculateFrailty() {
        const sel = document.getElementById('frailty-select');
        const out = document.getElementById('frailty-detail-result');
        if (!sel || !out) return;
        const val = sel.value;
        if (!val) {
            out.innerHTML = '<p class="error">Please select a frailty score</p>';
            return;
        }
        const descriptions = {
            1: 'Very fit ‚Äî robust, active, energetic and motivated. Typically exercises regularly.',
            2: 'Well ‚Äî no active disease symptoms but less fit than category 1.',
            3: 'Managing well ‚Äî medical problems are well controlled, not regularly active beyond routine activities.',
            4: 'Vulnerable ‚Äî not dependent on others for daily help, but symptoms limit activities.',
            5: 'Mildly frail ‚Äî evident slowing and need help in high order instrumental activities of daily living.',
            6: 'Moderately frail ‚Äî need help with all outside activities and with keeping house.',
            7: 'Severely frail ‚Äî completely dependent for personal care, but stable and not at high risk of dying within 6 months.',
            8: 'Very severely frail ‚Äî completely dependent, approaching the end of life. Typically approaching high risk of dying.',
            9: 'Terminally ill ‚Äî life expectancy <6 months, not otherwise evidently frail.'
        };
        const guidance = (n) => {
            const num = parseInt(n, 10);
            if (num <= 3) return 'Not frail ‚Äî encourage activity and prevention.';
            if (num === 4) return 'Pre-frail/vulnerable ‚Äî consider targeted interventions (exercise, medication review).';
            if (num >=5 && num <=6) return 'Frailty present ‚Äî consider CGA, falls review and medication optimisation.';
            return 'High dependency ‚Äî prioritise care needs, consider palliative needs assessment where appropriate.';
        };

        out.innerHTML = `
            <div>
                <strong>Score: ${val}</strong>
                <div style="margin-top:8px">${descriptions[val]}</div>
                <div style="margin-top:8px;color:#374151;font-weight:600">${guidance(val)}</div>
            </div>
        `;
    }

    getBarthelCalculator() {
        return `
            <div class="calculator-form">
                <h4>Barthel Index (ADL)</h4>
                <p><small>Complete the items and press Calculate</small></p>
                <div class="calc-input-group" id="barthel-detail-items">
                    <!-- Simplified form: items named to match common Barthel scoring -->
                    <label>Feeding: <select id="b-feeding"><option value="0">Dependent (0)</option><option value="5">Needs assistance (5)</option><option value="10">Independent (10)</option></select></label>
                    <label>Bathing: <select id="b-bathing"><option value="0">Dependent (0)</option><option value="5">Independent (5)</option></select></label>
                    <label>Grooming: <select id="b-grooming"><option value="0">Needs help (0)</option><option value="5">Independent (5)</option></select></label>
                    <label>Dressing: <select id="b-dressing"><option value="0">Dependent (0)</option><option value="5">Needs help (5)</option><option value="10">Independent (10)</option></select></label>
                    <label>Bowels: <select id="b-bowels"><option value="0">Incontinent (0)</option><option value="5">Occasional accident (5)</option><option value="10">Continent (10)</option></select></label>
                    <label>Bladder: <select id="b-bladder"><option value="0">Incontinent (0)</option><option value="5">Occasional accident (5)</option><option value="10">Continent (10)</option></select></label>
                    <label>Toilet use: <select id="b-toilet"><option value="0">Dependent (0)</option><option value="5">Needs some help (5)</option><option value="10">Independent (10)</option></select></label>
                    <label>Transfers (bed-chair): <select id="b-transfers"><option value="0">Dependent (0)</option><option value="5">Major help (5)</option><option value="10">Minor help (10)</option><option value="15">Independent (15)</option></select></label>
                    <label>Mobility (level): <select id="b-mobility"><option value="0">Dependent (0)</option><option value="5">Immobile (5)</option><option value="10">Walks with help (10)</option><option value="15">Independent (15)</option></select></label>
                    <label>Stairs: <select id="b-stairs"><option value="0">Unable (0)</option><option value="5">Needs help (5)</option><option value="10">Independent (10)</option></select></label>
                </div>
                <button onclick="window.quizApp.calculateBarthel()">Calculate</button>
                <div id="barthel-detail-result" class="calc-result"></div>
                <div class="calc-reference"><small>Score 0-100. Higher scores indicate greater independence.</small></div>
            </div>
        `;
    }

    calculateBarthel() {
        const ids = ['b-feeding','b-bathing','b-grooming','b-dressing','b-bowels','b-bladder','b-toilet','b-transfers','b-mobility','b-stairs'];
        let total = 0;
        ids.forEach(id => {
            const el = document.getElementById(id);
            if (el) total += parseInt(el.value, 10) || 0;
        });
        let interpretation = 'Total dependency';
        if (total === 100) interpretation = 'Independent';
        else if (total >= 91) interpretation = 'Slight dependency';
        else if (total >= 61) interpretation = 'Moderate dependency';
        else if (total >= 21) interpretation = 'Severe dependency';
        document.getElementById('barthel-detail-result').innerHTML = `
            <div>
                <strong>Barthel Total: ${total} / 100</strong>
                <div style="margin-top:8px">Interpretation: ${interpretation}</div>
            </div>
        `;
    }

    calculateBMI() {
        const weight = parseFloat(document.getElementById('bmi-weight').value);
        const height = parseFloat(document.getElementById('bmi-height').value) / 100; // Convert cm to m
        const waist = parseFloat(document.getElementById('bmi-waist').value);
        const ethnicity = document.getElementById('bmi-ethnicity').value;
        const sex = document.querySelector('input[name="bmi-sex"]:checked')?.value;
        
        if (!weight || !height) {
            document.getElementById('bmi-result').innerHTML = '<p class="error">Please enter valid weight and height</p>';
            return;
        }
        
        const bmi = weight / (height * height);
        let category = '';
        let color = '';
        let healthRisk = '';
        
        // Ethnic-specific BMI thresholds
        let overweightThreshold = 25;
        let obeseThreshold = 30;
        
        if (ethnicity === 'asian') {
            overweightThreshold = 23;
            obeseThreshold = 27.5;
        }
        
        if (bmi < 18.5) {
            category = 'Underweight';
            color = '#2196F3';
            healthRisk = 'Increased risk: nutritional deficiency, osteoporosis, immune dysfunction';
        } else if (bmi < overweightThreshold) {
            category = 'Normal weight';
            color = '#4CAF50';
            healthRisk = 'Optimal health risk profile';
        } else if (bmi < obeseThreshold) {
            category = 'Overweight';
            color = '#FF9800';
            healthRisk = 'Increased risk: diabetes, cardiovascular disease, sleep apnoea';


// ========================================
// CURB65 (lines 5039-5439)
// ========================================
                calculatorContent += this.getInsulinSlidingCalculator();
                break;
        }
        calculatorContent = calculatorContent.replace('<h3 id="calculator-title"></h3>', `<h3 id="calculator-title">${calculatorTitle}</h3>`);
        container.innerHTML = calculatorContent;
        // Attach export buttons to results and per-calculator notes area
        try {
            // Ensure export features are available across calc-result blocks
            if (typeof this.setupExportFeatures === 'function') {
                this.setupExportFeatures();
            }
            // Add notes area for this calculator (persisted via localStorage)
            if (typeof this.setupCalculatorNotes === 'function') {
                this.setupCalculatorNotes(calcType);
            }
        } catch (err) {
            console.warn('‚ö†Ô∏è Failed to setup export/features or notes for calculator:', err);
        }
        console.log('üßÆ Loaded calculator:', calcType);
    }
    getBMICalculator() {
        return `
            <div class="calculator-form">
                <h4>BMI & Waist Circumference Calculator</h4>
                <div class="calc-input-group">
                    <label>Weight (kg):</label>
                    <input type="number" id="bmi-weight" placeholder="70" step="0.1">
                </div>
                <div class="calc-input-group">
                    <label>Height (cm):</label>
                    <input type="number" id="bmi-height" placeholder="175" step="0.1">
                </div>
                <div class="calc-input-group">
                    <label>Waist Circumference (cm) - Optional:</label>
                    <input type="number" id="bmi-waist" placeholder="85" step="0.1">
                </div>
                <div class="calc-input-group">
                    <label>Ethnicity:</label>
                    <select id="bmi-ethnicity">
                        <option value="european">European/Caucasian</option>
                        <option value="asian">Asian (Chinese, Japanese, South Asian)</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="calc-checkbox-group">
                    <label><input type="radio" name="bmi-sex" value="male"> Male</label>
                    <label><input type="radio" name="bmi-sex" value="female"> Female</label>
                </div>
                <button onclick="window.quizApp.calculateBMI()">Calculate</button>
                <div id="bmi-result" class="calc-result"></div>
                <div class="calc-reference">
                    <small>
                        <strong>BMI Categories (WHO):</strong><br>
                        Underweight: &lt;18.5 | Normal: 18.5-24.9<br>
                        Overweight: 25-29.9 | Obese: ‚â•30<br>
                        <strong>Asian populations:</strong> Overweight ‚â•23, Obese ‚â•27.5
                    </small>
                </div>
            </div>
        `;
    }

    getFrailtyCalculator() {
        return `
            <div class="calculator-form">
                <h4>Clinical Frailty Scale (Rockwood)</h4>
                <p><small>Select the category that best matches the patient</small></p>
                <div class="calc-input-group" id="frailty-options-detail">
                    <select id="frailty-select">
                        <option value="">-- Select frailty score --</option>
                        <option value="1">1 ‚Äî Very fit</option>
                        <option value="2">2 ‚Äî Well</option>
                        <option value="3">3 ‚Äî Managing well</option>
                        <option value="4">4 ‚Äî Vulnerable</option>
                        <option value="5">5 ‚Äî Mildly frail</option>
                        <option value="6">6 ‚Äî Moderately frail</option>
                        <option value="7">7 ‚Äî Severely frail</option>
                        <option value="8">8 ‚Äî Very severely frail</option>
                        <option value="9">9 ‚Äî Terminally ill</option>
                    </select>
                </div>
                <button onclick="window.quizApp.calculateFrailty()">Calculate</button>
                <div id="frailty-detail-result" class="calc-result"></div>
                <div class="calc-reference"><small>Rockwood Clinical Frailty Scale (1‚Äì9): use as an aid to clinical judgement.</small></div>
            </div>
        `;
    }

    calculateFrailty() {
        const sel = document.getElementById('frailty-select');
        const out = document.getElementById('frailty-detail-result');
        if (!sel || !out) return;
        const val = sel.value;
        if (!val) {
            out.innerHTML = '<p class="error">Please select a frailty score</p>';
            return;
        }
        const descriptions = {
            1: 'Very fit ‚Äî robust, active, energetic and motivated. Typically exercises regularly.',
            2: 'Well ‚Äî no active disease symptoms but less fit than category 1.',
            3: 'Managing well ‚Äî medical problems are well controlled, not regularly active beyond routine activities.',
            4: 'Vulnerable ‚Äî not dependent on others for daily help, but symptoms limit activities.',
            5: 'Mildly frail ‚Äî evident slowing and need help in high order instrumental activities of daily living.',
            6: 'Moderately frail ‚Äî need help with all outside activities and with keeping house.',
            7: 'Severely frail ‚Äî completely dependent for personal care, but stable and not at high risk of dying within 6 months.',
            8: 'Very severely frail ‚Äî completely dependent, approaching the end of life. Typically approaching high risk of dying.',
            9: 'Terminally ill ‚Äî life expectancy <6 months, not otherwise evidently frail.'
        };
        const guidance = (n) => {
            const num = parseInt(n, 10);
            if (num <= 3) return 'Not frail ‚Äî encourage activity and prevention.';
            if (num === 4) return 'Pre-frail/vulnerable ‚Äî consider targeted interventions (exercise, medication review).';
            if (num >=5 && num <=6) return 'Frailty present ‚Äî consider CGA, falls review and medication optimisation.';
            return 'High dependency ‚Äî prioritise care needs, consider palliative needs assessment where appropriate.';
        };

        out.innerHTML = `
            <div>
                <strong>Score: ${val}</strong>
                <div style="margin-top:8px">${descriptions[val]}</div>
                <div style="margin-top:8px;color:#374151;font-weight:600">${guidance(val)}</div>
            </div>
        `;
    }

    getBarthelCalculator() {
        return `
            <div class="calculator-form">
                <h4>Barthel Index (ADL)</h4>
                <p><small>Complete the items and press Calculate</small></p>
                <div class="calc-input-group" id="barthel-detail-items">
                    <!-- Simplified form: items named to match common Barthel scoring -->
                    <label>Feeding: <select id="b-feeding"><option value="0">Dependent (0)</option><option value="5">Needs assistance (5)</option><option value="10">Independent (10)</option></select></label>
                    <label>Bathing: <select id="b-bathing"><option value="0">Dependent (0)</option><option value="5">Independent (5)</option></select></label>
                    <label>Grooming: <select id="b-grooming"><option value="0">Needs help (0)</option><option value="5">Independent (5)</option></select></label>
                    <label>Dressing: <select id="b-dressing"><option value="0">Dependent (0)</option><option value="5">Needs help (5)</option><option value="10">Independent (10)</option></select></label>
                    <label>Bowels: <select id="b-bowels"><option value="0">Incontinent (0)</option><option value="5">Occasional accident (5)</option><option value="10">Continent (10)</option></select></label>
                    <label>Bladder: <select id="b-bladder"><option value="0">Incontinent (0)</option><option value="5">Occasional accident (5)</option><option value="10">Continent (10)</option></select></label>
                    <label>Toilet use: <select id="b-toilet"><option value="0">Dependent (0)</option><option value="5">Needs some help (5)</option><option value="10">Independent (10)</option></select></label>
                    <label>Transfers (bed-chair): <select id="b-transfers"><option value="0">Dependent (0)</option><option value="5">Major help (5)</option><option value="10">Minor help (10)</option><option value="15">Independent (15)</option></select></label>
                    <label>Mobility (level): <select id="b-mobility"><option value="0">Dependent (0)</option><option value="5">Immobile (5)</option><option value="10">Walks with help (10)</option><option value="15">Independent (15)</option></select></label>
                    <label>Stairs: <select id="b-stairs"><option value="0">Unable (0)</option><option value="5">Needs help (5)</option><option value="10">Independent (10)</option></select></label>
                </div>
                <button onclick="window.quizApp.calculateBarthel()">Calculate</button>
                <div id="barthel-detail-result" class="calc-result"></div>
                <div class="calc-reference"><small>Score 0-100. Higher scores indicate greater independence.</small></div>
            </div>
        `;
    }

    calculateBarthel() {
        const ids = ['b-feeding','b-bathing','b-grooming','b-dressing','b-bowels','b-bladder','b-toilet','b-transfers','b-mobility','b-stairs'];
        let total = 0;
        ids.forEach(id => {
            const el = document.getElementById(id);
            if (el) total += parseInt(el.value, 10) || 0;
        });
        let interpretation = 'Total dependency';
        if (total === 100) interpretation = 'Independent';
        else if (total >= 91) interpretation = 'Slight dependency';
        else if (total >= 61) interpretation = 'Moderate dependency';
        else if (total >= 21) interpretation = 'Severe dependency';
        document.getElementById('barthel-detail-result').innerHTML = `
            <div>
                <strong>Barthel Total: ${total} / 100</strong>
                <div style="margin-top:8px">Interpretation: ${interpretation}</div>
            </div>
        `;
    }

    calculateBMI() {
        const weight = parseFloat(document.getElementById('bmi-weight').value);
        const height = parseFloat(document.getElementById('bmi-height').value) / 100; // Convert cm to m
        const waist = parseFloat(document.getElementById('bmi-waist').value);
        const ethnicity = document.getElementById('bmi-ethnicity').value;
        const sex = document.querySelector('input[name="bmi-sex"]:checked')?.value;
        
        if (!weight || !height) {
            document.getElementById('bmi-result').innerHTML = '<p class="error">Please enter valid weight and height</p>';
            return;
        }
        
        const bmi = weight / (height * height);
        let category = '';
        let color = '';
        let healthRisk = '';
        
        // Ethnic-specific BMI thresholds
        let overweightThreshold = 25;
        let obeseThreshold = 30;
        
        if (ethnicity === 'asian') {
            overweightThreshold = 23;
            obeseThreshold = 27.5;
        }
        
        if (bmi < 18.5) {
            category = 'Underweight';
            color = '#2196F3';
            healthRisk = 'Increased risk: nutritional deficiency, osteoporosis, immune dysfunction';
        } else if (bmi < overweightThreshold) {
            category = 'Normal weight';
            color = '#4CAF50';
            healthRisk = 'Optimal health risk profile';
        } else if (bmi < obeseThreshold) {
            category = 'Overweight';
            color = '#FF9800';
            healthRisk = 'Increased risk: diabetes, cardiovascular disease, sleep apnoea';
        } else if (bmi < 35) {
            category = 'Obese Class I';
            color = '#F44336';
            healthRisk = 'High risk: diabetes, CVD, stroke, certain cancers';
        } else if (bmi < 40) {
            category = 'Obese Class II';
            color = '#D32F2F';
            healthRisk = 'Very high risk: consider bariatric surgery consultation';
        } else {
            category = 'Obese Class III';
            color = '#B71C1C';
            healthRisk = 'Extremely high risk: urgent weight management, consider bariatric surgery';
        }
        
        // Waist circumference assessment
        let waistAssessment = '';
        if (waist && sex) {
            let waistRisk = '';
            let waistColor = '#4CAF50';
            
            if (sex === 'male') {
                if (waist >= 102) {
                    waistRisk = 'Very high risk';
                    waistColor = '#F44336';
                } else if (waist >= 94) {
                    waistRisk = 'Increased risk';
                    waistColor = '#FF9800';
                } else {
                    waistRisk = 'Low risk';
                }
            } else {
                if (waist >= 88) {
                    waistRisk = 'Very high risk';
                    waistColor = '#F44336';
                } else if (waist >= 80) {
                    waistRisk = 'Increased risk';
                    waistColor = '#FF9800';
                } else {
                    waistRisk = 'Low risk';
                }


// ========================================
// eGFR (lines 4975-5375)
// ========================================
                calculatorContent += this.getMEWSCalculator();
                break;
        }
        calculatorContent = calculatorContent.replace('<h3 id="calculator-title"></h3>', `<h3 id="calculator-title">${calculatorTitle}</h3>`);
        container.innerHTML = calculatorContent;
        // Attach export buttons to results and per-calculator notes area
        try {
            // Ensure export features are available across calc-result blocks
            if (typeof this.setupExportFeatures === 'function') {
                this.setupExportFeatures();
            }
            // Add notes area for this calculator (persisted via localStorage)
            if (typeof this.setupCalculatorNotes === 'function') {
                this.setupCalculatorNotes(calcType);
            }
        } catch (err) {
            console.warn('‚ö†Ô∏è Failed to setup export/features or notes for calculator:', err);
        }
        console.log('üßÆ Loaded calculator:', calcType);
    }
    getBMICalculator() {
        return `
            <div class="calculator-form">
                <h4>BMI & Waist Circumference Calculator</h4>
                <div class="calc-input-group">
                    <label>Weight (kg):</label>
                    <input type="number" id="bmi-weight" placeholder="70" step="0.1">
                </div>
                <div class="calc-input-group">
                    <label>Height (cm):</label>
                    <input type="number" id="bmi-height" placeholder="175" step="0.1">
                </div>
                <div class="calc-input-group">
                    <label>Waist Circumference (cm) - Optional:</label>
                    <input type="number" id="bmi-waist" placeholder="85" step="0.1">
                </div>
                <div class="calc-input-group">
                    <label>Ethnicity:</label>
                    <select id="bmi-ethnicity">
                        <option value="european">European/Caucasian</option>
                        <option value="asian">Asian (Chinese, Japanese, South Asian)</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="calc-checkbox-group">
                    <label><input type="radio" name="bmi-sex" value="male"> Male</label>
                    <label><input type="radio" name="bmi-sex" value="female"> Female</label>
                </div>
                <button onclick="window.quizApp.calculateBMI()">Calculate</button>
                <div id="bmi-result" class="calc-result"></div>
                <div class="calc-reference">
                    <small>
                        <strong>BMI Categories (WHO):</strong><br>
                        Underweight: &lt;18.5 | Normal: 18.5-24.9<br>
                        Overweight: 25-29.9 | Obese: ‚â•30<br>
                        <strong>Asian populations:</strong> Overweight ‚â•23, Obese ‚â•27.5
                    </small>
                </div>
            </div>
        `;
    }

    getFrailtyCalculator() {
        return `
            <div class="calculator-form">
                <h4>Clinical Frailty Scale (Rockwood)</h4>
                <p><small>Select the category that best matches the patient</small></p>
                <div class="calc-input-group" id="frailty-options-detail">
                    <select id="frailty-select">
                        <option value="">-- Select frailty score --</option>
                        <option value="1">1 ‚Äî Very fit</option>
                        <option value="2">2 ‚Äî Well</option>
                        <option value="3">3 ‚Äî Managing well</option>
                        <option value="4">4 ‚Äî Vulnerable</option>
                        <option value="5">5 ‚Äî Mildly frail</option>
                        <option value="6">6 ‚Äî Moderately frail</option>
                        <option value="7">7 ‚Äî Severely frail</option>
                        <option value="8">8 ‚Äî Very severely frail</option>
                        <option value="9">9 ‚Äî Terminally ill</option>
                    </select>
                </div>
                <button onclick="window.quizApp.calculateFrailty()">Calculate</button>
                <div id="frailty-detail-result" class="calc-result"></div>
                <div class="calc-reference"><small>Rockwood Clinical Frailty Scale (1‚Äì9): use as an aid to clinical judgement.</small></div>
            </div>
        `;
    }

    calculateFrailty() {
        const sel = document.getElementById('frailty-select');
        const out = document.getElementById('frailty-detail-result');
        if (!sel || !out) return;
        const val = sel.value;
        if (!val) {
            out.innerHTML = '<p class="error">Please select a frailty score</p>';
            return;
        }
        const descriptions = {
            1: 'Very fit ‚Äî robust, active, energetic and motivated. Typically exercises regularly.',
            2: 'Well ‚Äî no active disease symptoms but less fit than category 1.',
            3: 'Managing well ‚Äî medical problems are well controlled, not regularly active beyond routine activities.',
            4: 'Vulnerable ‚Äî not dependent on others for daily help, but symptoms limit activities.',
            5: 'Mildly frail ‚Äî evident slowing and need help in high order instrumental activities of daily living.',
            6: 'Moderately frail ‚Äî need help with all outside activities and with keeping house.',
            7: 'Severely frail ‚Äî completely dependent for personal care, but stable and not at high risk of dying within 6 months.',
            8: 'Very severely frail ‚Äî completely dependent, approaching the end of life. Typically approaching high risk of dying.',
            9: 'Terminally ill ‚Äî life expectancy <6 months, not otherwise evidently frail.'
        };
        const guidance = (n) => {
            const num = parseInt(n, 10);
            if (num <= 3) return 'Not frail ‚Äî encourage activity and prevention.';
            if (num === 4) return 'Pre-frail/vulnerable ‚Äî consider targeted interventions (exercise, medication review).';
            if (num >=5 && num <=6) return 'Frailty present ‚Äî consider CGA, falls review and medication optimisation.';
            return 'High dependency ‚Äî prioritise care needs, consider palliative needs assessment where appropriate.';
        };

        out.innerHTML = `
            <div>
                <strong>Score: ${val}</strong>
                <div style="margin-top:8px">${descriptions[val]}</div>
                <div style="margin-top:8px;color:#374151;font-weight:600">${guidance(val)}</div>
            </div>
        `;
    }

    getBarthelCalculator() {
        return `
            <div class="calculator-form">
                <h4>Barthel Index (ADL)</h4>
                <p><small>Complete the items and press Calculate</small></p>
                <div class="calc-input-group" id="barthel-detail-items">
                    <!-- Simplified form: items named to match common Barthel scoring -->
                    <label>Feeding: <select id="b-feeding"><option value="0">Dependent (0)</option><option value="5">Needs assistance (5)</option><option value="10">Independent (10)</option></select></label>
                    <label>Bathing: <select id="b-bathing"><option value="0">Dependent (0)</option><option value="5">Independent (5)</option></select></label>
                    <label>Grooming: <select id="b-grooming"><option value="0">Needs help (0)</option><option value="5">Independent (5)</option></select></label>
                    <label>Dressing: <select id="b-dressing"><option value="0">Dependent (0)</option><option value="5">Needs help (5)</option><option value="10">Independent (10)</option></select></label>
                    <label>Bowels: <select id="b-bowels"><option value="0">Incontinent (0)</option><option value="5">Occasional accident (5)</option><option value="10">Continent (10)</option></select></label>
                    <label>Bladder: <select id="b-bladder"><option value="0">Incontinent (0)</option><option value="5">Occasional accident (5)</option><option value="10">Continent (10)</option></select></label>
                    <label>Toilet use: <select id="b-toilet"><option value="0">Dependent (0)</option><option value="5">Needs some help (5)</option><option value="10">Independent (10)</option></select></label>
                    <label>Transfers (bed-chair): <select id="b-transfers"><option value="0">Dependent (0)</option><option value="5">Major help (5)</option><option value="10">Minor help (10)</option><option value="15">Independent (15)</option></select></label>
                    <label>Mobility (level): <select id="b-mobility"><option value="0">Dependent (0)</option><option value="5">Immobile (5)</option><option value="10">Walks with help (10)</option><option value="15">Independent (15)</option></select></label>
                    <label>Stairs: <select id="b-stairs"><option value="0">Unable (0)</option><option value="5">Needs help (5)</option><option value="10">Independent (10)</option></select></label>
                </div>
                <button onclick="window.quizApp.calculateBarthel()">Calculate</button>
                <div id="barthel-detail-result" class="calc-result"></div>
                <div class="calc-reference"><small>Score 0-100. Higher scores indicate greater independence.</small></div>
            </div>
        `;
    }

    calculateBarthel() {
        const ids = ['b-feeding','b-bathing','b-grooming','b-dressing','b-bowels','b-bladder','b-toilet','b-transfers','b-mobility','b-stairs'];
        let total = 0;
        ids.forEach(id => {
            const el = document.getElementById(id);
            if (el) total += parseInt(el.value, 10) || 0;
        });
        let interpretation = 'Total dependency';
        if (total === 100) interpretation = 'Independent';
        else if (total >= 91) interpretation = 'Slight dependency';
        else if (total >= 61) interpretation = 'Moderate dependency';
        else if (total >= 21) interpretation = 'Severe dependency';
        document.getElementById('barthel-detail-result').innerHTML = `
            <div>
                <strong>Barthel Total: ${total} / 100</strong>
                <div style="margin-top:8px">Interpretation: ${interpretation}</div>
            </div>
        `;
    }

    calculateBMI() {
        const weight = parseFloat(document.getElementById('bmi-weight').value);
        const height = parseFloat(document.getElementById('bmi-height').value) / 100; // Convert cm to m
        const waist = parseFloat(document.getElementById('bmi-waist').value);
        const ethnicity = document.getElementById('bmi-ethnicity').value;
        const sex = document.querySelector('input[name="bmi-sex"]:checked')?.value;
        
        if (!weight || !height) {
            document.getElementById('bmi-result').innerHTML = '<p class="error">Please enter valid weight and height</p>';
            return;
        }
        
        const bmi = weight / (height * height);
        let category = '';


// ========================================
// FluidBalance (lines 5071-5471)
// ========================================
                calculatorContent += this.getInfusionRateCalculator();
                break;
        }
        calculatorContent = calculatorContent.replace('<h3 id="calculator-title"></h3>', `<h3 id="calculator-title">${calculatorTitle}</h3>`);
        container.innerHTML = calculatorContent;
        // Attach export buttons to results and per-calculator notes area
        try {
            // Ensure export features are available across calc-result blocks
            if (typeof this.setupExportFeatures === 'function') {
                this.setupExportFeatures();
            }
            // Add notes area for this calculator (persisted via localStorage)
            if (typeof this.setupCalculatorNotes === 'function') {
                this.setupCalculatorNotes(calcType);
            }
        } catch (err) {
            console.warn('‚ö†Ô∏è Failed to setup export/features or notes for calculator:', err);
        }
        console.log('üßÆ Loaded calculator:', calcType);
    }
    getBMICalculator() {
        return `
            <div class="calculator-form">
                <h4>BMI & Waist Circumference Calculator</h4>
                <div class="calc-input-group">
                    <label>Weight (kg):</label>
                    <input type="number" id="bmi-weight" placeholder="70" step="0.1">
                </div>
                <div class="calc-input-group">
                    <label>Height (cm):</label>
                    <input type="number" id="bmi-height" placeholder="175" step="0.1">
                </div>
                <div class="calc-input-group">
                    <label>Waist Circumference (cm) - Optional:</label>
                    <input type="number" id="bmi-waist" placeholder="85" step="0.1">
                </div>
                <div class="calc-input-group">
                    <label>Ethnicity:</label>
                    <select id="bmi-ethnicity">
                        <option value="european">European/Caucasian</option>
                        <option value="asian">Asian (Chinese, Japanese, South Asian)</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="calc-checkbox-group">
                    <label><input type="radio" name="bmi-sex" value="male"> Male</label>
                    <label><input type="radio" name="bmi-sex" value="female"> Female</label>
                </div>
                <button onclick="window.quizApp.calculateBMI()">Calculate</button>
                <div id="bmi-result" class="calc-result"></div>
                <div class="calc-reference">
                    <small>
                        <strong>BMI Categories (WHO):</strong><br>
                        Underweight: &lt;18.5 | Normal: 18.5-24.9<br>
                        Overweight: 25-29.9 | Obese: ‚â•30<br>
                        <strong>Asian populations:</strong> Overweight ‚â•23, Obese ‚â•27.5
                    </small>
                </div>
            </div>
        `;
    }

    getFrailtyCalculator() {
        return `
            <div class="calculator-form">
                <h4>Clinical Frailty Scale (Rockwood)</h4>
                <p><small>Select the category that best matches the patient</small></p>
                <div class="calc-input-group" id="frailty-options-detail">
                    <select id="frailty-select">
                        <option value="">-- Select frailty score --</option>
                        <option value="1">1 ‚Äî Very fit</option>
                        <option value="2">2 ‚Äî Well</option>
                        <option value="3">3 ‚Äî Managing well</option>
                        <option value="4">4 ‚Äî Vulnerable</option>
                        <option value="5">5 ‚Äî Mildly frail</option>
                        <option value="6">6 ‚Äî Moderately frail</option>
                        <option value="7">7 ‚Äî Severely frail</option>
                        <option value="8">8 ‚Äî Very severely frail</option>
                        <option value="9">9 ‚Äî Terminally ill</option>
                    </select>
                </div>
                <button onclick="window.quizApp.calculateFrailty()">Calculate</button>
                <div id="frailty-detail-result" class="calc-result"></div>
                <div class="calc-reference"><small>Rockwood Clinical Frailty Scale (1‚Äì9): use as an aid to clinical judgement.</small></div>
            </div>
        `;
    }

    calculateFrailty() {
        const sel = document.getElementById('frailty-select');
        const out = document.getElementById('frailty-detail-result');
        if (!sel || !out) return;
        const val = sel.value;
        if (!val) {
            out.innerHTML = '<p class="error">Please select a frailty score</p>';
            return;
        }
        const descriptions = {
            1: 'Very fit ‚Äî robust, active, energetic and motivated. Typically exercises regularly.',
            2: 'Well ‚Äî no active disease symptoms but less fit than category 1.',
            3: 'Managing well ‚Äî medical problems are well controlled, not regularly active beyond routine activities.',
            4: 'Vulnerable ‚Äî not dependent on others for daily help, but symptoms limit activities.',
            5: 'Mildly frail ‚Äî evident slowing and need help in high order instrumental activities of daily living.',
            6: 'Moderately frail ‚Äî need help with all outside activities and with keeping house.',
            7: 'Severely frail ‚Äî completely dependent for personal care, but stable and not at high risk of dying within 6 months.',
            8: 'Very severely frail ‚Äî completely dependent, approaching the end of life. Typically approaching high risk of dying.',
            9: 'Terminally ill ‚Äî life expectancy <6 months, not otherwise evidently frail.'
        };
        const guidance = (n) => {
            const num = parseInt(n, 10);
            if (num <= 3) return 'Not frail ‚Äî encourage activity and prevention.';
            if (num === 4) return 'Pre-frail/vulnerable ‚Äî consider targeted interventions (exercise, medication review).';
            if (num >=5 && num <=6) return 'Frailty present ‚Äî consider CGA, falls review and medication optimisation.';
            return 'High dependency ‚Äî prioritise care needs, consider palliative needs assessment where appropriate.';
        };

        out.innerHTML = `
            <div>
                <strong>Score: ${val}</strong>
                <div style="margin-top:8px">${descriptions[val]}</div>
                <div style="margin-top:8px;color:#374151;font-weight:600">${guidance(val)}</div>
            </div>
        `;
    }

    getBarthelCalculator() {
        return `
            <div class="calculator-form">
                <h4>Barthel Index (ADL)</h4>
                <p><small>Complete the items and press Calculate</small></p>
                <div class="calc-input-group" id="barthel-detail-items">
                    <!-- Simplified form: items named to match common Barthel scoring -->
                    <label>Feeding: <select id="b-feeding"><option value="0">Dependent (0)</option><option value="5">Needs assistance (5)</option><option value="10">Independent (10)</option></select></label>
                    <label>Bathing: <select id="b-bathing"><option value="0">Dependent (0)</option><option value="5">Independent (5)</option></select></label>
                    <label>Grooming: <select id="b-grooming"><option value="0">Needs help (0)</option><option value="5">Independent (5)</option></select></label>
                    <label>Dressing: <select id="b-dressing"><option value="0">Dependent (0)</option><option value="5">Needs help (5)</option><option value="10">Independent (10)</option></select></label>
                    <label>Bowels: <select id="b-bowels"><option value="0">Incontinent (0)</option><option value="5">Occasional accident (5)</option><option value="10">Continent (10)</option></select></label>
                    <label>Bladder: <select id="b-bladder"><option value="0">Incontinent (0)</option><option value="5">Occasional accident (5)</option><option value="10">Continent (10)</option></select></label>
                    <label>Toilet use: <select id="b-toilet"><option value="0">Dependent (0)</option><option value="5">Needs some help (5)</option><option value="10">Independent (10)</option></select></label>
                    <label>Transfers (bed-chair): <select id="b-transfers"><option value="0">Dependent (0)</option><option value="5">Major help (5)</option><option value="10">Minor help (10)</option><option value="15">Independent (15)</option></select></label>
                    <label>Mobility (level): <select id="b-mobility"><option value="0">Dependent (0)</option><option value="5">Immobile (5)</option><option value="10">Walks with help (10)</option><option value="15">Independent (15)</option></select></label>
                    <label>Stairs: <select id="b-stairs"><option value="0">Unable (0)</option><option value="5">Needs help (5)</option><option value="10">Independent (10)</option></select></label>
                </div>
                <button onclick="window.quizApp.calculateBarthel()">Calculate</button>
                <div id="barthel-detail-result" class="calc-result"></div>
                <div class="calc-reference"><small>Score 0-100. Higher scores indicate greater independence.</small></div>
            </div>
        `;
    }

    calculateBarthel() {
        const ids = ['b-feeding','b-bathing','b-grooming','b-dressing','b-bowels','b-bladder','b-toilet','b-transfers','b-mobility','b-stairs'];
        let total = 0;
        ids.forEach(id => {
            const el = document.getElementById(id);
            if (el) total += parseInt(el.value, 10) || 0;
        });
        let interpretation = 'Total dependency';
        if (total === 100) interpretation = 'Independent';
        else if (total >= 91) interpretation = 'Slight dependency';
        else if (total >= 61) interpretation = 'Moderate dependency';
        else if (total >= 21) interpretation = 'Severe dependency';
        document.getElementById('barthel-detail-result').innerHTML = `
            <div>
                <strong>Barthel Total: ${total} / 100</strong>
                <div style="margin-top:8px">Interpretation: ${interpretation}</div>
            </div>
        `;
    }

    calculateBMI() {
        const weight = parseFloat(document.getElementById('bmi-weight').value);
        const height = parseFloat(document.getElementById('bmi-height').value) / 100; // Convert cm to m
        const waist = parseFloat(document.getElementById('bmi-waist').value);
        const ethnicity = document.getElementById('bmi-ethnicity').value;
        const sex = document.querySelector('input[name="bmi-sex"]:checked')?.value;
        
        if (!weight || !height) {
            document.getElementById('bmi-result').innerHTML = '<p class="error">Please enter valid weight and height</p>';
            return;
        }
        
        const bmi = weight / (height * height);
        let category = '';
        let color = '';
        let healthRisk = '';
        
        // Ethnic-specific BMI thresholds
        let overweightThreshold = 25;
        let obeseThreshold = 30;
        
        if (ethnicity === 'asian') {
            overweightThreshold = 23;
            obeseThreshold = 27.5;
        }
        
        if (bmi < 18.5) {
            category = 'Underweight';
            color = '#2196F3';
            healthRisk = 'Increased risk: nutritional deficiency, osteoporosis, immune dysfunction';
        } else if (bmi < overweightThreshold) {
            category = 'Normal weight';
            color = '#4CAF50';
            healthRisk = 'Optimal health risk profile';
        } else if (bmi < obeseThreshold) {
            category = 'Overweight';
            color = '#FF9800';
            healthRisk = 'Increased risk: diabetes, cardiovascular disease, sleep apnoea';
        } else if (bmi < 35) {
            category = 'Obese Class I';
            color = '#F44336';
            healthRisk = 'High risk: diabetes, CVD, stroke, certain cancers';
        } else if (bmi < 40) {
            category = 'Obese Class II';
            color = '#D32F2F';
            healthRisk = 'Very high risk: consider bariatric surgery consultation';
        } else {
            category = 'Obese Class III';
            color = '#B71C1C';
            healthRisk = 'Extremely high risk: urgent weight management, consider bariatric surgery';
        }
        
        // Waist circumference assessment
        let waistAssessment = '';
        if (waist && sex) {
            let waistRisk = '';
            let waistColor = '#4CAF50';
            
            if (sex === 'male') {
                if (waist >= 102) {
                    waistRisk = 'Very high risk';
                    waistColor = '#F44336';
                } else if (waist >= 94) {
                    waistRisk = 'Increased risk';
                    waistColor = '#FF9800';
                } else {
                    waistRisk = 'Low risk';
                }
            } else {
                if (waist >= 88) {
                    waistRisk = 'Very high risk';
                    waistColor = '#F44336';
                } else if (waist >= 80) {
                    waistRisk = 'Increased risk';
                    waistColor = '#FF9800';
                } else {
                    waistRisk = 'Low risk';
                }
            }
            
            waistAssessment = `
                <div style="margin-top: 8px; padding: 6px; background: #f5f5f5; border-radius: 4px;">
                    <strong>Waist Circumference:</strong> ${waist} cm<br>
                    <span style="color: ${waistColor}; font-weight: bold;">${waistRisk}</span> for metabolic complications
                </div>
            `;
        }
        
        document.getElementById('bmi-result').innerHTML = `
            <div class="bmi-result-display">
                <div class="bmi-value" style="color: ${color}; font-size: 1.2em;">
                    <strong>BMI: ${bmi.toFixed(1)} kg/m¬≤</strong>
                </div>
                <div class="bmi-category" style="color: ${color}; font-weight: bold; margin: 4px 0;">
                    ${category}
                </div>
                <div style="margin-top: 8px; font-size: 0.9em; color: #666;">
                    ${healthRisk}
                </div>
                ${waistAssessment}
                <div style="margin-top: 8px; font-size: 0.8em; color: #666;">
                    ${ethnicity === 'asian' ? 'Using Asian-specific BMI thresholds' : 'Using WHO BMI thresholds'}
                </div>
            </div>
        `;
    }

    getCHADS2VAScCalculator() {
        return `
            <div class="calculator-form">


// ========================================
// GCS (lines 4935-5335)
// ========================================
            <div class="calculator-content">
        `;
        
        let calculatorTitle = '';
        
        switch (calcType) {
        }
        calculatorContent = calculatorContent.replace('<h3 id="calculator-title"></h3>', `<h3 id="calculator-title">${calculatorTitle}</h3>`);
        container.innerHTML = calculatorContent;
        // Attach export buttons to results and per-calculator notes area
        try {
            // Ensure export features are available across calc-result blocks
            if (typeof this.setupExportFeatures === 'function') {
                this.setupExportFeatures();
            }
            // Add notes area for this calculator (persisted via localStorage)
            if (typeof this.setupCalculatorNotes === 'function') {
                this.setupCalculatorNotes(calcType);
            }
        } catch (err) {
            console.warn('‚ö†Ô∏è Failed to setup export/features or notes for calculator:', err);
        }
        console.log('üßÆ Loaded calculator:', calcType);
    }
    getBMICalculator() {
        return `
            <div class="calculator-form">
                <h4>BMI & Waist Circumference Calculator</h4>
                <div class="calc-input-group">
                    <label>Weight (kg):</label>
                    <input type="number" id="bmi-weight" placeholder="70" step="0.1">
                </div>
                <div class="calc-input-group">
                    <label>Height (cm):</label>
                    <input type="number" id="bmi-height" placeholder="175" step="0.1">
                </div>
                <div class="calc-input-group">
                    <label>Waist Circumference (cm) - Optional:</label>
                    <input type="number" id="bmi-waist" placeholder="85" step="0.1">
                </div>
                <div class="calc-input-group">
                    <label>Ethnicity:</label>
                    <select id="bmi-ethnicity">
                        <option value="european">European/Caucasian</option>
                        <option value="asian">Asian (Chinese, Japanese, South Asian)</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="calc-checkbox-group">
                    <label><input type="radio" name="bmi-sex" value="male"> Male</label>
                    <label><input type="radio" name="bmi-sex" value="female"> Female</label>
                </div>
                <button onclick="window.quizApp.calculateBMI()">Calculate</button>
                <div id="bmi-result" class="calc-result"></div>
                <div class="calc-reference">
                    <small>
                        <strong>BMI Categories (WHO):</strong><br>
                        Underweight: &lt;18.5 | Normal: 18.5-24.9<br>
                        Overweight: 25-29.9 | Obese: ‚â•30<br>
                        <strong>Asian populations:</strong> Overweight ‚â•23, Obese ‚â•27.5
                    </small>
                </div>
            </div>
        `;
    }

    getFrailtyCalculator() {
        return `
            <div class="calculator-form">
                <h4>Clinical Frailty Scale (Rockwood)</h4>
                <p><small>Select the category that best matches the patient</small></p>
                <div class="calc-input-group" id="frailty-options-detail">
                    <select id="frailty-select">
                        <option value="">-- Select frailty score --</option>
                        <option value="1">1 ‚Äî Very fit</option>
                        <option value="2">2 ‚Äî Well</option>
                        <option value="3">3 ‚Äî Managing well</option>
                        <option value="4">4 ‚Äî Vulnerable</option>
                        <option value="5">5 ‚Äî Mildly frail</option>
                        <option value="6">6 ‚Äî Moderately frail</option>
                        <option value="7">7 ‚Äî Severely frail</option>
                        <option value="8">8 ‚Äî Very severely frail</option>
                        <option value="9">9 ‚Äî Terminally ill</option>
                    </select>
                </div>
                <button onclick="window.quizApp.calculateFrailty()">Calculate</button>
                <div id="frailty-detail-result" class="calc-result"></div>
                <div class="calc-reference"><small>Rockwood Clinical Frailty Scale (1‚Äì9): use as an aid to clinical judgement.</small></div>
            </div>
        `;
    }

    calculateFrailty() {
        const sel = document.getElementById('frailty-select');
        const out = document.getElementById('frailty-detail-result');
        if (!sel || !out) return;
        const val = sel.value;
        if (!val) {
            out.innerHTML = '<p class="error">Please select a frailty score</p>';
            return;
        }
        const descriptions = {
            1: 'Very fit ‚Äî robust, active, energetic and motivated. Typically exercises regularly.',
            2: 'Well ‚Äî no active disease symptoms but less fit than category 1.',
            3: 'Managing well ‚Äî medical problems are well controlled, not regularly active beyond routine activities.',
            4: 'Vulnerable ‚Äî not dependent on others for daily help, but symptoms limit activities.',
            5: 'Mildly frail ‚Äî evident slowing and need help in high order instrumental activities of daily living.',
            6: 'Moderately frail ‚Äî need help with all outside activities and with keeping house.',
            7: 'Severely frail ‚Äî completely dependent for personal care, but stable and not at high risk of dying within 6 months.',
            8: 'Very severely frail ‚Äî completely dependent, approaching the end of life. Typically approaching high risk of dying.',
            9: 'Terminally ill ‚Äî life expectancy <6 months, not otherwise evidently frail.'
        };
        const guidance = (n) => {
            const num = parseInt(n, 10);
            if (num <= 3) return 'Not frail ‚Äî encourage activity and prevention.';
            if (num === 4) return 'Pre-frail/vulnerable ‚Äî consider targeted interventions (exercise, medication review).';
            if (num >=5 && num <=6) return 'Frailty present ‚Äî consider CGA, falls review and medication optimisation.';
            return 'High dependency ‚Äî prioritise care needs, consider palliative needs assessment where appropriate.';
        };

        out.innerHTML = `
            <div>
                <strong>Score: ${val}</strong>
                <div style="margin-top:8px">${descriptions[val]}</div>
                <div style="margin-top:8px;color:#374151;font-weight:600">${guidance(val)}</div>
            </div>
        `;
    }

    getBarthelCalculator() {
        return `
            <div class="calculator-form">
                <h4>Barthel Index (ADL)</h4>
                <p><small>Complete the items and press Calculate</small></p>
                <div class="calc-input-group" id="barthel-detail-items">
                    <!-- Simplified form: items named to match common Barthel scoring -->
                    <label>Feeding: <select id="b-feeding"><option value="0">Dependent (0)</option><option value="5">Needs assistance (5)</option><option value="10">Independent (10)</option></select></label>
                    <label>Bathing: <select id="b-bathing"><option value="0">Dependent (0)</option><option value="5">Independent (5)</option></select></label>
                    <label>Grooming: <select id="b-grooming"><option value="0">Needs help (0)</option><option value="5">Independent (5)</option></select></label>
                    <label>Dressing: <select id="b-dressing"><option value="0">Dependent (0)</option><option value="5">Needs help (5)</option><option value="10">Independent (10)</option></select></label>
                    <label>Bowels: <select id="b-bowels"><option value="0">Incontinent (0)</option><option value="5">Occasional accident (5)</option><option value="10">Continent (10)</option></select></label>
                    <label>Bladder: <select id="b-bladder"><option value="0">Incontinent (0)</option><option value="5">Occasional accident (5)</option><option value="10">Continent (10)</option></select></label>
                    <label>Toilet use: <select id="b-toilet"><option value="0">Dependent (0)</option><option value="5">Needs some help (5)</option><option value="10">Independent (10)</option></select></label>
                    <label>Transfers (bed-chair): <select id="b-transfers"><option value="0">Dependent (0)</option><option value="5">Major help (5)</option><option value="10">Minor help (10)</option><option value="15">Independent (15)</option></select></label>
                    <label>Mobility (level): <select id="b-mobility"><option value="0">Dependent (0)</option><option value="5">Immobile (5)</option><option value="10">Walks with help (10)</option><option value="15">Independent (15)</option></select></label>
                    <label>Stairs: <select id="b-stairs"><option value="0">Unable (0)</option><option value="5">Needs help (5)</option><option value="10">Independent (10)</option></select></label>
                </div>
                <button onclick="window.quizApp.calculateBarthel()">Calculate</button>


// ========================================
// GRACE (lines 4995-5395)
// ========================================
                calculatorContent += this.getEGFRCalculator();
                break;
        }
        calculatorContent = calculatorContent.replace('<h3 id="calculator-title"></h3>', `<h3 id="calculator-title">${calculatorTitle}</h3>`);
        container.innerHTML = calculatorContent;
        // Attach export buttons to results and per-calculator notes area
        try {
            // Ensure export features are available across calc-result blocks
            if (typeof this.setupExportFeatures === 'function') {
                this.setupExportFeatures();
            }
            // Add notes area for this calculator (persisted via localStorage)
            if (typeof this.setupCalculatorNotes === 'function') {
                this.setupCalculatorNotes(calcType);
            }
        } catch (err) {
            console.warn('‚ö†Ô∏è Failed to setup export/features or notes for calculator:', err);
        }
        console.log('üßÆ Loaded calculator:', calcType);
    }
    getBMICalculator() {
        return `
            <div class="calculator-form">
                <h4>BMI & Waist Circumference Calculator</h4>
                <div class="calc-input-group">
                    <label>Weight (kg):</label>
                    <input type="number" id="bmi-weight" placeholder="70" step="0.1">
                </div>
                <div class="calc-input-group">
                    <label>Height (cm):</label>
                    <input type="number" id="bmi-height" placeholder="175" step="0.1">
                </div>
                <div class="calc-input-group">
                    <label>Waist Circumference (cm) - Optional:</label>
                    <input type="number" id="bmi-waist" placeholder="85" step="0.1">
                </div>
                <div class="calc-input-group">
                    <label>Ethnicity:</label>
                    <select id="bmi-ethnicity">
                        <option value="european">European/Caucasian</option>
                        <option value="asian">Asian (Chinese, Japanese, South Asian)</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="calc-checkbox-group">
                    <label><input type="radio" name="bmi-sex" value="male"> Male</label>
                    <label><input type="radio" name="bmi-sex" value="female"> Female</label>
                </div>
                <button onclick="window.quizApp.calculateBMI()">Calculate</button>
                <div id="bmi-result" class="calc-result"></div>
                <div class="calc-reference">
                    <small>
                        <strong>BMI Categories (WHO):</strong><br>
                        Underweight: &lt;18.5 | Normal: 18.5-24.9<br>
                        Overweight: 25-29.9 | Obese: ‚â•30<br>
                        <strong>Asian populations:</strong> Overweight ‚â•23, Obese ‚â•27.5
                    </small>
                </div>
            </div>
        `;
    }

    getFrailtyCalculator() {
        return `
            <div class="calculator-form">
                <h4>Clinical Frailty Scale (Rockwood)</h4>
                <p><small>Select the category that best matches the patient</small></p>
                <div class="calc-input-group" id="frailty-options-detail">
                    <select id="frailty-select">
                        <option value="">-- Select frailty score --</option>
                        <option value="1">1 ‚Äî Very fit</option>
                        <option value="2">2 ‚Äî Well</option>
                        <option value="3">3 ‚Äî Managing well</option>
                        <option value="4">4 ‚Äî Vulnerable</option>
                        <option value="5">5 ‚Äî Mildly frail</option>
                        <option value="6">6 ‚Äî Moderately frail</option>
                        <option value="7">7 ‚Äî Severely frail</option>
                        <option value="8">8 ‚Äî Very severely frail</option>
                        <option value="9">9 ‚Äî Terminally ill</option>
                    </select>
                </div>
                <button onclick="window.quizApp.calculateFrailty()">Calculate</button>
                <div id="frailty-detail-result" class="calc-result"></div>
                <div class="calc-reference"><small>Rockwood Clinical Frailty Scale (1‚Äì9): use as an aid to clinical judgement.</small></div>
            </div>
        `;
    }

    calculateFrailty() {
        const sel = document.getElementById('frailty-select');
        const out = document.getElementById('frailty-detail-result');
        if (!sel || !out) return;
        const val = sel.value;
        if (!val) {
            out.innerHTML = '<p class="error">Please select a frailty score</p>';
            return;
        }
        const descriptions = {
            1: 'Very fit ‚Äî robust, active, energetic and motivated. Typically exercises regularly.',
            2: 'Well ‚Äî no active disease symptoms but less fit than category 1.',
            3: 'Managing well ‚Äî medical problems are well controlled, not regularly active beyond routine activities.',
            4: 'Vulnerable ‚Äî not dependent on others for daily help, but symptoms limit activities.',
            5: 'Mildly frail ‚Äî evident slowing and need help in high order instrumental activities of daily living.',
            6: 'Moderately frail ‚Äî need help with all outside activities and with keeping house.',
            7: 'Severely frail ‚Äî completely dependent for personal care, but stable and not at high risk of dying within 6 months.',
            8: 'Very severely frail ‚Äî completely dependent, approaching the end of life. Typically approaching high risk of dying.',
            9: 'Terminally ill ‚Äî life expectancy <6 months, not otherwise evidently frail.'
        };
        const guidance = (n) => {
            const num = parseInt(n, 10);
            if (num <= 3) return 'Not frail ‚Äî encourage activity and prevention.';
            if (num === 4) return 'Pre-frail/vulnerable ‚Äî consider targeted interventions (exercise, medication review).';
            if (num >=5 && num <=6) return 'Frailty present ‚Äî consider CGA, falls review and medication optimisation.';
            return 'High dependency ‚Äî prioritise care needs, consider palliative needs assessment where appropriate.';
        };

        out.innerHTML = `
            <div>
                <strong>Score: ${val}</strong>
                <div style="margin-top:8px">${descriptions[val]}</div>
                <div style="margin-top:8px;color:#374151;font-weight:600">${guidance(val)}</div>
            </div>
        `;
    }

    getBarthelCalculator() {
        return `
            <div class="calculator-form">
                <h4>Barthel Index (ADL)</h4>
                <p><small>Complete the items and press Calculate</small></p>
                <div class="calc-input-group" id="barthel-detail-items">
                    <!-- Simplified form: items named to match common Barthel scoring -->
                    <label>Feeding: <select id="b-feeding"><option value="0">Dependent (0)</option><option value="5">Needs assistance (5)</option><option value="10">Independent (10)</option></select></label>
                    <label>Bathing: <select id="b-bathing"><option value="0">Dependent (0)</option><option value="5">Independent (5)</option></select></label>
                    <label>Grooming: <select id="b-grooming"><option value="0">Needs help (0)</option><option value="5">Independent (5)</option></select></label>
                    <label>Dressing: <select id="b-dressing"><option value="0">Dependent (0)</option><option value="5">Needs help (5)</option><option value="10">Independent (10)</option></select></label>
                    <label>Bowels: <select id="b-bowels"><option value="0">Incontinent (0)</option><option value="5">Occasional accident (5)</option><option value="10">Continent (10)</option></select></label>
                    <label>Bladder: <select id="b-bladder"><option value="0">Incontinent (0)</option><option value="5">Occasional accident (5)</option><option value="10">Continent (10)</option></select></label>
                    <label>Toilet use: <select id="b-toilet"><option value="0">Dependent (0)</option><option value="5">Needs some help (5)</option><option value="10">Independent (10)</option></select></label>
                    <label>Transfers (bed-chair): <select id="b-transfers"><option value="0">Dependent (0)</option><option value="5">Major help (5)</option><option value="10">Minor help (10)</option><option value="15">Independent (15)</option></select></label>
                    <label>Mobility (level): <select id="b-mobility"><option value="0">Dependent (0)</option><option value="5">Immobile (5)</option><option value="10">Walks with help (10)</option><option value="15">Independent (15)</option></select></label>
                    <label>Stairs: <select id="b-stairs"><option value="0">Unable (0)</option><option value="5">Needs help (5)</option><option value="10">Independent (10)</option></select></label>
                </div>
                <button onclick="window.quizApp.calculateBarthel()">Calculate</button>
                <div id="barthel-detail-result" class="calc-result"></div>
                <div class="calc-reference"><small>Score 0-100. Higher scores indicate greater independence.</small></div>
            </div>
        `;
    }

    calculateBarthel() {
        const ids = ['b-feeding','b-bathing','b-grooming','b-dressing','b-bowels','b-bladder','b-toilet','b-transfers','b-mobility','b-stairs'];
        let total = 0;
        ids.forEach(id => {
            const el = document.getElementById(id);
            if (el) total += parseInt(el.value, 10) || 0;
        });
        let interpretation = 'Total dependency';
        if (total === 100) interpretation = 'Independent';
        else if (total >= 91) interpretation = 'Slight dependency';
        else if (total >= 61) interpretation = 'Moderate dependency';
        else if (total >= 21) interpretation = 'Severe dependency';
        document.getElementById('barthel-detail-result').innerHTML = `
            <div>
                <strong>Barthel Total: ${total} / 100</strong>
                <div style="margin-top:8px">Interpretation: ${interpretation}</div>
            </div>
        `;
    }

    calculateBMI() {
        const weight = parseFloat(document.getElementById('bmi-weight').value);
        const height = parseFloat(document.getElementById('bmi-height').value) / 100; // Convert cm to m
        const waist = parseFloat(document.getElementById('bmi-waist').value);
        const ethnicity = document.getElementById('bmi-ethnicity').value;
        const sex = document.querySelector('input[name="bmi-sex"]:checked')?.value;
        
        if (!weight || !height) {
            document.getElementById('bmi-result').innerHTML = '<p class="error">Please enter valid weight and height</p>';
            return;
        }
        
        const bmi = weight / (height * height);
        let category = '';
        let color = '';
        let healthRisk = '';
        
        // Ethnic-specific BMI thresholds
        let overweightThreshold = 25;
        let obeseThreshold = 30;
        
        if (ethnicity === 'asian') {
            overweightThreshold = 23;
            obeseThreshold = 27.5;
        }
        
        if (bmi < 18.5) {
            category = 'Underweight';
            color = '#2196F3';
            healthRisk = 'Increased risk: nutritional deficiency, osteoporosis, immune dysfunction';
        } else if (bmi < overweightThreshold) {
            category = 'Normal weight';
            color = '#4CAF50';
            healthRisk = 'Optimal health risk profile';


// ========================================
// HASBLED (lines 4931-5331)
// ========================================
            <div class="calculator-header">
                <button class="back-btn" onclick="window.quizApp.switchMedicalTool('calculators'); event.stopPropagation();">‚Üê Back to Calculators</button>
                <h3 id="calculator-title"></h3>
            </div>
            <div class="calculator-content">
        `;
        
        let calculatorTitle = '';
        
        switch (calcType) {
        }
        calculatorContent = calculatorContent.replace('<h3 id="calculator-title"></h3>', `<h3 id="calculator-title">${calculatorTitle}</h3>`);
        container.innerHTML = calculatorContent;
        // Attach export buttons to results and per-calculator notes area
        try {
            // Ensure export features are available across calc-result blocks
            if (typeof this.setupExportFeatures === 'function') {
                this.setupExportFeatures();
            }
            // Add notes area for this calculator (persisted via localStorage)
            if (typeof this.setupCalculatorNotes === 'function') {
                this.setupCalculatorNotes(calcType);
            }
        } catch (err) {
            console.warn('‚ö†Ô∏è Failed to setup export/features or notes for calculator:', err);
        }
        console.log('üßÆ Loaded calculator:', calcType);
    }
    getBMICalculator() {
        return `
            <div class="calculator-form">
                <h4>BMI & Waist Circumference Calculator</h4>
                <div class="calc-input-group">
                    <label>Weight (kg):</label>
                    <input type="number" id="bmi-weight" placeholder="70" step="0.1">
                </div>
                <div class="calc-input-group">
                    <label>Height (cm):</label>
                    <input type="number" id="bmi-height" placeholder="175" step="0.1">
                </div>
                <div class="calc-input-group">
                    <label>Waist Circumference (cm) - Optional:</label>
                    <input type="number" id="bmi-waist" placeholder="85" step="0.1">
                </div>
                <div class="calc-input-group">
                    <label>Ethnicity:</label>
                    <select id="bmi-ethnicity">
                        <option value="european">European/Caucasian</option>
                        <option value="asian">Asian (Chinese, Japanese, South Asian)</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="calc-checkbox-group">
                    <label><input type="radio" name="bmi-sex" value="male"> Male</label>
                    <label><input type="radio" name="bmi-sex" value="female"> Female</label>
                </div>
                <button onclick="window.quizApp.calculateBMI()">Calculate</button>
                <div id="bmi-result" class="calc-result"></div>
                <div class="calc-reference">
                    <small>
                        <strong>BMI Categories (WHO):</strong><br>
                        Underweight: &lt;18.5 | Normal: 18.5-24.9<br>
                        Overweight: 25-29.9 | Obese: ‚â•30<br>
                        <strong>Asian populations:</strong> Overweight ‚â•23, Obese ‚â•27.5
                    </small>
                </div>
            </div>
        `;
    }

    getFrailtyCalculator() {
        return `
            <div class="calculator-form">
                <h4>Clinical Frailty Scale (Rockwood)</h4>
                <p><small>Select the category that best matches the patient</small></p>
                <div class="calc-input-group" id="frailty-options-detail">
                    <select id="frailty-select">
                        <option value="">-- Select frailty score --</option>
                        <option value="1">1 ‚Äî Very fit</option>
                        <option value="2">2 ‚Äî Well</option>
                        <option value="3">3 ‚Äî Managing well</option>
                        <option value="4">4 ‚Äî Vulnerable</option>
                        <option value="5">5 ‚Äî Mildly frail</option>
                        <option value="6">6 ‚Äî Moderately frail</option>
                        <option value="7">7 ‚Äî Severely frail</option>
                        <option value="8">8 ‚Äî Very severely frail</option>
                        <option value="9">9 ‚Äî Terminally ill</option>
                    </select>
                </div>
                <button onclick="window.quizApp.calculateFrailty()">Calculate</button>
                <div id="frailty-detail-result" class="calc-result"></div>
                <div class="calc-reference"><small>Rockwood Clinical Frailty Scale (1‚Äì9): use as an aid to clinical judgement.</small></div>
            </div>
        `;
    }

    calculateFrailty() {
        const sel = document.getElementById('frailty-select');
        const out = document.getElementById('frailty-detail-result');
        if (!sel || !out) return;
        const val = sel.value;
        if (!val) {
            out.innerHTML = '<p class="error">Please select a frailty score</p>';
            return;
        }
        const descriptions = {
            1: 'Very fit ‚Äî robust, active, energetic and motivated. Typically exercises regularly.',
            2: 'Well ‚Äî no active disease symptoms but less fit than category 1.',
            3: 'Managing well ‚Äî medical problems are well controlled, not regularly active beyond routine activities.',
            4: 'Vulnerable ‚Äî not dependent on others for daily help, but symptoms limit activities.',
            5: 'Mildly frail ‚Äî evident slowing and need help in high order instrumental activities of daily living.',
            6: 'Moderately frail ‚Äî need help with all outside activities and with keeping house.',
            7: 'Severely frail ‚Äî completely dependent for personal care, but stable and not at high risk of dying within 6 months.',
            8: 'Very severely frail ‚Äî completely dependent, approaching the end of life. Typically approaching high risk of dying.',
            9: 'Terminally ill ‚Äî life expectancy <6 months, not otherwise evidently frail.'
        };
        const guidance = (n) => {
            const num = parseInt(n, 10);
            if (num <= 3) return 'Not frail ‚Äî encourage activity and prevention.';
            if (num === 4) return 'Pre-frail/vulnerable ‚Äî consider targeted interventions (exercise, medication review).';
            if (num >=5 && num <=6) return 'Frailty present ‚Äî consider CGA, falls review and medication optimisation.';
            return 'High dependency ‚Äî prioritise care needs, consider palliative needs assessment where appropriate.';
        };

        out.innerHTML = `
            <div>
                <strong>Score: ${val}</strong>
                <div style="margin-top:8px">${descriptions[val]}</div>
                <div style="margin-top:8px;color:#374151;font-weight:600">${guidance(val)}</div>
            </div>
        `;
    }

    getBarthelCalculator() {
        return `
            <div class="calculator-form">
                <h4>Barthel Index (ADL)</h4>
                <p><small>Complete the items and press Calculate</small></p>
                <div class="calc-input-group" id="barthel-detail-items">
                    <!-- Simplified form: items named to match common Barthel scoring -->
                    <label>Feeding: <select id="b-feeding"><option value="0">Dependent (0)</option><option value="5">Needs assistance (5)</option><option value="10">Independent (10)</option></select></label>
                    <label>Bathing: <select id="b-bathing"><option value="0">Dependent (0)</option><option value="5">Independent (5)</option></select></label>
                    <label>Grooming: <select id="b-grooming"><option value="0">Needs help (0)</option><option value="5">Independent (5)</option></select></label>
                    <label>Dressing: <select id="b-dressing"><option value="0">Dependent (0)</option><option value="5">Needs help (5)</option><option value="10">Independent (10)</option></select></label>
                    <label>Bowels: <select id="b-bowels"><option value="0">Incontinent (0)</option><option value="5">Occasional accident (5)</option><option value="10">Continent (10)</option></select></label>
                    <label>Bladder: <select id="b-bladder"><option value="0">Incontinent (0)</option><option value="5">Occasional accident (5)</option><option value="10">Continent (10)</option></select></label>
                    <label>Toilet use: <select id="b-toilet"><option value="0">Dependent (0)</option><option value="5">Needs some help (5)</option><option value="10">Independent (10)</option></select></label>
                    <label>Transfers (bed-chair): <select id="b-transfers"><option value="0">Dependent (0)</option><option value="5">Major help (5)</option><option value="10">Minor help (10)</option><option value="15">Independent (15)</option></select></label>


// ========================================
// MEWS (lines 4955-5355)
// ========================================
                calculatorContent += this.getGCSCalculator();
                break;
        }
        calculatorContent = calculatorContent.replace('<h3 id="calculator-title"></h3>', `<h3 id="calculator-title">${calculatorTitle}</h3>`);
        container.innerHTML = calculatorContent;
        // Attach export buttons to results and per-calculator notes area
        try {
            // Ensure export features are available across calc-result blocks
            if (typeof this.setupExportFeatures === 'function') {
                this.setupExportFeatures();
            }
            // Add notes area for this calculator (persisted via localStorage)
            if (typeof this.setupCalculatorNotes === 'function') {
                this.setupCalculatorNotes(calcType);
            }
        } catch (err) {
            console.warn('‚ö†Ô∏è Failed to setup export/features or notes for calculator:', err);
        }
        console.log('üßÆ Loaded calculator:', calcType);
    }
    getBMICalculator() {
        return `
            <div class="calculator-form">
                <h4>BMI & Waist Circumference Calculator</h4>
                <div class="calc-input-group">
                    <label>Weight (kg):</label>
                    <input type="number" id="bmi-weight" placeholder="70" step="0.1">
                </div>
                <div class="calc-input-group">
                    <label>Height (cm):</label>
                    <input type="number" id="bmi-height" placeholder="175" step="0.1">
                </div>
                <div class="calc-input-group">
                    <label>Waist Circumference (cm) - Optional:</label>
                    <input type="number" id="bmi-waist" placeholder="85" step="0.1">
                </div>
                <div class="calc-input-group">
                    <label>Ethnicity:</label>
                    <select id="bmi-ethnicity">
                        <option value="european">European/Caucasian</option>
                        <option value="asian">Asian (Chinese, Japanese, South Asian)</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="calc-checkbox-group">
                    <label><input type="radio" name="bmi-sex" value="male"> Male</label>
                    <label><input type="radio" name="bmi-sex" value="female"> Female</label>
                </div>
                <button onclick="window.quizApp.calculateBMI()">Calculate</button>
                <div id="bmi-result" class="calc-result"></div>
                <div class="calc-reference">
                    <small>
                        <strong>BMI Categories (WHO):</strong><br>
                        Underweight: &lt;18.5 | Normal: 18.5-24.9<br>
                        Overweight: 25-29.9 | Obese: ‚â•30<br>
                        <strong>Asian populations:</strong> Overweight ‚â•23, Obese ‚â•27.5
                    </small>
                </div>
            </div>
        `;
    }

    getFrailtyCalculator() {
        return `
            <div class="calculator-form">
                <h4>Clinical Frailty Scale (Rockwood)</h4>
                <p><small>Select the category that best matches the patient</small></p>
                <div class="calc-input-group" id="frailty-options-detail">
                    <select id="frailty-select">
                        <option value="">-- Select frailty score --</option>
                        <option value="1">1 ‚Äî Very fit</option>
                        <option value="2">2 ‚Äî Well</option>
                        <option value="3">3 ‚Äî Managing well</option>
                        <option value="4">4 ‚Äî Vulnerable</option>
                        <option value="5">5 ‚Äî Mildly frail</option>
                        <option value="6">6 ‚Äî Moderately frail</option>
                        <option value="7">7 ‚Äî Severely frail</option>
                        <option value="8">8 ‚Äî Very severely frail</option>
                        <option value="9">9 ‚Äî Terminally ill</option>
                    </select>
                </div>
                <button onclick="window.quizApp.calculateFrailty()">Calculate</button>
                <div id="frailty-detail-result" class="calc-result"></div>
                <div class="calc-reference"><small>Rockwood Clinical Frailty Scale (1‚Äì9): use as an aid to clinical judgement.</small></div>
            </div>
        `;
    }

    calculateFrailty() {
        const sel = document.getElementById('frailty-select');
        const out = document.getElementById('frailty-detail-result');
        if (!sel || !out) return;
        const val = sel.value;
        if (!val) {
            out.innerHTML = '<p class="error">Please select a frailty score</p>';
            return;
        }
        const descriptions = {
            1: 'Very fit ‚Äî robust, active, energetic and motivated. Typically exercises regularly.',
            2: 'Well ‚Äî no active disease symptoms but less fit than category 1.',
            3: 'Managing well ‚Äî medical problems are well controlled, not regularly active beyond routine activities.',
            4: 'Vulnerable ‚Äî not dependent on others for daily help, but symptoms limit activities.',
            5: 'Mildly frail ‚Äî evident slowing and need help in high order instrumental activities of daily living.',
            6: 'Moderately frail ‚Äî need help with all outside activities and with keeping house.',
            7: 'Severely frail ‚Äî completely dependent for personal care, but stable and not at high risk of dying within 6 months.',
            8: 'Very severely frail ‚Äî completely dependent, approaching the end of life. Typically approaching high risk of dying.',
            9: 'Terminally ill ‚Äî life expectancy <6 months, not otherwise evidently frail.'
        };
        const guidance = (n) => {
            const num = parseInt(n, 10);
            if (num <= 3) return 'Not frail ‚Äî encourage activity and prevention.';
            if (num === 4) return 'Pre-frail/vulnerable ‚Äî consider targeted interventions (exercise, medication review).';
            if (num >=5 && num <=6) return 'Frailty present ‚Äî consider CGA, falls review and medication optimisation.';
            return 'High dependency ‚Äî prioritise care needs, consider palliative needs assessment where appropriate.';
        };

        out.innerHTML = `
            <div>
                <strong>Score: ${val}</strong>
                <div style="margin-top:8px">${descriptions[val]}</div>
                <div style="margin-top:8px;color:#374151;font-weight:600">${guidance(val)}</div>
            </div>
        `;
    }

    getBarthelCalculator() {
        return `
            <div class="calculator-form">
                <h4>Barthel Index (ADL)</h4>
                <p><small>Complete the items and press Calculate</small></p>
                <div class="calc-input-group" id="barthel-detail-items">
                    <!-- Simplified form: items named to match common Barthel scoring -->
                    <label>Feeding: <select id="b-feeding"><option value="0">Dependent (0)</option><option value="5">Needs assistance (5)</option><option value="10">Independent (10)</option></select></label>
                    <label>Bathing: <select id="b-bathing"><option value="0">Dependent (0)</option><option value="5">Independent (5)</option></select></label>
                    <label>Grooming: <select id="b-grooming"><option value="0">Needs help (0)</option><option value="5">Independent (5)</option></select></label>
                    <label>Dressing: <select id="b-dressing"><option value="0">Dependent (0)</option><option value="5">Needs help (5)</option><option value="10">Independent (10)</option></select></label>
                    <label>Bowels: <select id="b-bowels"><option value="0">Incontinent (0)</option><option value="5">Occasional accident (5)</option><option value="10">Continent (10)</option></select></label>
                    <label>Bladder: <select id="b-bladder"><option value="0">Incontinent (0)</option><option value="5">Occasional accident (5)</option><option value="10">Continent (10)</option></select></label>
                    <label>Toilet use: <select id="b-toilet"><option value="0">Dependent (0)</option><option value="5">Needs some help (5)</option><option value="10">Independent (10)</option></select></label>
                    <label>Transfers (bed-chair): <select id="b-transfers"><option value="0">Dependent (0)</option><option value="5">Major help (5)</option><option value="10">Minor help (10)</option><option value="15">Independent (15)</option></select></label>
                    <label>Mobility (level): <select id="b-mobility"><option value="0">Dependent (0)</option><option value="5">Immobile (5)</option><option value="10">Walks with help (10)</option><option value="15">Independent (15)</option></select></label>
                    <label>Stairs: <select id="b-stairs"><option value="0">Unable (0)</option><option value="5">Needs help (5)</option><option value="10">Independent (10)</option></select></label>
                </div>
                <button onclick="window.quizApp.calculateBarthel()">Calculate</button>
                <div id="barthel-detail-result" class="calc-result"></div>
                <div class="calc-reference"><small>Score 0-100. Higher scores indicate greater independence.</small></div>
            </div>
        `;
    }

    calculateBarthel() {
        const ids = ['b-feeding','b-bathing','b-grooming','b-dressing','b-bowels','b-bladder','b-toilet','b-transfers','b-mobility','b-stairs'];
        let total = 0;
        ids.forEach(id => {
            const el = document.getElementById(id);
            if (el) total += parseInt(el.value, 10) || 0;
        });
        let interpretation = 'Total dependency';
        if (total === 100) interpretation = 'Independent';
        else if (total >= 91) interpretation = 'Slight dependency';
        else if (total >= 61) interpretation = 'Moderate dependency';
        else if (total >= 21) interpretation = 'Severe dependency';
        document.getElementById('barthel-detail-result').innerHTML = `
            <div>


// ========================================
// NEWS (lines 8636-9036)
// ========================================
                    <label>Systolic BP (mmHg):</label>
                    <input type="number" id="news2-sbp" placeholder="120" min="50" max="300">
                </div>
                <div class="calc-input-group">
                    <label>Heart Rate (bpm):</label>
                    <input type="number" id="news2-hr" placeholder="80" min="30" max="200">
                </div>
                <div class="calc-input-group">
                    <label>AVPU:</label>
                    <select id="news2-avpu">
                        <option value="0">Alert (0 points)</option>
                        <option value="3">Voice, Pain, or Unresponsive (3 points)</option>
                    </select>
                </div>
                <div class="calc-input-group">
                    <label>Temperature (¬∞C):</label>
                    <input type="number" id="news2-temp" placeholder="36.5" step="0.1" min="30" max="45">
                </div>
                
                <button onclick="window.quizApp.calculateNEWS2()">Calculate NEWS2</button>
                <div id="news2-result" class="calc-result"></div>
            </div>
        `;
    }

    calculateNEWS2() {
        const rr = parseInt(document.getElementById('news2-rr').value) || 0;
        const spo2 = parseInt(document.getElementById('news2-spo2').value) || 0;
        const sbp = parseInt(document.getElementById('news2-sbp').value) || 0;
        const hr = parseInt(document.getElementById('news2-hr').value) || 0;
        const avpu = parseInt(document.getElementById('news2-avpu').value) || 0;
        const temp = parseFloat(document.getElementById('news2-temp').value) || 0;
        const oxygen = document.getElementById('news2-air').checked;
        const hypercapnic = document.getElementById('news2-hypercapnic').checked;
        
        let score = 0;
        
        // Respiratory rate
        if (rr <= 8) score += 3;
        else if (rr <= 11) score += 1;
        else if (rr <= 20) score += 0;
        else if (rr <= 24) score += 2;
        else score += 3;
        
        // SpO2 (Scale 1 or 2)
        if (hypercapnic) {
            // Scale 2 (COPD patients)
            if (spo2 <= 83) score += 3;
            else if (spo2 <= 85) score += 2;
            else if (spo2 <= 87) score += 1;
            else if (spo2 <= 92) score += 0;
            else if (spo2 <= 94) score += 1;
            else if (spo2 <= 96) score += 2;
            else score += 3;
        } else {
            // Scale 1 (standard)
            if (spo2 <= 91) score += 3;
            else if (spo2 <= 93) score += 2;
            else if (spo2 <= 95) score += 1;
            else score += 0;
        }
        
        // Supplemental oxygen
        if (oxygen) score += 2;
        
        // Systolic BP
        if (sbp <= 90) score += 3;
        else if (sbp <= 100) score += 2;
        else if (sbp <= 110) score += 1;
        else if (sbp <= 219) score += 0;
        else score += 3;
        
        // Heart rate
        if (hr <= 40) score += 3;
        else if (hr <= 50) score += 1;
        else if (hr <= 90) score += 0;
        else if (hr <= 110) score += 1;
        else if (hr <= 130) score += 2;
        else score += 3;
        
        // AVPU
        score += avpu;
        
        // Temperature
        if (temp <= 35.0) score += 3;
        else if (temp <= 36.0) score += 1;
        else if (temp <= 38.0) score += 0;
        else if (temp <= 39.0) score += 1;
        else score += 2;
        
        let risk = '';
        let action = '';
        let color = '';
        
        if (score === 0) {
            risk = 'Low risk';
            action = 'Continue routine monitoring (12 hourly)';
            color = '#4CAF50';
        } else if (score <= 4) {
            risk = 'Low-medium risk';
            action = 'Increase monitoring (4-6 hourly). Consider medical review';
            color = '#FFC107';
        } else if (score <= 6) {
            risk = 'Medium risk';
            action = 'Hourly monitoring. Urgent medical review';
            color = '#FF9800';
        } else {
            risk = 'High risk';
            action = 'Continuous monitoring. Immediate medical review. Consider critical care';
            color = '#F44336';
        }
        
        document.getElementById('news2-result').innerHTML = `
            <div style="color: ${color}">
                <strong>NEWS2 Score: ${score}</strong><br>
                <strong>${risk}</strong><br>
                <div style="margin-top: 8px; font-weight: bold;">
                    ${action}
                </div>
            </div>
        `;
    }

    getCURB65Calculator() {
        return `
            <div class="calculator-form">
                <h4>CURB-65 Score</h4>
                <p><small>Enhanced CAP severity assessment (includes urea)</small></p>
                
                <div class="calc-checkbox-group">
                    <label><input type="checkbox" id="curb-confusion"> Confusion (AMT ‚â§8 or new disorientation)</label>
                    <label><input type="checkbox" id="curb-urea"> Urea >7 mmol/L</label>
                    <label><input type="checkbox" id="curb-rr"> Respiratory rate ‚â•30/min</label>
                    <label><input type="checkbox" id="curb-bp"> Systolic BP <90 or Diastolic BP ‚â§60</label>
                    <label><input type="checkbox" id="curb-age"> Age ‚â•65 years</label>
                </div>
                
                <button onclick="window.quizApp.calculateCURB65()">Calculate Score</button>
                <div id="curb65-result" class="calc-result"></div>
                
                <div class="calc-reference">
                    <small>
                        <strong>Comparison with CRB-65:</strong><br>
                        CURB-65 includes urea level, providing more accurate risk stratification than CRB-65
                    </small>
                </div>
            </div>
        `;
    }

    calculateCURB65() {
        let score = 0;
        
        if (document.getElementById('curb-confusion').checked) score += 1;
        if (document.getElementById('curb-urea').checked) score += 1;
        if (document.getElementById('curb-rr').checked) score += 1;
        if (document.getElementById('curb-bp').checked) score += 1;
        if (document.getElementById('curb-age').checked) score += 1;

        let mortality = '';
        let management = '';
        let color = '';

        if (score === 0) {
            mortality = '0.7% 30-day mortality';
            management = 'Home treatment (NICE CG191)';
            color = '#4CAF50';
        } else if (score === 1) {
            mortality = '2.1% 30-day mortality';
            management = 'Home treatment or short hospital stay';
            color = '#8BC34A';
        } else if (score === 2) {
            mortality = '9.2% 30-day mortality';
            management = 'Hospital admission recommended';
            color = '#FF9800';
        } else if (score === 3) {
            mortality = '14.5% 30-day mortality';
            management = 'Hospital admission - consider ICU assessment';
            color = '#F44336';
        } else if (score >= 4) {
            mortality = '‚â•27% 30-day mortality';
            management = 'Urgent hospital admission - high dependency/ICU care';
            color = '#D32F2F';
        }

        document.getElementById('curb65-result').innerHTML = `
            <div style="color: ${color}">
                <strong>CURB-65 Score: ${score}/5</strong><br>
                <strong>${mortality}</strong><br>
                <strong>Management: ${management}</strong>
            </div>
        `;
    }

    getPalliativeCalculator() {
        return `
            <div class="calculator-form">
                <h4>üå∏ Palliative Care Drug Calculator</h4>
                <p><small>Morphine equivalents, breakthrough dosing, and symptom management</small></p>
                
                <div class="calc-section">
                    <h5>üìä Opioid Conversion</h5>
                    <div class="calc-input-group">
                        <label>Current Opioid:</label>
                        <select id="palliative-current-opioid">
                            <option value="morphine-oral">Morphine (oral)</option>
                            <option value="morphine-sc">Morphine (subcutaneous)</option>
                            <option value="oxycodone-oral">Oxycodone (oral)</option>
                            <option value="fentanyl-patch">Fentanyl (patch mcg/hr)</option>
                            <option value="codeine">Codeine</option>
                            <option value="tramadol">Tramadol</option>
                            <option value="buprenorphine-patch">Buprenorphine (patch mcg/hr)</option>
                        </select>
                    </div>
                    <div class="calc-input-group">
                        <label>Current Daily Dose (mg or mcg/hr for patches):</label>
                        <input type="number" id="palliative-current-dose" placeholder="60" step="0.1">
                    </div>
                    <div class="calc-input-group">
                        <label>Convert to:</label>
                        <select id="palliative-target-opioid">
                            <option value="morphine-oral">Morphine (oral)</option>
                            <option value="morphine-sc">Morphine (subcutaneous)</option>
                            <option value="oxycodone-oral">Oxycodone (oral)</option>
                            <option value="fentanyl-patch">Fentanyl (patch mcg/hr)</option>
                            <option value="diamorphine-sc">Diamorphine (subcutaneous)</option>
                        </select>
                    </div>
                    <button onclick="window.quizApp.calculateOpioidConversion()">Convert Opioid</button>
                    <div id="opioid-conversion-result" class="calc-result"></div>
                </div>

                <div class="calc-section">
                    <h5>üíâ Breakthrough Dosing</h5>
                    <div class="calc-input-group">
                        <label>Total Daily Morphine Equivalent (mg):</label>
                        <input type="number" id="palliative-daily-morphine" placeholder="60" step="1">
                    </div>
                    <button onclick="window.quizApp.calculateBreakthroughDose()">Calculate Breakthrough</button>
                    <div id="breakthrough-result" class="calc-result"></div>
                </div>

                <div class="calc-section">
                    <h5>ü§ß Anti-emetic Calculator</h5>
                    <div class="calc-input-group">
                        <label>Patient Weight (kg):</label>
                        <input type="number" id="palliative-weight" placeholder="70" step="1">
                    </div>
                    <div class="calc-input-group">
                        <label>Cause of Nausea:</label>
                        <select id="palliative-nausea-cause">
                            <option value="opioid">Opioid-induced</option>
                            <option value="chemotherapy">Chemotherapy</option>
                            <option value="bowel-obstruction">Bowel obstruction</option>
                            <option value="raised-icp">Raised ICP</option>
                            <option value="metabolic">Metabolic</option>
                            <option value="vestibular">Vestibular</option>
                        </select>
                    </div>
                    <button onclick="window.quizApp.calculateAntiemetic()">Recommend Anti-emetic</button>
                    <div id="antiemetic-result" class="calc-result"></div>
                </div>

                <div class="calc-section">
                    <h5>ü´Å Respiratory Secretions</h5>
                    <div class="calc-input-group">
                        <label>Patient Weight (kg):</label>
                        <input type="number" id="palliative-secretions-weight" placeholder="70" step="1">
                    </div>
                    <div class="calc-input-group">
                        <label>Secretion Type:</label>
                        <select id="palliative-secretion-type">
                            <option value="bronchial">Bronchial secretions</option>
                            <option value="salivary">Excessive salivation</option>
                            <option value="death-rattle">Death rattle</option>
                        </select>
                    </div>
                    <button onclick="window.quizApp.calculateSecretionManagement()">Calculate Doses</button>
                    <div id="secretion-result" class="calc-result"></div>
                </div>

                <div class="calc-reference">
                    <small>
                        <strong>‚ö†Ô∏è Important Notes:</strong><br>
                        ‚Ä¢ All doses are starting suggestions - titrate to effect<br>
                        ‚Ä¢ Consider 25-50% dose reduction if frail/elderly<br>
                        ‚Ä¢ Monitor for sedation and respiratory depression<br>
                        ‚Ä¢ Seek specialist palliative care advice for complex cases<br>
                        ‚Ä¢ These calculations are guidelines only
                    </small>
                </div>
            </div>
        `;
    }

    // Wells DVT Score Calculator
    getWellsDVTCalculator() {
        return `
            <div class="calc-section">
                <h3>Wells Score for DVT</h3>
                <p>Assesses probability of deep vein thrombosis</p>
                
                <div class="calc-input-group">
                    <label>
                        <input type="checkbox" id="wells-dvt-cancer" value="1">
                        Active cancer (treatment within 6 months or palliative) (+1)
                    </label>
                </div>
                
                <div class="calc-input-group">
                    <label>
                        <input type="checkbox" id="wells-dvt-paralysis" value="1">
                        Paralysis, paresis, or recent plaster immobilisation of lower extremity (+1)
                    </label>
                </div>
                
                <div class="calc-input-group">
                    <label>
                        <input type="checkbox" id="wells-dvt-bedridden" value="1">
                        Recently bedridden >3 days or major surgery within 12 weeks (+1)
                    </label>
                </div>
                
                <div class="calc-input-group">
                    <label>
                        <input type="checkbox" id="wells-dvt-tenderness" value="1">
                        Localized tenderness along deep venous system (+1)
                    </label>
                </div>
                
                <div class="calc-input-group">
                    <label>
                        <input type="checkbox" id="wells-dvt-swelling" value="1">
                        Entire leg swollen (+1)
                    </label>
                </div>
                
                <div class="calc-input-group">
                    <label>
                        <input type="checkbox" id="wells-dvt-calf" value="1">
                        Calf swelling >3cm compared to asymptomatic leg (+1)
                    </label>
                </div>
                
                <div class="calc-input-group">
                    <label>
                        <input type="checkbox" id="wells-dvt-pitting" value="1">
                        Pitting edema confined to symptomatic leg (+1)
                    </label>
                </div>
                
                <div class="calc-input-group">
                    <label>
                        <input type="checkbox" id="wells-dvt-veins" value="1">
                        Collateral superficial veins (non-varicose) (+1)
                    </label>
                </div>
                
                <div class="calc-input-group">
                    <label>
                        <input type="checkbox" id="wells-dvt-previous" value="1">
                        Previously documented DVT (+1)
                    </label>
                </div>
                
                <div class="calc-input-group">
                    <label>
                        <input type="checkbox" id="wells-dvt-alternative" value="-2">
                        Alternative diagnosis at least as likely as DVT (-2)
                    </label>
                </div>
                
                <button class="calc-button" onclick="window.quizApp.calculateWellsDVT()">Calculate Wells DVT Score</button>
                <div id="wells-dvt-result" class="calc-result"></div>
                
                <div class="calc-notes">
                    <small>
                        <strong>Clinical Use:</strong><br>
                        ‚Ä¢ ‚â§0 points: DVT unlikely - consider D-dimer<br>
                        ‚Ä¢ 1-2 points: Moderate probability - D-dimer or imaging<br>
                        ‚Ä¢ ‚â•3 points: DVT likely - proceed to imaging<br>
                        ‚Ä¢ Two-level Wells: ‚â§1 = unlikely, ‚â•2 = likely
                    </small>
                </div>
            </div>
        `;
    }

    calculateWellsDVT() {
        const items = [
            'wells-dvt-cancer', 'wells-dvt-paralysis', 'wells-dvt-bedridden',
            'wells-dvt-tenderness', 'wells-dvt-swelling', 'wells-dvt-calf',
            'wells-dvt-pitting', 'wells-dvt-veins', 'wells-dvt-previous', 'wells-dvt-alternative'
        ];
        
        let score = 0;
        items.forEach(id => {
            const element = document.getElementById(id);
            if (element && element.checked) {
                score += parseInt(element.value);
            }


// ========================================
// NIHSS (lines 5079-5479)
// ========================================
                calculatorContent += this.getFractureRiskCalculator();
                break;
        }
        calculatorContent = calculatorContent.replace('<h3 id="calculator-title"></h3>', `<h3 id="calculator-title">${calculatorTitle}</h3>`);
        container.innerHTML = calculatorContent;
        // Attach export buttons to results and per-calculator notes area
        try {
            // Ensure export features are available across calc-result blocks
            if (typeof this.setupExportFeatures === 'function') {
                this.setupExportFeatures();
            }
            // Add notes area for this calculator (persisted via localStorage)
            if (typeof this.setupCalculatorNotes === 'function') {
                this.setupCalculatorNotes(calcType);
            }
        } catch (err) {
            console.warn('‚ö†Ô∏è Failed to setup export/features or notes for calculator:', err);
        }
        console.log('üßÆ Loaded calculator:', calcType);
    }
    getBMICalculator() {
        return `
            <div class="calculator-form">
                <h4>BMI & Waist Circumference Calculator</h4>
                <div class="calc-input-group">
                    <label>Weight (kg):</label>
                    <input type="number" id="bmi-weight" placeholder="70" step="0.1">
                </div>
                <div class="calc-input-group">
                    <label>Height (cm):</label>
                    <input type="number" id="bmi-height" placeholder="175" step="0.1">
                </div>
                <div class="calc-input-group">
                    <label>Waist Circumference (cm) - Optional:</label>
                    <input type="number" id="bmi-waist" placeholder="85" step="0.1">
                </div>
                <div class="calc-input-group">
                    <label>Ethnicity:</label>
                    <select id="bmi-ethnicity">
                        <option value="european">European/Caucasian</option>
                        <option value="asian">Asian (Chinese, Japanese, South Asian)</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="calc-checkbox-group">
                    <label><input type="radio" name="bmi-sex" value="male"> Male</label>
                    <label><input type="radio" name="bmi-sex" value="female"> Female</label>
                </div>
                <button onclick="window.quizApp.calculateBMI()">Calculate</button>
                <div id="bmi-result" class="calc-result"></div>
                <div class="calc-reference">
                    <small>
                        <strong>BMI Categories (WHO):</strong><br>
                        Underweight: &lt;18.5 | Normal: 18.5-24.9<br>
                        Overweight: 25-29.9 | Obese: ‚â•30<br>
                        <strong>Asian populations:</strong> Overweight ‚â•23, Obese ‚â•27.5
                    </small>
                </div>
            </div>
        `;
    }

    getFrailtyCalculator() {
        return `
            <div class="calculator-form">
                <h4>Clinical Frailty Scale (Rockwood)</h4>
                <p><small>Select the category that best matches the patient</small></p>
                <div class="calc-input-group" id="frailty-options-detail">
                    <select id="frailty-select">
                        <option value="">-- Select frailty score --</option>
                        <option value="1">1 ‚Äî Very fit</option>
                        <option value="2">2 ‚Äî Well</option>
                        <option value="3">3 ‚Äî Managing well</option>
                        <option value="4">4 ‚Äî Vulnerable</option>
                        <option value="5">5 ‚Äî Mildly frail</option>
                        <option value="6">6 ‚Äî Moderately frail</option>
                        <option value="7">7 ‚Äî Severely frail</option>
                        <option value="8">8 ‚Äî Very severely frail</option>
                        <option value="9">9 ‚Äî Terminally ill</option>
                    </select>
                </div>
                <button onclick="window.quizApp.calculateFrailty()">Calculate</button>
                <div id="frailty-detail-result" class="calc-result"></div>
                <div class="calc-reference"><small>Rockwood Clinical Frailty Scale (1‚Äì9): use as an aid to clinical judgement.</small></div>
            </div>
        `;
    }

    calculateFrailty() {
        const sel = document.getElementById('frailty-select');
        const out = document.getElementById('frailty-detail-result');
        if (!sel || !out) return;
        const val = sel.value;
        if (!val) {
            out.innerHTML = '<p class="error">Please select a frailty score</p>';
            return;
        }
        const descriptions = {
            1: 'Very fit ‚Äî robust, active, energetic and motivated. Typically exercises regularly.',
            2: 'Well ‚Äî no active disease symptoms but less fit than category 1.',
            3: 'Managing well ‚Äî medical problems are well controlled, not regularly active beyond routine activities.',
            4: 'Vulnerable ‚Äî not dependent on others for daily help, but symptoms limit activities.',
            5: 'Mildly frail ‚Äî evident slowing and need help in high order instrumental activities of daily living.',
            6: 'Moderately frail ‚Äî need help with all outside activities and with keeping house.',
            7: 'Severely frail ‚Äî completely dependent for personal care, but stable and not at high risk of dying within 6 months.',
            8: 'Very severely frail ‚Äî completely dependent, approaching the end of life. Typically approaching high risk of dying.',
            9: 'Terminally ill ‚Äî life expectancy <6 months, not otherwise evidently frail.'
        };
        const guidance = (n) => {
            const num = parseInt(n, 10);
            if (num <= 3) return 'Not frail ‚Äî encourage activity and prevention.';
            if (num === 4) return 'Pre-frail/vulnerable ‚Äî consider targeted interventions (exercise, medication review).';
            if (num >=5 && num <=6) return 'Frailty present ‚Äî consider CGA, falls review and medication optimisation.';
            return 'High dependency ‚Äî prioritise care needs, consider palliative needs assessment where appropriate.';
        };

        out.innerHTML = `
            <div>
                <strong>Score: ${val}</strong>
                <div style="margin-top:8px">${descriptions[val]}</div>
                <div style="margin-top:8px;color:#374151;font-weight:600">${guidance(val)}</div>
            </div>
        `;
    }

    getBarthelCalculator() {
        return `
            <div class="calculator-form">
                <h4>Barthel Index (ADL)</h4>
                <p><small>Complete the items and press Calculate</small></p>
                <div class="calc-input-group" id="barthel-detail-items">
                    <!-- Simplified form: items named to match common Barthel scoring -->
                    <label>Feeding: <select id="b-feeding"><option value="0">Dependent (0)</option><option value="5">Needs assistance (5)</option><option value="10">Independent (10)</option></select></label>
                    <label>Bathing: <select id="b-bathing"><option value="0">Dependent (0)</option><option value="5">Independent (5)</option></select></label>
                    <label>Grooming: <select id="b-grooming"><option value="0">Needs help (0)</option><option value="5">Independent (5)</option></select></label>
                    <label>Dressing: <select id="b-dressing"><option value="0">Dependent (0)</option><option value="5">Needs help (5)</option><option value="10">Independent (10)</option></select></label>
                    <label>Bowels: <select id="b-bowels"><option value="0">Incontinent (0)</option><option value="5">Occasional accident (5)</option><option value="10">Continent (10)</option></select></label>
                    <label>Bladder: <select id="b-bladder"><option value="0">Incontinent (0)</option><option value="5">Occasional accident (5)</option><option value="10">Continent (10)</option></select></label>
                    <label>Toilet use: <select id="b-toilet"><option value="0">Dependent (0)</option><option value="5">Needs some help (5)</option><option value="10">Independent (10)</option></select></label>
                    <label>Transfers (bed-chair): <select id="b-transfers"><option value="0">Dependent (0)</option><option value="5">Major help (5)</option><option value="10">Minor help (10)</option><option value="15">Independent (15)</option></select></label>
                    <label>Mobility (level): <select id="b-mobility"><option value="0">Dependent (0)</option><option value="5">Immobile (5)</option><option value="10">Walks with help (10)</option><option value="15">Independent (15)</option></select></label>
                    <label>Stairs: <select id="b-stairs"><option value="0">Unable (0)</option><option value="5">Needs help (5)</option><option value="10">Independent (10)</option></select></label>
                </div>
                <button onclick="window.quizApp.calculateBarthel()">Calculate</button>
                <div id="barthel-detail-result" class="calc-result"></div>
                <div class="calc-reference"><small>Score 0-100. Higher scores indicate greater independence.</small></div>
            </div>
        `;
    }

    calculateBarthel() {
        const ids = ['b-feeding','b-bathing','b-grooming','b-dressing','b-bowels','b-bladder','b-toilet','b-transfers','b-mobility','b-stairs'];
        let total = 0;
        ids.forEach(id => {
            const el = document.getElementById(id);
            if (el) total += parseInt(el.value, 10) || 0;
        });
        let interpretation = 'Total dependency';
        if (total === 100) interpretation = 'Independent';
        else if (total >= 91) interpretation = 'Slight dependency';
        else if (total >= 61) interpretation = 'Moderate dependency';
        else if (total >= 21) interpretation = 'Severe dependency';
        document.getElementById('barthel-detail-result').innerHTML = `
            <div>
                <strong>Barthel Total: ${total} / 100</strong>
                <div style="margin-top:8px">Interpretation: ${interpretation}</div>
            </div>
        `;
    }

    calculateBMI() {
        const weight = parseFloat(document.getElementById('bmi-weight').value);
        const height = parseFloat(document.getElementById('bmi-height').value) / 100; // Convert cm to m
        const waist = parseFloat(document.getElementById('bmi-waist').value);
        const ethnicity = document.getElementById('bmi-ethnicity').value;
        const sex = document.querySelector('input[name="bmi-sex"]:checked')?.value;
        
        if (!weight || !height) {
            document.getElementById('bmi-result').innerHTML = '<p class="error">Please enter valid weight and height</p>';
            return;
        }
        
        const bmi = weight / (height * height);
        let category = '';
        let color = '';
        let healthRisk = '';
        
        // Ethnic-specific BMI thresholds
        let overweightThreshold = 25;
        let obeseThreshold = 30;
        
        if (ethnicity === 'asian') {
            overweightThreshold = 23;
            obeseThreshold = 27.5;
        }
        
        if (bmi < 18.5) {
            category = 'Underweight';
            color = '#2196F3';
            healthRisk = 'Increased risk: nutritional deficiency, osteoporosis, immune dysfunction';
        } else if (bmi < overweightThreshold) {
            category = 'Normal weight';
            color = '#4CAF50';
            healthRisk = 'Optimal health risk profile';
        } else if (bmi < obeseThreshold) {
            category = 'Overweight';
            color = '#FF9800';
            healthRisk = 'Increased risk: diabetes, cardiovascular disease, sleep apnoea';
        } else if (bmi < 35) {
            category = 'Obese Class I';
            color = '#F44336';
            healthRisk = 'High risk: diabetes, CVD, stroke, certain cancers';
        } else if (bmi < 40) {
            category = 'Obese Class II';
            color = '#D32F2F';
            healthRisk = 'Very high risk: consider bariatric surgery consultation';
        } else {
            category = 'Obese Class III';
            color = '#B71C1C';
            healthRisk = 'Extremely high risk: urgent weight management, consider bariatric surgery';
        }
        
        // Waist circumference assessment
        let waistAssessment = '';
        if (waist && sex) {
            let waistRisk = '';
            let waistColor = '#4CAF50';
            
            if (sex === 'male') {
                if (waist >= 102) {
                    waistRisk = 'Very high risk';
                    waistColor = '#F44336';
                } else if (waist >= 94) {
                    waistRisk = 'Increased risk';
                    waistColor = '#FF9800';
                } else {
                    waistRisk = 'Low risk';
                }
            } else {
                if (waist >= 88) {
                    waistRisk = 'Very high risk';
                    waistColor = '#F44336';
                } else if (waist >= 80) {
                    waistRisk = 'Increased risk';
                    waistColor = '#FF9800';
                } else {
                    waistRisk = 'Low risk';
                }
            }
            
            waistAssessment = `
                <div style="margin-top: 8px; padding: 6px; background: #f5f5f5; border-radius: 4px;">
                    <strong>Waist Circumference:</strong> ${waist} cm<br>
                    <span style="color: ${waistColor}; font-weight: bold;">${waistRisk}</span> for metabolic complications
                </div>
            `;
        }
        
        document.getElementById('bmi-result').innerHTML = `
            <div class="bmi-result-display">
                <div class="bmi-value" style="color: ${color}; font-size: 1.2em;">
                    <strong>BMI: ${bmi.toFixed(1)} kg/m¬≤</strong>
                </div>
                <div class="bmi-category" style="color: ${color}; font-weight: bold; margin: 4px 0;">
                    ${category}
                </div>
                <div style="margin-top: 8px; font-size: 0.9em; color: #666;">
                    ${healthRisk}
                </div>
                ${waistAssessment}
                <div style="margin-top: 8px; font-size: 0.8em; color: #666;">
                    ${ethnicity === 'asian' ? 'Using Asian-specific BMI thresholds' : 'Using WHO BMI thresholds'}
                </div>
            </div>
        `;
    }

    getCHADS2VAScCalculator() {
        return `
            <div class="calculator-form">
                <h4>CHA‚ÇÇDS‚ÇÇ-VASc Score</h4>
                <p><small>Stroke risk assessment in atrial fibrillation</small></p>
                
                <div class="calc-checkbox-group">
                    <label><input type="checkbox" id="chads-chf"> Congestive heart failure (+1)</label>
                    <label><input type="checkbox" id="chads-htn"> Hypertension (+1)</label>
                    <label><input type="checkbox" id="chads-age75"> Age ‚â•75 years (+2)</label>
                    <label><input type="checkbox" id="chads-diabetes"> Diabetes mellitus (+1)</label>


// ========================================
// Osmolality (lines 15467-15867)
// ========================================
                        tests: 'CT abdomen/pelvis (preferred), ultrasound (children/pregnancy), CBC (leukocytosis), urinalysis',
                        urgency: 'Emergency',
                        timeToTreat: 'Surgery within 12-24 hours, antibiotics if perforated',
                        clinicalPearls: 'Alvarado score for risk stratification. Atypical presentation in elderly, pregnant. Perforation risk increases with time',
                        differentiatingFeatures: 'Migration of pain to RLQ, rebound tenderness, fever'
                    },
                    'Cholecystitis': {
                        features: 'RUQ pain, Murphy sign, fat intolerance, fever, nausea. Risk factors: 4 Fs (fat, female, forty, fertile)',
                        tests: 'Ultrasound (gallstones, wall thickening), HIDA scan if unclear, LFTs, lipase',
                        urgency: 'Urgent',
                        timeToTreat: 'Cholecystectomy within 72 hours, antibiotics if complicated',
                        clinicalPearls: 'Murphy sign more specific than ultrasound findings. Emphysematous cholecystitis in diabetics',
                        differentiatingFeatures: 'RUQ pain, positive Murphy sign, gallstones on imaging'
                    },
                    'Pancreatitis': {
                        features: 'Epigastric pain radiating to back, nausea, vomiting. Triggers: alcohol, gallstones, hypertriglyceridemia',
                        tests: 'Lipase (>3√ó normal), amylase, CT abdomen if severe, LFTs, triglycerides',
                        urgency: 'Urgent',
                        timeToTreat: 'Supportive care, pain control, IV fluids, NPO',
                        clinicalPearls: 'Ranson criteria for severity. ERCP if gallstone pancreatitis. Watch for complications (pseudocyst, necrosis)',
                        differentiatingFeatures: 'Epigastric pain radiating to back, elevated lipase'
                    },
                    'Bowel obstruction': {
                        features: 'Crampy pain, nausea, vomiting, distension, constipation, high-pitched bowel sounds or silence',
                        tests: 'CT abdomen/pelvis (transition point), abdominal X-ray (dilated loops), CBC, BMP',
                        urgency: 'Emergency',
                        timeToTreat: 'NGT decompression, IV fluids, surgery if complete obstruction',
                        clinicalPearls: 'Small bowel: crampy, early vomiting. Large bowel: distension, late vomiting. Strangulation risk',
                        differentiatingFeatures: 'Crampy pain, vomiting, distension, abnormal bowel sounds'
                    },
                    'Diverticulitis': {
                        features: 'LLQ pain (Western), fever, change in bowel habits, tender mass. More common in elderly',
                        tests: 'CT abdomen/pelvis (wall thickening, fat stranding), CBC, CRP',
                        urgency: 'Urgent',
                        timeToTreat: 'Antibiotics (ciprofloxacin + metronidazole), bowel rest',
                        clinicalPearls: 'Avoid colonoscopy in acute phase. Hinchey classification for severity. Consider complications',
                        differentiatingFeatures: 'LLQ pain, older patient, known diverticulosis'
                    },
                    'Gastroenteritis': {
                        features: 'Crampy pain, diarrhea, nausea, vomiting, fever. Food/water exposure, contacts with similar illness',
                        tests: 'Clinical diagnosis, stool studies if severe/bloody, CBC if dehydrated',
                        urgency: 'Non-urgent',
                        timeToTreat: 'Supportive care, hydration, probiotics',
                        clinicalPearls: 'Usually self-limited. Antibiotics only if bacterial and severe. Watch for dehydration',
                        differentiatingFeatures: 'Diarrhea predominant, food/water exposure, multiple affected individuals'
                    },
                    'Peptic ulcer disease': {
                        features: 'Epigastric pain, relationship to meals (duodenal: hungry pain, gastric: worse with food), H. pylori history',
                        tests: 'H. pylori testing (stool antigen, urea breath test), upper endoscopy if alarming features',
                        urgency: 'Non-urgent',
                        timeToTreat: 'PPI therapy, H. pylori eradication if positive',
                        clinicalPearls: 'NSAID and H. pylori most common causes. Triple therapy for eradication. Watch for complications',
                        differentiatingFeatures: 'Relationship to meals, response to PPIs, H. pylori positive'
                    }
                }
            },
            'headache': {
                title: 'Headache',
                category: 'Neurology',
                redFlags: 'üö© Sudden severe (thunderclap), fever + neck stiffness, focal neurologic deficits, papilledema',
                presentations: {
                    'Migraine': {
                        features: 'Unilateral, throbbing, 4-72 hours, photophobia, phonophobia, nausea. Aura in 20%. Family history common',
                        tests: 'Clinical diagnosis, neuroimaging if atypical features or red flags',
                        urgency: 'Non-urgent',
                        timeToTreat: 'Triptans (within 2 hours), NSAIDs, antiemetics. Preventive therapy if frequent',
                        clinicalPearls: 'POUND criteria (Pulsating, One day, Unilateral, Nausea, Disabling). Avoid medication overuse',
                        differentiatingFeatures: 'Unilateral throbbing, photophobia, family history'
                    },
                    'Tension headache': {
                        features: 'Bilateral, pressing/tightening, mild-moderate, no photophobia/phonophobia, stress-related',
                        tests: 'Clinical diagnosis',
                        urgency: 'Non-urgent',
                        timeToTreat: 'NSAIDs, acetaminophen, stress management, relaxation techniques',
                        clinicalPearls: 'Most common primary headache. Often chronic. Exclude medication overuse',
                        differentiatingFeatures: 'Bilateral pressing pain, no associated symptoms'
                    },
                    'Cluster headache': {
                        features: 'Unilateral severe, orbital/temporal, 15min-3h, lacrimation, nasal congestion. Male predominance, circadian',
                        tests: 'Clinical diagnosis',
                        urgency: 'Urgent',
                        timeToTreat: 'High-flow oxygen, subcutaneous sumatriptan. Preventive: verapamil',
                        clinicalPearls: 'Attacks in clusters (weeks-months). Patient restless during attack. Alcohol trigger during cluster',
                        differentiatingFeatures: 'Severe unilateral orbital pain, autonomic symptoms, restlessness'
                    },
                    'Subarachnoid hemorrhage': {
                        features: 'Sudden severe (thunderclap), worst headache of life, neck stiffness, photophobia, altered consciousness',
                        tests: 'Non-contrast CT head (within 6h), LP if CT negative, CTA for aneurysm',
                        urgency: 'Emergency',
                        timeToTreat: 'Neurosurgical consultation, aneurysm securing, prevent vasospasm',
                        clinicalPearls: 'Sentinel headache may precede. Hunt-Hess grade for severity. Watch for complications',
                        differentiatingFeatures: 'Thunderclap onset, worst headache ever, meningeal signs'
                    },
                    'Meningitis': {
                        features: 'Fever, headache, neck stiffness, photophobia, altered mental status. Kernig/Brudzinski signs',
                        tests: 'LP (opening pressure, cell count, glucose, protein, culture), blood cultures, CT if focal signs',
                        urgency: 'Emergency',
                        timeToTreat: 'Antibiotics immediately after LP (within 1 hour), steroids for bacterial',
                        clinicalPearls: 'Classic triad only in 44%. Bacterial more acute, viral more indolent. Don\'t delay antibiotics',
                        differentiatingFeatures: 'Fever + headache + neck stiffness, altered mental status'
                    }
                }
            },
            'altered-mental-status': {
                title: 'Altered Mental Status',
                category: 'Neurology/Emergency',
                redFlags: 'üö© Focal neurological signs, hypoglycemia, hypoxia, severe hypotension, hyperthermia',
                presentations: {
                    'Hypoglycemia': {
                        features: 'Confusion, diaphoresis, tachycardia, tremor, hunger. History of diabetes, missed meals, medication errors',
                        tests: 'Blood glucose (<3.9 mmol/L), HbA1c, C-peptide if factitious suspected',
                        urgency: 'Emergency',
                        timeToTreat: 'Immediate glucose correction, glucagon if unable to swallow',
                        clinicalPearls: 'Whipple triad: symptoms + low glucose + relief with treatment. Consider sulphonylurea poisoning',
                        differentiatingFeatures: 'Rapid improvement with glucose, diaphoresis, known diabetes'
                    },
                    'Stroke/TIA': {
                        features: 'Sudden onset focal deficits, FAST positive, speech difficulties, weakness, vision changes',
                        tests: 'CT head (exclude haemorrhage), CT angiogram, MRI if available, ECG, glucose',
                        urgency: 'Emergency',
                        timeToTreat: 'Thrombolysis within 4.5 hours, thrombectomy within 6-24 hours',
                        clinicalPearls: 'ROSIER score for recognition. NIHSS for severity. Time is brain - rapid assessment crucial',
                        differentiatingFeatures: 'Sudden onset, focal signs, FAST positive'
                    },
                    'Sepsis/Septic shock': {
                        features: 'Fever/hypothermia, tachycardia, hypotension, altered mental state, source of infection',
                        tests: 'Blood cultures, lactate, FBC, CRP, procalcitonin, urinalysis, CXR',
                        urgency: 'Emergency',
                        timeToTreat: 'Antibiotics within 1 hour, fluid resuscitation, vasopressors if needed',
                        clinicalPearls: 'qSOFA score for screening. Lactate >2 indicates organ dysfunction. Source control important',
                        differentiatingFeatures: 'Systemic signs of infection, elevated lactate, hypotension'
                    },
                    'Drug intoxication': {
                        features: 'History of ingestion, pupils (miosis/mydriasis), respiratory depression, specific toxidromes',
                        tests: 'Toxicology screen, paracetamol/salicylate levels, ABG, glucose, U&Es',
                        urgency: 'Emergency',
                        timeToTreat: 'Supportive care, specific antidotes (naloxone, flumazenil), activated charcoal if early',
                        clinicalPearls: 'Common toxidromes: opioid (miosis, bradycardia), anticholinergic (mydriasis, dry skin)',
                        differentiatingFeatures: 'History of ingestion, specific toxidrome, response to antidotes'
                    },
                    'Hepatic encephalopathy': {
                        features: 'Known liver disease, asterixis, confusion to coma, precipitants (infection, GI bleed, drugs)',
                        tests: 'Ammonia (elevated), LFTs, FBC, U&Es, blood cultures, ascitic tap if present',
                        urgency: 'Urgent',
                        timeToTreat: 'Lactulose, rifaximin, identify and treat precipitants',
                        clinicalPearls: 'West Haven criteria for grading. Common precipitants: infection, GI bleeding, constipation',
                        differentiatingFeatures: 'Known cirrhosis, asterixis, elevated ammonia'
                    },
                    'Uremic encephalopathy': {
                        features: 'Known CKD, confusion, nausea, muscle twitching, pericardial friction rub',
                        tests: 'U&Es (very high urea/creatinine), urinalysis, ECG (hyperkalaemia), ABG',
                        urgency: 'Emergency',
                        timeToTreat: 'Urgent dialysis, treat hyperkalaemia if present',
                        clinicalPearls: 'Usually urea >40 mmol/L. Watch for hyperkalaemia. Dialysis definitive treatment',
                        differentiatingFeatures: 'Known renal failure, very high urea, muscle twitching'
                    }
                }
            },
            'dizziness': {
                title: 'Dizziness/Vertigo',
                category: 'Neurology/ENT',
                redFlags: 'üö© Focal neurological signs, severe headache, hearing loss, diplopia, dysarthria',
                presentations: {
                    'BPPV': {
                        features: 'Episodic rotational vertigo with position changes, Dix-Hallpike positive, nausea',
                        tests: 'Clinical diagnosis with Dix-Hallpike manoeuvre, audiometry if hearing concerns',
                        urgency: 'Non-urgent',
                        timeToTreat: 'Canalith repositioning procedures (Epley manoeuvre)',
                        clinicalPearls: 'Most common cause of vertigo. Posterior canal most affected. May recur',
                        differentiatingFeatures: 'Positional triggers, Dix-Hallpike positive, brief episodes'
                    },
                    'Vestibular neuronitis': {
                        features: 'Sudden onset severe vertigo, nausea, vomiting, no hearing loss, recent viral illness',
                        tests: 'Clinical diagnosis, audiometry to rule out labyrinthitis',
                        urgency: 'Urgent',
                        timeToTreat: 'Vestibular suppressants (prochlorperazine), early mobilisation',
                        clinicalPearls: 'Horizontal nystagmus away from affected side. Gradual improvement over weeks',
                        differentiatingFeatures: 'Acute severe vertigo, no hearing loss, recent viral illness'
                    },
                    'Meniere disease': {
                        features: 'Episodic vertigo, fluctuating hearing loss, tinnitus, aural fullness',
                        tests: 'Audiometry (low-frequency hearing loss), consider MRI to exclude retrocochlear pathology',
                        urgency: 'Non-urgent',
                        timeToTreat: 'Low-salt diet, diuretics, betahistine, vestibular suppressants for acute attacks',
                        clinicalPearls: 'Triad: vertigo + hearing loss + tinnitus. Attacks last hours to days',
                        differentiatingFeatures: 'Triad of symptoms, fluctuating hearing loss, episodic'
                    },
                    'Posterior circulation stroke': {
                        features: 'Sudden vertigo with neurological signs (diplopia, dysarthria, ataxia, weakness)',
                        tests: 'Urgent CT head, MRI with DWI, CT angiogram, ECG',
                        urgency: 'Emergency',
                        timeToTreat: 'Thrombolysis/thrombectomy if within time window',
                        clinicalPearls: 'HINTS exam (Head Impulse, Nystagmus, Test of Skew) can differentiate from peripheral',
                        differentiatingFeatures: 'Associated neurological signs, negative head impulse test'
                    },
                    'Orthostatic hypotension': {
                        features: 'Dizziness on standing, lightheadedness, near-syncope, medications (antihypertensives)',
                        tests: 'Orthostatic vitals (drop >20 mmHg systolic or >10 mmHg diastolic), ECG',
                        urgency: 'Non-urgent',
                        timeToTreat: 'Medication review, increase fluid/salt intake, compression stockings',
                        clinicalPearls: 'Common in elderly. Check medications (diuretics, alpha-blockers). Gradual position changes',
                        differentiatingFeatures: 'Positional component, medication history, orthostatic vital changes'
                    },
                    'Anxiety/Panic': {
                        features: 'Lightheadedness, palpitations, chest tightness, sense of unreality, hyperventilation',
                        tests: 'Rule out organic causes, consider ECG, glucose if symptoms suggest',
                        urgency: 'Non-urgent',
                        timeToTreat: 'Reassurance, breathing exercises, CBT, consider anxiolytics',
                        clinicalPearls: 'Often in young patients. Associated with agoraphobia. Exclude cardiac/metabolic causes',
                        differentiatingFeatures: 'Associated anxiety symptoms, hyperventilation, young patient'
                    }
                }
            },
            'seizures': {
                title: 'Seizures',
                category: 'Neurology/Emergency',
                redFlags: 'üö© Status epilepticus (>5 minutes), focal neurological deficits, head trauma, fever in adults',
                presentations: {
                    'Tonic-clonic seizure': {
                        features: 'Generalised stiffening then rhythmic jerking, tongue biting, incontinence, post-ictal confusion',
                        tests: 'Blood glucose, U&Es, LFTs, drug levels (if on AEDs), CT head if first seizure',
                        urgency: 'Emergency',
                        timeToTreat: 'Protect airway, benzodiazepines if prolonged (>5 minutes)',
                        clinicalPearls: 'Most recover spontaneously. Lateral recovery position. Check for precipitants',
                        differentiatingFeatures: 'Generalised tonic-clonic movements, post-ictal confusion'
                    },
                    'Status epilepticus': {
                        features: 'Seizure >5 minutes or recurrent seizures without recovery of consciousness',
                        tests: 'Emergency investigations: glucose, U&Es, AED levels, ABG, consider LP if febrile',
                        urgency: 'Emergency',
                        timeToTreat: 'IV lorazepam, then phenytoin/levetiracetam, consider intubation',
                        clinicalPearls: 'Medical emergency. Refractory if continues despite two appropriate AEDs',
                        differentiatingFeatures: 'Prolonged seizure activity, impaired consciousness'
                    },
                    'Focal seizure': {
                        features: 'Localised symptoms (motor, sensory, psychic), may have impaired awareness, aura',
                        tests: 'EEG, MRI brain to identify structural lesion, routine bloods',
                        urgency: 'Urgent',
                        timeToTreat: 'Investigate underlying cause, consider AED therapy',
                        clinicalPearls: 'May indicate structural brain lesion. Can progress to generalised seizure',
                        differentiatingFeatures: 'Focal symptoms, may remain conscious, consistent pattern'
                    },
                    'Febrile seizure': {
                        features: 'Child 6 months-6 years, fever, usually brief generalised seizure',
                        tests: 'Identify source of fever, LP if <12 months or concerning features',
                        urgency: 'Urgent',
                        timeToTreat: 'Treat underlying infection, antipyretics, reassurance to parents',
                        clinicalPearls: 'Simple vs complex (>15 min, focal, recurs in 24h). Family history common',
                        differentiatingFeatures: 'Young child, fever, family history'
                    },
                    'Non-epileptic attack': {
                        features: 'Atypical movements, fluctuating consciousness, eyes closed during event, prolonged duration',
                        tests: 'Video EEG for definitive diagnosis, prolactin not raised post-ictally',
                        urgency: 'Non-urgent',
                        timeToTreat: 'Psychological support, avoid unnecessary AEDs, address underlying trauma',
                        clinicalPearls: 'Often history of trauma/abuse. Side-to-side head movements. Gradual onset/offset',
                        differentiatingFeatures: 'Atypical features, eyes closed, normal EEG during event'
                    },
                    'Syncope (mimicking seizure)': {
                        features: 'Brief loss of consciousness, preceding lightheadedness, pallor, rapid recovery',
                        tests: 'ECG, orthostatic vitals, echo if cardiac cause suspected',
                        urgency: 'Urgent',
                        timeToTreat: 'Treat underlying cause (cardiac, orthostatic), avoid triggers',
                        clinicalPearls: 'Brief myoclonic jerks common. No post-ictal confusion. Triggers often present',
                        differentiatingFeatures: 'Brief duration, rapid recovery, triggers (standing, pain)'
                    }
                }
            },
            'weakness': {
                title: 'Weakness/Paralysis',
                category: 'Neurology',
                redFlags: 'üö© Sudden onset, bilateral weakness, respiratory difficulty, bulbar symptoms',
                presentations: {
                    'Stroke': {
                        features: 'Sudden onset unilateral weakness, facial droop, speech difficulties, FAST positive',
                        tests: 'Urgent CT head, CT angiogram, MRI, ECG, glucose, NIHSS assessment',
                        urgency: 'Emergency',
                        timeToTreat: 'Thrombolysis within 4.5 hours, mechanical thrombectomy up to 24 hours',
                        clinicalPearls: 'Time critical. ROSIER score for recognition. Exclude hypoglycemia and seizure',
                        differentiatingFeatures: 'Sudden onset, unilateral, upper motor neuron signs'
                    },
                    'Guillain-Barr√© syndrome': {
                        features: 'Ascending symmetrical weakness, areflexia, minimal sensory loss, preceding infection',
                        tests: 'LP (raised protein, normal cells), nerve conduction studies, anti-GM1 antibodies',
                        urgency: 'Emergency',
                        timeToTreat: 'IVIG or plasmapheresis, monitor respiratory function',
                        clinicalPearls: 'Miller-Fisher variant: ophthalmoplegia, ataxia, areflexia. Watch for respiratory failure',
                        differentiatingFeatures: 'Ascending pattern, areflexia, recent infection'
                    },
                    'Myasthenia gravis': {
                        features: 'Fluctuating weakness, worse with activity, ptosis, diplopia, bulbar symptoms',
                        tests: 'Anti-AChR antibodies, Tensilon test, EMG with repetitive stimulation, CT thorax',
                        urgency: 'Urgent',
                        timeToTreat: 'Anticholinesterases, immunosuppression, plasmapheresis if crisis',
                        clinicalPearls: 'Ocular symptoms common initially. Myasthenic crisis can cause respiratory failure',
                        differentiatingFeatures: 'Fatigable weakness, ocular symptoms, improves with rest'
                    },
                    'Spinal cord compression': {
                        features: 'Back pain, bilateral leg weakness, sensory level, bowel/bladder dysfunction',
                        tests: 'Urgent MRI spine, FBC, ESR, PSA (males), protein electrophoresis',
                        urgency: 'Emergency',
                        timeToTreat: 'High-dose steroids, urgent neurosurgical/oncology referral',
                        clinicalPearls: 'Oncological emergency. Cauda equina if bladder/bowel involved. Time critical',
                        differentiatingFeatures: 'Sensory level, bilateral symptoms, bowel/bladder involvement'
                    },
                    'Periodic paralysis': {
                        features: 'Episodic weakness, triggers (exercise, carbohydrates), family history, normal between episodes',
                        tests: 'Potassium levels during attack, genetic testing, muscle biopsy',
                        urgency: 'Non-urgent',
                        timeToTreat: 'Treat electrolyte abnormalities, avoid triggers, prophylactic medications',
                        clinicalPearls: 'Hypokalaemic most common. Thyrotoxic variant in Asian males. Carbonic anhydrase inhibitors help',
                        differentiatingFeatures: 'Episodic nature, family history, electrolyte abnormalities'
                    },
                    'Conversion disorder': {
                        features: 'Inconsistent weakness, normal reflexes, give-way weakness, incongruent examination',
                        tests: 'Diagnosis of exclusion, detailed neurological assessment, psychological evaluation',
                        urgency: 'Non-urgent',
                        timeToTreat: 'Physiotherapy, psychological support, reassurance',
                        clinicalPearls: 'Often precipitated by stress. Hoover sign may be positive. Avoid confrontation',
                        differentiatingFeatures: 'Inconsistent findings, psychological stressors, normal investigations'
                    }
                }
            },
            'nausea-vomiting': {
                title: 'Nausea and Vomiting',
                category: 'Gastroenterology/General',
                redFlags: 'üö© Hematemesis, severe dehydration, projectile vomiting, abdominal distension',
                presentations: {
                    'Gastroenteritis': {
                        features: 'Acute onset nausea, vomiting, diarrhea, crampy pain, fever, food/water exposure',
                        tests: 'Clinical diagnosis, stool MC&S if bloody/severe, U&Es if dehydrated',
                        urgency: 'Non-urgent',
                        timeToTreat: 'Oral rehydration, antiemetics, antibiotics only if severe bacterial',
                        clinicalPearls: 'Usually viral. Norovirus common in outbreaks. Antibiotics may prolong shedding',
                        differentiatingFeatures: 'Acute onset, diarrhea, fever, food exposure'
                    },
                    'Bowel obstruction': {
                        features: 'Vomiting (early if small bowel), crampy pain, distension, constipation, previous surgery',
                        tests: 'CT abdomen/pelvis, AXR, FBC, U&Es, lactate',
                        urgency: 'Emergency',
                        timeToTreat: 'NBM, NG decompression, IV fluids, surgery if complete',
                        clinicalPearls: 'Small bowel: early vomiting, less distension. Large bowel: late vomiting, more distension',
                        differentiatingFeatures: 'Crampy pain, distension, previous abdominal surgery'
                    },
                    'Pregnancy': {
                        features: 'Missed period, morning sickness, breast tenderness, fatigue, food aversions',
                        tests: 'Pregnancy test (urine/serum Œ≤hCG), FBC if hyperemesis gravidarum',
                        urgency: 'Non-urgent',
                        timeToTreat: 'Small frequent meals, ginger, antiemetics if severe',
                        clinicalPearls: 'Hyperemesis gravidarum if severe (weight loss, ketosis). Usually improves by 16 weeks',
                        differentiatingFeatures: 'Reproductive age female, missed period, positive pregnancy test'
                    },
                    'Medication side effects': {
                        features: 'Recent medication changes, chemotherapy, opioids, antibiotics, timing related to doses',
                        tests: 'Review medication history, drug levels if applicable',
                        urgency: 'Non-urgent',
                        timeToTreat: 'Dose adjustment, antiemetics, alternative medications',
                        clinicalPearls: 'Common with chemotherapy, opioids, antibiotics. Ondansetron effective for chemotherapy',
                        differentiatingFeatures: 'Temporal relationship with medications, known emetogenic drugs'
                    },
                    'Migraine': {
                        features: 'Headache with nausea/vomiting, photophobia, phonophobia, aura, family history',
                        tests: 'Clinical diagnosis, neuroimaging if atypical features',
                        urgency: 'Non-urgent',
                        timeToTreat: 'Triptans, antiemetics, NSAIDs, dark quiet environment',
                        clinicalPearls: 'Nausea often prominent. Metoclopramide helps both nausea and headache',
                        differentiatingFeatures: 'Associated headache, photophobia, family history'
                    },
                    'Appendicitis': {
                        features: 'Initially periumbilical pain ‚Üí RLQ, nausea, vomiting, fever, McBurney point tenderness',
                        tests: 'CT abdomen/pelvis, FBC, CRP, urinalysis',
                        urgency: 'Emergency',
                        timeToTreat: 'Appendicectomy, antibiotics if perforated',
                        clinicalPearls: 'Vomiting after pain onset. Rovsing sign. Atypical in elderly/pregnant',
                        differentiatingFeatures: 'Pain migration to RLQ, fever, rebound tenderness'
                    }
                }
            },
            'back-pain': {
                title: 'Back Pain',
                category: 'Musculoskeletal/Emergency',
                redFlags: 'üö© Bowel/bladder dysfunction, saddle anaesthesia, bilateral leg symptoms, fever',
                presentations: {
                    'Mechanical low back pain': {
                        features: 'Gradual onset, worse with movement, better with rest, no neurological signs',
                        tests: 'Clinical diagnosis, imaging only if red flags or persistent >6 weeks',
                        urgency: 'Non-urgent',
                        timeToTreat: 'Analgesia, early mobilisation, physiotherapy, avoid bed rest',
                        clinicalPearls: 'Most resolve within 6 weeks. Avoid early imaging unless red flags',
                        differentiatingFeatures: 'Mechanical pain, no neurological signs, improves with rest'
                    },
                    'Sciatica/Disc prolapse': {
                        features: 'Leg pain worse than back pain, dermatomal distribution, positive straight leg raise',
                        tests: 'MRI if persistent >6 weeks or neurological deficit, nerve conduction studies',
                        urgency: 'Urgent if neurological deficit',
                        timeToTreat: 'Analgesia, physiotherapy, consider surgery if severe/persistent',
                        clinicalPearls: 'L5/S1 most common. Positive crossed straight leg raise more specific',
                        differentiatingFeatures: 'Dermatomal leg pain, positive straight leg raise'
                    },
                    'Cauda equina syndrome': {
                        features: 'Bilateral leg symptoms, saddle anaesthesia, bowel/bladder dysfunction, severe pain',


// ========================================
// PEFR (lines 10539-10939)
// ========================================
                    </div>
                    
                    <div class="checkbox-group">
                        <input type="checkbox" id="asthma-cyanosis">
                        <label for="asthma-cyanosis">Cyanosis</label>
                    </div>
                    
                    <div class="checkbox-group">
                        <input type="checkbox" id="asthma-exhaustion">
                        <label for="asthma-exhaustion">Exhaustion / confusion / altered consciousness</label>
                    </div>
                    
                    <div class="checkbox-group">
                        <input type="checkbox" id="asthma-bradycardia">
                        <label for="asthma-bradycardia">Bradycardia / hypotension / arrhythmia</label>
                    </div>
                </div>
                
                <div class="calc-input-group">
                    <label for="asthma-pefr">Peak Expiratory Flow Rate (PEFR) % predicted:</label>
                    <input type="number" id="asthma-pefr" min="0" max="100" step="1" placeholder="e.g., 50">
                    <small>Leave blank if unknown</small>
                </div>
                
                <div class="calc-input-group">
                    <label for="asthma-spo2">SpO‚ÇÇ (%):</label>
                    <input type="number" id="asthma-spo2" min="70" max="100" step="1" placeholder="e.g., 92">
                    <small>On air or specify oxygen</small>
                </div>
                
                <button class="calc-button" onclick="window.quizApp.calculateAsthma()">Assess Severity</button>
                <div id="asthma-result" class="calc-result"></div>
                
                <div class="calc-notes">
                    <small>
                        <strong>Severity Classification:</strong><br>
                        ‚Ä¢ <strong>Life-threatening:</strong> Silent chest, cyanosis, exhaustion, confusion, arrhythmia, SpO‚ÇÇ <92%, PEF <33%<br>
                        ‚Ä¢ <strong>Acute severe:</strong> Any of: Can't complete sentences, RR ‚â•25, HR ‚â•110, PEF 33-50%<br>
                        ‚Ä¢ <strong>Moderate:</strong> Increasing symptoms, PEF 50-75% predicted<br><br>
                        
                        <strong>Management:</strong><br>
                        ‚Ä¢ High-flow oxygen to maintain SpO‚ÇÇ 94-98%<br>
                        ‚Ä¢ Salbutamol 5mg nebulised (back-to-back if severe)<br>
                        ‚Ä¢ Ipratropium 500mcg nebulised<br>
                        ‚Ä¢ Prednisolone 40-50mg PO or hydrocortisone 100mg IV<br>
                        ‚Ä¢ Consider IV magnesium sulphate 1.2-2g over 20min<br>
                        ‚Ä¢ Life-threatening: Senior help, ICU referral, consider IV salbutamol
                    </small>
                </div>
            </div>
        `;
    }

    calculateWinters() {
        const hco3 = parseFloat(document.getElementById('winters-hco3').value) || 0;
        const actualPco2 = parseFloat(document.getElementById('winters-pco2').value);

        if (hco3 === 0) {
            document.getElementById('winters-result').innerHTML = 
                '<div class="calc-error"><strong>Please enter HCO‚ÇÉ‚Åª value</strong></div>';
            return;
        }

        // Winters formula: Expected pCO2 (kPa) = 0.16 + (0.16 √ó HCO3)
        const expectedPco2 = 0.16 + (0.16 * hco3);
        const lowerLimit = expectedPco2 - 0.27;
        const upperLimit = expectedPco2 + 0.27;

        let comparison = '';
        let cssClass = 'calc-success';
        
        if (actualPco2) {
            if (actualPco2 >= lowerLimit && actualPco2 <= upperLimit) {
                comparison = `
                    <p><strong>‚úì Appropriate respiratory compensation</strong></p>
                    <p>Actual pCO‚ÇÇ (${actualPco2.toFixed(1)} kPa) matches expected range</p>
                    <p>Pure metabolic acidosis with compensation</p>
                `;
                cssClass = 'calc-success';
            } else if (actualPco2 > upperLimit) {
                comparison = `
                    <p><strong>‚ö†Ô∏è Concomitant respiratory acidosis</strong></p>
                    <p>Actual pCO‚ÇÇ (${actualPco2.toFixed(1)} kPa) higher than expected</p>
                    <p>Mixed metabolic and respiratory acidosis</p>
                `;
                cssClass = 'calc-warning';
            } else {
                comparison = `
                    <p><strong>‚ö†Ô∏è Concomitant respiratory alkalosis</strong></p>
                    <p>Actual pCO‚ÇÇ (${actualPco2.toFixed(1)} kPa) lower than expected</p>
                    <p>Mixed disorder or over-compensation</p>
                `;
                cssClass = 'calc-warning';
            }
        }

        document.getElementById('winters-result').innerHTML = `
            <div class="${cssClass}">
                <h4>Expected pCO‚ÇÇ: ${expectedPco2.toFixed(1)} kPa</h4>
                <p><small>Expected range: ${lowerLimit.toFixed(1)} - ${upperLimit.toFixed(1)} kPa</small></p>
                <p><small>HCO‚ÇÉ‚Åª: ${hco3} mmol/L</small></p>
                ${comparison}
            </div>
        `;
    }

    calculateAsthma() {
        // Check clinical features
        const unableComplete = document.getElementById('asthma-unable-complete').checked;
        const pulse110 = document.getElementById('asthma-pulse-110').checked;
        const rr25 = document.getElementById('asthma-rr-25').checked;
        const pulsusParadoxus = document.getElementById('asthma-pulse-paradoxus').checked;
        const silentChest = document.getElementById('asthma-silent-chest').checked;
        const cyanosis = document.getElementById('asthma-cyanosis').checked;
        const exhaustion = document.getElementById('asthma-exhaustion').checked;
        const bradycardia = document.getElementById('asthma-bradycardia').checked;
        
        const pefr = parseFloat(document.getElementById('asthma-pefr').value);
        const spo2 = parseFloat(document.getElementById('asthma-spo2').value);
        
        // Life-threatening features
        const lifeThreatening = silentChest || cyanosis || exhaustion || bradycardia || 
                               (spo2 && spo2 < 92) || (pefr && pefr < 33);
        
        // Acute severe features
        const acuteSevere = unableComplete || pulse110 || rr25 || 
                           (pefr && pefr >= 33 && pefr <= 50);
        
        let severity = '';
        let cssClass = '';
        let management = '';
        let urgency = '';
        
        if (lifeThreatening) {
            severity = 'üö® LIFE-THREATENING ASTHMA';
            cssClass = 'calc-error';
            urgency = '‚ö†Ô∏è IMMEDIATE ACTION REQUIRED';
            management = `
                <strong>Immediate Management:</strong>
                <ul style="margin-top: 10px; text-align: left;">
                    <li><strong>Call for senior help immediately</strong></li>
                    <li><strong>High-flow oxygen 15L/min</strong> (target SpO‚ÇÇ 94-98%)</li>
                    <li><strong>Salbutamol 5mg nebulised</strong> continuously or back-to-back</li>
                    <li><strong>Ipratropium 500mcg nebulised</strong></li>
                    <li><strong>Hydrocortisone 100mg IV</strong> or prednisolone 40-50mg PO</li>
                    <li><strong>Magnesium sulphate 1.2-2g IV</strong> over 20 minutes</li>
                    <li>Consider <strong>IV salbutamol</strong> (ICU setting)</li>
                    <li>Prepare for <strong>intubation</strong> if deteriorating</li>
                    <li><strong>ICU referral</strong></li>
                </ul>
                <p style="margin-top: 10px;"><strong>Monitor:</strong> Continuous SpO‚ÇÇ, ECG, repeat ABG</p>
            `;
        } else if (acuteSevere) {
            severity = '‚ö†Ô∏è ACUTE SEVERE ASTHMA';
            cssClass = 'calc-warning';
            urgency = 'Urgent treatment required';
            management = `
                <strong>Urgent Management:</strong>
                <ul style="margin-top: 10px; text-align: left;">
                    <li><strong>High-flow oxygen</strong> (target SpO‚ÇÇ 94-98%)</li>
                    <li><strong>Salbutamol 5mg nebulised</strong> (repeat every 15-30 min if needed)</li>
                    <li><strong>Ipratropium 500mcg nebulised</strong> (4-6 hourly)</li>
                    <li><strong>Prednisolone 40-50mg PO</strong> or hydrocortisone 100mg IV</li>
                    <li>Consider <strong>magnesium sulphate 1.2-2g IV</strong> if poor response</li>
                    <li>Senior review if not responding within 15-30 minutes</li>
                </ul>
                <p style="margin-top: 10px;"><strong>Monitor:</strong> SpO‚ÇÇ, PEFR every 15-30min, repeat assessment</p>
            `;
        } else if (pefr && pefr >= 50 && pefr <= 75) {
            severity = 'Moderate Asthma Exacerbation';
            cssClass = 'calc-success';
            urgency = 'Treatment recommended';
            management = `
                <strong>Management:</strong>
                <ul style="margin-top: 10px; text-align: left;">
                    <li><strong>Salbutamol 5mg nebulised</strong> or 4-6 puffs via spacer</li>
                    <li><strong>Prednisolone 40-50mg PO</strong></li>
                    <li>Consider admission if inadequate response</li>
                    <li>Reassess after 1 hour</li>
                </ul>
                <p style="margin-top: 10px;"><strong>Monitor:</strong> Clinical response, PEFR, SpO‚ÇÇ</p>
            `;
        } else {
            severity = 'Mild or Improving';
            cssClass = 'calc-success';
            urgency = 'Continue monitoring';
            management = `
                <strong>Management:</strong>
                <ul style="margin-top: 10px; text-align: left;">
                    <li>Regular bronchodilators</li>
                    <li>Consider prednisolone if symptoms persist</li>
                    <li>Ensure follow-up arranged</li>
                    <li>Review inhaler technique and action plan</li>
                </ul>
            `;
        }
        
        // List present features
        let features = [];
        if (unableComplete) features.push('Unable to complete sentences');
        if (pulse110) features.push('Pulse ‚â•110 bpm');
        if (rr25) features.push('RR ‚â•25/min');
        if (pulsusParadoxus) features.push('Pulsus paradoxus');
        if (silentChest) features.push('Silent chest');
        if (cyanosis) features.push('Cyanosis');
        if (exhaustion) features.push('Exhaustion/confusion');
        if (bradycardia) features.push('Bradycardia/arrhythmia');
        if (pefr) features.push(`PEFR ${pefr}%`);
        if (spo2) features.push(`SpO‚ÇÇ ${spo2}%`);
        
        const featuresText = features.length > 0 
            ? `<p style="text-align: left;"><strong>Present features:</strong><br>${features.join(', ')}</p>`
            : '';
        
        document.getElementById('asthma-result').innerHTML = `
            <div class="${cssClass}">
                <h4>${severity}</h4>
                <p><strong>${urgency}</strong></p>
                ${featuresText}
                ${management}
            </div>
        `;
    }

    calculateOpioidConversion() {
        const currentOpioid = document.getElementById('palliative-current-opioid').value;
        const currentDose = parseFloat(document.getElementById('palliative-current-dose').value) || 0;
        const targetOpioid = document.getElementById('palliative-target-opioid').value;

        if (currentDose === 0) {
            document.getElementById('opioid-conversion-result').innerHTML = 
                '<div class="calc-error"><strong>Please enter current dose</strong></div>';
            return;
        }

        // UK opioid conversion factors - Faculty of Pain Medicine guidance
        // ‚ö†Ô∏è CRITICAL: Patch conversions are per mcg/hr, NOT total daily dose
        const toMorphineFactors = {
            'morphine-oral': 1,
            'morphine-sc': 2,  // SC morphine is twice as potent as oral
            'oxycodone-oral': 1.5,  // Oxycodone 1mg = 1.5mg morphine
            'fentanyl-patch': 2.4,  // UK: Fentanyl 12 mcg/hr ‚âà 30-45mg OME/day ‚Üí ~2.4-3.75 mg per mcg/hr
            'codeine': 0.1,  // Codeine 10mg = 1mg morphine
            'tramadol': 0.1,  // Tramadol 10mg = 1mg morphine
            'buprenorphine-patch': 2.4  // UK: Buprenorphine 5 mcg/hr ‚âà 12mg OME/day ‚Üí ~2.4 mg per mcg/hr
        };

        // Conversion factors from oral morphine equivalents
        const fromMorphineFactors = {
            'morphine-oral': 1,
            'morphine-sc': 0.5,  // Oral to SC morphine
            'oxycodone-oral': 0.67,  // Morphine to oxycodone
            'fentanyl-patch': 0.4,  // Conservative: ~2.5mg OME per mcg/hr
            'diamorphine-sc': 0.33  // Oral morphine to SC diamorphine
        };

        // Convert current dose to morphine equivalents
        const morphineEquivalent = currentDose * toMorphineFactors[currentOpioid];
        
        // Faculty of Pain Medicine: Reduce by 25-50% when switching (more for high doses/elderly)
        const fullTargetDose = morphineEquivalent * fromMorphineFactors[targetOpioid];
        const reducedTargetDose = fullTargetDose * 0.5; // 50% reduction for safety

        let dosageForm = '';
        let administration = '';
        let frequency = '';

        switch (targetOpioid) {
                dosageForm = 'mg oral';
                administration = 'Give as modified-release BD or immediate-release 4-hourly';
                frequency = reducedTargetDose <= 30 ? '5-10mg 4-hourly PRN' : Math.round(reducedTargetDose/6) + 'mg 4-hourly PRN';
                dosageForm = 'mg subcutaneous';
                administration = 'Via syringe driver over 24 hours or divided into 4-6 hourly doses';
                frequency = Math.round(reducedTargetDose/6) + 'mg SC PRN (1/6 of daily dose)';
                dosageForm = 'mg oral';
                administration = 'Give as modified-release BD or immediate-release 4-hourly';
                frequency = Math.round(reducedTargetDose/6) + 'mg 4-hourly PRN';
                dosageForm = 'mcg/hr patch';
                administration = 'Change patch every 72 hours';
                frequency = 'Breakthrough: use fast-acting fentanyl products or oral morphine';
                dosageForm = 'mg subcutaneous';
                administration = 'Via syringe driver over 24 hours';
                frequency = Math.round(reducedTargetDose/6) + 'mg SC PRN (1/6 of daily dose)';
        }
        document.getElementById('opioid-conversion-result').innerHTML = `
            <div style="color: #2196F3;">
                <strong>Opioid Conversion Estimate:</strong><br>
                <strong>Oral Morphine Equivalent: ${Math.round(morphineEquivalent)} mg/day</strong><br>
                <strong>Recommended Starting Dose: ${Math.round(reducedTargetDose * 10) / 10} ${dosageForm}</strong><br>
                <em>Administration:</em> ${administration}<br>
                <em>Breakthrough:</em> ${frequency}<br><br>
                <div style="color: #D32F2F; font-weight: bold; margin: 8px 0; border: 2px solid #D32F2F; padding: 8px; background: #FFEBEE;">
                    ‚ö†Ô∏è FACULTY OF PAIN MEDICINE WARNING:<br>
                    ‚Ä¢ Reduce calculated doses by 25-50% when switching<br>
                    ‚Ä¢ Reduce more for high doses (>200mg OME/day) or elderly<br>
                    ‚Ä¢ Incomplete cross-tolerance between opioids<br>
                    ‚Ä¢ Titrate carefully and monitor closely
                </div>
                <small style="color: #666;">
                    Using UK Faculty of Pain Medicine & MHRA guidance<br>
                    Original: ${currentDose} ${currentOpioid.replace('-', ' ')}<br>
                    Estimated OME: ${Math.round(morphineEquivalent)} mg/day<br>
                    Full calculated: ${Math.round(fullTargetDose * 10) / 10} ${dosageForm} (50% reduction applied)<br>
                    <em>This is a simplified calculator - seek specialist advice for complex conversions</em>
                </small>
            </div>
        `;
    }
    calculateBreakthroughDose() {
        const dailyMorphine = parseFloat(document.getElementById('palliative-daily-morphine').value) || 0;

        if (dailyMorphine === 0) {
            document.getElementById('breakthrough-result').innerHTML = 
                '<div class="calc-error"><strong>Please enter daily morphine equivalent</strong></div>';
            return;
        }

        // Breakthrough dose is typically 1/6 of total daily dose
        const breakthroughDose = Math.round(dailyMorphine / 6);
        const scBreakthroughDose = Math.round(breakthroughDose / 2);

        document.getElementById('breakthrough-result').innerHTML = `
            <div class="calc-success">
                <strong>Breakthrough Dosing:</strong><br>
                <strong>Oral Morphine:</strong> ${breakthroughDose}mg every 1-2 hours PRN<br>
                <strong>SC Morphine:</strong> ${scBreakthroughDose}mg every 1-2 hours PRN<br>
                <strong>Oxycodone:</strong> ${Math.round(breakthroughDose * 0.67)}mg every 1-2 hours PRN<br><br>
                <em>Frequency:</em> Maximum 6 doses per 24 hours<br>
                <em>Review:</em> If >2 breakthrough doses/day, consider increasing background dose<br><br>
                <small class="calc-note">
                    üí° Rule: Breakthrough = 1/6 of total daily dose
                </small>
            </div>
        `;
    }

    calculateAntiemetic() {
        const weight = parseFloat(document.getElementById('palliative-weight').value) || 70;
        const cause = document.getElementById('palliative-nausea-cause').value;

        let firstLine = '';
        let secondLine = '';
        let notes = '';

        switch (cause) {
                firstLine = `<strong>Haloperidol:</strong> 0.5-1.5mg PO BD or 1.5-5mg SC/24h<br>
                           <strong>Metoclopramide:</strong> 10mg TDS PO/SC (max 5 days)`;
                secondLine = `<strong>Ondansetron:</strong> 4-8mg TDS<br>
                            <strong>Levomepromazine:</strong> 6.25-25mg/24h SC`;
                notes = 'Avoid metoclopramide if bowel obstruction suspected';
                firstLine = `<strong>Ondansetron:</strong> 8mg BD PO or 8mg/24h SC<br>
                           <strong>Dexamethasone:</strong> 8-12mg daily`;
                secondLine = `<strong>Metoclopramide:</strong> 10mg TDS<br>
                            <strong>Levomepromazine:</strong> 6.25-12.5mg/24h SC`;
                notes = 'Consider NK1 antagonists for highly emetogenic chemotherapy';
                firstLine = `<strong>Levomepromazine:</strong> 6.25-25mg/24h SC<br>
                           <strong>Haloperidol:</strong> 2.5-10mg/24h SC`;
                secondLine = `<strong>Octreotide:</strong> 300-600mcg/24h SC<br>
                            <strong>Hyoscine butylbromide:</strong> 60-120mg/24h SC`;
                notes = '‚ö†Ô∏è AVOID metoclopramide - may worsen colic';
                firstLine = `<strong>Dexamethasone:</strong> 8-16mg daily<br>
                           <strong>Cyclizine:</strong> 50mg TDS PO or 150mg/24h SC`;
                secondLine = `<strong>Levomepromazine:</strong> 6.25-12.5mg/24h SC`;
                notes = 'Treat underlying cause. Consider mannitol if acute';
                firstLine = `<strong>Haloperidol:</strong> 0.5-1.5mg BD PO or 2.5-5mg/24h SC<br>
                           <strong>Metoclopramide:</strong> 10mg TDS`;
                secondLine = `<strong>Ondansetron:</strong> 4-8mg TDS`;
                notes = 'Correct reversible causes (hypercalcaemia, uraemia, etc.)';
                firstLine = `<strong>Cyclizine:</strong> 50mg TDS PO or 150mg/24h SC<br>
                           <strong>Prochlorperazine:</strong> 5-10mg TDS`;
                secondLine = `<strong>Levomepromazine:</strong> 6.25-12.5mg/24h SC`;
                notes = 'Consider cause: drugs, infection, vestibular disorders';
        }
        document.getElementById('antiemetic-result').innerHTML = `
            <div style="color: #2196F3;">
                <strong>Recommended Anti-emetics for ${cause.replace('-', ' ')}:</strong><br><br>
// ========================================
// QRISK3 (lines 621-1021)
// ========================================
    init() {
        console.log('üöÄ Starting app initialization...');
        this.bindEvents();
        this.loadQuizzes();
        
        // Initialize new features
        this.initializeDarkMode();
        this.initializeFontSize();
        this.initializeQuizLength();
        this.initializeVibration();
        this.initializeOrientationDetection();
        this.initializeRotationControl();
        console.log('ü©∫ About to initialize medical tools...');
        this.initializeMedicalTools();
        this.initializeAnatomyExplorer();
        this.initializeInteractiveFeatures();
        console.log('‚úÖ App initialization complete');
        
        // Listen for QRISK3 module load (already loaded by HTML but check availability)
        if (window.qrisk3 && typeof window.qrisk3.calculateScore === 'function') {
            console.log('‚úÖ QRISK3 official library detected and ready');
        } else {
            console.log('‚ö†Ô∏è QRISK3 library not yet loaded - will use fallback calculation');
            // Listen for the custom event in case it loads after app init
            window.addEventListener('qrisk3-loaded', () => {
                console.log('‚úÖ QRISK3 library loaded after app initialization');
            });
        }
    }
    
    bindEvents() {
        // Navigation
        document.getElementById('backBtn').addEventListener('click', () => this.goBack());
        document.getElementById('homeBtn').addEventListener('click', () => this.showQuizSelection());
        document.getElementById('retryBtn').addEventListener('click', () => this.retryQuiz());
        
        // Quiz navigation
        document.getElementById('submitBtn').addEventListener('click', () => this.submitAnswer());
        document.getElementById('nextBtn').addEventListener('click', () => this.nextQuestion());
        document.getElementById('prevBtn').addEventListener('click', () => this.prevQuestion());
        
        // Top navigation buttons
        document.getElementById('nextBtnTop').addEventListener('click', () => this.nextQuestion());
        document.getElementById('prevBtnTop').addEventListener('click', () => this.prevQuestion());
        
        // Flag button
        document.getElementById('flagBtn').addEventListener('click', () => this.toggleFlag());
        // Sidebar toggle removed - now using responsive grid layout
        
        // File upload
        document.getElementById('uploadBtn').addEventListener('click', () => {
            document.getElementById('quizFileInput').click();
        });
        
        document.getElementById('quizFileInput').addEventListener('change', (e) => {
            this.handleFileUpload(e.target.files);
        });
        
        // Quiz length selection
        document.addEventListener('click', (e) => {
            // Check if the clicked element or its parent is a quiz length button
            const lengthBtn = e.target.closest('.quiz-length-btn');
            if (lengthBtn) {
                this.selectQuizLength(lengthBtn);
            }
        });
        
        // Optional orientation lock toggle in the UI (if present)
        const lockBtn = document.getElementById('lockOrientationBtn');
        if (lockBtn) {
            lockBtn.addEventListener('click', async () => {
                try {
                    if (this.screenLocked) {
                        this.unlockOrientation();
                    } else {
                        await this.lockToOptimalOrientation();
                    }
                } catch (e) { console.debug('lockOrientationBtn handler error:', e); }
            });
        }

        // Navbar rotLock toggle (added to templates). If present, use it to
        // quickly lock/unlock orientation during the quiz.
        const rotNavBtn = document.getElementById('rotLock');
        if (rotNavBtn) {
            rotNavBtn.addEventListener('click', async () => {
                try {
                    if (this.screenLocked) {
                        this.unlockOrientation();
                        rotNavBtn.textContent = 'üîí';
                    } else {
                        await this.lockToOptimalOrientation();
                        rotNavBtn.textContent = this.screenLocked ? 'üîí' : 'üîì';
                    }
                } catch (e) {
                    console.debug('rotLock handler error:', e);
                }
            });
        }
    }

    // Quiz length selection methods
    selectQuizLength(button) {
        console.log('üéØ Quiz length button clicked:', button);
        
        // Remove active class from all buttons
        document.querySelectorAll('.quiz-length-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        
        // Add active class to clicked button
        button.classList.add('active');
        
        // Update selected length
        const length = button.getAttribute('data-length');
        this.selectedQuizLength = length === 'all' ? 'all' : parseInt(length);
        
        console.log('üéØ Selected quiz length:', this.selectedQuizLength);
        
        // Update info text
        this.updateQuizLengthInfo();
    }
    
    updateQuizLengthInfo() {
        const infoEl = document.getElementById('quiz-length-info');
        if (!infoEl) {
            console.log('üéØ Quiz length info element not found');
            return;
        }
        
        let message = '';
        if (this.selectedQuizLength === 'all') {
            message = 'üìö Selected: All available questions for comprehensive practice';
        } else if (this.selectedQuizLength === 100) {
            message = 'üéØ Selected: 100 questions for standard test simulation';
        } else {
            message = 'üìù Selected: 20 questions for quick practice session';
        }
        
        infoEl.textContent = message;
        console.log('üéØ Updated quiz length info:', message);
    }
    
    filterQuestionsByLength(questions) {
        if (this.selectedQuizLength === 'all' || this.selectedQuizLength >= questions.length) {
            return questions;
        }
        
        // Shuffle questions and take the selected amount
        const shuffled = [...questions].sort(() => Math.random() - 0.5);
        return shuffled.slice(0, this.selectedQuizLength);
    }

    async loadQuizzes() {
        try {
            const response = await fetch('/api/quizzes');
            const data = await response.json();
            
            if (data.success) {
                this.renderQuizList(data.quizzes);
            } else {
                this.showError('Failed to load quizzes: ' + data.error);
            }
        } catch (error) {
            console.error('Error loading quizzes:', error);
            this.showError('Failed to load quizzes. Please check your connection.');
        }
    }
    
    async renderQuizList(quizzes) {
        const quizList = document.getElementById('quizList');
        
        // Get uploaded quizzes from localStorage (now async for IndexedDB support)
        const uploadedQuizzes = await this.getUploadedQuizzes();
        
        // Combine server quizzes with uploaded quizzes
        const allQuizzes = [...quizzes];
        
        if (quizzes.length === 0 && uploadedQuizzes.length === 0) {
            quizList.innerHTML = `
                <div class="loading">
                    <p>No quizzes found. Upload quiz files using the button above.</p>
                </div>
            `;
            return;
        }
        
        let html = '';
        
        // Add uploaded quizzes first (with special styling)
        uploadedQuizzes.forEach(quiz => {
            html += `
                <div class="quiz-item uploaded-quiz" data-quiz-name="${quiz.name}" data-is-uploaded="true">
                    <div class="quiz-info">
                        <h3 class="quiz-name">üìÅ ${quiz.name}</h3>
                        <p class="quiz-details">Uploaded ‚Ä¢ ${quiz.total_questions} questions</p>
                    </div>
                    <span class="chevron">‚Ä∫</span>
                </div>
            `;
        });
        
        // Add server quizzes
        quizzes.forEach(quiz => {
            const sizeKB = Math.round(quiz.size / 1024);
            html += `
                <div class="quiz-item" data-quiz-name="${quiz.name}">
                    <div class="quiz-info">
                        <h3 class="quiz-name">${quiz.name}</h3>
                        <p class="quiz-details">${sizeKB}KB ‚Ä¢ ${quiz.filename}</p>
                    </div>
                    <span class="chevron">‚Ä∫</span>
                </div>
            `;
        });
        
        quizList.innerHTML = html;
        
        // Bind quiz selection events
        document.querySelectorAll('.quiz-item').forEach(item => {
            item.addEventListener('click', () => {
                const quizName = item.dataset.quizName;
                const isUploaded = item.dataset.isUploaded === 'true';
                this.loadQuiz(quizName, isUploaded);
            });
        });
    }
    
    async loadQuiz(quizName, isUploaded = false) {
        this.showLoading('Loading quiz...');
        
        try {
            if (isUploaded) {
                // Load from localStorage (now async for IndexedDB support)
                const uploadedQuizzes = await this.getUploadedQuizzes();
                const quiz = uploadedQuizzes.find(q => q.name === quizName);
                
                if (!quiz) {
                    this.showError('Uploaded quiz not found. Please re-upload the file.');
                    return;
                }
                
                // Check if this is a split storage quiz that needs reconstruction
                if (quiz.dataStored === 'split' && (!quiz.questions || quiz.questions.length === 0)) {
                    console.log('üîç LOADING - Reconstructing split storage quiz');
                    try {
                        const quizData = JSON.parse(localStorage.getItem(`quiz_${quiz.name}`) || '{}');
                        if (quizData.questions && quizData.questions.length > 0) {
                            quiz.questions = quizData.questions;
                            quiz.images = quizData.images || {};
                            console.log('üîç LOADING - Successfully reconstructed quiz with', quiz.questions.length, 'questions');
                        } else {
                            throw new Error('No questions found in split storage');
                        }
                    } catch (error) {
                        console.error('üîç LOADING ERROR - Failed to reconstruct quiz:', error);
                        this.showError('Failed to load quiz data. Please re-upload the file.');
                        return;
                    }
                }
                
                this.questions = quiz.questions || [];
                
                // Store current quiz for image lookups
                this.currentQuiz = quiz;
                
                // Filter questions based on selected length
                this.questions = this.filterQuestionsByLength(this.questions);
                this.quizName = quiz.name;
                this.currentQuestionIndex = 0;
                this.answers = {};
                this.submittedAnswers = {};
                this.ruledOutAnswers = {};
                this.flaggedQuestions = new Set();
                
                if (this.questions.length === 0) {
                    this.showError('This quiz contains no questions.');
                    return;
                }
                
                console.log('üîç LOADING - Successfully loaded uploaded quiz with', this.questions.length, 'questions');
                console.log('üì± Images available:', Object.keys(quiz.images || {}).length);
                if (quiz.imagesRemoved) {
                    this.showError('Note: Images were not stored due to browser limits. Questions will work but images may not display.');
                }
                
                this.startQuiz();
            } else {
                // Load from server
                const response = await fetch(`/api/quiz/${encodeURIComponent(quizName)}`);
                const data = await response.json();
                
                if (data.success) {
                    this.questions = data.questions;
                    
                    // Filter questions based on selected length
                    this.questions = this.filterQuestionsByLength(this.questions);
                    
                    this.quizName = data.quiz_name;
                    this.currentQuestionIndex = 0;
                    this.answers = {};
                    this.submittedAnswers = {};
                    this.flaggedQuestions = new Set();
                    
                    if (this.questions.length === 0) {
                        this.showError('This quiz contains no questions.');
                        return;
                    }
                    
                    this.startQuiz();
                } else {
                    this.showError('Failed to load quiz: ' + data.error);
                }
            }
        } catch (error) {
            console.error('Error loading quiz:', error);
            this.showError('Failed to load quiz. Please check your connection.');
        }
    }
    
    async startQuiz() {
        // Reset quiz state
        this.submittedAnswers = {}; // Reset submitted answers
        this.ruledOutAnswers = {}; // Reset ruled out answers
        this.ruledOutAnswers = {}; // Reset ruled out answers
        
        // Reset time tracking for new quiz
        this.quizStartTime = Date.now();
        this.questionTimes = {};
        this.sessionStats = {
            questionsAnswered: 0,
            totalTime: 0,
            averageTimePerQuestion: 0
        };
        
        // Shuffle questions to randomize order
        this.questions = this.shuffleArray(this.questions);
        
        // Shuffle options for all questions to prevent pattern memorization
        this.questions = this.questions.map(question => this.shuffleOptions(question));
        
        this.showScreen('quizScreen');
        this.updateNavigation('Quiz');
        this.renderCurrentQuestion();
        this.updateProgress();
        this.buildQuestionList(); // Build the question list in the sidebar
        // LOCK TO PORTRAIT (or allow landscape on tablets)
        try {
            // Attempt a best-effort orientation lock and await it so the UI
            // can settle in the desired orientation before the user interacts.
            await this.lockToOptimalOrientation();
        } catch (e) {
            console.debug('Orientation lock attempt failed at startQuiz:', e);
        }
        // Analytics: quiz_start
        try {
            if (window.MLAAnalytics && typeof window.MLAAnalytics.event === 'function') {
                window.MLAAnalytics.event('quiz_start', {
                    name: this.quizName || null,
                    selected_length: this.selectedQuizLength || null,
                    question_count: (this.questions && this.questions.length) || 0
                });
            }
        } catch (e) {
            console.debug('Analytics quiz_start error:', e);
        }
    }
    
    renderCurrentQuestion() {
        const question = this.questions[this.currentQuestionIndex];
        console.log('Debug - Question object:', question);
        console.log('Debug - Question prompt value:', question.prompt);
    
        if (!question) return;
        
        // Track question start time
        this.questionStartTime = Date.now();

        const container = document.getElementById('questionContainer');        // Hide explanation and feedback initially (will show again if answer is already submitted)
        const explanationContainer = document.getElementById('explanationContainer');
        const feedbackContainer = document.getElementById('feedbackContainer');
        if (explanationContainer) {
            explanationContainer.style.display = 'none';
        }
        if (feedbackContainer) {
            feedbackContainer.style.display = 'none';
        }

        // Process scenario text - add full stop if missing
        let scenarioText = question.scenario || '';
        if (
            scenarioText &&
            scenarioText.trim() &&
            !scenarioText.trim().endsWith('.') &&
            !scenarioText.trim().endsWith('?') &&
            !scenarioText.trim().endsWith('!')
        ) {
            scenarioText = scenarioText.trim() + '.';
        }
        console.log('Debug - Processed scenario:', scenarioText);


// ========================================
// Ranson (lines 15467-15867)
// ========================================
                        tests: 'CT abdomen/pelvis (preferred), ultrasound (children/pregnancy), CBC (leukocytosis), urinalysis',
                        urgency: 'Emergency',
                        timeToTreat: 'Surgery within 12-24 hours, antibiotics if perforated',
                        clinicalPearls: 'Alvarado score for risk stratification. Atypical presentation in elderly, pregnant. Perforation risk increases with time',
                        differentiatingFeatures: 'Migration of pain to RLQ, rebound tenderness, fever'
                    },
                    'Cholecystitis': {
                        features: 'RUQ pain, Murphy sign, fat intolerance, fever, nausea. Risk factors: 4 Fs (fat, female, forty, fertile)',
                        tests: 'Ultrasound (gallstones, wall thickening), HIDA scan if unclear, LFTs, lipase',
                        urgency: 'Urgent',
                        timeToTreat: 'Cholecystectomy within 72 hours, antibiotics if complicated',
                        clinicalPearls: 'Murphy sign more specific than ultrasound findings. Emphysematous cholecystitis in diabetics',
                        differentiatingFeatures: 'RUQ pain, positive Murphy sign, gallstones on imaging'
                    },
                    'Pancreatitis': {
                        features: 'Epigastric pain radiating to back, nausea, vomiting. Triggers: alcohol, gallstones, hypertriglyceridemia',
                        tests: 'Lipase (>3√ó normal), amylase, CT abdomen if severe, LFTs, triglycerides',
                        urgency: 'Urgent',
                        timeToTreat: 'Supportive care, pain control, IV fluids, NPO',
                        clinicalPearls: 'Ranson criteria for severity. ERCP if gallstone pancreatitis. Watch for complications (pseudocyst, necrosis)',
                        differentiatingFeatures: 'Epigastric pain radiating to back, elevated lipase'
                    },
                    'Bowel obstruction': {
                        features: 'Crampy pain, nausea, vomiting, distension, constipation, high-pitched bowel sounds or silence',
                        tests: 'CT abdomen/pelvis (transition point), abdominal X-ray (dilated loops), CBC, BMP',
                        urgency: 'Emergency',
                        timeToTreat: 'NGT decompression, IV fluids, surgery if complete obstruction',
                        clinicalPearls: 'Small bowel: crampy, early vomiting. Large bowel: distension, late vomiting. Strangulation risk',
                        differentiatingFeatures: 'Crampy pain, vomiting, distension, abnormal bowel sounds'
                    },
                    'Diverticulitis': {
                        features: 'LLQ pain (Western), fever, change in bowel habits, tender mass. More common in elderly',
                        tests: 'CT abdomen/pelvis (wall thickening, fat stranding), CBC, CRP',
                        urgency: 'Urgent',
                        timeToTreat: 'Antibiotics (ciprofloxacin + metronidazole), bowel rest',
                        clinicalPearls: 'Avoid colonoscopy in acute phase. Hinchey classification for severity. Consider complications',
                        differentiatingFeatures: 'LLQ pain, older patient, known diverticulosis'
                    },
                    'Gastroenteritis': {
                        features: 'Crampy pain, diarrhea, nausea, vomiting, fever. Food/water exposure, contacts with similar illness',
                        tests: 'Clinical diagnosis, stool studies if severe/bloody, CBC if dehydrated',
                        urgency: 'Non-urgent',
                        timeToTreat: 'Supportive care, hydration, probiotics',
                        clinicalPearls: 'Usually self-limited. Antibiotics only if bacterial and severe. Watch for dehydration',
                        differentiatingFeatures: 'Diarrhea predominant, food/water exposure, multiple affected individuals'
                    },
                    'Peptic ulcer disease': {
                        features: 'Epigastric pain, relationship to meals (duodenal: hungry pain, gastric: worse with food), H. pylori history',
                        tests: 'H. pylori testing (stool antigen, urea breath test), upper endoscopy if alarming features',
                        urgency: 'Non-urgent',
                        timeToTreat: 'PPI therapy, H. pylori eradication if positive',
                        clinicalPearls: 'NSAID and H. pylori most common causes. Triple therapy for eradication. Watch for complications',
                        differentiatingFeatures: 'Relationship to meals, response to PPIs, H. pylori positive'
                    }
                }
            },
            'headache': {
                title: 'Headache',
                category: 'Neurology',
                redFlags: 'üö© Sudden severe (thunderclap), fever + neck stiffness, focal neurologic deficits, papilledema',
                presentations: {
                    'Migraine': {
                        features: 'Unilateral, throbbing, 4-72 hours, photophobia, phonophobia, nausea. Aura in 20%. Family history common',
                        tests: 'Clinical diagnosis, neuroimaging if atypical features or red flags',
                        urgency: 'Non-urgent',
                        timeToTreat: 'Triptans (within 2 hours), NSAIDs, antiemetics. Preventive therapy if frequent',
                        clinicalPearls: 'POUND criteria (Pulsating, One day, Unilateral, Nausea, Disabling). Avoid medication overuse',
                        differentiatingFeatures: 'Unilateral throbbing, photophobia, family history'
                    },
                    'Tension headache': {
                        features: 'Bilateral, pressing/tightening, mild-moderate, no photophobia/phonophobia, stress-related',
                        tests: 'Clinical diagnosis',
                        urgency: 'Non-urgent',
                        timeToTreat: 'NSAIDs, acetaminophen, stress management, relaxation techniques',
                        clinicalPearls: 'Most common primary headache. Often chronic. Exclude medication overuse',
                        differentiatingFeatures: 'Bilateral pressing pain, no associated symptoms'
                    },
                    'Cluster headache': {
                        features: 'Unilateral severe, orbital/temporal, 15min-3h, lacrimation, nasal congestion. Male predominance, circadian',
                        tests: 'Clinical diagnosis',
                        urgency: 'Urgent',
                        timeToTreat: 'High-flow oxygen, subcutaneous sumatriptan. Preventive: verapamil',
                        clinicalPearls: 'Attacks in clusters (weeks-months). Patient restless during attack. Alcohol trigger during cluster',
                        differentiatingFeatures: 'Severe unilateral orbital pain, autonomic symptoms, restlessness'
                    },
                    'Subarachnoid hemorrhage': {
                        features: 'Sudden severe (thunderclap), worst headache of life, neck stiffness, photophobia, altered consciousness',
                        tests: 'Non-contrast CT head (within 6h), LP if CT negative, CTA for aneurysm',
                        urgency: 'Emergency',
                        timeToTreat: 'Neurosurgical consultation, aneurysm securing, prevent vasospasm',
                        clinicalPearls: 'Sentinel headache may precede. Hunt-Hess grade for severity. Watch for complications',
                        differentiatingFeatures: 'Thunderclap onset, worst headache ever, meningeal signs'
                    },
                    'Meningitis': {
                        features: 'Fever, headache, neck stiffness, photophobia, altered mental status. Kernig/Brudzinski signs',
                        tests: 'LP (opening pressure, cell count, glucose, protein, culture), blood cultures, CT if focal signs',
                        urgency: 'Emergency',
                        timeToTreat: 'Antibiotics immediately after LP (within 1 hour), steroids for bacterial',
                        clinicalPearls: 'Classic triad only in 44%. Bacterial more acute, viral more indolent. Don\'t delay antibiotics',
                        differentiatingFeatures: 'Fever + headache + neck stiffness, altered mental status'
                    }
                }
            },
            'altered-mental-status': {
                title: 'Altered Mental Status',
                category: 'Neurology/Emergency',
                redFlags: 'üö© Focal neurological signs, hypoglycemia, hypoxia, severe hypotension, hyperthermia',
                presentations: {
                    'Hypoglycemia': {
                        features: 'Confusion, diaphoresis, tachycardia, tremor, hunger. History of diabetes, missed meals, medication errors',
                        tests: 'Blood glucose (<3.9 mmol/L), HbA1c, C-peptide if factitious suspected',
                        urgency: 'Emergency',
                        timeToTreat: 'Immediate glucose correction, glucagon if unable to swallow',
                        clinicalPearls: 'Whipple triad: symptoms + low glucose + relief with treatment. Consider sulphonylurea poisoning',
                        differentiatingFeatures: 'Rapid improvement with glucose, diaphoresis, known diabetes'
                    },
                    'Stroke/TIA': {
                        features: 'Sudden onset focal deficits, FAST positive, speech difficulties, weakness, vision changes',
                        tests: 'CT head (exclude haemorrhage), CT angiogram, MRI if available, ECG, glucose',
                        urgency: 'Emergency',
                        timeToTreat: 'Thrombolysis within 4.5 hours, thrombectomy within 6-24 hours',
                        clinicalPearls: 'ROSIER score for recognition. NIHSS for severity. Time is brain - rapid assessment crucial',
                        differentiatingFeatures: 'Sudden onset, focal signs, FAST positive'
                    },
                    'Sepsis/Septic shock': {
                        features: 'Fever/hypothermia, tachycardia, hypotension, altered mental state, source of infection',
                        tests: 'Blood cultures, lactate, FBC, CRP, procalcitonin, urinalysis, CXR',
                        urgency: 'Emergency',
                        timeToTreat: 'Antibiotics within 1 hour, fluid resuscitation, vasopressors if needed',
                        clinicalPearls: 'qSOFA score for screening. Lactate >2 indicates organ dysfunction. Source control important',
                        differentiatingFeatures: 'Systemic signs of infection, elevated lactate, hypotension'
                    },
                    'Drug intoxication': {
                        features: 'History of ingestion, pupils (miosis/mydriasis), respiratory depression, specific toxidromes',
                        tests: 'Toxicology screen, paracetamol/salicylate levels, ABG, glucose, U&Es',
                        urgency: 'Emergency',
                        timeToTreat: 'Supportive care, specific antidotes (naloxone, flumazenil), activated charcoal if early',
                        clinicalPearls: 'Common toxidromes: opioid (miosis, bradycardia), anticholinergic (mydriasis, dry skin)',
                        differentiatingFeatures: 'History of ingestion, specific toxidrome, response to antidotes'
                    },
                    'Hepatic encephalopathy': {
                        features: 'Known liver disease, asterixis, confusion to coma, precipitants (infection, GI bleed, drugs)',
                        tests: 'Ammonia (elevated), LFTs, FBC, U&Es, blood cultures, ascitic tap if present',
                        urgency: 'Urgent',
                        timeToTreat: 'Lactulose, rifaximin, identify and treat precipitants',
                        clinicalPearls: 'West Haven criteria for grading. Common precipitants: infection, GI bleeding, constipation',
                        differentiatingFeatures: 'Known cirrhosis, asterixis, elevated ammonia'
                    },
                    'Uremic encephalopathy': {
                        features: 'Known CKD, confusion, nausea, muscle twitching, pericardial friction rub',
                        tests: 'U&Es (very high urea/creatinine), urinalysis, ECG (hyperkalaemia), ABG',
                        urgency: 'Emergency',
                        timeToTreat: 'Urgent dialysis, treat hyperkalaemia if present',
                        clinicalPearls: 'Usually urea >40 mmol/L. Watch for hyperkalaemia. Dialysis definitive treatment',
                        differentiatingFeatures: 'Known renal failure, very high urea, muscle twitching'
                    }
                }
            },
            'dizziness': {
                title: 'Dizziness/Vertigo',
                category: 'Neurology/ENT',
                redFlags: 'üö© Focal neurological signs, severe headache, hearing loss, diplopia, dysarthria',
                presentations: {
                    'BPPV': {
                        features: 'Episodic rotational vertigo with position changes, Dix-Hallpike positive, nausea',
                        tests: 'Clinical diagnosis with Dix-Hallpike manoeuvre, audiometry if hearing concerns',
                        urgency: 'Non-urgent',
                        timeToTreat: 'Canalith repositioning procedures (Epley manoeuvre)',
                        clinicalPearls: 'Most common cause of vertigo. Posterior canal most affected. May recur',
                        differentiatingFeatures: 'Positional triggers, Dix-Hallpike positive, brief episodes'
                    },
                    'Vestibular neuronitis': {
                        features: 'Sudden onset severe vertigo, nausea, vomiting, no hearing loss, recent viral illness',
                        tests: 'Clinical diagnosis, audiometry to rule out labyrinthitis',
                        urgency: 'Urgent',
                        timeToTreat: 'Vestibular suppressants (prochlorperazine), early mobilisation',
                        clinicalPearls: 'Horizontal nystagmus away from affected side. Gradual improvement over weeks',
                        differentiatingFeatures: 'Acute severe vertigo, no hearing loss, recent viral illness'
                    },
                    'Meniere disease': {
                        features: 'Episodic vertigo, fluctuating hearing loss, tinnitus, aural fullness',
                        tests: 'Audiometry (low-frequency hearing loss), consider MRI to exclude retrocochlear pathology',
                        urgency: 'Non-urgent',
                        timeToTreat: 'Low-salt diet, diuretics, betahistine, vestibular suppressants for acute attacks',
                        clinicalPearls: 'Triad: vertigo + hearing loss + tinnitus. Attacks last hours to days',
                        differentiatingFeatures: 'Triad of symptoms, fluctuating hearing loss, episodic'
                    },
                    'Posterior circulation stroke': {
                        features: 'Sudden vertigo with neurological signs (diplopia, dysarthria, ataxia, weakness)',
                        tests: 'Urgent CT head, MRI with DWI, CT angiogram, ECG',
                        urgency: 'Emergency',
                        timeToTreat: 'Thrombolysis/thrombectomy if within time window',
                        clinicalPearls: 'HINTS exam (Head Impulse, Nystagmus, Test of Skew) can differentiate from peripheral',
                        differentiatingFeatures: 'Associated neurological signs, negative head impulse test'
                    },
                    'Orthostatic hypotension': {
                        features: 'Dizziness on standing, lightheadedness, near-syncope, medications (antihypertensives)',
                        tests: 'Orthostatic vitals (drop >20 mmHg systolic or >10 mmHg diastolic), ECG',
                        urgency: 'Non-urgent',
                        timeToTreat: 'Medication review, increase fluid/salt intake, compression stockings',
                        clinicalPearls: 'Common in elderly. Check medications (diuretics, alpha-blockers). Gradual position changes',
                        differentiatingFeatures: 'Positional component, medication history, orthostatic vital changes'
                    },
                    'Anxiety/Panic': {
                        features: 'Lightheadedness, palpitations, chest tightness, sense of unreality, hyperventilation',
                        tests: 'Rule out organic causes, consider ECG, glucose if symptoms suggest',
                        urgency: 'Non-urgent',
                        timeToTreat: 'Reassurance, breathing exercises, CBT, consider anxiolytics',
                        clinicalPearls: 'Often in young patients. Associated with agoraphobia. Exclude cardiac/metabolic causes',
                        differentiatingFeatures: 'Associated anxiety symptoms, hyperventilation, young patient'
                    }
                }
            },
            'seizures': {
                title: 'Seizures',
                category: 'Neurology/Emergency',
                redFlags: 'üö© Status epilepticus (>5 minutes), focal neurological deficits, head trauma, fever in adults',
                presentations: {
                    'Tonic-clonic seizure': {
                        features: 'Generalised stiffening then rhythmic jerking, tongue biting, incontinence, post-ictal confusion',
                        tests: 'Blood glucose, U&Es, LFTs, drug levels (if on AEDs), CT head if first seizure',
                        urgency: 'Emergency',
                        timeToTreat: 'Protect airway, benzodiazepines if prolonged (>5 minutes)',
                        clinicalPearls: 'Most recover spontaneously. Lateral recovery position. Check for precipitants',
                        differentiatingFeatures: 'Generalised tonic-clonic movements, post-ictal confusion'
                    },
                    'Status epilepticus': {
                        features: 'Seizure >5 minutes or recurrent seizures without recovery of consciousness',
                        tests: 'Emergency investigations: glucose, U&Es, AED levels, ABG, consider LP if febrile',
                        urgency: 'Emergency',
                        timeToTreat: 'IV lorazepam, then phenytoin/levetiracetam, consider intubation',
                        clinicalPearls: 'Medical emergency. Refractory if continues despite two appropriate AEDs',
                        differentiatingFeatures: 'Prolonged seizure activity, impaired consciousness'
                    },
                    'Focal seizure': {
                        features: 'Localised symptoms (motor, sensory, psychic), may have impaired awareness, aura',
                        tests: 'EEG, MRI brain to identify structural lesion, routine bloods',
                        urgency: 'Urgent',
                        timeToTreat: 'Investigate underlying cause, consider AED therapy',
                        clinicalPearls: 'May indicate structural brain lesion. Can progress to generalised seizure',
                        differentiatingFeatures: 'Focal symptoms, may remain conscious, consistent pattern'
                    },
                    'Febrile seizure': {
                        features: 'Child 6 months-6 years, fever, usually brief generalised seizure',
                        tests: 'Identify source of fever, LP if <12 months or concerning features',
                        urgency: 'Urgent',
                        timeToTreat: 'Treat underlying infection, antipyretics, reassurance to parents',
                        clinicalPearls: 'Simple vs complex (>15 min, focal, recurs in 24h). Family history common',
                        differentiatingFeatures: 'Young child, fever, family history'
                    },
                    'Non-epileptic attack': {
                        features: 'Atypical movements, fluctuating consciousness, eyes closed during event, prolonged duration',
                        tests: 'Video EEG for definitive diagnosis, prolactin not raised post-ictally',
                        urgency: 'Non-urgent',
                        timeToTreat: 'Psychological support, avoid unnecessary AEDs, address underlying trauma',
                        clinicalPearls: 'Often history of trauma/abuse. Side-to-side head movements. Gradual onset/offset',
                        differentiatingFeatures: 'Atypical features, eyes closed, normal EEG during event'
                    },
                    'Syncope (mimicking seizure)': {
                        features: 'Brief loss of consciousness, preceding lightheadedness, pallor, rapid recovery',
                        tests: 'ECG, orthostatic vitals, echo if cardiac cause suspected',
                        urgency: 'Urgent',
                        timeToTreat: 'Treat underlying cause (cardiac, orthostatic), avoid triggers',
                        clinicalPearls: 'Brief myoclonic jerks common. No post-ictal confusion. Triggers often present',
                        differentiatingFeatures: 'Brief duration, rapid recovery, triggers (standing, pain)'
                    }
                }
            },
            'weakness': {
                title: 'Weakness/Paralysis',
                category: 'Neurology',
                redFlags: 'üö© Sudden onset, bilateral weakness, respiratory difficulty, bulbar symptoms',
                presentations: {
                    'Stroke': {
                        features: 'Sudden onset unilateral weakness, facial droop, speech difficulties, FAST positive',
                        tests: 'Urgent CT head, CT angiogram, MRI, ECG, glucose, NIHSS assessment',
                        urgency: 'Emergency',
                        timeToTreat: 'Thrombolysis within 4.5 hours, mechanical thrombectomy up to 24 hours',
                        clinicalPearls: 'Time critical. ROSIER score for recognition. Exclude hypoglycemia and seizure',
                        differentiatingFeatures: 'Sudden onset, unilateral, upper motor neuron signs'
                    },
                    'Guillain-Barr√© syndrome': {
                        features: 'Ascending symmetrical weakness, areflexia, minimal sensory loss, preceding infection',
                        tests: 'LP (raised protein, normal cells), nerve conduction studies, anti-GM1 antibodies',
                        urgency: 'Emergency',
                        timeToTreat: 'IVIG or plasmapheresis, monitor respiratory function',
                        clinicalPearls: 'Miller-Fisher variant: ophthalmoplegia, ataxia, areflexia. Watch for respiratory failure',
                        differentiatingFeatures: 'Ascending pattern, areflexia, recent infection'
                    },
                    'Myasthenia gravis': {
                        features: 'Fluctuating weakness, worse with activity, ptosis, diplopia, bulbar symptoms',
                        tests: 'Anti-AChR antibodies, Tensilon test, EMG with repetitive stimulation, CT thorax',
                        urgency: 'Urgent',
                        timeToTreat: 'Anticholinesterases, immunosuppression, plasmapheresis if crisis',
                        clinicalPearls: 'Ocular symptoms common initially. Myasthenic crisis can cause respiratory failure',
                        differentiatingFeatures: 'Fatigable weakness, ocular symptoms, improves with rest'
                    },
                    'Spinal cord compression': {
                        features: 'Back pain, bilateral leg weakness, sensory level, bowel/bladder dysfunction',
                        tests: 'Urgent MRI spine, FBC, ESR, PSA (males), protein electrophoresis',
                        urgency: 'Emergency',
                        timeToTreat: 'High-dose steroids, urgent neurosurgical/oncology referral',
                        clinicalPearls: 'Oncological emergency. Cauda equina if bladder/bowel involved. Time critical',
                        differentiatingFeatures: 'Sensory level, bilateral symptoms, bowel/bladder involvement'
                    },
                    'Periodic paralysis': {
                        features: 'Episodic weakness, triggers (exercise, carbohydrates), family history, normal between episodes',
                        tests: 'Potassium levels during attack, genetic testing, muscle biopsy',
                        urgency: 'Non-urgent',
                        timeToTreat: 'Treat electrolyte abnormalities, avoid triggers, prophylactic medications',
                        clinicalPearls: 'Hypokalaemic most common. Thyrotoxic variant in Asian males. Carbonic anhydrase inhibitors help',
                        differentiatingFeatures: 'Episodic nature, family history, electrolyte abnormalities'
                    },
                    'Conversion disorder': {
                        features: 'Inconsistent weakness, normal reflexes, give-way weakness, incongruent examination',
                        tests: 'Diagnosis of exclusion, detailed neurological assessment, psychological evaluation',
                        urgency: 'Non-urgent',
                        timeToTreat: 'Physiotherapy, psychological support, reassurance',
                        clinicalPearls: 'Often precipitated by stress. Hoover sign may be positive. Avoid confrontation',
                        differentiatingFeatures: 'Inconsistent findings, psychological stressors, normal investigations'
                    }
                }
            },
            'nausea-vomiting': {
                title: 'Nausea and Vomiting',
                category: 'Gastroenterology/General',
                redFlags: 'üö© Hematemesis, severe dehydration, projectile vomiting, abdominal distension',
                presentations: {
                    'Gastroenteritis': {
                        features: 'Acute onset nausea, vomiting, diarrhea, crampy pain, fever, food/water exposure',
                        tests: 'Clinical diagnosis, stool MC&S if bloody/severe, U&Es if dehydrated',
                        urgency: 'Non-urgent',
                        timeToTreat: 'Oral rehydration, antiemetics, antibiotics only if severe bacterial',
                        clinicalPearls: 'Usually viral. Norovirus common in outbreaks. Antibiotics may prolong shedding',
                        differentiatingFeatures: 'Acute onset, diarrhea, fever, food exposure'
                    },
                    'Bowel obstruction': {
                        features: 'Vomiting (early if small bowel), crampy pain, distension, constipation, previous surgery',
                        tests: 'CT abdomen/pelvis, AXR, FBC, U&Es, lactate',
                        urgency: 'Emergency',
                        timeToTreat: 'NBM, NG decompression, IV fluids, surgery if complete',
                        clinicalPearls: 'Small bowel: early vomiting, less distension. Large bowel: late vomiting, more distension',
                        differentiatingFeatures: 'Crampy pain, distension, previous abdominal surgery'
                    },
                    'Pregnancy': {
                        features: 'Missed period, morning sickness, breast tenderness, fatigue, food aversions',
                        tests: 'Pregnancy test (urine/serum Œ≤hCG), FBC if hyperemesis gravidarum',
                        urgency: 'Non-urgent',
                        timeToTreat: 'Small frequent meals, ginger, antiemetics if severe',
                        clinicalPearls: 'Hyperemesis gravidarum if severe (weight loss, ketosis). Usually improves by 16 weeks',
                        differentiatingFeatures: 'Reproductive age female, missed period, positive pregnancy test'
                    },
                    'Medication side effects': {
                        features: 'Recent medication changes, chemotherapy, opioids, antibiotics, timing related to doses',
                        tests: 'Review medication history, drug levels if applicable',
                        urgency: 'Non-urgent',
                        timeToTreat: 'Dose adjustment, antiemetics, alternative medications',
                        clinicalPearls: 'Common with chemotherapy, opioids, antibiotics. Ondansetron effective for chemotherapy',
                        differentiatingFeatures: 'Temporal relationship with medications, known emetogenic drugs'
                    },
                    'Migraine': {
                        features: 'Headache with nausea/vomiting, photophobia, phonophobia, aura, family history',
                        tests: 'Clinical diagnosis, neuroimaging if atypical features',
                        urgency: 'Non-urgent',
                        timeToTreat: 'Triptans, antiemetics, NSAIDs, dark quiet environment',
                        clinicalPearls: 'Nausea often prominent. Metoclopramide helps both nausea and headache',
                        differentiatingFeatures: 'Associated headache, photophobia, family history'
                    },
                    'Appendicitis': {
                        features: 'Initially periumbilical pain ‚Üí RLQ, nausea, vomiting, fever, McBurney point tenderness',
                        tests: 'CT abdomen/pelvis, FBC, CRP, urinalysis',
                        urgency: 'Emergency',
                        timeToTreat: 'Appendicectomy, antibiotics if perforated',
                        clinicalPearls: 'Vomiting after pain onset. Rovsing sign. Atypical in elderly/pregnant',
                        differentiatingFeatures: 'Pain migration to RLQ, fever, rebound tenderness'
                    }
                }
            },
            'back-pain': {
                title: 'Back Pain',
                category: 'Musculoskeletal/Emergency',
                redFlags: 'üö© Bowel/bladder dysfunction, saddle anaesthesia, bilateral leg symptoms, fever',
                presentations: {
                    'Mechanical low back pain': {
                        features: 'Gradual onset, worse with movement, better with rest, no neurological signs',
                        tests: 'Clinical diagnosis, imaging only if red flags or persistent >6 weeks',
                        urgency: 'Non-urgent',
                        timeToTreat: 'Analgesia, early mobilisation, physiotherapy, avoid bed rest',
                        clinicalPearls: 'Most resolve within 6 weeks. Avoid early imaging unless red flags',
                        differentiatingFeatures: 'Mechanical pain, no neurological signs, improves with rest'
                    },
                    'Sciatica/Disc prolapse': {
                        features: 'Leg pain worse than back pain, dermatomal distribution, positive straight leg raise',
                        tests: 'MRI if persistent >6 weeks or neurological deficit, nerve conduction studies',
                        urgency: 'Urgent if neurological deficit',
                        timeToTreat: 'Analgesia, physiotherapy, consider surgery if severe/persistent',
                        clinicalPearls: 'L5/S1 most common. Positive crossed straight leg raise more specific',
                        differentiatingFeatures: 'Dermatomal leg pain, positive straight leg raise'
                    },
                    'Cauda equina syndrome': {
                        features: 'Bilateral leg symptoms, saddle anaesthesia, bowel/bladder dysfunction, severe pain',


// ========================================
// SOFA (lines 13097-13497)
// ========================================
                organisation: 'NICE',
                types: {
                    'Paroxysmal': 'Self-terminating within 7 days (usually <48 hours)',
                    'Persistent': 'Lasts >7 days or requires cardioversion',
                    'Long-standing persistent': '>12 months duration',
                    'Permanent': 'Accepted long-term AF, no attempt at rhythm control'
                },
                rateControl: {
                    'First-line': 'Beta-blocker or rate-limiting CCB (diltiazem, verapamil)',
                    'Alternative': 'Digoxin (if sedentary or heart failure)',
                    'Target': 'Resting heart rate <110 bpm (lenient control)',
                    'Strict control': '<80 bpm if symptoms persist'
                },
                rhythmControl: {
                    'Indications': 'Symptomatic AF despite rate control, younger patients, first presentation',
                    'Cardioversion': 'If AF <48 hours or anticoagulated for ‚â•3 weeks',
                    'Maintenance': 'Amiodarone, sotalol, flecainide (if no structural heart disease)'
                },
                anticoagulation: {
                    'CHA2DS2-VASc': 'Calculate stroke risk. Anticoagulate if score ‚â•2 (men) or ‚â•3 (women)',
                    'HAS-BLED': 'Assess bleeding risk but high score not contraindication',
                    'DOAC': 'First-line: apixaban, dabigatran, edoxaban, rivaroxaban',
                    'Warfarin': 'If DOAC contraindicated. Target INR 2.0-3.0'
                },
                monitoring: 'Annual review. Check for symptoms, pulse rate/rhythm, blood pressure, medication adherence'
            },
            'depression': {
                title: 'Depression Management (NICE NG222 2024)',
                category: 'mental-health',
                evidenceLevel: 'NICE Clinical Guideline',
                lastUpdated: '2024',
                organisation: 'NICE',
                assessment: {
                    'PHQ-9': 'Patient Health Questionnaire for severity assessment',
                    'Mild': 'PHQ-9 score 5-9. Watchful waiting, self-help, brief interventions',
                    'Moderate': 'PHQ-9 score 10-14. Psychological interventions or antidepressants',
                    'Severe': 'PHQ-9 score 15-19. Antidepressants + psychological interventions'
                },
                psychological: {
                    'First-line': 'CBT (individual or group), guided self-help, computerised CBT',
                    'Alternatives': 'IPT (interpersonal therapy), counselling, mindfulness-based cognitive therapy'
                },
                pharmacological: {
                    'First-line': 'SSRI (sertraline, citalopram, fluoxetine, paroxetine)',
                    'Second-line': 'Different SSRI, SNRI (venlafaxine), mirtazapine',
                    'Starting dose': 'Sertraline 50mg daily, citalopram 20mg daily'
                },
                monitoring: {
                    'Initial': 'Review within 2 weeks of starting antidepressant',
                    'Young people': 'Weekly for first month if <30 years old',
                    'Ongoing': 'Every 2-4 weeks for first 3 months, then less frequently'
                },
                duration: 'Continue antidepressant for ‚â•6 months after remission. Consider longer if recurrent episodes',
                riskFactors: 'Discontinuation symptoms, suicide risk (especially early treatment), drug interactions'
            },
            'obesity': {
                title: 'Obesity Management (NICE NG189 2024)',
                category: 'endocrine',
                evidenceLevel: 'NICE Clinical Guideline',
                lastUpdated: '2024',
                organisation: 'NICE',
                classification: {
                    'Overweight': 'BMI 25-29.9 kg/m¬≤',
                    'Obesity class I': 'BMI 30-34.9 kg/m¬≤',
                    'Obesity class II': 'BMI 35-39.9 kg/m¬≤',
                    'Obesity class III': 'BMI ‚â•40 kg/m¬≤'
                },
                assessment: 'BMI, waist circumference, comorbidities (T2DM, hypertension, sleep apnoea), cardiovascular risk',
                lifestyle: {
                    'Diet': 'Calorie deficit 600kcal/day. Mediterranean-style, low-calorie, low-fat diets',
                    'Exercise': 'Gradually increase to 150-300 minutes moderate intensity per week',
                    'Behaviour': 'Goal setting, self-monitoring, cognitive restructuring'
                },
                pharmacotherapy: {
                    'Orlistat': 'BMI ‚â•30 or ‚â•28 with comorbidities. 120mg three times daily with meals',
                    'GLP-1 agonists': 'Specialist initiation. Liraglutide if specific criteria met',
                    'Monitoring': 'Weight loss target ‚â•5% at 3 months, ‚â•10% at 6 months'
                },
                surgery: {
                    'Criteria': 'BMI ‚â•40 or ‚â•35 with comorbidities. Failed non-surgical methods',
                    'Options': 'Gastric bypass, sleeve gastrectomy, adjustable gastric band',
                    'Follow-up': 'Lifelong specialist monitoring, nutritional supplements'
                },
                comorbidities: 'Screen for T2DM, hypertension, dyslipidaemia, sleep apnoea, NAFLD, osteoarthritis'
            },
            'stroke': {
                title: 'Stroke Prevention & Management (NICE NG128 2024)',
                category: 'neurological',
                evidenceLevel: 'NICE Clinical Guideline',
                lastUpdated: '2024',
                organisation: 'NICE',
                prevention: {
                    'Antiplatelet': 'Aspirin 75mg + dipyridamole 200mg twice daily for secondary prevention',
                    'Anticoagulation': 'For AF: DOAC first-line (apixaban, rivaroxaban, dabigatran)',
                    'Statin': 'Atorvastatin 80mg daily for secondary prevention',
                    'Blood pressure': 'Target <130/80 mmHg. Start 2 weeks after acute stroke'
                },
                acute: {
                    'Recognition': 'FAST (Face, Arms, Speech, Time) assessment',
                    'Thrombolysis': 'Alteplase within 4.5 hours of symptom onset if eligible',
                    'Thrombectomy': 'Within 6 hours for proximal anterior circulation occlusion',
                    'Aspirin': '300mg daily for 2 weeks, then 75mg daily long-term'
                },
                rehabilitation: {
                    'Early': 'Mobilisation within 24 hours if medically stable',
                    'MDT': 'Physiotherapy, occupational therapy, speech therapy, dietician',
                    'Goals': 'Functional independence, swallowing assessment, mood screening'
                },
                riskFactors: 'Hypertension, AF, diabetes, smoking, hyperlipidaemia, carotid stenosis, previous TIA/stroke',
                monitoring: 'Annual review: BP, cholesterol, diabetes control, medication adherence, functional status'
            },
            'uti': {
                title: 'Urinary Tract Infections (NICE NG109 2024)',
                category: 'infectious-diseases',
                evidenceLevel: 'NICE Clinical Guideline',
                lastUpdated: '2024',
                organisation: 'NICE',
                diagnosis: {
                    'Uncomplicated UTI': 'Dysuria, frequency, urgency, suprapubic pain in healthy women',
                    'Complicated UTI': 'Men, pregnant women, children, catheterised patients, immunocompromised',
                    'Urine dipstick': 'Nitrites + leucocyte esterase positive. Blood may be present'
                },
                treatment: {
                    'Uncomplicated cystitis': 'Nitrofurantoin 100mg twice daily for 3 days OR trimethoprim 200mg twice daily for 3 days',
                    'Pyelonephritis': 'Ciprofloxacin 500mg twice daily for 7 days OR co-amoxiclav 500/125mg three times daily for 14 days',
                    'Men': 'Trimethoprim 200mg twice daily for 7 days OR nitrofurantoin 100mg twice daily for 7 days',
                    'Pregnancy': 'Nitrofurantoin 100mg twice daily for 7 days (avoid at term)'
                },
                recurrent: {
                    'Definition': '‚â•3 UTIs in 12 months or ‚â•2 in 6 months',
                    'Prevention': 'Post-coital prophylaxis, continuous prophylaxis, self-treatment',
                    'Prophylaxis': 'Trimethoprim 100mg at night OR nitrofurantoin 50mg at night'
                },
                catheter: {
                    'Symptomatic CAUTI': 'Treat with antibiotics based on local guidelines',
                    'Asymptomatic bacteriuria': 'Do not treat unless immunocompromised or before invasive procedures'
                },
                advice: 'Adequate fluid intake, complete antibiotic course, cranberry products may help prevent recurrence'
            },
            'diabetes': {
                title: 'Type 2 Diabetes Management (NICE NG28 2024)',
                category: 'endocrine',
                evidenceLevel: 'NICE Clinical Guideline',
                lastUpdated: '2024',
                organisation: 'NICE',
                diagnosis: {
                    'HbA1c': '‚â•48 mmol/mol (‚â•6.5%) on two occasions OR single value if symptomatic',
                    'Fasting glucose': '‚â•7.0 mmol/L (‚â•126 mg/dL)',
                    'Random glucose': '‚â•11.1 mmol/L (‚â•200 mg/dL) with symptoms',
                    'OGTT': '2-hour glucose ‚â•11.1 mmol/L (‚â•200 mg/dL)'
                },
                targets: {
                    'HbA1c': '<48 mmol/mol (<6.5%) for newly diagnosed, <53 mmol/mol (<7.0%) for most adults',
                    'Blood pressure': '<130/80 mmHg',
                    'Cholesterol': 'Non-HDL <2.5 mmol/L'
                },
                lifestyle: {
                    'Diet': 'Mediterranean-style, low glycaemic index, weight loss if BMI >25',
                    'Exercise': '150 minutes moderate intensity per week, resistance training',
                    'Weight': 'Target weight loss 5-10% if overweight'
                },
                medications: {
                    'First-line': 'Metformin 500mg twice daily, titrate to 1g twice daily',
                    'Second-line': 'SGLT2 inhibitor (if CVD/heart failure) OR DPP-4 inhibitor OR sulfonylurea',
                    'Third-line': 'Triple therapy or insulin',
                    'Insulin': 'Start with basal insulin (glargine, detemir) 10 units daily, titrate 2-4 units every 3-7 days'
                },
                monitoring: {
                    'HbA1c': 'Every 3-6 months until stable, then 6-monthly',
                    'Annual checks': 'Foot examination, eye screening, kidney function, lipids, blood pressure',
                    'Sick day rules': 'Continue insulin, increase monitoring, seek help if vomiting'
                },
                complications: 'Retinopathy, nephropathy, neuropathy, cardiovascular disease, diabetic foot'
            },
            'pneumonia': {
                title: 'Pneumonia Management (NICE NG138 2024)',
                category: 'pulmonary',
                evidenceLevel: 'NICE Clinical Guideline',
                lastUpdated: '2024',
                organisation: 'NICE',
                diagnosis: {
                    'Clinical': 'Cough, fever, dyspnea, pleuritic chest pain, crackles',
                    'CXR': 'New infiltrate (may be normal in early disease)',
                    'Blood tests': 'FBC, CRP, U&E, LFT. Consider pneumococcal/legionella antigens'
                },
                severity: {
                    'CURB-65': 'Confusion, Urea >7, RR ‚â•30, BP <90/60, age ‚â•65',
                    'Score 0-1': 'Low severity - consider home treatment',
                    'Score 2': 'Moderate severity - consider hospital admission',
                    'Score ‚â•3': 'High severity - urgent hospital admission'
                },
                treatment: {
                    'Mild CAP': 'Amoxicillin 500mg three times daily for 5 days',
                    'Moderate CAP': 'Amoxicillin 500mg three times daily + clarithromycin 500mg twice daily for 5 days',
                    'Severe CAP': 'Co-amoxiclav 1.2g three times daily IV + clarithromycin 500mg twice daily IV',
                    'Atypical': 'Clarithromycin 500mg twice daily OR doxycycline 200mg on day 1, then 100mg daily'
                },
                admission: {
                    'Criteria': 'CURB-65 ‚â•2, hypoxia <90%, inability to maintain oral intake, significant comorbidities',
                    'Monitoring': 'Oxygen saturation, fluid balance, response to treatment',
                    'Discharge': 'Clinically stable for 24 hours, able to maintain oral intake, oxygen saturation >90%'
                },
                prevention: 'Pneumococcal vaccination (‚â•65 years, immunocompromised), annual influenza vaccination'
            },
            'sepsis': {
                title: 'Sepsis Recognition & Management (NICE NG51 2024)',
                category: 'infectious-diseases',
                evidenceLevel: 'NICE Clinical Guideline',
                lastUpdated: '2024',
                organisation: 'NICE',
                recognition: {
                    'Red flags': 'Systolic BP <90, HR >130, RR ‚â•25, needs O2 to maintain sats ‚â•92%, non-blanching rash',
                    'Amber flags': 'Relatives concerned about mental state, acute change in mental state, HR 91-130, T <36¬∞C',
                    'High-risk groups': 'Age >75, immunocompromised, recent surgery/invasive procedure, indwelling devices'
                },
                definitions: {
                    'Sepsis': 'Life-threatening organ dysfunction due to dysregulated host response to infection',
                    'Septic shock': 'Sepsis with circulatory/cellular dysfunction (lactate >2, vasopressors needed)',
                    'qSOFA': 'Altered mental state, SBP ‚â§100, RR ‚â•22 (score ‚â•2 = high risk)'
                },
                management: {
                    'Sepsis Six': '1. Give oxygen, 2. Take blood cultures, 3. Give antibiotics, 4. Give fluids, 5. Measure lactate, 6. Measure urine output',
                    'Timeframe': 'Complete within 1 hour of recognition',
                    'Antibiotics': 'Broad-spectrum within 1 hour. Adjust based on cultures and local guidelines',
                    'Fluids': '500ml crystalloid bolus, reassess and repeat if needed'
                },
                antibiotics: {
                    'Community-acquired': 'Amoxicillin 1g IV three times daily + gentamicin',
                    'Hospital-acquired': 'Piperacillin-tazobactam 4.5g three times daily + gentamicin',
                    'Neutropenic': 'Piperacillin-tazobactam + gentamicin',
                    'Duration': 'Review daily, typically 5-7 days depending on source and response'
                },
                monitoring: 'Hourly observations, fluid balance, lactate, organ function, consider HDU/ICU if deteriorating'
            },
            'dvt-pe': {
                title: 'DVT & Pulmonary Embolism (NICE NG158 2024)',
                category: 'cardiovascular',
                evidenceLevel: 'NICE Clinical Guideline',
                lastUpdated: '2024',
                organisation: 'NICE',
                assessment: {
                    'Wells Score DVT': '<1 unlikely, ‚â•1 likely. Use 2-level score',
                    'Wells Score PE': '‚â§4 unlikely, >4 likely. Use 2-level score',
                    'D-dimer': 'If low probability. Negative D-dimer excludes VTE'
                },
                diagnosis: {
                    'DVT': 'Doppler ultrasound within 4 hours or interim DOAC + scan within 24 hours',
                    'PE': 'CTPA (CT pulmonary angiography) first-line imaging',
                    'V/Q scan': 'If CTPA contraindicated (pregnancy, contrast allergy, renal impairment)'
                },
                treatment: {
                    'Initial': 'DOAC (apixaban, rivaroxaban) first-line OR LMWH ‚Üí warfarin',
                    'Apixaban': '10mg twice daily for 7 days, then 5mg twice daily',
                    'Rivaroxaban': '15mg twice daily for 21 days, then 20mg daily',
                    'Warfarin': 'LMWH overlap until INR 2-3 for 2 consecutive days. Target INR 2.5',
                    'Duration': 'Provoked: 3 months. Unprovoked: 3-6 months, consider longer if recurrent'
                },
                'massive PE': {
                    'Definition': 'Hypotension, shock, cardiac arrest',
                    'Treatment': 'Thrombolysis (alteplase), consider embolectomy',
                    'HDU/ICU': 'Immediate admission, monitoring, vasopressor support'
                },
                thrombophilia: {
                    'Screen if': 'Age <50, unprovoked VTE, recurrent VTE, unusual site, family history',
                    'Tests': 'Protein C/S, antithrombin, factor V Leiden, prothrombin gene, antiphospholipid antibodies',
                    'Timing': 'At least 3 months after stopping anticoagulation'
                },
                prevention: 'Risk assess all hospital admissions. LMWH prophylaxis if indicated. TED stockings if immobile'
            },
            'acs': {
                title: 'Acute Coronary Syndrome (NICE NG185 2024)',
                category: 'cardiovascular',
                evidenceLevel: 'NICE Clinical Guideline',
                lastUpdated: '2024',
                organisation: 'NICE',
                recognition: {
                    'Chest pain': 'Central, crushing, radiating to jaw/arm, associated with sweating, nausea',
                    'Atypical': 'Epigastric pain, dyspnoea, syncope (especially elderly, diabetic, women)',
                    'ECG': 'ST elevation (STEMI), ST depression/T wave inversion (NSTEMI), normal (possible ACS)'
                },
                'stemi': {
                    'Diagnosis': 'ST elevation ‚â•1mm in ‚â•2 contiguous leads OR new LBBB',
                    'Immediate': 'Aspirin 300mg, P2Y12 inhibitor (ticagrelor 180mg), morphine, antiemetic, GTN',
                    'Reperfusion': 'Primary PCI <120 minutes OR thrombolysis if PCI not available <120 minutes',
                    'Thrombolysis': 'Alteplase or tenecteplase. Give if PCI not achievable within 120 minutes'
                },
                'nstemi': {
                    'Risk stratification': 'GRACE score determines management',
                    'High risk': 'Coronary angiography within 72 hours',
                    'Immediate': 'Aspirin 300mg, ticagrelor 180mg, fondaparinux 2.5mg SC daily',
                    'Anticoagulation': 'Fondaparinux preferred unless angiography planned within 24 hours'
                },
                'secondary prevention': {
                    'Antiplatelet': 'Aspirin 75mg + ticagrelor 90mg twice daily for 12 months, then aspirin alone',
                    'Statin': 'Atorvastatin 80mg daily',
                    'ACE inhibitor': 'Ramipril 1.25mg twice daily, titrate to 5mg twice daily',
                    'Beta-blocker': 'Bisoprolol 1.25mg daily, titrate to 10mg daily',
                    'Lifestyle': 'Cardiac rehabilitation, smoking cessation, BP <130/80, lipid target'
                },
                complications: 'Arrhythmias, heart failure, cardiogenic shock, mechanical complications (VSD, MR, rupture)',
                targets: 'Total cholesterol <4mmol/L, LDL <2mmol/L, non-HDL <2.5mmol/L'
            },
            'anaphylaxis': {
                title: 'Anaphylaxis Management (Resus Council UK 2024)',
                category: 'emergency',
                evidenceLevel: 'Emergency Guideline',
                lastUpdated: '2024',
                organisation: 'Resuscitation Council UK',
                recognition: {
                    'ABC problems': 'Airway, breathing, circulation compromise',
                    'Skin changes': 'Urticaria, angioedema, flushing (may be absent in 20%)',
                    'Sudden onset': 'Minutes after exposure to known allergen',
                    'Life-threatening': 'Airway/breathing/circulation problems'
                },
                treatment: {
                    'IM Adrenaline': '500 micrograms (0.5ml of 1:1000) into anterolateral thigh. Repeat after 5 minutes if no improvement',
                    'Position': 'Lie flat with legs raised (unless airway/breathing compromised)',
                    'High-flow oxygen': '15L via non-rebreathing mask',
                    'IV fluids': '500ml-1L crystalloid rapidly if signs of shock',
                    'Antihistamine': 'Chlorphenamine 10mg IV/IM (after adrenaline)',
                    'Steroid': 'Hydrocortisone 200mg IV/IM (after adrenaline)'
                },
                refractory: {
                    'IV adrenaline': 'If no response to IM doses. Titrate carefully, cardiac monitoring',
                    'Alternative': 'Glucagon 1-2mg IM if on beta-blockers'
                },
                observation: {
                    'Minimum': '6-8 hours observation after resolution',
                    'Biphasic reaction': 'Can occur up to 72 hours later (1-20% cases)',
                    'Discharge': 'Ensure 2 adrenaline auto-injectors prescribed, referral to allergy clinic'
                },
                autoInjector: {
                    'Indications': 'Previous anaphylaxis, high-risk foods (nuts, fish), venom allergy, idiopathic',
                    'Training': 'Demonstrate use, provide written plan, MedicAlert bracelet',
                    'Types': 'EpiPen, Jext, Emerade (150, 300, 500 microgram doses)'
                }
            },
            'osteoporosis': {
                title: 'Osteoporosis Prevention & Treatment (NICE NG239 2024)',
                category: 'endocrine',
                evidenceLevel: 'NICE Clinical Guideline',
                lastUpdated: '2024',
                organisation: 'NICE',
                assessment: {
                    'FRAX tool': 'Calculate 10-year fracture risk. Age, sex, BMI, risk factors',
                    'DEXA scan': 'T-score ‚â§-2.5 = osteoporosis. -1 to -2.5 = osteopenia',
                    'Indications for DEXA': 'Age >50 + fragility fracture, long-term steroids, FRAX intermediate/high risk'
                },
                riskFactors: {
                    'Major': 'Age >75, previous fragility fracture, glucocorticoids, family history hip fracture',
                    'Other': 'Low BMI <18.5, alcohol >14 units/week, smoking, rheumatoid arthritis, conditions causing secondary osteoporosis'
                },
                prevention: {
                    'Calcium': '700-1200mg daily (diet or supplements)',
                    'Vitamin D': '10-20 micrograms (400-800 IU) daily',
                    'Exercise': 'Weight-bearing, balance, resistance training',
                    'Lifestyle': 'Stop smoking, reduce alcohol, maintain healthy weight'
                },
                treatment: {
                    'First-line': 'Oral bisphosphonate (alendronate 70mg weekly OR risedronate 35mg weekly)',
                    'Administration': 'Take on empty stomach with full glass water, stay upright 30 minutes',
                    'Second-line': 'IV bisphosphonate (zoledronic acid 5mg annually) OR denosumab 60mg SC 6-monthly',
                    'Alternatives': 'Raloxifene (postmenopausal women), teriparatide (severe osteoporosis)',
                    'Duration': 'Review after 5 years bisphosphonate, consider drug holiday'
                },
                monitoring: {
                    'DEXA': 'Not routinely repeated if on treatment unless clinical indication',
                    'Falls risk': 'Assess and address falls risk factors',
                    'Fracture liaison': 'Post-fracture services for secondary prevention'
                },
                steroids: 'Consider bone protection if prednisolone ‚â•7.5mg daily for ‚â•3 months'
            },
            'gout': {
                title: 'Gout Management (BSR/BHPR Guidelines 2024)',
                category: 'rheumatologic',
                evidenceLevel: 'BSR Guideline',
                lastUpdated: '2024',
                organisation: 'British Society for Rheumatology',
                diagnosis: {
                    'Clinical': 'Acute monoarthritis (typically 1st MTP joint), rapid onset, severe pain, red, hot, swollen',
                    'Joint aspiration': 'Negatively birefringent needle-shaped crystals (monosodium urate)',
                    'Serum urate': 'May be normal during acute attack. Check 2-4 weeks after attack'
                },
                acute: {
                    'First-line': 'NSAID (naproxen 750mg stat, then 250mg three times daily) OR colchicine 500mcg 2-4 times daily',
                    'Alternatives': 'Colchicine (if NSAID contraindicated), oral/IM steroid (if both contraindicated)',
                    'Avoid': 'Do NOT start/stop allopurinol during acute attack',
                    'Duration': 'Continue until 1-2 days after symptoms resolve'
                },
                uratelowering: {
                    'Indications': '‚â•2 attacks/year, tophi, chronic gouty arthritis, urate stones, CKD stage ‚â•3',
                    'Target': 'Serum urate <300 micromol/L (<5mg/dL)',
                    'First-line': 'Allopurinol 100mg daily, increase by 100mg every 2-4 weeks to target (max 900mg)',
                    'Prophylaxis': 'Give colchicine 500mcg once/twice daily OR NSAID when starting allopurinol',
                    'Alternative': 'Febuxostat if allopurinol not tolerated'
                },
                lifestyle: {
                    'Diet': 'Reduce purine-rich foods (red meat, seafood, organ meats, yeast extracts)',
                    'Alcohol': 'Limit beer and spirits (wine less problematic)',
                    'Drinks': 'Avoid sugar-sweetened drinks, increase water intake',
                    'Weight': 'Gradual weight loss if overweight (rapid weight loss can trigger attacks)',


// ========================================
// Wells (lines 4943-5343)
// ========================================
                calculatorContent += this.getBMICalculator();
                break;
        }
        calculatorContent = calculatorContent.replace('<h3 id="calculator-title"></h3>', `<h3 id="calculator-title">${calculatorTitle}</h3>`);
        container.innerHTML = calculatorContent;
        // Attach export buttons to results and per-calculator notes area
        try {
            // Ensure export features are available across calc-result blocks
            if (typeof this.setupExportFeatures === 'function') {
                this.setupExportFeatures();
            }
            // Add notes area for this calculator (persisted via localStorage)
            if (typeof this.setupCalculatorNotes === 'function') {
                this.setupCalculatorNotes(calcType);
            }
        } catch (err) {
            console.warn('‚ö†Ô∏è Failed to setup export/features or notes for calculator:', err);
        }
        console.log('üßÆ Loaded calculator:', calcType);
    }
    getBMICalculator() {
        return `
            <div class="calculator-form">
                <h4>BMI & Waist Circumference Calculator</h4>
                <div class="calc-input-group">
                    <label>Weight (kg):</label>
                    <input type="number" id="bmi-weight" placeholder="70" step="0.1">
                </div>
                <div class="calc-input-group">
                    <label>Height (cm):</label>
                    <input type="number" id="bmi-height" placeholder="175" step="0.1">
                </div>
                <div class="calc-input-group">
                    <label>Waist Circumference (cm) - Optional:</label>
                    <input type="number" id="bmi-waist" placeholder="85" step="0.1">
                </div>
                <div class="calc-input-group">
                    <label>Ethnicity:</label>
                    <select id="bmi-ethnicity">
                        <option value="european">European/Caucasian</option>
                        <option value="asian">Asian (Chinese, Japanese, South Asian)</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="calc-checkbox-group">
                    <label><input type="radio" name="bmi-sex" value="male"> Male</label>
                    <label><input type="radio" name="bmi-sex" value="female"> Female</label>
                </div>
                <button onclick="window.quizApp.calculateBMI()">Calculate</button>
                <div id="bmi-result" class="calc-result"></div>
                <div class="calc-reference">
                    <small>
                        <strong>BMI Categories (WHO):</strong><br>
                        Underweight: &lt;18.5 | Normal: 18.5-24.9<br>
                        Overweight: 25-29.9 | Obese: ‚â•30<br>
                        <strong>Asian populations:</strong> Overweight ‚â•23, Obese ‚â•27.5
                    </small>
                </div>
            </div>
        `;
    }

    getFrailtyCalculator() {
        return `
            <div class="calculator-form">
                <h4>Clinical Frailty Scale (Rockwood)</h4>
                <p><small>Select the category that best matches the patient</small></p>
                <div class="calc-input-group" id="frailty-options-detail">
                    <select id="frailty-select">
                        <option value="">-- Select frailty score --</option>
                        <option value="1">1 ‚Äî Very fit</option>
                        <option value="2">2 ‚Äî Well</option>
                        <option value="3">3 ‚Äî Managing well</option>
                        <option value="4">4 ‚Äî Vulnerable</option>
                        <option value="5">5 ‚Äî Mildly frail</option>
                        <option value="6">6 ‚Äî Moderately frail</option>
                        <option value="7">7 ‚Äî Severely frail</option>
                        <option value="8">8 ‚Äî Very severely frail</option>
                        <option value="9">9 ‚Äî Terminally ill</option>
                    </select>
                </div>
                <button onclick="window.quizApp.calculateFrailty()">Calculate</button>
                <div id="frailty-detail-result" class="calc-result"></div>
                <div class="calc-reference"><small>Rockwood Clinical Frailty Scale (1‚Äì9): use as an aid to clinical judgement.</small></div>
            </div>
        `;
    }

    calculateFrailty() {
        const sel = document.getElementById('frailty-select');
        const out = document.getElementById('frailty-detail-result');
        if (!sel || !out) return;
        const val = sel.value;
        if (!val) {
            out.innerHTML = '<p class="error">Please select a frailty score</p>';
            return;
        }
        const descriptions = {
            1: 'Very fit ‚Äî robust, active, energetic and motivated. Typically exercises regularly.',
            2: 'Well ‚Äî no active disease symptoms but less fit than category 1.',
            3: 'Managing well ‚Äî medical problems are well controlled, not regularly active beyond routine activities.',
            4: 'Vulnerable ‚Äî not dependent on others for daily help, but symptoms limit activities.',
            5: 'Mildly frail ‚Äî evident slowing and need help in high order instrumental activities of daily living.',
            6: 'Moderately frail ‚Äî need help with all outside activities and with keeping house.',
            7: 'Severely frail ‚Äî completely dependent for personal care, but stable and not at high risk of dying within 6 months.',
            8: 'Very severely frail ‚Äî completely dependent, approaching the end of life. Typically approaching high risk of dying.',
            9: 'Terminally ill ‚Äî life expectancy <6 months, not otherwise evidently frail.'
        };
        const guidance = (n) => {
            const num = parseInt(n, 10);
            if (num <= 3) return 'Not frail ‚Äî encourage activity and prevention.';
            if (num === 4) return 'Pre-frail/vulnerable ‚Äî consider targeted interventions (exercise, medication review).';
            if (num >=5 && num <=6) return 'Frailty present ‚Äî consider CGA, falls review and medication optimisation.';
            return 'High dependency ‚Äî prioritise care needs, consider palliative needs assessment where appropriate.';
        };

        out.innerHTML = `
            <div>
                <strong>Score: ${val}</strong>
                <div style="margin-top:8px">${descriptions[val]}</div>
                <div style="margin-top:8px;color:#374151;font-weight:600">${guidance(val)}</div>
            </div>
        `;
    }

    getBarthelCalculator() {
        return `
            <div class="calculator-form">
                <h4>Barthel Index (ADL)</h4>
                <p><small>Complete the items and press Calculate</small></p>
                <div class="calc-input-group" id="barthel-detail-items">
                    <!-- Simplified form: items named to match common Barthel scoring -->
                    <label>Feeding: <select id="b-feeding"><option value="0">Dependent (0)</option><option value="5">Needs assistance (5)</option><option value="10">Independent (10)</option></select></label>
                    <label>Bathing: <select id="b-bathing"><option value="0">Dependent (0)</option><option value="5">Independent (5)</option></select></label>
                    <label>Grooming: <select id="b-grooming"><option value="0">Needs help (0)</option><option value="5">Independent (5)</option></select></label>
                    <label>Dressing: <select id="b-dressing"><option value="0">Dependent (0)</option><option value="5">Needs help (5)</option><option value="10">Independent (10)</option></select></label>
                    <label>Bowels: <select id="b-bowels"><option value="0">Incontinent (0)</option><option value="5">Occasional accident (5)</option><option value="10">Continent (10)</option></select></label>
                    <label>Bladder: <select id="b-bladder"><option value="0">Incontinent (0)</option><option value="5">Occasional accident (5)</option><option value="10">Continent (10)</option></select></label>
                    <label>Toilet use: <select id="b-toilet"><option value="0">Dependent (0)</option><option value="5">Needs some help (5)</option><option value="10">Independent (10)</option></select></label>
                    <label>Transfers (bed-chair): <select id="b-transfers"><option value="0">Dependent (0)</option><option value="5">Major help (5)</option><option value="10">Minor help (10)</option><option value="15">Independent (15)</option></select></label>
                    <label>Mobility (level): <select id="b-mobility"><option value="0">Dependent (0)</option><option value="5">Immobile (5)</option><option value="10">Walks with help (10)</option><option value="15">Independent (15)</option></select></label>
                    <label>Stairs: <select id="b-stairs"><option value="0">Unable (0)</option><option value="5">Needs help (5)</option><option value="10">Independent (10)</option></select></label>
                </div>
                <button onclick="window.quizApp.calculateBarthel()">Calculate</button>
                <div id="barthel-detail-result" class="calc-result"></div>
                <div class="calc-reference"><small>Score 0-100. Higher scores indicate greater independence.</small></div>
            </div>
        `;
    }

    calculateBarthel() {
        const ids = ['b-feeding','b-bathing','b-grooming','b-dressing','b-bowels','b-bladder','b-toilet','b-transfers','b-mobility','b-stairs'];


};

if (typeof window !== 'undefined') {
    window.ExtractedCalculators = ExtractedCalculators;
}

console.log('Extracted Calculators loaded: 28 calculators');
